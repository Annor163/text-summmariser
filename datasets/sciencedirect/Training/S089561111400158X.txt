@&#MAIN-TITLE@&#
Digital reconstruction of high-quality daily 4D cone-beam CT images using prior knowledge of anatomy and respiratory motion

@&#HIGHLIGHTS@&#
By taking advantages of deformable image registration, we can successfully convert a single a low-quality cone-beam CT into a high-quality multi-phase cone-beam CT images.

@&#KEYPHRASES@&#
Deformable image registration,4D CT,CBCT,Respiratory motion,Principal component analysis,

@&#ABSTRACT@&#
Conventional in-room cone-beam computed tomography (CBCT) lacks explicit representation of patient respiratory motion and usually has poor image quality and inaccurate CT numbers for target delineation and/or adaptive treatment planning. In-room four-dimensional (4D) CBCT image acquisition is still time consuming and suffers the same issue of poor image quality. To overcome this limitation, we developed a computational framework to digitally synthesize high-quality daily 4D CBCT images using the prior knowledge of motion and appearance learned from the planning 4D CT dataset. A patient-specific respiratory motion model was first constructed from the planning 4D CT images using principal component analysis of displacement vector fields across different respiratory phases. Subsequently, the respiratory motion model as well as the image content of the planning CT was spatially mapped onto the daily CBCT using deformable image registration. The synthesized 4D images possess explicit patient motion while maintaining the geometric accuracy of patient's anatomy at the time of treatment. We validated our model by quantitatively comparing the synthesized 4D CBCT against the 4D CT dataset acquired in the same day from protocol patients undergoing daily in-room CBCT setup and weekly 4D CT for treatment evaluation. Our preliminary results have demonstrated good agreement of contours in different motion phases between the synthesized and acquired scans. Various imaging artifacts were also suppressed and soft-tissue visibility was enhanced.

@&#INTRODUCTION@&#
In radiation therapy, it is well known that patient anatomy can undergo significant changes, such as tumor shrinkage or expansion and weight loss, from the simulation phase to the delivery of radiation beam. Apparently, those changes cannot be fully compensated by rigid image alignment. Therefore, image guidance on a regular basis is critical to monitoring anatomic changes during the course of treatment. Although routine assessment of patient anatomy can generally be achieved using conventional CT, the advent of in-room cone-beam computed tomography (CBCT) [1–4] provides an accurate representation of patient anatomy prior to treatment delivery, allowing for daily patient setup, evaluation of changes in the tumor and critical structures, treatment re-planning, and dose verification/accumulation in adaptive radiotherapy [5]. However, owing to the lack of temporal information, a single 3D CBCT image may not be adequate to characterize patient anatomy when intra-fractional motion is involved during the delivery of radiation, such as the respiratory motion encountered in the treatment of thoracic cancers. Another typical challenge in the clinical application of CBCT lies in the degraded quality of CBCT images, which is mainly caused by the scatter effect when using a large flat-panel detector, imperfect beam-hardening correction, uncorrected detector signal lag, and motion artifacts during image acquisition [6]. Particularly in thoracic radiotherapy, the artifacts caused by respiratory motion generally dominate and appear as blurs and streaks in the thoracic and abdominal region (Fig. 1). These adverse effects may influence the operator's clinical decision-making, increase the inter-observer variations in image evaluation, and lead to inaccurate dose calculations [7].Although conventional four-dimensional (4D) CT has already become a routine practice in the simulation/planning phase of radiation treatment [8–10], in-room respiratory-correlated CBCT acquisition remains a time-consuming procedure (over 4min) and thus comprises its clinical use, despite considerable research efforts that have been made on 4D CBCT image reconstruction [11–14]. Reducing 4D CBCT scan time comes at the cost of image quality. Short scan times produce images with streak artifacts, which can degrade the ability for the assessment of tumor motion from the 4D images. Therefore, alternative techniques/algorithms incorporating temporal information into daily CBCT imaging are needed. To address the aforementioned challenges, we herein propose a computational framework for the digital synthesis of high-quality daily 4D CBCT images for image-guided treatment of thoracic cancer. The synthesized daily 4D images possess explicit respiratory motion of the patient, and their quality is comparable to that of conventional CT images, while maintaining the shape and geometric representation of the patient defined by in-room CT prior to the treatment. The motivation for developing our algorithm is to use the prior knowledge of the respiratory motion and CT number explicitly defined in the treatment planning/simulation 4D CT images. Simply put, our strategy is to transfer the respiratory motion pattern and calibrated CT number from planning CT images to daily CBCT images. The transferred respiratory motion will be used to derive 4D CBCT images, whereas the mapped CT number will enhance the CBCT image quality. The assumption underlying our algorithm is that, although the patient's anatomy may deviate significantly after the treatment planning phase, the pattern of respiratory motion can be characterized using a parametric motion model for a specific subject. Previous studies have shown that patients’ breathing motion is not reproducible for each breathing cycle, and irregular breathing is usually not predictable [15,16]. Nonetheless, it is a viable approach to characterize patient's regular respiratory motion components using planning 4D CT images.Previous research efforts have presented interesting work toward deriving a prior patient-specific respiratory motion model and the use of prior knowledge of motion to correct CBCT artifacts. Broadly speaking, this research effort can be categorized into two streams. The first stream is direct acquisition of 4D CBCT images, which involves sorting CBCT projections based on the respiratory signal. Although 4D CBCT reconstructions have been successfully demonstrated by some researchers [11–14], the compromise between image acquisition time and image quality still poses a challenge to its practical use as an in-room image guidance solution. In-room image guidance usually requires a short scanning time, but reducing the scan time comes at the cost of image quality. Usually, the reconstruction of 4D CBCT images within clinically acceptable periods results in images with streaky aliasing artifacts caused by insufficient angular sampling of CBCT projections at each respiratory phase. The degraded image quality thus compromises the accuracy of tumor motion assessment and patient positioning. The alternative solution for dealing with respiratory motion is to reconstruct motion-compensated daily CBCT images with reduced motion artifacts. The key is to incorporate patient motion into the CBCT reconstruction procedure, which involves the challenging problem of estimating patient motion from the cone-beam projections. To address this problem, some authors have proposed taking advantage of knowledge of prior respiratory motion obtained using conventional CT images. In a study, researchers estimated patient motion by matching the CBCT projection sequence with the CT projection sequence simulated from a B-spline deformed reference CT image; complicated optimization was involved in the estimation of the B-spline parameters [26]. Also, Sonke et al.[24] described an approach to reconstruct respiratory motion-compensated CBCT images using prior motion knowledge in the planning 4D CT, in which the prior motion was directly represented by displacement vector fields from a reference phase to the rest phases calculated using a phase-based optical flow algorithm. Similarly, Vandemeulebroucke et al.[25] used the motion defined in the planning 4D CT set; they also used a B-spline temporal model to represent displacement vector fields to reduce the number of parameters. More recently, Zhang et al.[23] developed an algorithm to correct CBCT motion artifacts using a PCA-based patient-specific motion model [19]. They used this patient-specific motion model to deformably combine respiratory-correlated CBCT data sets into a single high-quality CBCT set with reduced motion-introduced blur. More recently, digital reconstruction of daily free breathing 4D CT images has been reported by Wu et al. [35]. However, the reconstruction of 4D CBCT presents more challenges than that of 4D CT due to the inherent poor image quality.In our approach, deformable image registration plays a key role in establishing dense voxel-by-voxel correspondences across different phases of planning 4D CT images (intra-fractional displacement vector fields) and between daily CBCT and planning 4D CT images (inter-fractional displacement vector fields). Specifically, we first used intra-fractional displacement vector fields to create a low-dimensional respiratory motion model and then spatially mapped this model as well as calibrated CT number of planning CT images to CBCT image domain using inter-fractional displacement vector fields. Proof-of-concept experimental results on a proton protocol of lung cancer patients have demonstrated the potential of this approach.A patient's respiratory motion can be explicitly described by a 4D CT image set, which consists of a set of phase-binned CT images (usually ten phases) representing different respiratory motion states. However, incorrect phase tagging due to irregular motion can lead to severe motion artifacts, and the 4D CT reconstructions are available only at discrete phases. To have a better motion representation, a respiratory motion model is desirable to allow for image interpolations at arbitrary phases during a respiratory cycle. On the other hand, the use of a respiratory motion model makes it easier for 4D CT images to be transferred to the CBCT with minimal impact from motion artifacts.To create the respiratory motion model, a reference image should be identified from the 4D CT image set. In this study, we chose the averaged planning CT as the reference image, which is defined as(1)CTave(x→)=1T∑t=1TCT(x→,t)where, vectorx→indicates the voxel location in 3D space, t indices the phases in 4D CT image set, and T is the number of phases (T=10 phases are reconstructed for our scanners). Averaged CT is generally used as the planning CT to account for tumor motion in radiation therapy. Deformable image registration was then performed from each of the phases to the averaged planning CT to establish dense correspondences. We used a dual-force demons deformable image registration algorithm [28], which was proved to be of good accuracy and better convergence than the traditional one [29]. The validation of this in-house algorithm in the context of 4D CT images has been investigated on published data sets. Each of the displacement vector fields can be represented as a 3-tupleD→LR(x→,t),D→AP(x→,t),D⇀SI(x→,t), whereD→LR(.),D→AP(.)andD→SI(.)represent the displacement field matrices from phase t to the reference image along the left–right (LR), anterior–posterior (AP), and superior–inferior (SI) directions. We derived a patient-specific respiratory motion model using principal component analysis (PCA) of the displacement vector fields. Specifically, letd→i(t), i=LR, AP and SI, be the columnwise vectorization of the displacement field for phase t, andDi={d→i(1),d→i(2),...,d→i(T)}, i=LR, AP and SI, be the matrix consisting of T displacement fields (T=10). First, we calculated the sample covariance matrix of Di, given as(2)Σi=1T−1∑t=1T(d→i(t)−d¯→i)(d→i(t)−d¯→i)T,i=LR,AP,SIwhere, the column vectord¯→irepresented the sample mean given as(3)d¯→i=1T∑t=1Td→i(t),i=LR,AP,SIAn optimal transformation that maps the original high-dimensional space onto a low-dimensional subspace can be obtained by solving eigen values and eigen vectors of the covariance matrix as(4)Σiλi(j)=λi(j)φ→i(j),i=LR,AP,SI;j=1,2,...,Twhere,λi(j)andφ→i(j)are the jth eigen value and eigen vector of Σi, respectively. We observed from more than 50 4D CT image sets that the principal motion basisφ→i(1), the eigen vector corresponding to the largest eigen value, was capable of capturing more than 85% of the total variations of displacement fields. This means that the transformation matrix Σii=LR, AP, SI can be described by the principal motion basisφ→i(1)only. Dropping off the superscript in the principal motion basis, the displacement field at phase t,d→i(t)can be represented by the projection coefficient onto the one-dimensional subspace spanned byφ→ias(5)αi(t)=φ→iT(d→i(t)−d¯→i),i=LR,AP,SITo this point, the motion versus time is described by the projection coefficientsαi(1),αi(2),...,αi(T)i=LR,AP,SIat T (T=10) discrete points, which was determined inherently by the CT scanner. The limited temporal resolution impedes the reconstruction of 4D CT at many time points. To solve this problem, a continuous temporal function βi(t) can be fitted to these discrete coefficients for each direction, i=LR, AP, SI by minimizing the following Eq.:(6)βi(t)=argminβi(t)λ∑k=1Tβi(t)−αi(k)2+(1−λ)∫1T∂2βi(t)∂t22dt,where, the first term describes the data loyalty and the second term controls the smoothness. The parameter λ is the weighted parameters balancing the data loyalty and smoothness terms. In our implementation, λ was set to 0.9 based on experimental tests. The fitted continuous function βi(t) turns to be a cubic spline function. Withφ→iand βi(t), i=LR, AP, SI available, the respiratory motion function was readily reconstructed along each direction via a linear combination of principal motion bases that characterized the regular motion component, resulting in the following function:(7)D→4DCT(x⇀,t)=D→LR(x→,t)=d¯→LR(x→)+βLR(t)φ→LR(x→)D→AP(x→,t)=d¯→AP(x→)+βAP(t)φ→AP(x→)D→SI(x→,t)=d¯→SI(x→)+βSI(t)φ→SI(x→),where,x→indices the voxel location andd¯→i(.)represents the mean displacement field over all phases as defined in Eq. (3). The variable t in Eq. (7) is continuous and can be sampled at any time point to obtain a reconstructed phased CT image [17]. Similar PCA models have been validated by several previous studies [18–22] to have the capability in accurately characterizing the respiratory motion.Digital reconstruction of 4D CBCT images requires mapping the respiratory motion model and the calibrated CT number from the 4D CT images to the single daily CBCT image. To do so, we shall first establish the voxel-level correspondence between the planning 4D CT and the daily CBCT images.Dense correspondences between planning 4D CT and daily CBCT can be established using aforementioned deformable image registration. An appropriate CT image should be first selected carefully from the 4D CT data set for the registration purpose. The CT number of this data set should be the one that best matches that of the daily CBCT images so that errors caused by intensity-based registration will be minimal. The CBCT projection images are acquired with a low gantry speed in the presence of respiratory motion; these motion-blurred 2D projections are used to reconstruct a 3D CBCT volume encoding information from all the different phases. As a result, the reconstructed 3D CBCT volume tends to have more similarities in intensity distribution with the averaged CT set than with any of the other phases in the planning 4D CT set. To establish dense correspondences across daily CBCT images and the averaged planning CT images, an in-house developed, dual-force intensity-based Demons algorithm was used. Therefore, averaged planning CT was registered to the daily CBCT image to serve as the connection between the planning 4D CT set with the daily CBCT. This is also the reason that we chose the averaged planning CT as the reference image in creating the respiratory motion model. An explicit assumption about intensity-based methods is that the intensity distribution will be consistent across the image pair to be registered. Unfortunately, this assumption may be violated when applied to CT-CBCT registration, as CBCT images usually do not possess the accurate Hounsfield units as calibrated in conventional CT. To alleviate this inconsistency, we used an intensity normalization approach to pre-process the CBCT–CT image pairs. By using local histogram equalization, this approach can simultaneously matche image intensities across an image pair and enhances image intensities within low-contrast regions. Our previous study [30] demonstrated the effectiveness of this intensity normalization algorithm in dealing with intensity inconsistency and low image contrast in CBCT–CT registration. A similar approach has been proposed and validated in [31]. Mathematically, the displacement vector field obtained from deformable image registration represents a dense mappingx→=γ→(y→)from the daily CBCT domainy→∈R3to the planning average CT domainx→∈R3.Since the respiratory motion model was defined on the averaged planning CT image, with the mapping between averaged planning CT and the daily CBCT image available, it is straightforward to transfer the respiratory motion from the planning CT domain to the daily CBCT domain. A compositional mapping could be created using the respiratory motion model described by Eq. (7) and the aforementioned mapping from the daily CBCT to the averaged planning CT. The respiratory motion model on the daily CBCT can be formally represented as(8)D→CBCT(y→,t)=D→LRCBCT(y→,t)=d¯→LR(γ→(y→))+βLR(t)φ→LR(γ→(y→))D→APCBCT(y→,t)=d¯→AP(γ→(y→))+βAP(t)φ→AP(γ→(y→))D→SICBCT(y→,t)=d¯→SI(γ→(y→))+βSI(t)φ→SI(γ→(y→)).Using Eq. (8), we can derive the CBCT at any phase t by warping the original CBCT image using the following equation,(9)It(y→)=ICBCT(y→+D→CBCT(y→,t)).Mapping respiratory motion model to the CBCT domain can be referred to Fig. 2. To this end, we were able to create 4D CBCT images with the image contents defined by the CT numbers in the daily CBCT image.Although the 4D CBCT data set can be synthesized as described in the preceding section, the image quality of synthesized images might be even worse than that of the original CBCT images after deformable warping of the poor-quality daily CBCT images. To address this problem, we used the well-calibrated Hounsfield units defined in the planning CT, and replaced the image content (CT number) in the daily CBCT with that of the planning CT on a voxel-by-voxel basis [32]. Although one can directly warp the averaged planning CT images to the CBCT images byx→=γ(y→), but the image blur in the averaged CT image was also propagated to the mapped CBCT images (Fig. 3). To further reduce the blurring effect, we propose a two-step procedure that uses a particular phase from the planning 4D CT set as the original source of the image content, which is free of image blur. Our criterion is to find a phase from 4D CT images that undergoes the least amount of deformation from the average planning CT. Formally, ifD→4DCT(x→,t)denotes the 4D motion function defined in Eq. (7), the optimal phase is defined asI(z→,t*), in whicht*=argmintD→4DCT(x→,t). In our experiments, the optimal phase selected based on our procedure was usually about T30% or T70%, which is very close to that in mid-ventilation images [33,34]. To transfer CT numbers, a dense mapping, denoted byz→=κ(y→), from the daily CBCT domainy→to the mid-ventilation phase domainz→must be established. In fact, the functionz→=κ(y→)was reduced to the additive composition of two consecutive mappingsx→=γ→(y→), which maps from the CBCT domainy→to the averaged planning CT domainx⇀, andz→=D→4DCT(x→,t*), which maps from the averaged planning CTx⇀to the mid-ventilation CT domainz→. This mapping was formally defined as Eq. (10).(10)z→=κ(y)=γ(y→)+D→4DCT(γ→(y→),t*)This mapping can be used to transfer the calibrated CT number in the selected phase image in 4D CT, to the synthesized 4D CBCT images. Combining Eqs. (9) and (10), this CT number mapping can be formally defined as(11)It(y→)=It*(κ−1(z→)+D→CBCT(κ−1(z→),t)).The synthesized 4D CBCT images possessed the image quality comparable to that of conventional CT images, but maintained the anatomy representation at the time of treatment. Fig. 4demonstrated the superior image quality of the proposed approach.

@&#CONCLUSIONS@&#
We have proposed a novel framework for generating improved daily 4D CBCT images via deformable mapping of prior respiratory motion and appearance information defined in the planning 4D CT. The synthesized daily 4D CBCT images possess explicit respiratory motion of the patient, and their image quality is comparable with that of conventional CT images. At the same time, the patient's shape and geometric representation defined by in-room CT before daily treatment is maintained using our framework. Proof-of-principal experiments with various patient cases have demonstrated the potential of our approach in improving on-line image and motion evaluation for adaptive replanning and dose verification.