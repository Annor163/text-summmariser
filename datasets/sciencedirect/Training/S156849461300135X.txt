@&#MAIN-TITLE@&#
A design methodology for semi-physical fuzzy models applied to the dynamic characterization of LiFePO4 batteries

@&#HIGHLIGHTS@&#
Methodology for obtaining fuzzy rule-based semi-physical models.Possibilistic maximally specific observer of the state of a nonlinear system.Mathematical model of open circuit voltage and state of charge of LiFePO4 batteries.

@&#KEYPHRASES@&#
Fuzzy models,Online identification,Semi-physical modeling,Imprecise data,LiFePO4 batteries,

@&#ABSTRACT@&#
A methodology for designing semi-physical fuzzy models is proposed. Prior physical knowledge about the dynamics of the system is modeled with continuous time differential equations. Fuzzy knowledge bases are embedded in these equations as nonlinear constructive blocks. Rules comprising the knowledge bases are fitted to interval-valued data with metaheuristics. A possibilistic filter is proposed that is able to gradually evolve an initial estimation of the latent variables of the model on the basis of successive prediction errors.This methodology has been applied to the prediction of voltage and state of charge of LiFePO4 batteries. An empirical study has been carried over data gathered in experiments at the Battery Laboratory at Oviedo University. Fitting between the proposed model and actual measurements is studied for four different manufacturers and different charge–discharge patterns. Predictions of the evolution of the voltage during charge, discharge and inactivity compare favorably to different models in the literature. The possibilistic filter allows to estimate the state of charge of batteries after an arbitrary path that may include partial charges and discharges. It is shown that the accuracy of the open loop model improves that of other approaches in the literature, and at the same time the observer-based online model is able to approximate the effective remnant charge of the battery after a reasonably short time.

@&#INTRODUCTION@&#
Nonlinear system identification is prone to overparameterization, that can be alleviated by restricting the degrees of freedom of the model with prior physical knowledge about the system. A gradation exists between “white boxes”, that only depend on this physical knowledge, and “black boxes”, universal approximators that are agnostic about the properties the problem and are fitted to data [43]. “Gray boxes”, also called semi-physical, semi-mechanical or hybrid models, are intermediate between white and black boxes. These intermediate models only assume a partial knowledge about the system dynamics. For instance, “almost white” models can be conceived where a set of differential equations depends on the value of a non-observable variable that is synthesized by means of universal approximators. At the other extreme, a piecewise model can be defined where prior knowledge is only used for defining the position or the number of different zones of operation but the behavior at each region is characterized by a black box model.Prior physical knowledge can be expressed in different forms, for instance by means of equations, constrains or linguistic rules. Combinations of black boxes with equations describing the system behavior were first described in [33,34], where semi-empirical models were solved with variational calculus. In [49], neural networks play the role of nonlinear functions that are inserted into the differential equations describing the dynamics of the system. In this respect, fuzzy rule-based systems (FRBS) are also well suited for being part of semi-physical models because they are capable of approximating a wide range of functions, can be fitted to data and express the acquired knowledge in a human-understandable form [12]. Different associations between prior knowledge and universal approximators have been explored in the context of fuzzy modeling [35,7,66,71]. Fuzzy systems can also serve as flexible constrains of the behavior of a system [1,9,42] or be local models, whose scope is found with cluster analysis [2,3].This study was originated in response to some problems found while designing dynamical models of lithium-ion (Li-Ion) batteries for electric vehicles (see Section2). Most of the physical knowledge about these systems can be applied to the design of the differential equations describing its dynamic behavior, and black boxes are reserved for those dependences that must be learned from data. In the present contribution, these black boxes are FRBSs, that will be used for modeling nonlinear functions, embedded in a set of differential equations modeling prior physical knowledge. FRBSs are very well suited to this task because they are universal approximators, and it is easy to incorporate expert knowledge in their definition. For instance, it will be shown later that charge and discharge cycles have hysteresis. This knowledge has been introduced by means of an input variable describing the slope of the charging current with only three linguistic terms (“charging”, “rest”, “discharge”). Other types of black boxes do not offer additional plasticity neither additional advantages in terms of representational power but can limit the amount of expert knowledge that can be added to the domain of the problem.Consequently, a general methodology for learning fuzzy rules as constructive blocks of a class of semi physical models is proposed in Section3. In Section4, this methodology is particularized to the mentioned case of Li-Ion batteries, and the numerical results obtained are compared to those of other battery models in the same section. Lastly, concluding remarks and future work are explained in Section5.Li-ion batteries are a good choice for electrical vehicles because of the good balance between the energy storage density and the amount of power that can be supplied [11]. There is a large number of chemical technologies used in electric or hybrid vehicles [67], but it is expected that LiFePO4 are present in a significant part of the vehicles. The Battery Laboratory at Oviedo University has developed different test protocols for determining the conditions (high current, high demand of energy and high temperatures) that impede the functionality of the battery [54]. The results of these studies will be used for developing new Battery Management Systems (BMS) that allow, among different applications, an accurate estimation of the State of Charge (SOC) of a battery and therefore the autonomy of the vehicle. Different battery models are subjected to different experiments: fast charge and discharge cycles, discharge under variable patterns of consumption and periodical essays of the battery that determine the evolution of the available capacity and the aging degree. These experiments measure voltage, current and surface temperature. Charge and discharge graphs are obtained.LiFePO4 batteries have an almost flat Open Circuit Voltage (OCV) as a function of SOC. This fact makes hard to predict SOC as a function of OCV. In addition to this, there is a noticeable hysteresis in the charge–discharge process. This nonlinearity, along with the fact that batteries are unstable systems (their best lineal approximation contains one or more poles in the origin) difficulties the applicability of conventional system identification techniques. Lastly, flat OCV graphs mean that the linearized state space model is not observable in certain areas, preventing the use of black box models in some operating regimes. All these factors make difficult to obtain an accurate model of batteries built with this technology unless prior physical knowledge about the system is used in the definition of the model.In previous works, different models have been proposed that can reproduce the expected behavior of a LiFePO4 battery. For instance, chemical models [53] are capable of predicting either SOC or State of Health (SOH) [52]. Dynamical models based on a equivalent electrical circuit where some or all of the components are nonlinear are also used. In [14,27,76] the battery is approximated by a circuit containing resistive and capacitive elements. In [10,45] the battery impedance is analyzed, and in [38] the effect of nonlinearities in the capacity is studied. There are comparative studies of different electric models in [23,31,41]. Thermal properties are studied on [8,24]. Apart from this, other dynamical models exist that predict the output of the battery under sudden changes in charge or discharge current [26,47,55,73,75,77]. SOC can also be estimated with state space models [30,72], in combination with a filter that adjusts the predicted state as a function of the differences between the prediction of the model and measurements taken on the battery. If a stochastic characterization of the residual of the model is available, then Kalman filters can be used [19,32]. Lastly, soft computing techniques have been already applied to similar problems, including a combination of neural networks and Kalman filter for estimating SOC [15], fuzzy [68] or neuro-fuzzy models [13]. Notwithstanding these works, the reliable estimation of the SOC of a LiFePO4 battery for arbitrary charge–discharge cycles is an open problem. This question is addressed in this contribution by means of a FRBS-based possibilistic observer that, in combination with a semi-physical model, gradually evolves an initial estimation of the charge on the basis of successive prediction errors.As mentioned, semi-physical models depend on prior knowledge. In certain cases, this knowledge consists in an incomplete description of the set of difference or differential equations defining the dynamics of the system. The standard state-space formulation of these equations is as follows:(1)x˙(t)=f(x(t),u(t))(2)y(t)=g(x(t),u(t))where x is a vector of state space variables, y is a vector of outputs, u contains the inputs and f, g are vector-valued functions describing the evolution of the state and outputs in time as a function of the actual state and inputs. The components of x(t) cannot be observed. Some of the inputs u(t) are known control actions. Other inputs are unknown and their influence in the model is manifested as an additional difference between the actual output and its prediction. Outputs y(t) can in turn be imprecisely perceived, because of sensor noise or other sources of random or epistemic uncertainty [22]. It will be assumed that the functions f and g are partially unknown.In lack of prior knowledge, both f and g can be approximated by means of universal approximators [29]. In this study, it will be assumed that only a part of these equations is undetermined. This part consists in two functions funk and gunk, such that(3)f(x,u)=fknoθ∘funk(x,u)(4)g(x,u)=gknoθ∘gunk(x,u)where ∘ is function composition, andfknoθandgknoθare known except for the values of a parameter vector θ. Analytical expressions of funk and gunk are unknown. Parametric definitions of fkno and gkno are known. All parameters and the expressions of funk and gunk will be learned from sequences of inputs and outputs to the system. In the present contribution, both funk and gunk will be approximated by means of FRBSs. An additional procedure must be devised for gradually evolving the state of the system from values of the observable variables. This procedure is needed for predicting the future evolution of the output of the system under a known temporal sequence of inputs, because this evolution would depend on the initial state of the system, which is undetermined. In this work, the strategy used for evolving the state estimation is based on the concept of Luenberger observer [74]. Generally speaking, an observer is a matrix function G that depends on the difference between the estimated outputyˆpredicted by the models and the actual output y of the system. This function is introduced in the system model as follows:(5)xˆ˙(t)=f(xˆ(t),u(t))−G(y(t)−yˆ(t))(6)yˆ(t)=g(xˆ(t),u(t)).Under certain conditions, the difference betweeny(t)−yˆ(t)is gradually being reduced and at the same time thatxˆ(t)converges towards x(t).In Section3.3 a method will be proposed for obtaining a definition of G as a new FRBS, able to optimize the specificity of an interval-valued estimation of the system state. Before this, in the next section the proposed modeling methodology is described. This procedure consists of four tasks:1.Discretization of the differential equations of the state model, allowing their numerical integration (Section3.1).Definition of a quality metric associated to the estimation of the parameters definingfknoθandgknoθ, and the rule-based systems funk and gunk, taking into account the associated uncertainties (Section3.2).Definition of a procedure for estimating the state of the system from past prediction errors, again considering the uncertainties originated in the lack of accuracy of the model and the imprecise perceptions of the observable variables (Section3.3).Definition of a metaheuristic that find the values of the unknown parameters and rules needed in the preceding stages (Section3.4 and Appendix A).Numerical discretization of systems of differential equations can be made with explicit (forward) or implicit (backward) approaches [51].An equation(7)x˙(t)=fkno∘funk(x(t),u(t))is explicitly discretized as follows:(8)K(x(k)ΔT)·x((k+1)ΔT)+ϕ(funk(x(kΔT),u((kΔT))),ΔT)=0where K is a matrix, ϕ is a vector function and ΔT is the discretization interval (in this case, that interval will be a multiple of the sample period used for capturing the experimental data). Using a subindex-based notation,(9)K(xk)·xk+1+ϕ(funk(xk,uk),ΔT)=0.There are different solutions for K and ϕ. In reference [51] the most common explicit discretization schemes can be found. Runge-Kutta's method is widespread; starting with Euler's method,(10)xk+1(RK1)=xk+f(xk,uk)·ΔTthe derivative in k+1 is estimated as(11)f(xk+1(RK1),uk+1)and the estimation of the derivative between periods k and k+1 is the average of both, thus(12)xk+1(RK2)=xk+12(f(xk,uk)+f(xk+1(RK1),uk+1))·ΔT.This process can be repeated,(13)xk+1(p)=xk+12(f(xk,uk)+f(xk+1(p−1),uk+1))·ΔT.Equation(14)x˙=fkno∘funk(x(t),u(t))is implicitly discretized as follows:(15)K(x(k+1)ΔT)·x((k+1)ΔT)+φ(funk(x((k+1)ΔT),u((k+1)ΔT)),funk(x(kΔT),u((kΔT))),ΔT)=0where K is a matrix, φ is a vector function and ΔT is the discretization interval, as before. Therefore,(16)K(xk)·xk+1+φ(funk(xk+1,uk+1),funk(xk,uk),ΔT)=0.Different matrices K and functions φ can be selected. Implicit discretization is numerically more stable than explicit discretization, and allows using longer discretization periods, however a system of nonlinear equations must be solved for each step, and this system depends on the unknown nonlinear function funk. In this study, the implicit Euler's method will be used:(17)xk+1(E1)=xk+f(xk+1(E1),uk+1)·ΔT.For estimatingxk+1(E1)the system of equations(18)x−f(x,uk+1)·ΔT−xk=0must be solved. A fixed point algorithm may be used,(19)x(p+1)=xk+f(x(p),uk+1)·ΔT,starting withx(1)=xk+1(RK1), and makingxk+1(E1)=x(p0)for a high enough p0.If state variables were directly observable, the quality metric would be the cumulated sum of the differences between estimationsxˆkand actual values of xkin a representative path of the state space. Since this is not always possible, the quality of a model will be defined as the difference between their observable outputs and the model outputs. For instance, if implicit Euler's methods was used, given a path comprising a sequence of input and output vectors{(uk,yk)}k=1N, the square error of the model described by means of the state (3) and output (4) equations recursively depends on the initial state as follows:(20)E(x1(E1))=∑k=1N||yk−gkno∘gunk(xk(E1),uk)||2wherexk+1(E1)is calculated as mentioned in Eq. (19).The initial statex1(E1)is not always known. For stable systems the influence of the initial state is negligible after k0 periods, thus it is possible to start with an arbitrary estimation of the initial state and discard the first k0 periods of the model simulation, making for instance(21)Ek0=∑k=k0N||yk−gkno∘gunk(xk(E1),uk)||2(22)x1(E1)=0.On the contrary, if the system is unstable, the quality of the model will only be defined if the initial state is known. For these systems, not often addressed in the related literature [70], it is proposed to make an analysis based on a plausible set of state values: let be supposed that a set of possible values for the initial state Xini is known. In total lack of knowledge this set could be the whole range of values of the variable. The set of possible quality values of the model is given by the evaluation of all possible paths of the model for each initial state in Xini:(23)E¯(Xini)={E(x)∣x∈Xini}.Furthermore, if the knowledge about the initial state is given by a possibility distributionΠini(X)=sup{X˜ini(x):x∈X}that (according to [18,17,56]) is equivalent to a nested family of confidence intervals{[X˜ini]α}α∈[0,1], the quality of the model is given by the fuzzy set that follows:(24)E˜(X˜ini)(e)=sup{α∣e∈E¯([X˜ini]α)}.In case the output data is interval-valued, because of an insufficient resolution in digital sensors, missing or censored data [56,58,57,59], the quality of a stable model will be given by an interval of valuesE¯k0, that will be approximated with fuzzy arithmetic because of computational efficiency reasons:(25)E¯k0=oplusk=k0N||y¯k⊖gkno∘gunk(xk(E1),uk)||2(26)x1(E1)=0where(27)(A¯⊖x)={a−x∣a∈A¯}(28)(A¯⊕B¯)={a−b∣a∈A¯,b∈B¯}(29)||(V¯1,…,V¯n)||={||(v1,…,vn)||∣v1∈V¯1,…,vn∈V¯n}.The quality of an unstable model will also be an interval-valued function of the initial state,(30)E¯(x1(E1))=oplusk=1N||y¯k⊖gkno∘gunk(xk(E1),uk)||2.Lastly, in case both the initial state is imprecisely known and the outputs are intervals,(31)E˜(X˜ini)(e)=sup{X˜ini(x)∣E¯(x)∋e}.For predicting the output, the state of the system must be known. By means of a Luenberger observer [74], as mentioned, the prediction can be started with an arbitrary initial estimation of the state. The model state will gradually converge to the system state, being guided by the output prediction error. Given a nonlinear system defined by the set of equations(32)x˙(t)=f(x(t),u(t))(33)y(t)=g(x(t),u(t))the structure of a linear observer [25] is as follows:(34)xˆ˙(t)=f(xˆ(t),u(t))−G(y(t)−yˆ(t))(35)yˆ(t)=g(xˆ(t),u(t))therefore(36)xˆ˙(t)=f(xˆ(t),u(t))−G(y(t)−g(xˆ(t),u(t))).The observer gain is a matrix chosen so the observation error(37)e(t)=x(t)−xˆ(t)tends to zero. The dynamics of the observation error are determined by(38)e˙(t)=x˙(t)−xˆ˙(t)=f(x(t),u(t))−f(xˆ(t),u(t))+G·(g(x(t),u(t))−g(xˆ(t),u(t))).Removingxˆ(t)from the error equation, it is obtained that(39)e˙=f(x,u)−f(x−e,u)+G·g(x,u)−G·g(x−e,u)and, in steady state,(40)0=f(x,u)−f(x−e,u)+G·g(x,u)−G·g(x−e,u),where it is clear that e=0 is a solution. That is to say, if the gain G ensures that the dynamics of error and observer are asymptotically stable, then the observer will gradually reduce the error in the state estimation.There are many strategies for computing G[25], the Kalman filter being the best known [28]. If the measurements of the observable variables are affected by a non stochastic uncertainty, it is possible to generalize a design based on pole assignment [37] by analyzing the residual of the prediction of the output, as explained below.The procedure for estimating the observer gain for a linear, time invariant system, is based on the observer equations:(41)xˆk+1=Axˆk+Buk−Gɛk(42)yk=Cxˆk+Duk+ɛkwhere(43)ɛk=yk−yˆkis a sequence of residuals, with(44)yˆk=Cxˆk+Duk.The residual ɛkis a composition of both process noise and measurement noise, andxˆkis the observer state vector. When process and measurement noises are statistically independent, null mean stationary white noise processes, ɛkis in turn a sequence of white noise residuals and −G is Kalman gain.If G is to be estimated from a set of data and the model of the system is known but the statistical properties of the noises in the system are not, than according to [37] observer equations can be split in two sets,(45)xˆk+11=Axˆk1+Buk(46)yk1=Cxˆk1+Duk(47)xˆk+12=Axˆk2−Gɛk(48)yk2=Cxˆk2+ɛkwherexˆk=xˆk1+xˆk2, andyk=yk1+yk2. Valuesxˆk1andyk1are the parts of state and output caused by the deterministic part of the input, uk. Eqs. (47) and (48) model the dynamics caused by the unknown part of the input, ɛk. The purpose of the procedure is to find a gain G that makes ɛkminimum and uncorrelated.Rewriting Eqs. (47) and (48),(49)xˆk+12=(A+GC)xˆk2−Gyk2(50)yk2=Cxˆk2+ɛkit can be checked that a necessary condition for achieving convergence between estimated and actual states from any starting point is the stability of the system given by Eqs. (49) and (50), and therefore the poles of the system with observer (the eigenvalues of the matrix A+GC) must be inside the unity circle.The extension of this procedure to nonlinear, continuous time system is not feasible in the general case, however it can be extended to linearizable systems, as proposed below.Equations of the observer for nonlinear, continuous time systems are(51)xˆ˙(t)=f(xˆ(t),u(t))−G(ɛ(t))(52)y(t)=g(xˆ(t),u(t))+ɛ(t)where the residual is a function(53)ɛ(t)=y(t)−yˆ(t)with(54)yˆ(t)=g(xˆ(t),u(t)).Generally speaking, state and output equations cannot be separated as mentioned before unless f and g are linear, thus a design strategy consists in linearizing f and g around different operating points defined by a state x0 and an input u0[36]:(55)f(x0+h,u0)≈f(x0,u0)+h∂f∂xx0,u0(56)g(x0+h,u0)≈g(x0,u0)+h∂g∂xx0,u0thus an approximated decomposition, similar to that seen before for discrete linear systems, can be performed(57)xˆ˙(t)=f(xˆ1(t)+xˆ2(t),u(t))−G(ɛ(t))(58)y1(t)+y2(t)=g(xˆ1(t)+xˆ2(t),u(t))+ɛ(t)where(59)xˆ˙1(t)=f(xˆ1(t),u(t))(60)y1(t)=g(xˆ1(t),u(t))(61)xˆ˙2(t)=xˆ2(t)·∂f∂x(t)−G(ɛ(t))(62)y2(t)=xˆ2(t)·∂g∂x(t)+ɛ(t).Eqs. (61) and (62) can be rewritten as follows:(63)xˆ˙2(t)=xˆ2(t)·∂f∂x(t)−G(y2(t)−xˆ2(t)·∂g∂x(t))=xˆ2(t)∂f∂x(t)+G∂g∂x(t)−G(y2(t))=(AL(t)+GCL(t))xˆ2(t)+K(y2(t))(64)y2(t)=xˆ2(t)·∂g∂x(t)+ɛ(t)=CL(t)xˆ2(t)+ɛ(t)and therefore(65)xˆ˙2(t)=(AL(t)+GCL(t))xˆ2(t)−G(y2(t))(66)y2(t)=CL(t)xˆ2(t)+ɛ(t)from which it can be concluded that the observer gain must fulfill that the linear, time variant system given by Eqs. (65) and (66) is stable. Unfortunately, is not immediate to verify this property in this case (see for instance [46]) and the approximation done when the system is linearized is only valid if the sample period is short enough with respect to the system dynamics. Because of this reason, a soft computing based method, that does not depend on a linearization, is proposed in the next subsection.Let be recalled that a nonlinear model, discretized as explained in Section3.1, is being used. Without loss of generality, let be supposed that Euler's explicit discretization is chosen and expressions of f=fkno∘funk and g=gkno∘gunk have been obtained in a previous step. The observer model equations are(67)xˆk+1=xˆk+f(xˆk+1,uk+1)·ΔT−G(yk−yˆk)(68)yˆk=g(xˆk,uk).Given that funk and gunk are defined by mean of FRBS, their linearization is difficult and the separationxˆk=xˆk1+xˆk2, andyk=yk1+yk2cannot be achieved, as mentioned. In this section this issue will be given a different treatment.On the one hand, let be supposed that prior knowledge about the system state is given by a possibility distribution Π1. In case this knowledge does not exist, a vacuous distribution will be assumed, i.e. let X be the set of possible values of the state vector; the vacuous distribution is(69)Π1(A)=1siA∩X≠∅0else.This partial knowledge about the initial state is transformed by Eqs. (67) and (68). The possibility distribution modeling the posterior knowledge about the system state in period k is(70)Πk(A)=Π1({x∣xˆk(x)∈A})where, if the output variable ykcan be precisely measured,(71)xˆk(x0)=x0fork=1x∣xˆk−1+f(x,uk)·ΔT−G(yk−g(x,uk))−x=0k=2,…,H.Otherwise, if intervalsy¯kcontaining the observable outputs are known,(72)Πk(A)=Π1({x∣x¯k(x)∩A≠∅})where(73)x¯k(x0)={x0}fork=1{x∣x′+f(x,uk)·ΔT−G(y′−g(x,uk))−x=0,withx′∈x¯k−1(x0),y′∈y¯kk=2,…,H.An observer must improve the knowledge about the system state; in other words, the purpose of the observer is to increase the specificity of the posterior knowledge without affecting the predictive power of the model. Hence it is proposed to define G as the fuzzy knowledge base that fulfills the following conditions:1.The non-specificity [40] of Πkis minimized for periods k≥k0,(74)NS(k0)=∑k=k0H∫01log[1+μ({x∣πk(x)≥α})]dαwhere πk(x)=Πk({x}), μ(·) is the Lebesgue measure, μ([a, b])=b−a. In words: it is desired that the observer transforms an initial uncertainty volume into a smaller volume, after a short setting time. This condition is related to Lyapunov stability criterion: in state space, a linear stable system transforms infinitesimal spheres into ellipses of smaller volume, and the quotient between the length of the axis of the ellipses and the radius of the spheres are related to the eigenvalues of the state transition matrix of the system. In turn, the value of the setting time k0 determines the speed of convergence between estimated and actual states, and it is related to the pole placement method based on the matrix A+GC, as mentioned before.There is at least a trajectory which, being compatible with the prior knowledge about the initial state, is accurate:(75)mink=k0H{||y−g(x,uk)||∣x∈x¯k(x0),y∈y¯k,π1(x0)>0}≤ɛ.This second condition guarantees that introducing the observer does not bias the prediction of the model.The input data is a sequence of measurements{(uk,y¯k)}k=1H, where the inputs ukare known and the only information about the outputs isyk∈y¯k. Given the preceding explanations, two numerical optimization problems have to be solved:1.Obtain the two FRBSs funk and gunk that, after being combined with the parametric expressions of fkno and gkno, and a possibility distribution about the initial state of the system given by the fuzzy setX˜ini, minimize the fuzzy valueE˜(X˜ini), whose membership function is(76)E˜(X˜ini)(e)=sup{X˜ini(x)∣E¯(x)∋e},where(77)E¯(x)=oplusk=1N||y¯k⊖gkno∘gunk(xk(x),uk)||2and(78)xk(x)=xfork=1z∣xk−1(x)+fkno∘funk(z,uk)·ΔT−z=0fork>1.Obtain the observer G, using the two functions f=fkno∘funk and g=gkno∘gunk produced in the preceding step, a possibility distribution Π1 defining the knowledge about the initial state of the system, and the setting time k0. The observer is a FRBS fulfilling the following two conditions:(a)The nonspecificity that follows is maximized:(79)NS(k0)=∑k=k0H∫01log[1+μ({x∣πk(x)≥α})]dαwhere(80)Πk(A)=Π1({x∣x¯k(x)∩A≠∅})and(81)x¯k(x)={x}fork=1{z∣x′+f(x,uk)·ΔT−G(y′−g(z,uk))−z=0,withx′∈x¯k−1(x0),y′∈y¯kk=2,…,H.The minimum distance between the set of paths compatible with the knowledge about the initial state and the actual output of the system is bounded:(82)mink=k0H{||y−g(x,uk)||∣x∈x¯k(x0),y∈y¯k,π1(x0)>0}≤ɛ.The application of the proposed methodology to obtain a knowledge-based model of a Li-Ion battery is described in this section. The structure of this part is as follows: in Section4.1, experiments for producing battery data that will be used for learning and validating the different models are described. In Section4.2 a linear state-space model is obtained with the Eigensystem Realization Algorithm (ERA) and the Observer Kalman Identification (OKID) methods [37]. In Section4.3 neural networks and fuzzy models are applied to the same data. In Section4.4 the proposed methodology is used, and in Section4.5 all models are compared for four different battery technologies. Lastly, in Section4.6 the possibilistic observer is introduced and used for estimating the SOC of a battery in three charge–discharge cycles.The battery test procedure comprises a continuous series of full charge and discharge cycles. Charge takes place in two stages. The first stage is performed at constant current 0.3C (0.3 times the nominal capacity) and ends when the voltage reaches 3.6V. The second stage is performed at constant voltage and ends when the current is smaller than 0.05C. Discharges at performed at constant current. Each battery is subjected to three different tests, with discharges at 0.33C, 0.5C and C. After each charge or discharge there is an inactivity period longer than one hour, until the temperature of the battery is lower than 26∘C. In Fig. 1a graph of the cell voltage (black) and charge or discharge current (blue), during a test at 0.33C, is shown.Experiments were carried out using a multichannel Arbin BT2000 battery testing system. The cells were located in a climate chamber from the manufacturer Memmert (see Ref. [6]). Ambient temperature is 23∘C. Temperatures were measured with T-type copper-constantan thermocouples and logged by the Arbin System. All testing procedures have been developed by the Battery Research Laboratory at the University of Oviedo, following USABC recommendations [16]. The different stages of these procedures are described in the following subsections.The first task consists in identifying and weighing the battery. The Open Circuit Voltage (OCV) is measured. Other pre-test preparations include calibrating the testing system, planning and scheduling the tests.Characterization tests determine the effective capacity of the batteries. Standard charge methods use a constant current until OCV is 3.6V, and switch to constant voltage until a termination current of C/20 is obtained. Discharges at constant current are finished when a cut-off voltage of 2V is reached.The characterization sequence comprises groups of three constant current discharge cycles, at C/3, C/2 and C. The battery capacity is regarded stable when three consecutive discharges at C/3 agree within 2%. An additional C/25 charge/discharge cycle is performed after the capacity is stable.Cycling consists in continuous complete charges and discharges at different rates. Stressful or mixed cycling are possible. These protocols are maintained from 200 to 400 cycles.Lastly, reference tests comprise three cycles: charge at C – discharge at C, charge at C – discharge at C/3, charge at C/25 – discharge at C/25. Degradation during life of a battery is determined with these tests, that are also used for measuring the equivalent internal resistance, as a function of drops in voltage during discharges at C/25 and C/3. Ohm's Law is applied, assuming a pseudo-ohmic polarization of the cell below C/2. These tests are performed at regular intervals, for instance every 300 cycles.Four batteries were tested (see Fig. 2), whose characteristics are described in the following table:ManufacturerHUANYUCALB-SEHEADWAYGBS ENERGYCell referenceHYLFPx/100AhSE 100AHA40160SGBS LFMP60AHChemical compositionLiFePO4LiFePO4LiFePO4LiFeMnPO4Capacity [Ah]1001001660Testing procedures depend on the nominal capacity of the batteries. Charge and discharge currents are programmed as follows:Capacity (Ah)I charge (A)I charge cutoff (A)I discharge C/3 - C/2 - C (A)100305 for CALB33 - 50 - 1004 for Huanyu6018220 - 30 - 60164.80.85.33 - 8 -16Standard electrical models of Li-Ion batteries comprise the following parts [26] (see Fig. 3):•A series resistance R1 that models losses.A voltage source E that depends on the SOC.A device C1, comprising an ideal capacitor with a parallel resistance, whose voltage also depends on the SOC.In a first approximation, let be supposed that R2=∞ and E is constant. Let VB(t) be the cell voltage and let i(t) be the current. Since the voltage in the capacitor is(83)V(t)=1C1∫0ti(t)dt,making a numerical integration of the circuit equations,(84)VB(0)=E+i(0)R1VB(T)=E+i(T)R1+T2C1(i(1)+i(0))⋮VB(kT)=E+i(kT)R1+T2C1∑t=1k(i(tT)+i((t−1)T)).In matrix form,(85)VB(0)VB(T)⋮VB(kT)=1i(0)01i(1)T/2(i(0)+i(1))⋮1i(kT)T/2(i(0)+i(kT)+2∑t=1k−1i(tT))ER11C1or(86)VB=JER11C1thus(87)ER11C1=(JtJ)−1JtVB.This model serves as a reference for studying the nonlinearities of the problems and for comparing the different alternatives that will be proposed. In Fig. 4model predictions have been plotted in red over the actual voltage (in black) and current (blue) The green line is the estimation of the SOC Q produced by this model, Q=C1·VB.Some conclusions can be drawn from these results:•The equivalent capacity of the battery is different in charge and discharge cycles; there is a noticeable hysteresis.Least squares adjustment of the series resistance is not consistent with the SOC of the battery, because the residual charge after the last cycle is higher than the initial charge.Voltage is not constant when current is zero in an actual battery. This effect cannot be captured by this kind of model unless time-varying values for C and R were used.In the preceding section it was found that there are different nonlinearities, including hysteresis. Because of this, state-space dynamical models and artificial intelligence-based models are applied and their respective properties discussed.Linear state-space models can be identified with different techniques; Eigensystem Realization Algorithm (ERA) [37] is a well known technique that produces a realization comprising the four matrices A, B, C and D of the standard model(88)xk+1=Axk+Buk(89)yk=Cxk+Dukfrom a set of samples of the inputs and outputs of a multivariate system. In this problem, after studying the ranks of the Hankel matrices for different sampling periods, it was concluded that best results can be obtained with a sampling period of 8min and a first order system. 10 Markov parameters of the system with observer (equivalent to a Kalman filter) were obtained, and 25 Markov parameters of the system without observer were reconstructed. The validation results of this method are shown in the left part of Fig. 5.Being a linear model, the output in the absence of excitation is zero (differences between black and red lines for periods between 200 and 300). If this is compensated by biasing the data, then the gain in upper and lower parts of the curve could not be properly adjusted.The response of the model in steady state (third charge–discharge cycle) is reasonably close to the desired response, but inferior to the least squares model in the preceding section. Notwithstanding, the closed loop simulation using the observer gain G derived from the Observer Kalman Identification (OKID),(90)xˆk+1=Axˆk+Buk−Gɛk(91)yk=Cxˆk+Duk+ɛkis accurate. It is remarked that this last one is a one-step prediction (8min in the future) while open-loop simulation predicts some hours of functioning. The results of the closed loop simulation are shown in the right part of Fig. 5.A multilayer perceptron with a NARX topology (Nonlinear Auto-Regressive eXogenous inputs) has been applied for designing a nonlinear, open-loop model. For validating this and other black-box models, the model has been identified from charge–discharge cycles at C/3 and validated with C/2 and C cycles. In this case, the number of elements in the hidden layer of the neural network was determined with data from C/2 cycles and the test error is estimated from cycles at current C. The same sampling period used for ERA/OKID has been used in this case.Best models were obtained with two nodes in the hidden layer. Results are displayed in Fig. 7. The left part of this figure contains the simulation for training data, and test results are shown in the right part. Apart from the good approximation in inactivity (from period 200), these results are not significantly better than those obtained with the white box linear model fitted with least squares. However, an important improvement can be achieved with a neural network based semi-physical model. Expert knowledge about the physical properties of a battery is introduced as described in Fig. 6:Given that the initial charge of a battery is kept after a full charge–discharge cycle, the mean losses during period [0, kT] can be estimated by(92)losses=1kT∫0kTIcharge(t)dtthus the charge, estimated in t=t0 is(93)Q(t0)=(1−losses)∫0t0i(t)dt.Using this synthetic variable Q0(t) and the actual current i(t) as inputs, a non-recurrent neural network can model the evolution of the voltage VBduring charge and discharge as shown in Fig. 8. There is a good fitting in the training stage, however the model is not always stable in on the validation data, when the battery is discharged at C or C/2, as shown in the right part of Fig. 8.A TSK fuzzy model [63] used as an universal approximator has also been tested. The same configuration discussed for the neural network is applied. Fuzzy partitions and the equations of the planes in the consequents of the fuzzy rules were estimated from cycles at C/3, the granularity of the FRBS is estimated from cycles at C/2 and the model is tested with a current C. The same sampling period studied for ERA/OKID methods has been used.Results are comparable to those of the multilayer perceptron, however the model is less prone to instability, as shown in Fig. 9. In this last figure the same semi-physical configuration proposed for neural networks has been reused: the effective current is reduced by a factor derived from the charge equilibrium during three cycles.In this section, the proposed methodology for designing semi-physical fuzzy models is applied to the problem at hand. As seen in the preceding sections, the electrical model does not fit the data because of two main reasons:•The nonlinearities in the capacity are not considered: hysteresis and change of slope in the voltage curve when the battery is near full or empty.Changes in the open circuit voltage in inactivity periods are not being predicted.The semi-physical model used in the preceding section for synthesizing the SOC variable and feeding it as an additional input in neural and fuzzy black-box models will be extended. In this section, a semi-rigid tank is assumed, as explained in Fig. 10.The hysteresis in the charge/discharge cycles is modeled by means of different shapes in the tank, included in the model through a function that depends on the sign of the current through the battery in Eqs. (94) and (95):(94)dCdT=−1τC+g1(Q,sign(i))τ(95)dVdt=i−VR21C−VCdCdT(96)VB=iR1+VDifferential equation (94 indicates that the capacity of the equivalent circuit approximates, with an exponential decay with parameter τ, an unknown function g1 that relates the charge of the battery with the capacity of the equivalent circuit. In the physical analogy, g1 models the area of the tank at the water level with respect to the volume of water, when the tank is filled at a very slow rate.The second differential equation (95) relates the change in the voltage of the battery and the current through the equivalent circuit. It is remarked that the capacity is variable, thus the standard equation(97)i=CdVdTcannot be applied. Instead,(98)i=dQdT=dCVdT=CdVdT+VdCdTin words, the change of the capacity during inactivity given by Eq. (94) causes changes in the open circuit voltage of the cell because or Eq. (95).According to the proposed methodology,(99)x˙=f(x,u)=fknoθ∘funk(x,u)(100)y=g(x,u)=gknoθ∘gunk(x,u)thus(101)x=(C,V)(102)u=i(103)y=VB(104)funk(x,u)=(x1,x2,u,g1(C·V,sign(i)))(105)fkno(τ,R2)(z1,z2,z3,z4)=−z1τ+z4τ,z3z1−z2z1R2+z2τ−z2z4z1τ(106)gunk(x,u)=(x1,x2,u)(107)gkno(R1)(z1,z2,z3)=z3R1+z2This is more accurate than all models seen before (a numerical comparison is given in Section4.5). Nevertheless, there are cases (see Fig. 11) where this model is unstable, and parameters estimated for a current C/3 cannot be extrapolated to charge at current C. In this last figure, the red line (predicted voltage) follows the black curve (actual voltage). The capacitor of the equivalent circuit is drawn in pink. Observe that the approximation is good in the first charge/discharge cycle but the inaccuracies in the estimation of the SOC make that the equivalent capacity, as estimated with g1, is too low and then the estimation of the voltage is too high. This effect is corrected with the second model, described in the following paragraphs.The instability of the preceding model happens because the error in the estimation of the SOC affects the derivative of the capacity, and this value commands the derivative of the open circuit voltage when the battery is being charged or discharged at constant current. In other words, the approximation errors of funk affect the second derivative of the voltage.This undesired dependence is avoided if the voltage of the capacitor in the equivalent model follows, again with an exponential decay, a strength function that depends on the charge and the sign of the current flowing through the battery. This way, the errors in the determination of the SOC affect the first derivative of the voltage, which is less sensitive to approximation errors. The new equations are, therefore:(108)dVdT=−Vτ+g2(Q,sign(i))τ(109)dVdt=i−VR21C−VCdCdT(110)VB=iR1+Vand solving the system defined by the first two equations it is obtained that(111)dCdt=1τ−g2(Q,sign(i))τVC+1Vi−VR2thus, according to the proposed methodology,(112)x˙=f(x,u)=fknoθ∘funk(x,u)(113)y=g(x,u)=gknoθ∘gunk(x,u)and(114)x=(C,V)(115)u=i(116)y=VB(117)funk(x,u)=(x1,x2,u,g2(C·V,sign(i)))(118)fkno(τ,R2)(z1,z2,z3,z4)=−z2τ+z4τ,z3z2−1R2+z1τ−z1z4z1τ(119)gunk(x,u)=(x1,x2,u)(120)gkno(R1)(z1,z2,z3)=z3R1+z2.In Figs. 12–15results of this model, when applied to the four batteries being studied, are shown. Black and red curves are actual and predicted voltages, as before. The blue line is the charge or discharge current. The pink curve is the estimated capacity in the equivalent electrical circuit, and the green curve is the estimated SOC. In all figures, the left graphs are training results (current C/3), and the right parts contain the test results (current C). In Section4.5 it will be shown, as mentioned before, a complete numerical comparison of all models tested in this study.In Fig. 16the function g2(Q, sign(i)), modeled by means of a FRBS for the battery CALB-SE, is shown. A cycle of hysteresis has been drawn over this graph. Functions g2 of the four tested batteries are shown in Fig. 17. In these four cases, voltage does not vary too much for changes in charge except for almost full or almost empty batteries, where the slope is high, as expected.In Table 1all studied models are summarized. Mean squared errors of predictions of voltage obtained with all models are compared, for currents C/3, C/2 and C. In all cases, parameters have been learnt from tests at C/3, and open loop simulations have been carried for C/2 and C. For neural networks and fuzzy black-box models, tests at C/2 have been used for selecting the number of hidden nodes and the granularity of the rule bases.The labels in the following table have the following meanings:•Model type:–Black box and Dynamical black box: Without prior expert knowledge, difference models learnt from sampled data.Semi-physical Dynamical: Prior expert knowledge, continuous time differential equations-based model with FRBS definition of the nonlinearities.Model:–ERA-OKID: OKID identification of observer Markov parameters, ERA algorithm for obtaining a realization of the state-space equations, open loop simulation.NARX recurrent Neural Network: Multilayer perceptron with NARX topology.Neural Network V(Q): Feed forward multilayer perceptron with an estimation of the SOC as an additional synthesized input variable.NARX Recurrent Fuzzy TSK: Fuzzy TSK-rules based system with recurrent NARX configuration.Fuzzy TSK V(Q): Feed forward Fuzzy TSK-rules based system with an estimation of the SOC as synthesized input variable.Constant C: equivalent electrical model with ideal elementsFuzzy C(Q): Proposed methodology with a fuzzy model of the capacity as a function of charge C(Q).Fuzzy V(Q): Proposed methodology with a fuzzy model of the voltage as a function of charge V(Q).Error C3, Error C2, Error C: Train and tests for C/2 and C or Train, Validation and Test for C in Neural Networks and Fuzzy black-boxes.Open loop simulations of the system have been accurate because in all cases the initial state was known (Q=0). The output of the model is dramatically degraded if incorrect assumptions are made about this state. For instance, in Fig. 18a simulation has been made where the model assumes en empty battery at period 4000. The error in SOC is carried for all the simulation and consequently the predicted voltage does not match the actual values.As mentioned in Section3.3, an observer can be introduced in the model that makes the estimation of the state to converge towards the actual state on the basis of the prediction errors. Following the proposed method, a maximum-specific observer converts an uncertainty volume containing the initial estimation into the the smallest volume that can be produced while keeping the residual of the model under a bound ɛ for some point of the second volume.In Fig. 19this is demonstrated by means of an illustrative example. In the upper left part of the figure, the knowledge about the initial state is represented by a square: it is only known that the voltage of the equivalent capacitor is between 0 and 4V, and its capacity is between 0 and 40,000F. Black dots are random samples in this range. Red dots in this graph are those values where, the error in the prediction of the model is lower than 0.01V after 5 sample periods, in open loop simulation, when taken as estimations of the initial state. In the upper-center part of the same figure, the set of predicted states after 5 periods, for each random starting point in the initial uncertainty interval. The red dots are the states originated in the red positions in the left part. In the upper-right part the same set is pictured after 50 periods. Observe that the initial uncertainty volume is reduced very slowly, and this means that the dynamics of this system are highly dependent on the initial conditions.In the lower part of the same figure, the same simulation has been made with the evolving model, when the maximum-specific observer proposed in this study has been added. After 5s, the initial uncertainty volume is much reduced, and after 50s the evolution of the model for all points in the initial uncertainty volume is concentrated in a small volume, making the model less sensitive to initial conditions thus the combination of model and observer is stable. This is clearly depicted in the right part of Fig. 19, where the battery CALB-SE has been simulated starting in the same wrong initial SOC shown in the left graph. In this last case, the predicted SOC converges to the actual value after a time. This result is of great practical significance, given the automotive uses of LiFePO4 batteries, since it means that the capacity of a battery can be predicted by the model after a series of partial charges, without the need of completely charging or depleting the battery.In semi-physical fuzzy models, prior knowledge about the structure of the system is combined with universal approximators, that learn the unknown behavior of the system for certain values of the regime variable. In this study a methodology has been proposed for obtaining knowledge bases comprising fuzzy rules that are part of differential equations-based models. Crisp or interval-valued data can be used. Predictions of the model are adjusted on line, by means of a FRBS that feeds the residual of the differences to the initial model and makes the posterior knowledge about the state of the modeled system more specific.This new methodology has been applied to the dynamical modeling of LiFePO4 batteries. The obtained model explains with good accuracy the voltage while the battery is being charged, discharged or at inactivity. The closed loop simulation with an observer predicts the SOC of the battery without the need of making periodical full charges or discharges. However, the convergence between the estimation of the state and the actual values is still slow; in future works the stability margin of the observed system might be reduced for obtaining a more responsive estimator.In a different respect, the present model does not take into account the chemical changes caused by the raises of temperature during charge and discharge, neither it predicts the useful capacity of the cell as a function of the number of charge and discharge cycles. The age of the battery influences both the effective remnant charge and the OCV curve, thus the number of cycles could be incorporated as an additional input of the model. Alternatively, certain types of Evolving Fuzzy Systems [4,5,44] might be extended to produce an online interpretable model that relates the age of a cell with its electrical properties in a continuous manner. In future works, it is intended to develop an adaptive scheme that monitors the open-loop prediction error of the differential equations-based model, and includes this error as part of a vigilance term, used for adjusting the FRBS that characterizes the capacitive element. Given that the physical properties of this capacitive element are not expected to undergo large changes during normal operation, it is also expected that this adaptation can be achieved by tuning only the membership functions of the linguistic terms, leaving its KB unchanged. It is remarked, however, that this hypothesis is largely untested and must be supported by future experimentations with battery data that is unavailable at the time of writing this contribution.

@&#CONCLUSIONS@&#
