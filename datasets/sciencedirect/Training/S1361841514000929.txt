@&#MAIN-TITLE@&#
Diffeomorphic metric mapping and probabilistic atlas generation of hybrid diffusion imaging based on BFOR signal basis

@&#HIGHLIGHTS@&#
The representation of DWI signals based on orthonormal BFOR signal basis.Diffeomorphic metric mapping for Hybrid Diffusion Imaging (HYDI) in the q-space.Bayesian atlas estimation for HYDI.The explicit computation of the reorientation of the q-space in HYDI mapping.

@&#KEYPHRASES@&#
Hybrid diffusion imaging (HYDI),Large deformation diffeomorphic metric mapping (LDDMM),Bessel Fourier orientation reconstruction (BFOR) signal basis,Bayesian estimation,The white matter atlas,

@&#ABSTRACT@&#
We first propose a large deformation diffeomorphic metric mapping algorithm to align multiple b-value diffusion weighted imaging (mDWI) data, specifically acquired via hybrid diffusion imaging (HYDI). We denote this algorithm as LDDMM-HYDI. We then propose a Bayesian probabilistic model for estimating the white matter atlas from HYDIs. We adopt the work given in Hosseinbor et al. (2013) and represent the q-space diffusion signal with the Bessel Fourier orientation reconstruction (BFOR) signal basis. The BFOR framework provides the representation of mDWI in the q-space and the analytic form of the emsemble average propagator (EAP) reconstruction, as well as reduces memory requirement. In addition, since the BFOR signal basis is orthonormal, theL2norm that quantifies the differences in the q-space signals of any two mDWI datasets can be easily computed as the sum of the squared differences in the BFOR expansion coefficients. In this work, we show that the reorientation of the q-space signal due to spatial transformation can be easily defined on the BFOR signal basis. We incorporate the BFOR signal basis into the LDDMM framework and derive the gradient descent algorithm for LDDMM-HYDI with explicit orientation optimization. Additionally, we extend the previous Bayesian atlas estimation framework for scalar-valued images to HYDIs and derive the expectation–maximization algorithm for solving the HYDI atlas estimation problem. Using real HYDI datasets, we show that the Bayesian model generates the white matter atlas with anatomical details. Moreover, we show that it is important to consider the variation of mDWI reorientation due to a small change in diffeomorphic transformation in the LDDMM-HYDI optimization and to incorporate the full information of HYDI for aligning mDWI. Finally, we show that the LDDMM-HYDI outperforms the LDDMM algorithm with diffusion tensors generated from each shell of HYDI.

@&#INTRODUCTION@&#
Diffusion-weighted MRI methods are promising tools for characterizing tissue microstructure. While diffusion tensor imaging (DTI) and high angular resolution diffusion imaging (HARDI) methods are widely used methods, they do not provide a complete description of the diffusion distribution. In order to more accurately reconstruct the ensemble average propagator (EAP), a thorough the sampling of the q-space is needed, which requires multiple b-value diffusion weighted imaging (mDWI). The EAP estimation using mDWI better characterizes more complex neural fiber geometries and non-Gaussian diffusion behavior when compared to single b-value techniques (Wu and Alexander, 2007). Recently, new q-space imaging techniques, diffusion spectrum imaging (DSI) (Wedeen et al., 2005) and hybrid diffusion imaging (HYDI) (Wu and Alexander, 2007) have been developed for estimating the EAP. HYDI is a mDWI technique that samples the diffusion signal along concentric spherical shells in the q-space. The number of encoding directions increases with each shell to increase the angular resolution with the level of diffusion weighting. Originally, HYDI employed the fast Fourier transform (FFT) to reconstruct the EAP. However, the recent advent of analytical EAP reconstruction schemes, which obtain closed-form expressions of the EAP, obviate the use of the FFT in HYDI. Such reconstruction schemes include diffusion propagator imaging (DPI) (Descoteaux et al., 2011), simple harmonic oscillator based reconstruction and estimation (SHORE) (Ozarslan et al., 2008), spherical polar Fourier imaging (SPFI) (Cheng et al., 2010; Assemlal et al., 2009). One recent technique successfully validated on HYDI datasets is Bessel Fourier orientation reconstruction (BFOR) (Hosseinbor et al., 2013). While mDWI techniques like HYDI have not been widely used, the new human connectome project (Essen et al., 2013) and spin-off projects will likely significantly increase the application. However, there is a lack of fundamental image analysis tools for mDWI and EAP maps, such as registration and atlas generation, that can fully utilize their information.In the last decades, researchers have spent great efforts on developing registration algorithms to align diffusion tensors derived from DTI and orientation distribution functions (ODFs) derived from HARDI (e.g., Alexander et al. (2001), Raffelt et al. (2011), Du et al. (2012)). However, registration algorithms directly based on DWIs are few. The direct alignment of DWIs in the q-space utilizes the full diffusion information, is independent of the choice of diffusion models and their reconstruction algorithms (e.g., tensor), and unifies the transformation to align the local diffusion profiles defined at each voxel of two brains (Dhollander et al., 2010; Yap and Shen, 2012; Zhang et al., 2012). Dhollander et al. (2010) developed an algorithm that transforms the diffusion signals on a single shell of the q-space and preserves anisotropic as well as isotropic volume fractions. Yap and Shen (2012) proposed to decompose the diffusion signals on a single shell of the q-space into a series of weighted diffusion basis functions, reorient these functions independently based on a local affine transformation, and then recompose the reoriented functions to obtain the final transformed diffusion signals. This approach provides the representation of the diffusion signals and also explicitly models the isotropic component of the diffusion signals to avoid undesirable artifacts during the local affine transformation. Zhang et al. (2012) developed a diffeomorphic registration algorithm for aligning diffusion signals on a single shell of the q-space.Only recently, Dhollander et al. (2011) aligned DWIs on multiple shells of the q-space by first estimating transformation using a multi-channel diffeomorphic mapping algorithm, in which generalized fractional anisotrophy (GFA) images computed from each shell were used as mapping objects, and then applying the transformation to DWIs on each shell using the DWI reorientation method given in Dhollander et al. (2010). This approach neglected possible influences of the DWI reorientation on the optimization of the spatial transformation. Hsu et al. (2012) generalized the large deformation diffeomorphic metric image mapping algorithm (Beg et al., 2005) to DWIs on multiple shells of the q-space and considered the image domain and the q-space as the domain where the diffeomorphic transformation is applied to. The authors claimed that the reorientation of DWIs is no longer needed because the transformation also incorporates the deformation due to the shape differences in the diffusion profiles in the q-space. It is a robust registration approach with the explicit consideration of the large deformation in both the image domain and q-space. However, its computational complexity and memory requirement are high.While limited research has been done for aligning the HYDI images, efforts on the white matter atlas from HYDI is even less. Only recently, Dhollander et al. (2011) employed their multi-channel diffeomorphic matching algorithm to generate the atlas from multiple HYDI datasets. To our best knowledge, there is no probabilistic atlas generation approach for HYDI.In this paper, we propose a large deformation diffeomorphic metric mapping (LDDMM) algorithm to align HYDI datasets, denoted as LDDMM-HYDI, and then develop a Bayesian probabilistic estimation framework for generating the HYDI atlas. In particular, we adopt the Bessel Fourier orientation reconstruction (BFOR) framework in representing the q-space signal (Hosseinbor et al., 2013). Unlike the diffeomorphic mapping of mDWIs in Hsu et al. (2012), the BFOR signal basis provides the representation of the q-space signal and the analytic form of the EAP reconstruction, as well as reduces memory requirement. In addition, since the BFOR signal basis is orthonormal, theL2norm that quantifies the differences in the q-space signals can be easily computed as the sum of the squared differences in the BFOR expansion coefficients. In this work, we will show that the reorientation of the q-space signal due to spatial transformation can be easily defined on the BFOR signal basis. Unlike the work in Dhollander et al. (2011), we will incorporate the BFOR signal basis into the LDDMM framework and derive the gradient descent algorithm for solving the LDDMM-HYDI variational problem with explicit orientation optimization. Even though the LDDMM-HYDI algorithm is largely based on our previous work (Du et al., 2013), in this paper we further develop a Bayesian probabilistic model to estimate the brain white matter atlas from the q-space. This probabilistic model is the extension of the previous Bayesian atlas estimation for scalar-based intensity images (Ma et al., 2008). With the aids of the BFOR representation and reorientation of mDWIs introduced in this work, we show that it is feasible to adopt the previous Bayesian atlas estimation model for scalar-valued images (Ma et al., 2008) to HYDI. Nevertheless, the HYDI data has much higher dimensionality than the scalar image used in Ma et al. (2008). Moreover, the HYDI alignment requires the reorientation of the diffusion signals, while the scalar image alignment does not. Hence, we show that the extension of the Bayesian scalar image atlas generation in (Ma et al., 2008) to the HYDI data is not straightforward. In this paper, we thus reformulate the Bayesian atlas generation model for HYDI under the LDDMM framework and derive the expectation–maximization algorithm to optimize the HYDI atlas based on a set of HYDI data. As shown below, the main contributions of this paper are:1.to seek large deformation for aligning HYDI datasets based on the BFOR representation of mDWI.to derive the rotation-based reorientation of the q-space signal via the BFOR signal basis. This is equivalent to applying Wigner matrix to the BFOR expansion coefficients, where Wigner matrix can be easily constructed by the rotation matrix (see Section 3.1).to derive the gradient descent algorithm for the LDDMM-HYDI variational problem with the explicit orientation optimization. In particular, we provide a computationally efficient method for calculating the variation of Wigner matrix due to the small variation of the diffeomorphic transformation (see Section 3.4).to show that the LDDMM-HYDI gradient descent algorithm does not involve the calculation of the BFOR signal bases and hence avoids the discretization in the q-space.to propose a Bayesian estimation model for the q-space signals represented via the BFOR signal basis and derive an expectation–maximization algorithm for solving it (see Section 4).to validate the mapping accuracy of the LDDMM-HYDI algorithm and compare our approach with the LDDMM algorithm incorporating multiple diffusion tensors derived from each shell of the q-space. This has not been shown in our previous work (Du et al., 2013).In this paper, we employ the BFOR signal basis to represent the q-space diffusion signal according to the work in Hosseinbor et al. (2013). The diffusion signal is assumed to satisfy Laplace’s equation. The BFOR basis is derived based on the heat equation, a generalization of Laplace’s equation and hence naturally incorporates water diffusion processes. In addition, the BFOR signal basis is orthonormal, which leads to the simple computation on the norm of the diffusion signals as shown below. Furthermore, the BFOR signal basis gives the analytic solution for the EAP as shown in Hosseinbor et al. (2013), which facilitates the registration of the EAP data via aligning the BFOR coefficients defined in the q-space. In the BFOR framework, the q-space diffusion signal,S(x,q), can be represented as(1)S(x,q)=∑n=1Nb∑j=1NYcnj(x)Ψnj(q),wherexandqrespectively denote the image domain and q-space.Ψnj(q)is the nj-th BFOR signal basis with its corresponding coefficient,cnj(x), atx.Ψnj(q)is given as(2)Ψnj(q)=2αnl(j)πτ3Jl(j)+3/2(αnl(j))jl(j)αnl(j)|q|τYjq|q|.Here,αnlis the nth root of the lth order spherical Bessel (SB) function of the first kindjl, then the eigenvalues are found to be-λnl=-αnl2τ2.τis the radial distance in q-space at which the Bessel function goes to zero. Note that forl=0, the roots are simplyαn0=nπ.Yjare the modified real and symmetric spherical harmonics (SH) bases as given in Descoteaux et al. (2006).Jl(j)+3/2(·)is the Bessel function of the first kind.NY=(L+1)(L+2)2is the number of terms in the modified SH bases of truncation order L, whileNbis the truncation order of radial basis.Using the fact that the BFOR signal basis is orthonormal, theL2-norm ofS(x,q)can be easily written as(3)‖S(x,q)‖2=∫x∈R3∫q∈R3S2(x,q)dqdx=∫x∈R3∑n=1Nb∑j=1NYcnj(x)2dx.We now discuss the reorientation ofS(x,q)when a rotation transformation, R, is applied. We assume that the diffusion profile in each shell of the q-space remains in the same shell after the reorientation. However, its angular profile in each shell of the q-space is transformed according to the rotation transformation. Hence, we defineRS(x,q)=S(x,R-1q).In order to characterizeRS(x,q)based on the BFOR signal basis given in Eq. (1), we separate the angular and radial coordinates such thatRS(x,q)=Sx,|q|R-1q|q|.Hence, we haveRS(x,q)=∑n=1Nb∑j=1NYcnj(x)2αnl(j)πτ3Jl(j)+3/2(αnl(j))jl(j)αnl(j)|q|τYjR-1q|q|.This indicates that the rotation reorientation of mDWI is equivalent to applying the rotation transformation to the real spherical harmonics,Yj. According to the work in Geng et al. (2011) and Edmonds (1996), the rotation ofYjcan be achieved by the rotation of their corresponding coefficients, yielding(4)RS(x,q)=∑n=1Nb∑j=1NY∑j′=1NYMjj′cnj′(x)2αnl(j)πτ3Jl(j)+3/2(αnl(j))jl(j)αnl(j)|q|τYjq|q|,whereMjj′is thejj′th element of Wigner matrixM(R)constructed based on R (see details in Geng et al. (2011) and Edmonds (1996)). We can see that the same Wigner matrix is applied tocnjat a fixed n. For the sake of simplicity, we rewrite Eq. (4) in the matrix form, i.e.,(5)RS(x,q)=(M(R)c(x))⊤Ψ(q),whereMis a sparse matrix withNbdiagonal blocks ofM(R).cis a vector that concatenates coefficientscnj′in the order such thatcnj′corresponds toM(R)at a fixed n.Ψ(q)concatenates the BFOR signal basis.We define an action of diffeomorphismsϕ:Ω→ΩonS(x,q), which takes into consideration of the reorientation in the q-space as well as the transformation of the spatial volume inΩ. Based on the rotation reorientation ofS(x,q)in Eq. (5), for a given spatial locationx, the action ofϕonS(x,q)can be defined asϕ·S(x,q)=Sϕ-1(x),Rϕ-1(x)-1q=MRϕ-1(x)cϕ-1(x)⊤Ψ(q),whereRxcan be defined in a way similar to the finite strain scheme used in DTI registration (Alexander et al., 2001). That is,Rx=DxϕDx⊤ϕ-12Dxϕ, whereDxϕis the Jacobian matrix ofϕatx. For the remainder of this paper, we denote this as(6)ϕ·S(x,q)=M(Rx)c⊤∘ϕ-1(x)Ψ(q),where∘indicates as the composition of diffeomorphisms.Based on the BFOR representation ofS(x,q)and the diffeomorphic group action onS(x,q), we now state a variational problem for mapping HYDIs from one subject to another. We define this problem in the “large deformation” setting of Grenander’s group action approach for modeling the white matter anatomy, that is, the HYDI data are modeled by assuming that they can be generated from one to another via flows of diffeomorphisms,ϕt, which are the solutions of ordinary differential equations,ϕ̇t=vt(ϕt),t∈[0,1], starting from the identity mapϕ0=Id. They are therefore characterized by time-dependent velocity vector fieldsvt,t∈[0,1]. We define a metric distance between a HYDI volume of a subject,S(s), and an atlas HYDI volume,Satlas, as the minimal length of curvesϕt·Satlas,t∈[0,1], in a shape space such that, at timet=1,ϕ1·Satlas=S(s). Lengths of such curves are computed as the integrated norm‖vt‖Vof the vector field generating the transformation, wherevt∈Vand V is a reproducing kernel Hilbert space with kernelkVand norm‖·‖V. To ensure solutions are diffeomorphic, V must be a space of smooth vector fields. Using the duality isometry in Hilbert spaces, one can equivalently express the lengths in terms ofmt, interpreted as momentum, such that for eachu∈V,〈mt,u∘ϕt〉2=〈kV-1vt,u〉2,where we let〈m,u〉2denote theL2inner product between m and u, but also, with a slight abuse, the result of the natural pairing between m and v in cases where m is singular (e.g., a measure). This identity is classically written asϕt∗mt=kV-1vt, whereϕt∗is referred to as the pullback operation on a vector measure,mt. Using the identity‖vt‖V2=〈kV-1vt,vt〉2=〈mt,kVmt〉2and the standard fact that energy-minimizing curves coincide with constant-speed length-minimizing curves, one can obtain the metric distance between the atlas and target volumes by minimizing∫01〈mt,kVmt〉2dtsuch thatϕ1·Satlas≈S(s)att=1. We associate this with a variational problem in the form of(7)J(mt)=infmt:ϕ̇t=kVmt(ϕt),ϕ0=Id∫01〈mt,kVmt〉2dt+λE(ϕ1·Satlas,S(s)),whereλis a positive scalar. E quantifies the difference between the deformed atlasϕ1·Satlasand the subjectS(s). Based on Eqs. (3) and (6), E is expressed in the form of(8)E=∫x∈ΩM(Rx)catlas∘ϕ-1(x)-c(s)(x)22dx.We now solve the optimization problem in Eq. (7) via a gradient descent method. The gradient of J with respect tomtcan be computed via studying a variationmt∊=mt+∊m∼ton J such that the derivative of J with respect to∊is expressed in function ofm∼t. According to the general LDDMM framework derived in Du et al. (2011), we directly give the expression of the gradient of J with respect tomtas(9)∇J(mt)=2mt+ληt,where(10)ηt=∇ϕ1E+∫t1[∂ϕs(kVms)]⊤(ηs+ms)ds.Eq. (10) can be solved backward givenη1=∇ϕ1E.∂ϕs(kVms)is the partial derivative ofkVmswith respect toϕs.In the following, we discuss the computation of∇ϕ1E. We consider a variation ofϕ1asϕ1∊=ϕ1+∊hand denote the corresponding variation inM(Rx)asM(Rx∊). Denotecˆ(x)=M(Rx)catlas(x)for the simplicity of notation. We have(11)∂E∂∊∊=0=∫x∈Ω∂(M(Rx∊)catlas)∘(ϕ1∊)-1(x)-c(s)(x)22∂∊∊=0dx=2∫x∈Ωcˆ∘ϕ1-1(x)-c(s)(x),∇x⊤cˆ∘ϕ1-1(x)∂(ϕ1∊)-1∂∊∊=0dx︸term(A)+2∫x∈Ωcˆ∘ϕ1-1(x)-c(s)(x),∂M(Rx∊)catlas∂∊∊=0∘ϕ1-1(x)dx︸term(B).The calculation of Term (A) is straightforward. We have∂ϕ1∊-1∂∊∊=0=-(Dxϕ1)-1h∘ϕ1-1derived from the fact ofϕ1∊∘(ϕ1∊)-1=Id. Applying the strategy of the change of variable,y=ϕ1-1(x), we haveTerm(A)=-2∫y∈Ωcˆ(y)-c(s)∘ϕ1(y),∇y⊤cˆ(y)(Dyϕ1)-1hdetDyϕ1dyHence,(12)Term(A)=-2∫x∈ΩDxϕ1-⊤∇xcˆ(x)cˆ(x)-c(s)∘ϕ1(x)detDxϕ1,hdx.This is similar to that in the scalar image mapping case. It seeks the optimal spatial transformationϕtin the gradient direction of imagecˆ(x)weighted by the difference between the atlas and subject’s images.The computation of Term (B) involves the derivative ofM(Rx)with respect to a rotation matrix,Rx, and the variation ofRx∊with respect to the small variation ofϕ1∊. Let’s first compute the derivative ofM(Rx)with respect toRx. According to the work in Cetingul et al. (2012), the analytical form of this derivative can be solved using the Euler angle representation ofRxbut is relatively complex. Here, we consider Wigner matrixM(Rx)and the coefficients of the BFOR signal basiscatlas(x)together, which leads to a simple numeric approach for computing the derivative ofcˆ(x)=M(Rx)catlas(x)with respect toRx, i.e.,∇Rxcˆ(x). AssumeR∼x=eδUR, whereδU=0-δμ3δμ2δμ30-δμ1-δμ2δμ10is a skew-symmetric matrix parameterized byδμ=δμ1δμ2δμ3⊤. From this construction,δUis the tangent vector atRxon the manifold of rotation matrices andR∼xis also a rotation matrix. Based on the Taylor expansion, we have the first order approximation ofM(R∼x)catlas(x)asM(R∼x)catlas(x)≈cˆ(x)+∇Rx⊤cˆ(x)δμ.We can compute∇Rxcˆ(x)as follows. AssumeδU1,δU2,δU3to be skew-symmetric matrices respectively constructed from[δμ1,0,0]⊤,[0,δμ2,0]⊤,[0,0,δμ3]⊤. We have(13)∇Rxcˆ(x)≈M(eδU1Rx)catlas(x)-cˆ(x)⊤/δμ1M(eδU2Rx)catlas(x)-cˆ(x)⊤/δμ2M(eδU3Rx)catlas(x)-cˆ(x)⊤/δμ3.We now compute the variation ofRx∊with respect to the small variation ofϕ1∊. This has been referred as exact finite-strain differential that was solved in Dorst (2005) and applied to the DTI tensor-based registration in Yeo et al. (2009). Here, we directly adopt the result from Yeo et al. (2009) and obtain(14)∂Rx∊∂∊∊=0=-Fx∑i=13ri×(Dxh⊤)i,whereFx=-Rx⊤trace(Dxϕ1Dx⊤ϕ1)1/2Id-(Dxϕ1Dx⊤ϕ1)1/2-1Rx.×denotes as the cross product of two vectors.(A)idenotes the ith column of matrix A.ri=(Rx⊤)i.Given Eqs. (13) and (14), we thus have(15)Term(B)=-2∫x∈Ωcˆ∘ϕ1-1(x)-c(s)(x),∇Rxcˆ⊤Fx∑i=13ri×(Dxh⊤)i∘ϕ1-1dx=-2∫x∈Ωωx⊤∑i=13ri×(Dxh⊤)idx=-2∫x∈Ω∑i=13ωx×ri,∇xhidx,where(16)ωx⊤=∇Rxcˆ(x)cˆx-c(s)∘ϕ1(x)⊤FxdetDxϕ1,andh=h1h2h3⊤.Dxhis approximated asDxh=∇xh1⊤∇xh2⊤∇xh3⊤≈12Δdh1,xX+-h1,xX-h1,xY+-h1,xY-h1,xZ+-h1,xZ-h2,xX+-h1,xX-h2,xY+-h2,xY-h2,xZ+-h2,xZ-h3,xX+-h3,xX-h3,xY+-h3,xY-h3,xZ+-h3,xZ-,where{xX+,xX-,xY+,xY+,xZ+,xZ-}are the neighbors ofxinx,y,zdirections, respectively.Δdis the distance of these neighbors tox. Here, term (B) seeks the spatial transformationϕtsuch that the local diffusion profiles of the atlas and subject’s HYDIs have to be aligned.In summary, we have(17)∂E∂∊∊=0≈-2∫x∈ΩDxϕ1-⊤∇xcˆ(x)cˆ(x)-c(s)∘ϕ1(x)detDxϕ1,hdx-1Δd∫x∈Ω∑k=13ωx×rk,hk,xX+hk,xY+hk,xZ+-ωx×rk,hk,xX-hk,xY-hk,xZ-dx.Therefore,∇ϕ1Ecan be obtained from Eq. (17).We so far derive J and its gradient∇J(mt)in the continuous setting. In this section, we elaborate the numerical implementation of our algorithm under the discrete setting. Since HYDI DW signals were represented using the orthonormal BFOR signal bases, both the computation of J in Eq. (7) and the gradient computation in Eq. (17) do not explicitly involve the calculationΨ(q). Hence, we do not need to discretize the q-space. In the discretization of the image domain, we first represent the ambient space,Ω, using a finite number of points on the image grid,Ω≅{(xi)i=1N}. In this setting, we can assumemtto be the sum of Dirac measures, whereαi(t)is the momentum vector atxiand time t. We use a conjugate gradient routine to perform the minimization of J with respect toαi(t). We summarize steps required in each iteration during the minimization process below:1.Use the forward Euler method to compute the diffeomorphic trajectory based on the flow equation:(18)dϕt(xi)dt=∑j=1NkV(ϕt(xi),ϕt(xj))αj(t).That is,ϕt+1(xi)=ϕt(xi)+dt∑j=1NkV(ϕt(xi),ϕt(xj))αj(t),where dt is the step size.Compute∇ϕ1(xi)Ebased on Eq. (17).Solveηt=[ηi(t)]i=1Nin Eq. (10) using the backward Euler integration, where i indicesxi, with the initial conditionηi(1)=∇ϕ1(xi)E. Hence, numerically,ηt=ηt+1+∂ϕt+1(kVmt+1)⊤(ηt+1+mt+1)dt,where dt is the step size.Compute gradient∇J(αi(t))=2αi(t)+ηi(t).Evaluate J whenαi(t)=αiold(t)-∊∇J(αi(t)), where∊is the adaptive step size determined by a golden section search.In the above LDDMM-HYDI algorithm, we assume that the atlas,Satlas, is known. In this section, we introduce a HYDI atlas estimation approach based on Bayesian decision theory. Given n observed HYDI datasets,S(i)fori=1,…,n, we assume that each of them can be estimated through an unknown atlasSatlasand a diffeomorphic transformationϕ(i)such that(19)S(i)≈Sˆ(i)=ϕ(i)·Satlas.The variation ofS(i)relative toSˆ(i)is then denoted byσ2. The goal here is to estimate the unknown atlas,Satlas, and the variation,σ2. To solve this problem, we first introduce an ancillary “hyperatlas”S0, and assume that our atlas is generated from it via a diffeomorphic transformation ofϕsuch thatSatlas=ϕ·S0. The use of the hyperatlas guarantees the estimated atlas in the orbit of the hyperatlas. We use the Bayesian strategy to estimateϕandσ2from the set of observationsS(i),i=1,…,nby computing the maximum a posteriori (MAP) offσ(ϕ|S(1),S(2),…,S(n),S0). This can be achieved using the Expectation–Maximization algorithm by first computing the log-likelihood of the complete data (ϕ,ϕ(i),S(i),i=1,2,…,n) whenϕ(1),⋯,ϕ(n)are introduced as hidden variables. We denote this likelihood asfσ(ϕ,ϕ(1),…,ϕ(n),S(1),…S(n)|S0). We consider that the paired information of individual observations,(S(i),ϕ(i))fori=1,…,n, as independent and identically distributed. As a result, this log-likelihood can be written as(20)logfσ(ϕ,ϕ(1),…,ϕ(n),S(1),…S(n)|S0)=logf(ϕ|S0)+∑i=1nlogf(ϕ(i)|ϕ,S0)+logfσ(S(i)|ϕ(i),ϕ,S0),wheref(ϕ|S0)is the shape prior (probability distribution) of the atlas given the hyperatlas,S0.f(ϕ(i)|ϕ,S0)is the distribution of random diffeomorphisms given the estimated atlas (ϕ·S0).fσ(S(i)|ϕ(i),ϕ,S0)is the conditional likelihood of the HYDI data given its corresponding hidden variableϕ(i)and the estimated atlas (ϕ·S0). In the remainder of this section, we first adoptf(ϕ|S0)andf(ϕ(i)|ϕ,S0)introduced in Ma et al. (2008) and Qiu et al. (2010) under the framework of LDDMM and then describe how to calculatefσ(S(i)|ϕ(i),ϕ,S0)in Section 4.2 based on the BFOR representation of HYDI.We adopt the previous work in Ma et al. (2008) and Qiu et al. (2010) and briefly describe the construction of the shape prior (probability distribution) of the atlas,f(ϕ|S0). Under the LDDMM framework, we can compute the priorf(ϕ|S0)viam0, i.e.,(21)f(ϕ|S0)=f(m0|S0),wherem0is initial momentum defined in the coordinates ofS0such that it uniquely determines diffeomorphic geodesic flows fromS0to the estimated atlas. WhenS0remains fixed, the space of the initial momentumm0provides a linear representation of the nonlinear diffeomorphic shape space in which linear statistical analysis can be applied. Hence, assumingm0is random, we immediately obtain a stochastic model for diffeomorphic transformations ofS0. More precisely, we follow the work in Ma et al. (2008) and Qiu et al. (2010) and assumem0to be a centered Gaussian random field (GRF) model. The distribution ofm0is characterized by its covariance bilinear form, defined byΓm0(v,w)=E[m0(v)m0(w)],wherev,ware vector fields in the Hilbert space of V with reproducing kernelkV.We associateΓm0withkV-1. The “prior” ofm0in this case is then1Zexp-12〈m0,kVm0〉2,whereZis the normalizing Gaussian constant. This leads to formally define the “log-prior” ofm0to be(22)logf(m0|S0)≈-12〈m0,kVm0〉2,where we ignore the normalizing constant termlogZ.We can construct the distribution of random diffeomorphisms,f(ϕ(i)|ϕ,S0), in the similar manner. We definef(ϕ(i)|ϕ,S0)via the corresponding initial momentumm0(i)defined in the coordinates ofϕ·S0. We also assume thatm0(i)is random, and therefore, we again obtain a stochastic model for diffeomorphic transformations ofSatlas≅ϕ·S0.m0(i)is assumed to be a centered GRF model with its covariance askVπ, wherekVπis the reproducing kernel of the smooth vector field in a Hilbert space V. Hence, we can define the log distribution of random diffeomorphisms as(23)logf(ϕ(i)|ϕ,S0)≈-12〈m0(i),kVπm0(i)〉2.where as before, we ignore the normalizing constant termlogZ.Given the representation of the diffusion signals in the q-space using the BFOR signal bases, we construct the conditional likelihood of the HYDI data,fσ(S(i)|ϕ(i),ϕ,S0), via the BFOR coefficients. We assume thatcnj(x)has a multivariate Gaussian distribution with mean ofcatlas(x)and covarianceσ2Id, wherecatlas(x)are the BFOR coefficients associated withSatlasandIdis the identity matrix.From the Gaussian assumption, we can thus write the conditional “log-likelihood” ofS(i)givenSatlasandϕ1(i)as(24)logfσ(S(i)|ϕ1(i),ϕ1,S0)≈∫x∈Ω-12σ2M(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2-logσ22dx,where as before, we ignore the normalizing Gaussian term.In this section, we employ the Expectation–Maximization algorithm to estimateσ2and the atlas,Satlas(x,q), forq∈R3,x∈Ω. From the above discussion, we first rewrite the log-likelihood function of the complete data in Eq. (20) as(25)logfσ(m0,m0(1),…,m0(n),S(1),…S(n)|S0)≈-12〈m0,kVm0〉2-∑i=1n12〈m0(i),kVπm0(i)〉2+∫x∈Ω12σ2M(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2+logσ22dx,wherecatlas(x)=M(Rx)c0∘ϕ1-1(x)computed based on Eq. (6).c0is the BFOR coefficients of the hyperatlas andϕ1is the diffeomorphic transformation from the hyperatlas to the estimated atlas.The E-Step. The E-step computes the expectation of the complete data log-likelihood given the previous atlasm0oldand varianceσ2old. We denote this expectation asQ(m0,σ2|m0old,σ2old)given in the equation below,(26)Qm0,σ2|m0old,σ2old=Elogfσ(m0,m0(1),…,m0(n),S(1),…S(n)|S0)|m0old,σ2old,S(1),⋯,S(n),S0≈-12〈m0,kVm0〉2-∑i=1nE12〈m0(i),kVπm0(i)〉2+∫x∈Ω12σ2M(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2+logσ22dx.The M-Step. The M-step generates the new atlas by maximizing the Q-function with respect tom0andσ2. The update equation is given as(27)m0new,σ2new=argmaxm0,σ2Qm0,σ2|m0old,σ2old=argminm0,σ2〈m0,kVm0〉2+∑i=1nE∫x∈Ω1σ2M(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2+logσ2dx,where we use the fact that the conditional expectation of〈m0(i),kVπm0(i)〉2is constant. We solveσ2andm0by separating the procedure for updatingσ2using the current value ofm0, and then optimizingm0using the updated value ofσ2.We now derive how to update values ofσ2andm0from theQ-function in Eq. (27). It is straightforward to obtainσ2by taking the derivative ofQm0,σ2|m0old,σ2oldwith respect toσ2and setting it to zero (see Appendix A). Hence, we have(28)σ2new=1n1nv∑i=1n∫x∈ΩM(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2dx,wherenvis the number of voxels inΩ.For updatingm0, lety=ϕ1(i)-1(x)and|Dϕ1(i)|be the Jacobian determinant ofϕ1(i). Using the change of variables strategy, we have(29)∑i=1nE∫x∈Ω12σ2M(Rx)catlas∘(ϕ1(i))-1(x)-c(i)(x)2dx=∑i=1nE∫y∈Ω12σ2catlas(y)-M(Ry)c(i)∘ϕ1(i)(y)2|Dϕ1(i)(y)|dyWe now introducec‾0(y)and assume(30)c‾0(y)=1∑j=1n|Dϕ1(j)(y)|∑i=1n|Dϕ1(i)(y)|M(Ry)c(i)∘ϕ1(i)(y),Hence, Eq. (29) can be computed as∫y∈Ω12σ2∑i=1nEcatlas(y)-c‾0(y)+c‾0(y)-M(Ry)c(i)∘ϕ1(i)(y)2dy=∫y∈Ω12σ2∑i=1nEcatlas(y)-c‾0(y)2+c‾0(y)-M(Ry)c(i)∘ϕ1(i)(y)2+2catlas(y)-c‾0(y),c‾0(y)-M(Ry)c(i)∘ϕ1(i)(y)|Dϕ1(i)(y)|dy.Sincec‾0(y)andM(Ry)c(i)∘ϕ1(i)(y)are only dependent onϕ1(i)and∑i=1n|Dϕ1(i)(y)|c‾0(y)-M(Ry)c(i)∘ϕ1(i)(y)=0, we have(31)m0new=argminm012〈m0,kVm0〉2+12σ2new∫y∈Ωα(y)‖catlas(y)-c‾0(y)‖2+∑i=1n‖c‾0(y)-M(Ry)c(i)∘ϕ1(i)(y)‖2|Dϕ1(i)(y)|dy,whereα(y)=∑i=1n|Dϕ1(i)(y)|. Since the last term in Eq. (31) is not related tom0, we havem0new=argminm012〈m0,kVm0〉2+12σ2new∫y∈Ωα(y)‖catlas(y)-c‾0(y)‖2dy.Herecatlas(y)=(M(Ry)c0)∘ϕ1-1(y), wherec0corresponds to the BFOR coefficients of the hyperatlas. We finally have(32)m0new=argminm012〈m0,kVm0〉2+12σ2new∫y∈Ωα(y)‖(M(Ry)c0)∘ϕ1-1(y)-c‾0(y)‖2dy.The variational problem listed in Eq. (32) is referred as “modified LDDMM-HYDI mapping”, where weightαis introduced. It can be easily solved by adopting the LDDMM-HYDI algorithm in Section 3. We present the steps involved in the EM optimization in Algorithm 1.Algorithm 1(The EM Algorithm for the HYDI Atlas Generation)We initializem0=0. Thus, the hyperatlasS0is considered as the initial atlas. In our case, we randomly select a subject’s HYDI dataset asS0.1. Apply the LDDMM-HYDI mapping algorithm in Section 3 to register the current atlas to individual HYDI datasets, which yieldm0(i)andϕt(i).2. Computec‾0according to Eq. (30).3. Updateσ2according to Eq. (28).4. EstimateSatlas=ϕ1·S0, whereϕtis found by applying the modified LDDMM-HYDI mapping algorithm as given in Eq. (32).The above computation is repeated until the atlas converges.

@&#CONCLUSIONS@&#
