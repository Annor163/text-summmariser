@&#MAIN-TITLE@&#
Spherical volume-preserving Demons registration

@&#HIGHLIGHTS@&#
We introduce a volume-preserving registration framework for brain shift analysis.A volume-preserving mapping is supported by a rigorous continuous theory.The registration is performed on spherical tetrahedron mesh with MRI gray value.The registration can retain the equality of local volume elements.Our method can register the brain efficiently while preserving the volume.

@&#KEYPHRASES@&#
Registration,Brain image,Tetrahedral mesh,Volume-preserving parameterization,

@&#ABSTRACT@&#
In order to analyze the brain shift situation accurately, we need to register the medical image and analyze its deformation. In this paper, we introduce a framework with volume-preserving registration for brain shift analysis. First, a volume-preserving mapping is introduced for general manifolds supported by a rigorous continuous theory. The registration is then performed on the spherical tetrahedron mesh with MRI gray values. The registration can retain the equality of local volume elements while registering the manifold to a template at the same time. We use simulated brain shift data to test our method. The results show that our method can efficiently register the brain while preserving the volume of each vertex.

@&#INTRODUCTION@&#
At present, the increasing use of image-guided surgery systems for neurosurgery has brought to prominence of the problem regarding brain shift, including the deformation of the brain after craniotomy and tumor resection. This phenomenon is caused by various interacting factors such as the characteristics of tissue, the swelling of brain structures, a deformation following gravity, and so on  [1]. Most of the deformation can be considered as a volume-preserving deformation. In consequence, the correspondence of structures identified between the pre-operative image data and the real-time imaging data of the patient’s brain becomes incorrect during the operation. Therefore, the location and the extent of structures are misinterpreted when mapping pre-operative findings into real-time images. Thus, it is of great importance to register and align these images. This topic has recently led to considerable interest in the solid and physics-based modeling as well as medical image analysis communities  [2].In order to analyze medical image data, a complicated geometric structure from the image data is desired to be mapped onto a canonical domain. Instead of working on the complicated geometry directly, all the operations can be defined on a simpler domain, such as planes and structured grid volumes. The mapping will help improving the efficiency of the data processing. In general, a manifold cannot be mapped to another domain without any distortions. Thus, different mapping methods focus on preserving certain local geometries like angle  [3,4] or area  [5,6]. To date, more and more volumetric measurements are derived from a rich line of multimodal imaging, e.g. neuronal density, activation extent, thickness, etc., so that volume-preserving mapping becomes increasingly important. In 2D domain, to prevent severe geometric stretches, the original model can be decomposed into many charts which are topologically equal to an open disk to make interior Gaussian curvature closed to zero  [7]. Even distribution of intrinsic distortions  [5,7] are studied to achieve uniformity metrics mapping. Based on the singular values of the Jacobian matrix, Sander  [5] optimized the parametric location of each vertex within its 1-ring neighborhood to reduce local stretches. Sorkine et al.’s bounded-distortion mapping  [7] made heavy use of mesh cuts to keep distortions below some preset threshold. They considered 2D area distortion with an energy term. The purpose is to minimize the 2D area distortion. No conclusion is drawn whether an absolute area-preserving patch mapping can be practically achieved. Desbrun et al.  [8] also focused on minimizing area distortion for the intrinsic mapping of triangle meshes. In their work, an intuitive area-preserving functional was devised. Zhao  [9] presents a novel area-preserving flattening method using the optimal mass transport technique based on Monge–Brenier theory. Zou  [6] proposed a theoretical authalic mapping based on the differential forms on 2D manifold by flowing under a Lie advection of area. The aforementioned methods are for 2D general surfaces so far. There also exist many harmonic volumetric mapping techniques among objects  [10].Image registration is the process of finding the optimal transformation that aligns different imaging data into spatial correspondence. As a result, the same anatomic structures occupy the same spatial locations in different images  [11]. It is the building block for a variety of medical image analysis tasks, such as motion correction, multi-modality information fusion, atlas-based image segmentation, population-based studies, longitudinal studies, computational anatomy and image-guided surgery  [12]. Since most brain shift deformations can be treated as a volume-preserving deformation based on their physical properties, registration with preserving volumetric properties can capture more information of brain deformation, hence achieving a higher accuracy in terms of volume-preserving alignment. However, general manifold volume-preserving mapping with registration was seldom discussed within those mapping methods.In this paper, we introduce a framework for a volume-preserving registration method based on volume-preserving parameterization. First, a volume-preserving mapping is introduced for general manifolds supported by a rigorous continuous theory. Then, registration is performed based on new Demons metric to preserve local volume elements. We use 12 pairs of simulated brain shift datasets to test our method and compare our method with traditional Demons. The results show that our method can successfully register the deformed and shifted brain while preserving the volume during the registration.Our framework consists of two major steps. First, we introduce a volume-preserving parameterization to map the mesh into a sphere domain. Then, we conduct the novel volume-preserving Demons registration to register the different meshes.Given two connected manifolds with the same topology, there are diffeomorphisms between them. Each diffeomorphism is corresponding to a mapping between these meshes. Different mappings have different purposes. They either preserve local geometry or minimize some deformation energy. Consider a three dimension manifoldP, a local volume element is defined on the local coordinatesx1,x2,x3as(1)τP=ρP(x)dx,wheredx=dx1∧dx2∧dx3andρP(x)>0is a volume density function. There exists a diffeomorphismfwhich mapsPto another manifoldQ,f:P→Q. Without loss of generality, the global volume ofQcan be scaled to that ofP, which means∫PτP=∫QτQ. After the mapping, the local volume elementτPdeforms toτQ. Suppose there is another diffeomorphismgwhich mapsQto itself,g:Q→Q.galso maps the local volume elementτQtoτQ′. IfτP≡τQ′everywhere,g∘fis such a diffeomorphism, which mapsPtoQpreserving the local volume. According to Eq. (1),τP≡τQ′can be converted toρQ′≡ρP.gnot only mapsQto itself, but also maps the volume density back to the original one inP. This density change inQis described as fluid dynamics. Suppose thatQfollows a velocity fieldVdefined at itself; then the material derivative can be derived fromV:DρDt=∇ρ⋅V.The material derivative describes the density changes along the stream line inV. Note that, each element moves along the stream line inV, so that the local densityρQchanges toρP. This change can be interpolated linearly asρ(t)=(1−t)ρQ+tρP,t∈[0,1].Thus,Vmust satisfy(2)−ρQ+ρP=∇ρ⋅V.In order to solve this equation ofV, we introduce a scalar fieldφ(x,t)such thatV=∇φ. Then, Eq. (2) is converted into a Poisson equation ofφ(x,t):−ρQ+ρP=−ρΔφ.The Poisson equation has a unique solution. Once the scalar field is solved, the path of each element onQis an integral curvex(t)such that(3)dx(t)dt=V(x(t),t),x(0)=x0,wherexis the initial position of the curve. If each element follows the curvex(t)fromt=0tot=1, the densityρon it changes linearly fromρQtoρP. Since the density is positive, the curvex(t)yields a desired diffeomorphismg, andg∘f:P→Qis a diffeomorphism which maps manifoldPtoQwith local volume preserved.Based on the above mathematical derivation, in the discrete condition, we apply an iterative algorithm on those manifolds with discrete representations. Manifolds in 3D can be represented with tetrahedral volume meshes. First, an initial mapping is constructed. Then, the time interval is divided into the discrete time steps for the iteration. At the beginning of each iteration, the current local density is calculated on each vertex. The Poisson equation, Eq. (2), is solved within current time step. All the vertices move a time step along the vector fieldVguided by the solved scalar field. The iteration continues for each time step.Assume that a 3D volume is represented with a tetrahedral meshT={V,E,F,C},V={vi}denotes the vertex set,E={eij}the edge set,F={fijk}the face set, andC={cijkl}the tetrahedral cell set with1≤i,j,k,l≤m=|V|. Given a scalar functionφon the volume, its discrete version is a vectorφ→=[φ1,φ2,…,φm]T, defined at the vertices. The volume element is represented with the voronoi volume|Ωi|of that vertex.Thus, the discrete Laplace–Beltrami operator is linearly approximated at each vertex. Suppose thateijis shared byntetrahedrons, the volumetricδφis estimated atvias  [13](4)δφ(vi)=∑j∈N(i)wij(φ(vi)−φ(vj)),wherewijis the volumetric edge weight defined on edgeeijandN(i)is the one-ring neighbor of vertexi. As the scalar functionφis represented with a vector, the Laplace operator is defined with a weight matrix asLij.Suppose that an edgeeijis shared byntetrahedrons,wijis defined aswij=1|Ωi|(16∑kllilcot(θkl))[14], where|Ωi|is the voronoi volume ofvi,lklis the edge length ofeklto the opposite edgeeij, andθklis the dihedral angle onekl. When considering all vertices of a mesh, Eq. (4) can be written as a linear systemLx=b, wherex=φ→andb=(ρQ−ρP)/ρ.By solving the discrete Poisson equation, we obtain the scalar fieldφon the unit sphere volume. The gradient of the field is assumed constant inside the tetrahedral cell. To obtain a unique vector at each vertex,∇φat vertexviis defined as(5)Vi=∇φi=1∑cijkl∈N1(i)αjkli∑cijkl∈N1(i)αjkli∇φ(cijkl),that is, an average of the gradients of the adjacent cells, weighted by the inverse of the distanceαjklibetween the central vertexviand the centroid of cellcijkl.V(t)is not a steady field but varies with timetdepending on the solution of∇φ(t). Therefore, an iterative integration is employed based on each vertex. The time interval[0,1]is divided intoKstep, and the time difference between the neighbor step isδ=1K. Thus, we get the iteration(6)X(k)=X(k−1)+1KV(K−1),k=1,2,…,K,whereX(k)is the current position of thek-th step. And the final diffeomorphismgis represented with the sum of the displacements of all steps asg(x)=x0+∑k=1K1K∇φ(k−1).In general, a larger number of iteration steps result in more accurate approximations. Empirically,Kis set to 50, which will satisfy most cases.The movement of vertices is in principle determined by the designated volume changes. However, degenerated tetrahedron may undermine the discrete computation due to inaccurate approximation of the Laplace–Beltrami operator. At the beginning of each step, we optimize the underlying tetrahedralization by performing combinatorial flips to all flippable faces for the Delaunay condition. Note that the geometry of volume is realized by theirR3embedding. Throughout this procedure, the discrete sampling of the shape remains unchanged, but is merely interpolated by a different tetrahedralization.Based on the volume-preserving parameterization, we continue to solve the volume-preserving registration. The registration can be defined to find a registration which can minimize the distance between two meshes without breaking the original volume-preserving constraint. Here, the distance between two meshes can be defined as the MRI gray value differences of the corresponding vertices between two meshes.We introduce metrics similar to the Demons approach  [15] to our volume-preserving registration. In  [15], Thirion proposed to consider non-parametric non-rigid registration as a diffusion process. He introduced Demons that pushes according to local characteristics of the images in a similar way Maxwell did for solving the Gibbs paradox.A normal Demons approach is a two-step optimization, in which the first step represents a search for the update direction of the current warp, and the second the regularization of the new warp resulting from this update. Given a fixed imageSand a moving imageT, non-parametric image registration is treated as an optimization problem that aims at finding the displacement of each pixel to get a reasonable alignment of the images. In many cases, non-parametric spatial transformations will be described by a displacement fielduwhich is simply added to an identity transformation to get the non-parametric transformation:u:p→p+u(p).The similarity criterionSim(.,.)measures the resemblance of two volumes. Here, we consider the distance between two volumetric meshes asSim(S,T∘u)=12‖|S−T∘u|‖2.A simple optimization ofSimover the space of non-parametric transformations leads to an ill-posed problem with unstable and non-smooth solutions. To avoid this and possibly add some a priori knowledge, a regularization termReg(u)is introduced to get the global energy(7)E(u)=1σi2Sim(S,T∘u)+1σT2Reg(u),whereσiaccounts for the noise on the image intensity andσTcontrols the amount of regularization we need.The idea is to consider the regularization criterion as a prior on the smoothness of the transformationu. Instead of requiring the point correspondences between image pixels, a non-parametric spatial transformation,g, is exact realization of the spatial transformationu, but allows some error at each image point. Considering a Gaussian noise on displacements, we end up with the global energy:(8)E(g,u)=‖1σi(S−T∘g)‖2+1σx2dist(u,g)2+1σT2Reg(u),whereσxaccounts for a spatial uncertainty on the correspondences,dist(u,g)=‖g−u‖andReg(u)=‖∇u‖2.The unique advantage of the algorithms is precisely the separation of the two optimization problems: each cost can be optimized very efficiently with either a linear approximation or a fast convolution.Since the third term in Eq. (8) can be interpreted as a penalty on the harmonic energy ofu, as well as its norm, and can be smoothed with a Gaussian kernel. Smoothing the displacement field is often termed “diffusion-like regularization”, and smoothing the update, “fluid-like regularization”. Thus, in order to preserving the volume while registration, we modified the regularization term as follows.Given a manifoldM, a displacement fielduis required to deform the whole volume domain at each step. To accomplish the volume registration,umust satisfy two criteria: first,uis divergence free everywhere so that the volume elements are preserved under the deformation; second,uon the boundary has no normal components, where no element moves in or out of the original volume domain. Formally, the problem can be represented as finding a displacement fieldudefined on the volume domainMsuch that(9){∇U≡0u(bj)⋅n(bj)≡0,bj∈∂M.Since Radial Basis Function (RBF) interpolation is a powerful tool to generate a function which interpolates a discrete set of values, the set of values is the displacement vectorufor each constant time step. Therefore, instead of regular scalar RBF, vector–matrix RBF is employed, which is represented as(10)u(x)=∑iΦ(‖x−xi‖)ci,whereΦis ann∗nmatrix valued radial basis function inndimensions space, andciis a coefficient vector. The set ofcisatisfies|u(ci)|=|gi|. Thus, Eq. (10) is an overdetermined equation that we could find the optimal solution.To interpolate a divergence free field, we employ the radial basis function, which McNally proposed to interpolate a magnetic field  [16], since at each step, the update directiongcan form a divergence free field.(11)Φ(x)=(∇∇T−IΔ)ϕ(x),where the∇operator is represented with a vector operator[∂x1,∂x2,…,∂xn]T,Δis a scalar valued Laplace operator, andΦis a scalar value radial basis function. Thus, we have(12)∑iΦ(‖xj−xi‖)ci=gj,j=1,2,…,N.With the solution of this equation,uis interpolated, which is divergence free and guarantees that each point is along the direction. In the experiment, we choose GaussianΦ(x)=e−λ‖x‖2as the scalar valued radius basis function, which makes the divergence procedure equivalent with diffusion like Demons registration in the Lie group  [17].After a divergence free displacement fielduis obtained, we need to constrain the boundary so that the shape of the domain can still be a unit sphere after the deformation. To keep the original shape of the domain, the displacement field must have zero normal component on the boundary, which means nothing is moving in or out of the original domain. To eliminate the normal component on the boundary to zero, another displacement fielduccan be added to the existingu.ucis also divergence free asuand has the same normal components at those sampling points on the boundary, but with opposite normal directions. Then, addinguctouleads to the final registration displacement fieldur=u+uc.Here, we can find that the divergence free displacement fielduis a Lie group under composition, the original warp direction is computed based on Eq. (8), the warp value is calculated by Eq. (10), after the iteration, we can finally get the optimal registration results.Thus, we define the volume-preserving Demons registration as(13){u=argminu(‖S−T∘{g∗u}‖22+1σdist(g,u))u(bj)⋅n(bj)≡0,bj∈∂Mu(x)=∑i=1N∗KΦ(‖x−xi‖)ui.In practice, we first perform a rigid registration to minimize the distance between two meshes. Then we conduct the volume-preserving registration based on Eq. (13). Finally we can get the transfer matrix and the registration results. Algorithm 1 shows the whole registration steps.

@&#CONCLUSIONS@&#
