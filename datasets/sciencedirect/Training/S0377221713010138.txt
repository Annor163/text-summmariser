@&#MAIN-TITLE@&#
Electricity swing option pricing by stochastic bilevel optimization: A survey and new approaches

@&#HIGHLIGHTS@&#
We review swing option pricing in the context of stochastic bilevel programs.Several to date modeling and algorithmic approaches are discussed.We treat a penalty method for stochastic multistage bilevel problems in detail.We demonstrate the complexity on a real world problem.The bargaining between a potential seller and a buyer is illustrated.

@&#KEYPHRASES@&#
Pricing,Swing option,Bilevel optimization,Stochastic optimization,Stackelberg game,

@&#ABSTRACT@&#
We demonstrate how the problem of determining the ask price for electricity swing options can be considered as a stochastic bilevel program with asymmetric information. Unlike as for financial options, there is no way for basing the pricing method on no-arbitrage arguments. Two main situations are analyzed: if the seller has strong market power he/she might be able to maximize his/her utility, while in fully competitive situations he/she will just look for a price which makes profit and has acceptable risk. In both cases the seller has to consider the decision problem of a potential buyer – the valuation problem of determining a fair value for a specific option contract – and anticipate the buyer’s optimal reaction to any proposed strike price. We also discuss some methods for finding numerical solutions of stochastic bilevel problems with a special emphasis on using duality gap penalizations.

@&#INTRODUCTION@&#
Swing options are derivative contracts – usually between a producer or wholesaler, and a retailer – which give their purchasers the right to buy the underlying commodity at a prespecified exercise price per unit during a future term of validity. For each decision period within this timeframe the purchaser is allowed to choose the quantities delivered within prespecified bounds. Swing contracts are widely used in energy related commodity markets. In this paper we are particularly interested in electricity swing options.Two important quantification questions arise: pricing aims at finding an exercise price such that neither the holder nor the seller of the option are disadvantaged. On the other hand, valuation of an existing contract with given exercise price should result in a fair resale price.The valuation problem can be described (see e.g. Haarbrücker & Kuhn, 2009) by an optimization problem for the buyer, where the optimal value corresponds to the economic value of the swing option. The seller however has a different objective than the buyer: he/she tries to find an optimal offered price with respect to his/her own specification, but also needs to consider the buyer’s reaction to this offer (e.g. Broussev & Pflug, 2009). Since both agents take optimal decisions which are related to each other, the very nature of the pricing problem is bilevel and of the leader–follower type: the option seller plays the role of the leader, or upper level decision maker, when setting the price, but he/she acts in view of the reaction of the option buyer, who is the follower, or lower level decision maker. Throughout this paper, we mark all upper level decision problems of the seller by [UL] and those of the lower level option buyer by [LL]. Since future spot market prices are not known at the time of contracting, and since the buyer may make decisions at several time steps, we have to deal with a multistage stochastic bilevel optimization problem.For this reason we will review swing option modeling as well as stochastic bilevel programming and introduce some new solution methods in the following. While bilevel programming and in particular stochastic (two stage) bilevel programming has recently made considerable advances, stochastic decision problems in electricity usually are large (in particular if formulated as stochastic optimization problems defined on tree structures) and have certain nonstandard features. This means that standard algorithms cannot be applied or lead to unacceptable computation times.This is true even for the simplest setup, where the optimization problems of both agents are linear, given the decisions of the other level, but bilinear if all decision variables are considered at once. On the other hand the swing option problem is simpler than other typical bilevel problems in that all decisions are determined by the seller’s decision for a strike price, which is a single number. The article will predominantly discuss such algorithms that are able to deal with the complicated overall structure of the problem, but are also suitable to exploit this special feature.The paper is organized as follows: Section 2 reviews some basic facts of electricity markets, describes the swing option problem from both, the buyer’s and the seller’s view and states it as a multistage stochastic bilevel optimization problem. Section 3 gives an overview of general solution methods for bilevel problems and introduces two simple approaches, well suited for the bilevel formulation described before. The section closes with a numerical example on swing option pricing. In the appendices we add some technical details on acceptability functionals.Because of the non-storability of electricity there is a layered structure of short term markets, reaching from day ahead to real time. In addition, also forward contracts exist in most electricity markets, with a gradual transition from forwards with maturities up to 2years to the day ahead spot market. Forward contracts fix a price for future power delivery (the strike price) over a specified period in the future.Usually, such contracts are traded over-the-counter (OTC) as forward contracts, or in standardized form. In the latter case they are called futures. While settlement at electricity spot and OTC markets usually is physical, futures markets mostly rely on financial settlement. We will not distinguish between forward contracts and futures throughout the rest of the paper. In fact, there is no difference in the valuation of the two contract types, if the interest rate is considered as deterministic.Given the non-storability of electric energy, the usual no-arbitrage arguments for pricing forward contracts in financial and commodity markets cannot be applied for power markets. A functional relation between the actual spot priceStand forward prices is not observable. However futures pricesF0,tbegin,tend(i.e. the strike price of a futures contract with delivery between point in timetbeginandtend, agreed at time 0) are related to expected prospective spot pricesE(St)withtbegin⩽t⩽tend. Stoft (2002) proposes to use the simple relation(2.1)F0,tbegin,tend=∑t=tbegintendESt,where electricity is delivered between timestbeginandtend. Others (e.g. Bessembinder & Lemmon, 2002; Geman & Vasicek, 2001) have made the effort to extend relation (2.1), which leads to(2.2)F0,tbegin,tend=∑t=tbegintendESt+risk premium(0,tbegin,tend).Based on real data, Geman (2006) shows that the risk premium is positive iftbeginis small, particularly if it corresponds to a winter or summer month, and may be negative iftbeginis large, i.e. several years. Similar results are discussed in Giacometti, Vespucci, Bertocchi, and Adesi (2010).Other models for the spot price and/or the forward price structure – in fact the whole arsenals of econometrics and finance – have been used as well. E.g., starting with Pilipović (1998), mean reverting Pilipović spot price models with different number of risk factors have been formulated. See Eydeland and Wolyniec (2003) for a broad overview of spot and future price models.Swing options – an important form of flexible delivery contracts – can be considered as the simplest and most important types of option-like electricity contracts. They are also known as flexible nomination contracts, take-or-pay contracts, or virtual power plants. See e.g. Kaminski and Gibner (1995), Barbieri and Garman (1996), Pilipović and Wengler (1998), and Pilipović (2007).A swing option gives its buyer (or option holder) the right to get a commodity at a price K per unit, which is fixed now, but allows to choose the actual purchase quantities in a later moment of time. For electricity swing options we will state the price as K EUR per megawatthour. For simplicity we will assume that delivery takes place at equidistant periodst∈1,2,…,T. The actual demand has to be specified one period (usually a day) before delivery. For the tth period, the demanded and delivered amount of energy (megawatthour) is denoted byyt, wheret∈T=0,1,…,T-1.Usually, demands for each period (often expressed by maximum deviations from a base-line schedule) and the quantity bought over the full contract period must lie within certain bounds. Such volume constraints can be expressed as(2.3)e̲t⩽yt⩽e‾t∀t∈T(2.4)E̲⩽∑t=0T-1yt⩽E‾Heree̲t,e‾tdenote the lower and the upper bound of energy consumptionytfor the tth period, whileE̲,E‾denote the overall lower and upper bounds for the whole contract duration. Sometimes those hard constraints are replaced by penalty payments for exceedinge‾t,E‾or falling belowe̲t,E̲.If we map the index 0 to a point in timetbeginand introduce a time incrementΔtand a point in timetend=tbegin+T·Δt, we can also handle swing options related to the contract period(tbegin,tend]and with different decision intervalsΔt, for instance hourly decisions. In this case the notification time before delivery has to beh·Δtwithh=24.Note that often (2.3) is expressed in terms of power (MW) fixed at the beginning of a period, so in principle we could base all decisions on powervtand substitute(2.5)yt=Δt·vt.A possible additional condition are ramping constraints with ratchetsϱt(2.6)vt-vt-1⩽ϱtt=1,…,T-1,limiting the changes in power demanded between consecutive periods. In this casep0has to be agreed as an additional parameter of the contract. With given time incrementsΔt, such constraints can easily be reformulated as linear constraints on energy:(2.7)-ϱt·Δt⩽yt-yt-1⩽ϱt·Δt.Constraints of this type can be important, if the period lengths are short (e.g. hours).We see that – unlike typical financial options – swing options are flexible with respect to time and quantity and so is able to reduce both, volume risk and price risk for the buyer. In both, the gas and the electricity industry swing options have been used for many years, either as embedded options related to general delivery contracts, or in the form of separate contracts. Typical buyers in the electricity sector are public distributors with fixed retail prices, facing random load and spot prices. See e.g. Doege, Lüthi, and Schiltknecht (2006) regarding the usage of swing options as hedging instruments.Swing contracts usually are traded bilaterally and hence may be subject to market power: often the seller of a contract will be a big producer or even a big, state owned entity. On the other hand, if market efficiency and liquidity are high, the seller’s ability to set the price might be severely limited. We will consider both cases in the following. In any case, the seller’s scope is limited by the buyer’s possibility to buy the commodity at the spot price if the swing-price is too high.Typically, the economic risk is with the option seller, who has to contract at a time, when the information about future spot prices is very low. In addition, there might be counterparty-risk at both sides of the contract, if one of the counterparties does not fulfill all contracted conditions. Upfront payments may be agreed to reduce this risk. But generally speaking, non-compliance with agreements will not be an issue in this survey. We will also neglect other costs related to, e.g. setting up, calculating and monitoring the contract.Two questions arise when swing options are analyzed:•Valuation: Given the exercise price K, what is the value of a swing option for the buyer?Pricing: What exercise price K should be offered by the seller?In view of the preceding discussion it is clear that the answers, in particular to the second question, will be more complicated than in financial option pricing and involves optimal decisions of both, the buyer and the seller.Any valuation of a contract should involve the option holder’s optimal exercise strategy. Consider a pure trader, who – in addition to buying a swing option – is able to buy and sell electricity at the spot market. His objective is to maximize the profit by taking any arbitrage opportunity between the strike price and market prices. In the basic setup the trader maximizes his/her expected value.A simple swing option contract with exercise price K (which is set by the option seller) and constraints (2.3) and (2.4) can be described by the following multistage stochastic program:(2.8)[LL]maxy∑t=0T-1EytSt+1-Ksubject toe̲t⩽yt⩽e‾t,∀t∈0,…,T-1E̲⩽∑t=0T-1yt⩽E‾yt⩾0,∀t∈Tyt◁Gt,whereyt◁Gt=σS1,…,Stdenotes measurability of the decisions with respect to the filtrationG=(G0,…,GT-1), generated by the past spot price process. Note that in this formulation, decisionsytare taken at stage t, while the corresponding spot priceSt+1is only known one stage later. Generalizations to the case where the notice ahead time is not one, but h stages are straightforward, onlySt+1has to be replaced everywhere bySt+h. Notice that the spot price process(St)is a stochastic process, its distribution has to be estimated from available data, such as past observations or economic forecasts. While the buyer needs only to estimate one- or h-step-ahead distributions, the seller is required to model the process for the whole validity period of the contract.Stochastic optimization is an important tool for risk management in energy production and trading, see e.g. Fleten and Kristoffersen (2007), Möst and Keles (2010), and Rocha and Kuhn (2012) and hence also has been used to formulate decision problems related to swing options: the formulation (2.8) was introduced in Broussev and Pflug (2009). Haarbrücker and Kuhn (2009) proposes a similar program with additional constraints, see also Frauendorfer, Güssow, Haarbrücker, and Kuhn (2005). Using a Pilipović type spot price model, the idea in Haarbrücker and Kuhn (2009) is that the optimal value of the objective function gives the value of the swing option from the buyers view.A market participant, optimizing (2.8), fully speculates against the issuer of the swing option, as he will only buy, when spot prices are expected to be high: this causes opportunity costs for the issuer. As pointed out for example in Broussev and Pflug (2009) and Hochreiter and Wozabal (2010) there are other market participants whose behavior differs from a pure trader: their main goal is to satisfy the demand and not to speculate. We mention demand followers with access to spot markets and demand followers without access to spot markets. Both types of demand followers – these could be retailers, selling electricity to end users at a fixed price – have to cover a (stochastic) load at future points in time.Another class – retail clients without access to the spot market, but with access to providers with different prices – is considered in the context of classical retail pricing by Carrión, Arroyo, and Conejo (2009).While a variety of modifications and extensions can be useful in certain situations, we will refer to formulation (2.8), because facing a pure trader/arbitrageur is a kind of worst case setting for an option seller. We also mostly abstain from using expected utility or risk adjustments for the option buyer’s optimization problem, because his/her utility is unknown to the option seller.As an alternative, all models discussed so far can also be formulated and solved in terms of stochastic dynamic programming. In this case at least the amount of energy consumed up to time t has to be introduced as a state variable, additional to the prices. Papers on valuing swing options by dynamic programming include Thompson (1995), Lari-Lavasani, Simchi, and Ware (2001), Jaillet, Ronn, and Tompaidis (2004), Barrera-Esteve et al. (2006), Baldick, Kolos, and Tompaidis (2006).Often dynamic programming problems are solved approximatively. This is also the case for problems related to swing option valuation. Meinshausen and Hambly (2004) extends the least-squares Monte Carlo method, originally developed for the valuation of American options (see Longstaff & Schwartz, 2001). Because the results of this method depends heavily on the price models used for simulation, different variants have been proposed in the following, see e.g. Gråvas (2004) and Boogert and de Jong (2008). Further simulation based valuation methods were proposed in Ibáñez and Zapatero (2004) and Ibáñez (2004).Using the buyer’s decision problem (2.8) and a suitable spot price model we are able to valuate a swing contract with given strike price. Its value is given by the maximum objective value, if the maximum is positive. Otherwise the value is zero and the contract will not be concluded.The main question from the seller’s standpoint consists in setting a suitable strike price. From a finance point of view it seems natural to search for a strike price that results in a value of zero for the buyer – such that the buyer is indifferent between concluding or denying the contract (see Haarbrücker & Kuhn, 2009).However, there are important differences between financial derivatives and electricity derivatives. For financial derivatives, the key principle is the no-arbitrage assumption: if a contract can be replicated by some strategy involving only contracts, for which the price is already given, then the price of the new contract is determined by the other prices in such a way that there do not exist any arbitrage possibilities, i.e. no riskless positive income with zero initial capital. The fundamental result in option pricing states that the correct price can be found by looking at valuation measures, which make the discounted underlying price process a martingale. If this martingale measure is unique, one speaks about a complete market, otherwise the market is called incomplete. In the incomplete situation, an interval of prices is determined: if the price of the contract lies within this interval, no arbitrage is possible. Notice that the existence of replicating strategies is fundamental for this pricing method.In contrast, pricing in electricity markets cannot be based on the no-arbitrage principle since for a given demand pattern – flexible or not – no replicating strategies exist: electricity is not storable and there are only very few instruments (i.e. contracts such as base and peak futures) available to partially hedge a specific contract. In such a situation, a strike price resulting in a value of zero for the buyer, might just be too high, especially in a fully competitive setting without strong market power on the side of the seller. Even the seller might be better off with a smaller strike price, because his/her profit depends on the volume of sales, which is reduced by the buyer when the price increases (see e.g. the example in Section 4.5).Instead of the no-arbitrage principle we use two alternative approaches for modeling the decision of the option seller. Which one is more appropriate in a given situation, depends on the market power relations between seller and buyer:•Expected profit/utility maximization: If the seller is (almost) a monopolist, he/she will be able to maximize the expected profit. Of course the optimal decisions of the buyer – his/her reactions to any strike price decision of the seller – have to be anticipated.Acceptability pricing: In a very competitive market the aim is just to find the minimal strike price such that the profit and loss distribution, resulting from optimal decisions of the buyer, stays ”acceptable” for the seller.To describe the seller’s problem in more detail we assume that he/she has the possibility to get electricity at a priceS∼t, which is typically lower than the spot priceSt. This can be an internal (or transfer) price between the production and the trading division of a generator and works as a proxy for modeling the whole production process (see Kovacevic & Pflug (2013) for a framework including production). If the seller is not an electricity producer, one may setS∼t=St, assuming that the seller and the buyer have access to the same spot market. Otherwise one may estimate a statistical model, in the simplest case e.g a regression modelS∼t=α+β·St+ut(with noiseut), if historical data on bothStandS∼tare available. We will not allow that the seller uses simultaneously both, his own production with priceS∼tand the spot market with priceSt. The buyer has always to make his/her extra purchases on the spot market at priceSt.Suppose further that also there are M different types of futures contracts available. Each typem∈{1,…,M}is characterized by a delivery scheduleτ, whereτ(m,t)is the amount of electricity (in megawatthour) offered in period t by one unit of contract of type m. Typical patterns are the base futures (delivers 1megawatthour at each hour of the week), the peak futures (delivers 1megawatthour Monday through Friday, 8–20hours) and the Vattenfall GH0 profile (see Vattenfall, 2005). Common futures are available for full years, quarters or months. The price per contract of the mth type is denoted byFm.At the time of contracting, the seller sets the strike price K and simultaneously buysx̃m∈Runits of futures contracts to hedge away as much risk as possible. We assume that fractions of contracts can be traded. The decision vector x of the seller then consists of K and the vectorx̃=(x̃1,…,x̃M), which indicates the number of contracts of each type bought on the futures market, i.e.(2.9)x=(K,x̃1,…,x̃M).Using this setup means that we adopt static hedging throughout this paper, i.e. hedging contracts are bought by the option seller at the time of contracting and not changed later. Static hedging is often used in practice, because sellers want to bring to completion all actions related with a contract, and to avoid further transaction costs and other costs related to turnover. Dynamic hedging can be implemented in a straightforward way, replacingx̃mbyGt-measurable decision variablesx̃m,t, representing the number of contracts of type m, held at time t.Withytdenoting the demand of the buyer as above, the unmatched surplus/shortage in time period t is∑m=1Mx̃mτ(m,t)-yt.This amount is valued by the internal priceS∼t.Denote byWxthe profit/loss variable of this contract from the seller’s point of view. It takes the values(2.10)Wx=K∑t=0T-1yt+∑t=0T-1S∼t+1∑m=1Mx̃mτ(m,t)-yt-∑m=1MFmx̃m.Introducing the random quantitiesϕm=∑t=0T-1τ(m,t)S∼t+1the spot-value of them-th futures contract,δ(y)=∑t=0T-1ytS∼t+1the demanded quantities valuated at spot prices,y¯=∑t=0T-1ytthe total demand,one can get rid of summations over time in (2.10) and just write(2.11)Wx=y¯K+∑m=1Mx̃m[ϕm-Fm]-δ(y).Assuming a probability model and a valuation functionalAu(e.g. expectation, expected utility or more general acceptability measures) the seller’s problem in the monopolistic situation can be stated as(2.12)[ULM]maxK,x̃Au[Wx]=Auy¯K+∑m=1Mx̃m[ϕm-Fm]-δ(y).In the competitive situation it can be formulated as(2.13)[ULC]minK,x̃Ksubject toA[Wx]=Ay¯K+∑m=1Mx̃m[ϕm-Fm]-δ(y)⩾q,where q is some minimal level of acceptability.It has to be kept in mind that in both cases the profit variableWxand the constraints depend on the optimal exercise behavior of the contract buyer, and hence indirectly on the upper level decisionsK,x̃. The demand patternyt, its spot valueδ(y)and the total demandy¯are scenario dependent random variables, which are found by solving the buyer’s optimization problem (2.8).So far it has been assumed that the buyer is willing to contract anyway. In reality however, if the minimum consumptione̲t>0and the strike price is high, then the buyer might not accept the whole contract:yt≡0is always a solution, even if there are lower bounds formulated in the contract, and the constraint(2.14)∑t=0T-1EytSt+1-K⩾0has to be added to either the buyer’s or the seller’s optimization problem. In most cases we will consider the lower level problem (2.8), augmented by (2.14), which will be denoted by[LLE].The subordination of the two sub-problems[ULM], respectively[ULC], and[LL]resp.[LLE]makes the whole a bilevel problem with the buyer’s decision as the lower level and the seller’s decision as the upper level. From a game-theoretic viewpoint, these are Stackelberg games (also called leader–follower game), where the leader determines the price, while the follower communicates his/her demand based on the price information.So far our formulation of the combined problem[ULM](or[ULC]) and[LL]is incomplete: it is not clear how to deal with the fact that the lower level decision variablesytappear in both, the upper levels objective function and constraints.Typically, in textbook examples the lower level solution y, given the upper level decision x can be calculated analytically and is unique. In this case, y can be expressed as a functiony(x)of the upper level decision variable, and hence it is possible to replace all occurrences of y byy(x). The whole bilevel problem then can be reformulated in terms of x as the only remaining decision variable.Unfortunately the situation is more complicated for the swing problem. Analytical solutions cannot be given for realistic instances, and[LL]is linear in y given K. The latter fact means that unique solutions are not guaranteed. For the sake of clarity, we review step by step some basic facts about bilevel problems.Deterministic bilevel problems: Suppose that x is the decision of an upper level decision maker with objectivef(x,y)and feasible setX. Given x, the lower level problem[LL]with decisions y, objective g and feasible setYxis(2.15)[LL]y∗x=argmaxyg(x,y):y∈Yx.Two types of bilevel problems then can be formulated, see e.g. Dempe (2002). The optimistic version assumes that the lower level decision maker chooses an actual decisiony∗∈y∗(x)such that it is the best w.r.t. the upper level objective f, which results in the upper level [UL] problem(2.16)[UL]maxx,yfx,y:x∈X,y∈y∗x.The pessimistic formulation argues that the upper level has no influence on the decisiony∗∈y∗(x)and may choose the worst w.r.t. f:(2.17)[UL]maxxminy∈y∗xfx,y:x∈X.The largest part of the bilevel literature focuses on the optimistic approach and we will follow this trend in the rest of this paper. However, see Wiesemann, Tsoukalas, Kleniati, and Rustem (2012) for a recent treatment of pessimistic bilevel optimization.Even optimistic bilevel problems are nonconvex, and strongly NP-hard (e.g. Bard, 1991; Ben-Ayed & Blair, 1990) if the lower level feasible set depends on the upper level decision. See e.g. Dempe (1992) and Outrata (1993) for necessary optimality conditions. Note that bilevel problems can be reformulated as MPEC problems, but as was demonstrated in Dempe and Dutta (2012), local optimal solutions of the MPEC are not necessarily also locally optimal for the original bilevel formulation.A specific intricacy of bilevel problems lies in the fact that even for very simple cases the feasible set of (2.16) can be disconnected. As a simple, but instructive example, consider a revenue maximizing upper level, determining the price x of a good, and a lower level choosing the demand y. The lower level maximizes its utility and has a budget of 14 currency units. A substitute good is available at the price of 3, hence the lower level also decides, how much (denoted by z) to buy of the substitute. Finally, the lower level is contractually bound to buy at least 1 and at most 5 units of the upper levels good. Given the price x, the lower level problem can be stated as[LL]y∗(x)=argmaxy{y0.9+z0.9:x·y+3·z⩽14,1⩽y⩽5}.The solution for each x is unique and therefore we denote the amount bought at price x (the unique element ofy∗(x)) byy(x).Knowing the lower levels reaction, the upper level maximizes the revenue,[UL]maxxx·y(x)Fig. 1shows the optimaly(x)in dependency of x (dashed line) and the upper level profit functionW(x)=x·y(x)(solid line). One sees that this function has a local maximum atx=2.75and a global maximum at the boundaryx=14. If the upper level has the additional constraintW(x)⩾11(see the dotted line), then the upper level feasible set is not connected.As we will see later this behavior is possible also for the swing option problem.Stochastic bilevel problems: A bilevel problem with random parameters is called a stochastic bilevel problem. Let(Ω,B,P)be a probability space andξbe a random variable defined onΩ. Let in additionFandGbe two sub-sigma-algebras ofBmodeling the information available for the respective decision maker. Finally, letAu,Aℓbe probability functionals, like the expectation, some quantile or any other acceptability functional. A stochastic bilevel problem is of the form(2.18)[UL]maxx,yAu[fx,y,ξ]:x∈Xy∗(x),x◁F,y∈y∗x,wherey∗(x)is the solution set of(2.19)[LL]y∗=y∗x=argmaxyAℓ[g(x,y,ξ)]:y∈Yx,y◁G.Here the measurability conditionsx◁Fandy◁Gsymbolize the information constraints. We require that the lower level has at least the same information as the upper level, i.e.F⊆G. IfF⊂G, then the problem has asymmetric information. IfF={Ω,∅}, the trivial sigma-algebra, the upper problem is called a here-and-now problem in contrast to a wait-and-see problem, whereFor is nontrivial. Deeper analysis of two-stage stochastic bilevel problems was done mostly for upper level here-and-now decisions versus lower level wait-and-see decisions (see e.g. Wynter, 2009).Dynamic stochastic bilevel problems: In the most general formulation, both the upper and the lower level problem are multistage, meaning that a series of decisions is required from the upper and from the lower level decision maker. LetF=(F0,F1,…,FT)andG=(G0,G1,…,GT)be two filtrations in(Ω,B,P)withFt⊆Gt. A stochastic process(ξt)represents the uncertainty, which is gradually revealed as time goes on.Decisions(xt)t∈0,…,T-1and(yt)t∈0,…,T-1are now adapted random processes, depending on the history up to time t. Furthermore, the criterion functions must be extended for the process(ξt)and are described asf(x0,y0,ξ1,x1,y1,ξ2,…,xT-1,yT-1,ξT)for the upper problem andg(x0,y0,ξ1,x1,y1,ξ2,…,xT-1,yT-1,ξT)for the lower one.The upper level problem may look as(2.20)maxx,y∈y∗xAu[f(x0,y0,ξ1,x1,y1,…,xT-1,yT-1,ξT)]:x∈Xy∗(x),x◁F.wherex◁Fdenotes the fact that the process of decisions is adapted to the filtrationF, andy∗(x)is the lower level solution set(2.21)y∗x=argmaxyAℓ[g(x0,y0,ξ1,x1,y1,…,xT-1,yT-1,ξT)]:y∈Yx,y◁G.Swing option pricing as a bilevel problem: In the case of swing option pricing, at first glance the upper level decision [UL] seems to be here-and-now and not dynamic: decisions K andx̃are taken only at the beginning and not at later stages. However the lower level decision [LL] y is anF-adapted process, and hence the optimistic bilevel reformulation is – implicitly – dynamic multistage. The swing option pricing problem specified by (2.8), (2.12) or (2.13) can be rewritten as(2.22)[ULM]maxK,x̃,yAu[Wx]=Au[y¯K+∑m=1Mx̃m[ϕm-Fm]-δ(y)].subject toy∈y∗(x)for the monopolistic case, or(2.23)[ULC]minK,x̃,yKsubject toA[Wx]=A[y¯K+∑m=1Mx̃m[ϕm-Fm]-δ(y)]⩾qy∈y∗(x),in the competitve case, wherey∗(x)is theargmax-set of the lower level problem (2.8) augmented by constraint (2.14), i.e.[LLE].The basic formulation of the competitive case[ULC]goes back to Broussev and Pflug (2009), whereas the monopolistic formulation[ULM]is new. The overall Stackelberg-type setup of the seller’s problems is also similar to the electricity retailing problem described in Carrión et al. (2009). However the latter paper deals with the relationship between a retailer and its clients in view of competition between retailers with different price structure. In this model clients do not have access to spot markets and take their only decision – of supplier selection – at the beginning of the planning horizon. The retailer decides on offered prices purchases on spot, as well as futures markets. In this model, the lower level (client) as well as the upper level (retailer) take here-and-now decisions. The swing option problem is more complicated at the lower level, since the option buyer has access to the spot market and is able to make time dependent decisions. Conceptually, swing option problems deal with the relation between a wholesaler and a retailer and not between a retailer and its clients. Stackelberg-type problems have also been proposed for gas-markets in order to model the relationship between pipeline operating companies and natural gas shipping companies (Dempe, Kalashnikov, Pérez-Valdés, & Kalashnykova, 2011; Kalashnikov, Pérez-Valdés, Tomasgard, & Kalashnykova, 2010). However those models are not focussed at pricing. Further bilevel models related to energy can be found in e.g. Fampa, Barroso, Candal, and Simonetti (2008) and Carrión et al. (2009).Generally spoken, it is not possible to solve bilevel problems based on the formulations (2.8), (2.22) or (2.23) as optimization problems in function spaces. If one wants to apply numerical algorithms and solve the pricing problem with realistic data it is therefore important to discretize the formulation. Before we discuss tree-structured discretizations of these problems, we will review some methods to solve stochastic bilevel programs. We also discuss stochastic quasigradient methods in some detail, because they can be used to approximate solutions for both, the original and the discretized problem, provided that it is possible to give an estimate for the gradient of the lower level decision. Finally we propose some simple algorithms for the important practical case of a linear formulation of the swing option problem. Because stochastic gradient methods will not work for LPs, we will refer to a penalty method and a simple bracketing algorithm for our two main cases, the monopolistic and the competitive formulation.There is a vast literature on the theory of deterministic bilevel problems and related algorithms, see Bard (1998), Dempe (2002), Colson, Marcotte, and Savard (2007) for overviews and general theory. Extreme point algorithms are suitable for small, fully linear bilevel problems (e.g. Marcotte & Savard, 1991) and exploit the fact that the optimal solution of linear bilevel problems lie in some extreme points. Because the described swing option problems are not linear, such algorihms cannot be applied. Gradient/subgradient methods (e.g. Kolstad & Lasdon, 1990; Savard & Gauvin, 1994) use subgradients or directional derivatives to construct descent directions, see (3.1) below. Because bilevel problems are hard to solve, also heuristics have been applied, see e.g. (Calvete, Galé, & Mateo, 2008).However the most popular approach extends the upper level problem by necessary optimality conditions for the lower level decision problem and tries to solve the resulting highly nonlinear optimization problem. See e.g. Luo, Pang, and Ralph (1996) on dealing with general equilibrium constraints and Allende and Still (2012) for using the KKT conditions. We mention two possibilities for dealing with the resulting complementarity constraints: branch and bound methods and penalty methods. The latter (e.g. Aiyoshi & Shimizu, 1984; Facchinei & Soares, 1997; Harker & Choi, 2009; Marcotte & Zhu, 1996) use a penalty function in order to augment the upper level objective function by a penalization of the equilibrium or KKT constraints.Typically, algorithms for stochastic bilevel problems are discussed in the context of one- or two-stage stochastic problems. Usually, the models are discretized and formulated such that the upper level has to decide here and now, whereas the lower level is able to wait and see. An exception is e.g. Xu and Ye (2010). Basically the main methods for general bilevel programs have be modified for dealing with (two-stage) stochastic bilevel programs: gradient descent and penalization methods were discussed already in Patriksson and Wynter (1999). Again, using necessary conditions of the lower level problem as constraints for the upper level problem is an important approach, see e.g. Facchinei, Jiang, and Qi (1999) and Liu, Xu, and Lin (2011). In the MPEC-framework some papers also deal with equilibrium constraints for Nash-equilibria at the lower level. Such approaches have also been applied to various aspects of electricity and energy markets (see Yao, Oren, & Adler, 2007; Zhang, Xu, & Wu, 2010).The situation for multistage decision problems is different, if the lower level decision maker cannot be considered as a clairvoyant: information increases gradually over time. It is possible to reformulate stochastic programs as deterministic equivalents and typical MPEC approaches have been used in Carrión et al. (2009) and Dempe et al. (2011) for stochastic multistage bilevel problems.Gradient/subgradient descent methods can be applied to bilevel problems, if gradients or subgradients for the optimal decisions of the lower level problem can be calculated (or estimated). This is also true for stochastic bilevel problems and a convenient method in this case is the stochastic quasigradient method, described in the following.It should be kept in mind that the stochastic quasigradient method only works for compact, convex upper level feasible sets, which means that it is not applicable to the constraints used in our formulation (2.13) of the competitive case. However, for a strictly concave expected utility formulation of the upper level problem stochastic gradient-type methods can be used.We begin with treating deterministic problems, i.e. special cases of (2.15) resp. (2.17). For using gradient methods the feasible setYxhas to be defined by equalities and inequalities. Suppose that the lower level problem is[LL]maxyg(x,y)h(x,y)=[hi(x,y)]i=1,…,p⩽0k(x,y)=[ki(x,y)]i=1,…,q=0where g denotes the lower level objective function, y the lower level decision variables and the feasible set is specified by the intersection of inequalitieshi(x,y)⩽0and equationski(x,y)=0for some functionshi,ki.If the lower level problem has a unique solution for each x, under smoothness and regularity conditions for the functionsg,hand k (see Dempe, 2002, Theorem 4.11), one may find the directional derivatives of the solutiony∗(x)w.r.t. x, i.e.∇x;dy∗(x)=limt↓01t[y∗(x+td)-y∗(x)].as the solution of the following quadratic program (sety=y∗(x))(3.1)minr12r⊤∇xxL(x,y,λ,μ)r+r⊤∇xy2L(x,y,λ,μ)d∇xhi(x,y)r+∇yhi(x,y)d==0λi>0⩽0λi=0∇xkj(x,y)r+∇ykj(x,y)d=0,whereL(x,y,λ,μ)=g(x,y)+λ⊤h(x,y)+μ⊤k(x,y)is the Lagrangian and(λ,μ)is a maximizer of∇xL(x,y,λ,μ)d. These directional derivatives may be used to find the directional derivatives of the upper level objective. By the chain rule, the directional derivative off(x,y+(x))in the direction d is∇x,df(x,y)=[∇xf(x,y)]·d+[∇yf(x,y)]·∇x,dy∗(x)aty=y∗(x).The natural extension for stochastic bilevel problems are stochastic quasigradient methods. These methods use estimates for the gradients based on random sampling. For a single level problem(3.2)maxx∈XF(x)=E[f(x,ξ)]one must find estimates∇xf(x,ξ)^based on random sampling for the gradients∇xF(x). These estimates are called stochastic quasigradients, if•E[∇xf(x,ξ)^]=∇xF(x)+bn.Var[∇xf(x,ξ)^]=σn2.Forbn→0andσn2bounded or slowly growing. A possible choice for∇xf(x,ξ)^in the univariate case are divided differences[f(x+cn,ξ)-f(x-cn,ξ)]/(2cn), whereξnare randomly sampled (the so called Kiefer-Wolfowitz method). In the multivariate case, divided differences are taken in each coordinate direction. Alternative methods for finding stochastic quasigradients can be found in Pflug (1996). Based on the estimates∇xf(x,ξ)^, the Robbins–Monro type recursive algorithm for solving (3.2) over a compact, convex feasible setXis(3.3)xn+1=πX[xn+an∇xf(xn,ξn)^]withξnbeing independent random samples ofξandπXis the (convex) projection ontoX. (3.3) converges to the true solution provided thatan→0,∑nan=∞,∑nan|bn|<∞,∑nan2σn2<∞and some global Ljapunov-type condition holds (see e.g. Wasan, 1969 or Ljung, Pflug, & Walk, 1992 or Kushner & Yin, 2003).In the bilevel situation, the estimate∇xf(x,y∗(x),ξ)^must incorporate an estimate of the lower level solutiony∗(x)together with its gradient w.r.t. x.Given the actual upper level approximationxnand for fixed n, the lower level solution is adapted in several stepss=1,…,Sasys+1(n)=πY(xn)ys(n)+cs∇yg(xn,ys(n))^.In order to get the derivative of the lower level solution w.r.t. the upper level, one defines a second recursion wherexnis replaced byxn+an:ys+1+(n)=πY(xn)ys+(n)+cs∇yg(xn+an,ys(n))^.The directional derivative of the lower level solution is estimated by∇xy∗(xn)^=an-1(yS+(n)-yS(n)).Finally the approximation process for the upper level solution isxn+1=πXxn+an∇xf(xn,yS(n))^+∇yf(xn,yS(n))^·∇xy∗(xn)^.The stochastic quasigradient method for bilevel problems was implemented e.g. in Dance and Gaivoronski (2012). However, it is not always easily possible to find gradients for the lower level solutiony∗(x). This is especially true for lower level problems that are linear in y for given x.In this section we formulate the bilevel problem on scenario trees. We assume that the probability spaceΩis finite and consists of k scenarios:Ω={ω1,…,ωk}. Because both the upper and the lower level problem depend on stochastic processes (StandSt̃), the discretized probability space has to carry a filtration and can therefore be represented as a finite tree with node setN={1,…,N}, where node 1 represents the root (see Fig. 2).The levels of the tree correspond to the decision stages. LetNtbe the nodes at level t, fort=0,…,T. The last levelNTcontains the k leaves of the tree, which represent the scenarios and which play the role of the atomsωiof the probability spaceΩ. The tree structure (related to the filtration of the process) can be defined by stating the predecessor node n− for each node n.The tree carries the spot price process, i.e. spot pricesSnare associated to each node. Furthermore, probabilitiespn⩾0(and∑n∈Ntpn=1for all t) are attached to each node n. The spot prices and the related probabilities are estimated from historical data, see e.g. Dupacova, Gröwe-Kuska, and Römisch (2003), Pflug and Pichler (2011, Chapter 15), and Kovacevic and Pichler (2012). In addition, (2.1) is used to ensure that arbitrage between spot and futures markets is impossible, which would lead to unbounded problems.In tree notation, the lower level problem (2.8) can be represented as a linear program(3.4)[LL]maxy,s∑n=2Npnyn-Sn-Ksubject toe̲t(n)+1⩽yn⩽e‾t(n)+1,∀n∈Nt;t=0,…,T-1sn=sn-+yn-,∀n∈1,…,NE̲⩽sn⩽E‾,∀n∈NTyn⩾0,∀n∈Nt;t=0,…,T-1Here K is the strike price of the swing option as before,t(n)denotes the stage of node n andsnis the cumulative demand up to timet(n). Again it is important to include the constraint(3.5)∑n=2Npnyn-Sn-K⩾0ife̲t(n)>0for some n, see (2.14). As above, we will denote the lower level problem by[LLE]in this case.To specify the upper level problems in a concrete way, we will assume pure expectation as the objective for the monopolistic case and the average value at riskAV@R (expected tail loss, conditional value at risk) as defining the minimum acceptability for the full competitive case. See Appendix A for a discussion ofAV@R and its relations to quantiles as an acceptability measure.In the monopolistic case the upper level problem (with given demand pattern y) is discretized in the following way:(3.6)[ULM]maxK,x̃∑n=2Npnyn-+∑n=2NpnS∼n∑m=1Mx̃mτ(m,n)-yn-subject tox̃⩾0K⩾0With the additional constraintx̃⩾0we assume that the only purpose of the futures contract is to hedge away some risk. In the competitive situation the pricing problem can be formulated as(3.7)[ULC]minK,x̃,a,zKsubject toc1=-∑m=1MFmx̃mcn=cn-+Kyn-+S∼n∑m=1Mx̃mτ(m,t(n))-yn-,∀n∈N⧹{1}cn-a+zn⩾0∀n∈NTa-1α∑n∈NTpnzn⩾q∀n∈NTzn⩾0Withαrepresenting theα-level of theAV@R-functional and q being the minimum required level of theAV@R, this representation uses (A.3) and additional variablescn, accumulating the cashflows over time.As we have seen, typical standard approaches for bilevel programming may fail for the multistage stochastic case because of the high dimensionality of the problems. Furthermore stochastic quasigradient methods are not able to deal with all linear formulations in a sensible way. However it is possible to exploit some special properties of the LP formulations. Two observations are critical.•All programs (3.4), (3.6) and (3.7) are bilinear in x and y, which also means that they are linear in x given y, and in y given x.While the dimensionality of variables and constraints may be very large, all other decisions depend critically on the strike price: when the strike price is known the lower level decisions can be calculated by solving an LP. Given the strike price and the lower level decisions the remaining upper level decisions (the hedges) can also be calculated by solving an LP.The second observation already suggests an algorithm that will be discussed below, see Section 3.4.1. The other algorithms will reformulate our bilevel problems as ordinary bilinear optimization problems by penalizing the duality gap of the lower level problem. Standard approaches for bilinear problems, or a bracketing algorithm for the competitive case then can be used to find local optima.The reformulated lower level optimization problem (3.4) has an objective function that is bilinear in x and y, i.e. is linear in y for given x and vice versa. All constraints are linear. Using matrix notation it can be represented in the following way2We leave to the reader to find the correspondences between the original parameters and the new matrices and vectors. Notice e.g. that the sportpricesStappear in the vectorc1and the production pricesS∼tappear in the vector f in (3.11).2:(3.8)[LL:P]maxy(c1⊤+x⊤C2)yAy⩽by⩾0for some suitable vectorsb,c1and matricesA,C2. Notice that the upper level decision variable x appears here only in the objective and not in the constraints. The dual of [LL:P] is(3.9)[LL:D]minvb⊤vA⊤v-C2⊤x⩾c1v⩾0with v being the dual variables. The primal–dual problem [LL:PD] minimizes the duality gap and is therefore well suited for penalty formulations:(3.10)[LL:PD]miny,v-(c1+x⊤C2)y+b⊤vAy⩽bA⊤v-C2x⩾c1y⩾0v⩾0Notice that the primal–dual problem is a bilinear problem, which has a nonnegative objective, its optimal value 0 is obtained if and only if y (respectively v) are the optimal value of the primal (respectively dual) problem.In the monopolistic case the objective function of the upper level problem (3.6) is also bilinear and can be formulated as(3.11)[ULM]maxxx⊤f+x⊤DyLx⩽ℓ,for suitablef,ℓ,Dand L.With[LL:PD]and[ULM]as above the original bilevel problem can be reformulated as a penalized bilinear problem[ULM+LL:PD]with linear constraints. With penalty weightλ≫0this reads(3.12)[ULM+LL:PD]maxx,v;yx⊤f+x⊤Dy+λ[(c1+x⊤C2)y-b⊤v]Lx⩽ℓ,Ay⩽b,A⊤v-C2x⩾c1y⩾0,v⩾0.The reformulation as a bilinear problem extends the penalization proposed in White and Anandalingam (1993), where it was used for purely linear bilevel programs. Notice that[ULM+LL]is bilinear in the objective but the constraints are linear. In this case sequential linear programming (see e.g. Wendell & Hurter, 1976) leads to a local solution. Algorithm 1 summarizes this approach. Recall thatx̃denotes the vector of all components of x excluding the strike price K. To keep the algorithmic description simple we assume that the problem is feasible (in y) and thatλis chosen large enough, such that the duality gap is closed.Algorithm 1Bilinear iterationRequire:K0,λ>0,∊>01: SetK≔K0, as starting value2: Solve (3.12) inx=(K,x̃)with K fixed, resulting in the solutionsx̃,v,y3: repeat4: SetKold≔K5: Solve (3.12) with y fixed resulting in the solutionsK,x̃and v6: Solve (3.12) withx,vfixed resulting in y7: until|K-Kold|⩽∊8: SetK∗≔K,x∗≔x,y∗≔yIn addition, Branch and Bound methods can be used in order to find improved local solutions.If hedging is not possible one may also solve the pessimistic bilevel version of[ULM], which maximizes in x but minimizes in y. Algorithm 1 has to be augmented as follows: after step 6 store the optimal valueγof (3.12). Before step 5 in the next iteration solve the problem(3.13)minyx⊤f+x⊤Dy(c1⊤+x⊤C2)y⩾γLx⩽ℓ.with x fixed. From the stance of the upper level the argminỹis the worst solution out of all lower level decisions that maximize the lower level objective with given K. Finally use theỹinstead of y in step 5.For a more realistic model it is important to include the constraint (3.5), such that it is possible for the lower level to reject the contract. If this constraint is included into (3.12), the same reasoning as above will lead to a modified problem[ULM+LLE]that consists of the objective and all constraints of (3.12) plus the additional constraint (3.5). Unfortunately the additional constraint is bilinear (in x and y) such that[ULM+LLE]is a bilinear problem with bilinear constraints. While algorithms, using branch-and-bound approaches, do exist for this type of problem (see Linderoth, 2005; Luedtke, Namazifar, & Linderoth, 2010), it might be more convenient to use a simpler method. First search for the largestK=K+such that all constraints of (3.4) plus the additional constraint (3.5) are feasible. This is a bilinear problem itself but by some simple line search algorithm (in K) it is easily possible to find the value with sufficient precision. Finally Algorithm 1 can be extended: ifK>K+in step 4 for the first time then setK=K+and solve (3.4) with this fixed K, which leads to a new value for y. Then go back to to step 4. IfK>K+for the second time, then go to step 8.In the competitive case with the upper level given by (3.7) we see that bilinear constraints, related to theAV@Rcalculation, are inherently present. While it is possible to reformulate the bilevel problem as a bilinear problem[ULC+LLE]by following the arguments in the previous section, but replacing the upper level (3.12) by (3.7), dealing with many bilinear constraints is much more involved than dealing with the single bilinear constraint (3.5).Denoting the upper level constraints in (3.7) by(3.14)x⊤gxn+y⊤gyn+x⊤Hny⩽β,for noden∈N, the full bilevel problem can be represented3Again we leave the details to the reader. Note e.g. that the indefinite quadratic partx⊤Hnyrefers to the productK·ynin (3.7).3by(3.15)[ULC+LLE]maxx,v;yx⊤f+x⊤Dy+λ[(c1+x⊤C2)y-b⊤v]Lx⩽ℓ,Ay⩽b,A⊤v-C2x⩾c1x⊤gxn+y⊤gyn+x⊤Hny⩽β(n∈N)(c1+x⊤C2)y⩾0y⩾0,v⩾0.Note that this formulation also includes constraint (3.5).For small trees a variant of the alternating optimization method works, if (3.5) is not included, i.e. if (3.4) is used as the lower level. Such a case is reported in Broussev and Pflug (2009) for the quantile pricing problem withAV@R constraint. LetG(K′)be the argmin ofmin Ksubject toAV@Rα(Y(K′,x1,…,xM))⩾q.Then it might be shown that the optimal K is the smallest fixpoint of G. This is due to the fact that for finite probability spaces,y∗is piecewise constant as a function of K, and the intervals of constancy can be found by looking at the dual variables at the lower level solution. The overall problem can then be solved by solving a sequence of linear programs.A second simple algorithm uses the fact that the strike price K is the main decision variable, determining the further decisions of both levels. A bracketing type procedure is used to find the lowest level of K such that all constraints are satisfied, and the dual gap of the lower level problem is closed. This is basically a sequence of feasibility problems that finds the minimal price, if the regionK=K:AV@Rα(Y(K,x̃))⩾qis a connected set. Algorithm 2 describes the approach: as before, the variable x denotes all decisions taken by the upper level and contains the strike price K and the hedge amountsx̃=(x̃1,…,x̃m).[LLE]is the lower level problem (3.4) augmented by the constraint (3.5). The function feas([OP]) applied to an optimization problem [OP] takes the values true if the problem is feasible and false if this is not the case. Again we assume for simplicity thatλhas been chosen large enough.Algorithm 2Feasibility search with simple bisectionRequire:K⩾0,∊1,∊2>0,M>01: Setlbound≔0,ubound≔2K,δ≔ubound-lbound,K∗≔∞2: whileδ>∊1do3: SetK≔(ubound-lbound)24: Solve[ULC+LLE]with K fixed, setfeas(UL)=true5: if it is feasible (and otherwise false)6:iffeas(UL)then7:Get the solutionsx̃,y,v8:Set the duality gapη≔(c1+x⊤C2)y-b⊤vforx=(K,x̃)9:endif10:if|η|>∊2orfeas(UL)=false then11:Solve[LLE]and setfeas(LL)=true if it is feasible12:(and otherwise false)13:iffeas(LL)= false then14:ubound≔K15:else16:lbound≔K17:end if18:else19:SetK∗≔K,x̃∗≔x̃,y∗≔y20:end if21:Setδ≔ubound-lbound22: end whileWhile this simple algorithm works fine in many cases, it should be kept in mind that the set of possible strike prices K such that all feasibility criteria are fulfilled might be unconnected for a given specification of theAV@R-constraints. In this case the algorithm only finds a local minimum, and lower feasible strike prices may exist. In order to deal with this problem it is possible to use a probabilistic version of the algorithm by settinglbound≔Kwith probabilitypjin line 20 of Algorithm 2 andlbound≔(K-lbound)2with probability1-pj. The probabilitypjshould be monotonically increasing with the number j of optimizations already calculated.To illustrate the peculiarities of the swing option pricing problem we consider two simplified swing contracts. All energy related quantities are expressed in units of TWh, while prices are in Euro/MWh and the profit is in Mega Euro.With this convention for units we setet‾≡5,E‾≡50and let theAV@R-parameter beα=0.15and the minimumAV@Rα-requirementq=-35. The spot price processStis modeled by a stochastic tree with 12 stages, consisting of 893 nodes, with 200 scenario (leaf) nodes. Based on historical spot prices we used simulated spot price scenarios (see Kovacevic & Paraschiv, 2013 for the estimation methods used) to construct the stochastic tree by a variant of Dupacova et al. (2003). Fig. 3shows the resulting spot price scenario tree. The internal pricesS∼twere set to 95% of the spot price, and the resulting processes were fitted to the tree. Finally, we introduced the possibility to use three futures products (with exercise periods of length 3) for hedging.We look at two cases, which differ with respect to lower bounds: in case A there are no lower bounds for the demands, i.e.et̲≡0andE̲=0. In contrast, case B is defined byet̲≡1andE̲=20.In both cases we want to analyze pricing strategies for the seller of the option. To this end we seek for the largest strike prices, such that the constraint (3.5) is fulfilled, and for the smallest strike price such that theAV@R-constraint of the upper level is fulfilled. This gives a whole range of possible strike prices. If the seller has some bargaining power, he/she will be able to enforce a higher price than the absolute minimum. If the seller is a monopolist, he/she will be able to set the price such that her expected profit is maximized, hence we also calculate the optimal monopolistic solution for cases A and B.Fig. 4shows the main results for both cases. The thick black lines, overlaying the x-axis, shows the set of strike prices that are feasible for both, upper and lower level. In case A it can be seen that for the chosenAV@R-parameters this area is not connected. The minimum feasible strike price isK̲=47.2, while there is no maximum feasible strike price in this case: for the lower level decision maker it is always possible to buy a zero amount in order to avoid expected losses. While theAV@Rof the upper level decision maker is below zero within the feasible region, the upper level expected payoff is positive for the whole range and shows a maximum atK∗≈48.9.Fig. 4 also shows the analogous results for the more realistic case B. The set of feasible strike prices is connected now. The minimum feasible strike price isK̲=42.4, while the maximum feasible strike price isK‾≈49.9. No contract will be signed at a higher price.AV@Rand Expectation broadly develop in parallel, with their maxima at49.1. Even in the monopolistic case it is not optimal for the seller to target the highest feasible price. The minimum constraint on demand is very favorable for the seller: in case B the smallest feasible strike price is lower and the optimal strike price with respect to expectation is higher than in case A. Furthermore, theAV@Rin case B is above zero for most of the feasible region. Finally, the expected profit at the optimal point is much higher for case B.Figs. 5 and 6show a comparison of lower and upper level effects, quantiles of the upper level profit and details of the hedging strategy for both cases, A and B.

@&#CONCLUSIONS@&#
Swing options are important types of derivatives at electricity markets, and finding a suitable strike price is a key problem for producers and traders. Because of the unique features of electricity markets the usual no-arbitrage methods for option pricing cannot be applied. As an alternative this article gave a survey of game theoretic approaches, modeling the decision process as a bilevel program, or Stackelberg-type game. After describing swing options and reviewing basic facts about (stochastic) bilevel programs we considered two basic (idealized) situations: the case of a monopolitic seller and the case of full competition. In the first case the seller of the option maximizes his/her profit, while in the second case he/she only has the aim to set the price such that a certain risk level is not exceeded (acceptability pricing). In both cases the buyer of the option is able to trade at the spot market or even reject to sign an offered contract.We also gave an overview of literature related to solution methods (see Table 1) for (stochastic) bilevel problems. Most of the classical methods are not feasible for the swing option pricing problem: extreme point algorithms can be applied only to linear bilevel problems, gradient methods need unique solutions and the usage of KKT conditions leads to untractably large instances. Therefore we proposed simple solution algorithms that are based on discretized reformulations as bilinear problems. The analyzed algorithms for both the monopolistic and the competitive case use bilinearity, penalize the duality gap of the lower level problem and account for the basic fact that the strike price decision determines all other lower and upper level decisions. Such approaches are especially useful in the context of big practical problems.Since riskless contracts do not exist in electricity markets, decision makers have to use an acceptability criterion for contracts. If W is the random net profit of a contract, thenW⩾0would be a clear criterion for acceptance. However, such riskless profit is not possible. For financial options, the price is considered to be correct if a hedge is found resulting inW=0a.s., but for electricity contracts, a hedge does not exist. An acceptability criterion accepts some W, even ifP{W<0}>W.The most important acceptability criterion used in practical situations is to accept W if(A.1)P{W<q}⩽α,i.e. if the probability of a shortfall below q loss is smaller than some predetermined small valueα. This is called quantile hedging/pricing, see e.g. Föllmer and Leukert (1999). Notice that using the value-at-risk functionalV@Rα(W)=inf{v:P{W⩽v}⩾α},V@Rα(W)⩾qis equivalent toP{W<q}⩽α. Unfortunately,Y↦V@Rα(Y)is not convex andV@R(Wx)is nonsmooth in the decision x, which makes the optimization problems very difficult. For this reason, we deal with concave minorants ofV@R.Concave minorants. Convex inner approximations of the (nonconvex) level sets{W:V@Rα(W)⩾q}={W:E[1(-∞,q](W)]⩽α}are given by{W:E[k(W)]⩽α}where k is a convex majorant of1(-∞,q]. Examples are the kinked linear functionska(u)=1a-q[u-a]-or exponential functionshb(u)=eb(q-u), see Nemirovski and Shapiro (2006). The conditionE1a-q[W-a]-⩽αfor somea⩾qis equivalent toq⩽a-1αE([W-a]-)for somea⩾q, which can be rewritten as(A.2)q⩽maxa-1αE([W-a]-):a∈R=AV@Rα(W)whereAV@Rα(W)is the average value-at-risk, also known as conditional value-at-risk (Rockafellar & Uryasev, 2000). Condition (A.2) can be rephrased as(A.3)∃a⩾q,∃Z⩾0such thatW-a+Z⩾0andq⩽a-1αE(Z).It is easily seen that condition (A.3) impliesV@Rα(W)⩾q.As an alternative to the quantile pricing method, one may also consider utility functions U and accept a contract, ifE[U(W)]⩾q. However, the price will then depend on the choice of the entire utility function while in quantile pricing only two parameters, the threshold q and the confidence level1-αhave to be set by the management.