@&#MAIN-TITLE@&#
A multi-step directional generalized gradient vector flow snake for target tumor segmentation in US-guided high-intensity focused ultrasound ablation

@&#HIGHLIGHTS@&#
We propose a multi-step directional GGVF snake model for target tumor segmentation.The model integrates the gradient directional information and the magnitude information on the distance map.The model shows some improvements to deal with unwanted neighboring edges and highlight the real edges.The influences of the spurious boundaries and the speckle noise are significantly reduced.This technique is greatly useful for target tumor segmentation in HIFU treatment system.

@&#KEYPHRASES@&#
US-guided HIFU system,GGVF snake model,Tumor segmentation,Gaussian filter,Distance map,Edge map,Noise reducing,

@&#ABSTRACT@&#
Getting precise locations of target tumors can help to ensure ablation of cancerous tissues and avoid unwanted destruction of healthy tissues in high-intensity focused ultrasound (HIFU) treatment system. Because of speckle noise and spurious boundaries in ultrasound images, traditional image segmentation methods are not suitable for achieving the precise locations of target tumors in HIFU ablation. In this paper, a multi-step directional generalized gradient vector flow snake model is introduced for target tumor segmentation. In the first step, the traditional generalized gradient vector flow (GGVF) snake is used to obtain an approximate contour of the tumor. According to the approximate contour, a new distance map is generated. Subsequently, a new directional edge map is created by calculating a scalar product of the gradients of the distance map and the initial image. In this process, the gradient directional information and the magnitude information of the distance map are used to attenuate unwanted edges and highlight the real edges in the new directional edge map. Finally, a refined GGVF field is derived from a diffusion operation of the gradient vectors of the directional edge map. The GGVF field is used to refine the tumor's contour, by directing the approximate contour to edges with the desired gradient directionality. Based on the newly developed snake model, the influences of the spurious boundaries and the speckle noise are significantly reduced in the ultrasound image segmentation. Experimental results indicate that this technique is greatly useful for target tumor segmentation in HIFU treatment system

@&#INTRODUCTION@&#
Extracorporeal ablation with HIFU is capable of producing coagulative necrosis in organ tissues by focusing acoustic energy to a focal point inside the body without skin incision [1]. In the last decade, this technique has been used to treat patients with both benign and malignant solid tumors, of which include benign prostate hyperplasia, breast cancer, liver cancer and uterine fibroids [2–7]. Recently, HIFU ablation has been performing as a safe, noninvasive and effective oncology treatment modality according to clinical practices.In the HIFU treatment system, achieving precise locations of the target tumors can help to ensure ablation of cancerous tissues and avoid unwanted destruction of healthy tissues. At present, magnetic resonance imaging (MR) and ultrasound imaging (US) show a high potential in target location of tumors with noninvasive imaging technique. In contrast to MR-guided HIFU system [8–10], US-guided HIFU system presents a great cost advantage as well as a real-time imaging velocity. A US-guided HIFU system developed by Wang and his team from Chongqing University of Medical Sciences has been used to treat patients with various kinds of malignancies successfully, especially advanced pancreatic cancer [11–14]. Many works by other teams have covered the feasibility of US-guided HIFU treatments [15–17].The precision of the target location is strongly influenced by the quality of the ultrasound images. However, ultrasound imaging system always produces low quality images with speckle noise and shadows [18]. The variability of tumor echogenicity [19] and the non-uniform contrast between certain tissues make it difficult to obtain a good segmentation. The above properties of ultrasound images in practice are normally challenging to traditional image segmentation methods [20] such as region growing and edge detection. To solve these difficulties, the traditional active contour model (snakes) [21], which provides a deformable contour to move toward the image edges under the influence of internal and external forces, has been proposed as one of the greatest potential methods for image segmentation and object tracking. Compared with other image segmentation methods, snakes are self-adapting in their search for minimizing the energy functional. They can be easily achieved using external image forces. However the traditional snake model is limited in practical application due to diminutive capture range and inability to converge to concavities and sharp corners. In order to address these issues, many researches were devoted to designing the external image forces for snakes such as balloon force [22], distance potential force [23], gradient vector flow (GVF) [24]. The GVF field is derived from a diffusion operation of the gradient vectors of a binary edge map, which outstrips other force fields in capture range extending and boundary concavities convergence. As a result, GVF force has been the most widely used external force in numerous medical image analyses. The GVF snake was also modified in different ways to further improve the performance of the snake model. To take advantage of the prior directional information in discerning between positive and negative step edges, the dynamic directional gradient vector flow (DDGCF) was proposed by Cheng [25]. A directional edge map obtained from a scalar product of the image gradient and a unit vector in the directionality of the edge is used to define a new directional GVF field that directs the contour to boundaries with gradients [26]. In other studies [27], a two-step directional gradient vector flow (DGVF) segmentation algorithm was proposed to segment live cells in phase-contrast images. In addition, there are still a lot of other variants related to the GVF field, such as the multi-scale GVF field [28], the extended GVF field [29], the fast gradient vector flow based on augmented Lagrangian method [30].Because of low signal-to-noise ratio (SNR) and low contrast between target tumors and other tissues in ultrasound images, it is still difficult and challenging to achieve precise locations for HIFU ablation. When the energy functional falls into local minima, the evolution of the snake may be stopped unexpectedly by the spurious boundaries caused by noise or other tissues. In this paper, we cooperate with Chongqing University of Medical Sciences in exploring a multi-step directional GGVF snake model for ultrasound image segmentation. The first step starts from the preprocessing of the original image with a Gaussian filter which inhibits speckle noise while reserving good boundaries. In the filtering process, the standard deviation of the Gaussian filter is often set large enough to reduce the influences from noise and other tissues, which stops the snake contour from moving toward spurious boundaries. However, unfortunately, the details of the target tumors are partially lost at the same time. After pretreatment, a generalized GVF (GGVF) vector field is built by the diffusion of the gradient vectors of the edge map. As a result, an approximate contour close to the real boundaries is obtained with the influence of the GGVF force field. In the second step, a new distance map is generated by calculating a new weighted distance formula associated with the approximate contour. The gradients of the distance map have desirable directions and different magnitudes (large magnitudes near the contour and small magnitudes far from the contour). Besides, in order to highlight the details of the target tumors, the original image is re-filtered with a small standard deviation of Gaussian filter. By using the calculation of the scalar product of the gradients of the distance map gradient and the re-filtered image, a directional edge map is obtained. In this process, the gradient directional information and the magnitude information of the distance map are used to attenuate unwanted edges and highlight the real edges in the new directional edge map. Subsequently, a refined GGVF field is derived from a diffusion operation of the gradient vectors of the directional edge map. Based on the refined GGVF field, the approximate contour obtained from the first step is directed to the real boundary of the tumor. The steps above are repeated until the contour of the target tumor is no longer changed. Finally, a precise contour of the target tumor is obtained with the help of the multi-step directional GGVF snake model.As shown below, the algorithm has been applied in ultrasound image segmentation for the target location of different tumors. The results indicate that the location of the target tumor is much more precise with multi-step directional GGVF snake model than with traditional GVF snake model. The modified GVF snake model is reliable, accurate and stable for ultrasound image segmentation in US-guided HIFU ablation.The rest of this paper is organized as follows. In the next subsection, the original GVF snake model and its solution are briefly described. Then, some factors affecting accuracy in target tumor segmentation are pointed out. In the fourth subsection, the proposed multi-step directional GGVF snake model is given in detail. Besides, the performance of the algorithm in US-guided HIFU ablation is presented in compared with the traditional GVF snake. Finally, we discuss the limitations of this approach and give a prospect of this research area in the next step.According to Kass et al. [16], a traditional snake is a curveX(s)=[x(s), y(s)](s∈[0, 1]). The final boundaries are determined by minimizing the following energy functional(1)E=∫0112(α|X′(s)|2+β|X″(s)|2)+Eext(X(s))dswhere α and β are two weighting coefficients associated with the snake's tension and rigidity, respectively. The first two formulas represent the internal energy function, which control the curve changes, while the last formula represents the external energy function, which is derived from the image and appointed to smaller values for the feature of interest.To minimize the energy function, an Euler equation must be satisfied:(2)αX″(s)−βX⁗(s)−∇Eext=0The equation can be regarded as a force balance equation:(3)Fint+Fext=0whereFint=αX″(s)−βX″″(s), andFext=−▿Eext. The external forceFext can be constructed in different situations to pull the curve to the desired boundaries in the image.To solve Eq. (2), the deformable contour evolves as a function of time t given by:(4)Xt(s,t)=αX″(s,t)−βX⁗(s,t)−∇EextHowever the traditional snake model is limited in practical application due to diminutive capture range and inability to converge to concavities and sharp corners. To address these issues, Xu and Prince proposed GVF snake force as a new external force [19]. The GVF vectors fieldV(x,y)=[u(x,y),v(x,y)]used to replace the external forceFext is obtained by minimizing the following energy functional:(5)ε=∬μ(ux2+uy2+vx2+vy2)+|∇f|2|V−∇f|2dxdywhere μ is the weighting parameter, which is set according to the image noise, and f(x,y) is the edge map of the image. Using the variational method [31], the minimum value of the energy functional can be acquired by solving these following Euler equations:(6a)μ∇2u−(u−fx)(fx2+fy2)=0(6b)μ∇2v−(v−fy)(fx2+fy2)=0where ▿2 is the Laplacian operator. The value of the second term is close to zero in homogeneous regions, since the gradient of the edge map is zero. Thus, in such regions, u and v are dominated by Laplace's equation, resulting in a diffusion of the gradient vectors of the regions’ boundaries. The numerical implementation method of these two Euler equations is regarding u and v as the function of time t:(7a)ut(x,y,t)=μ∇2u(x,y,t)−(u(x,y,t)−fx)(fx2+fy2)(7b)vt(x,y,t)=μ∇2v(x,y,t)−(v(x,y,t)−fy)(fx2+fy2)The equations in Eq. 7 are known as generalized diffusion equations. Therefore, the calculation process can be regarded as a diffusion of the gradient vectors of the edge map derived from the image. GVF snake model greatly extends the capture range of the traditional snake model and can move snakes into boundary concavities.In ultrasound images, speckle noise is the inherent noise pattern evoked by the mechanism of ultrasound imaging. Thus, before image segmentation, a noise reduction technique is necessary to improve the accuracy of target segmentation. Typically, a Gaussian filter is used to reduce the noise before the edge map is obtained in GVF snake model. For step edges, the edge map can be described as the following equation:(8)f(x,y)=|∇(Gσ(x,y)×I(x,y))|2where Gσ(x, y) is a two-dimensional Gaussian function with a standard deviation σ. In Fig. 1, a noisy heart-shaped image is segmented by using GVF model with different σ. When σ is small, the contour preferably reflects the details of the shape, while it may move toward spurious boundaries as shown in Fig. 1(e). On the contrary, the contour moves close to the real boundaries with large σ as shown in Fig. 1(h), while it may loss the details of the shape. Thus, it is necessary to find a solution to choose a suitable value of σ in ultrasound images segmentation.Because of the mechanism of ultrasound imaging, many spurious boundaries generated by non-target objects such as non-target tissues and inhomogeneous white light spots are ubiquitous in ultrasound images as shown in Fig. 2. Sometimes, the gradient intensity of spurious boundaries is higher than that of real boundaries. As a result, the GVF vector field pointing to the real boundaries is influenced by the spurious boundaries, especially when the spurious boundaries are close to the target tumor. In Fig. 2(b), line1, line2 and line3 are hand-drawn to represent three boundaries, respectively. Among them, line1 is the real boundary, while line2 and line3 are the unwanted boundaries. However, it is noted that the gradient intensity of line2 is much higher than that of line1 as shown in Fig. 2(c). Thus, the vectors pointing to line1 are changed with the influence of line2, leading to a bad convergence. In order to discuss this issue intuitively, an example is given in Fig. 3. The circle is the target object, while the rectangle is the non-target object in Fig. 3. Without the influence of the rectangle, the GVF vector field points to the circle's boundary, resulting in a good convergence as shown in (a)–(d). Whereas, with the influence of the rectangle, the GVF vector field is changed in (g), leading to a bad convergence in (h). Consequently, it is important to reduce the influence of spurious boundaries for accurate image segmentation.These two factors seriously affect the accuracy in target tumor segmentation. Our multi-step directional GGVF snake model is proposed to improve on these issues in the next subsection.We use GGVF snake model to obtain an approximate contour. Compared with the original GVF, GGVF improves active contour convergence to a long, thin boundary indentation [32]. The GGVF vector field is computed by a diffusion process, which can be described as follows:(9a)g(|∇f|)∇2u−(1−g(|∇f|))(u−fx)=0(9b)g(|∇f|)∇2v−(1−g(|∇f|))(v−fy)=0where g(|▿f|)is a decreasing function of |▿f| as follows:(10)g(|∇f|)=exp−|∇f|kwhere k is a regularization parameter for the vector field[u(x,y),v(x,y)], which determines the degree of tradeoff between gradient conformity and field smoothness.As mentioned above, it is necessary to choose a suitable value of σ to mitigate the influence from noise. Although large σ may cause the boundaries to become blurry, large σ is often necessary for capture range extending. Besides, in comparison with the convergence result of the contour with small σ, the convergence result with large σ is closer to the real boundaries as shown in Fig. 1. Therefore, in our proposed multi-step directional GGVF snake model, the standard deviation σ of the Gaussian filter is set large enough to ensure the contour be close to the real boundaries in the first step. Then it will be reduced gradually to correct the contour and highlight the details of the target tumors in the following steps.As a result, an approximate contour close to the real boundaries is obtained with the influence of the GGVF force field in the first step.Here, a new distance map is defined associated with the approximate contour. Firstly, a normal distance is obtained by calculating the minimal Euclidean distance of any point (x,y) in the image from the approximate contourX(s)=[x(s), y(s)](s∈[0, 1]):(11)D(x,y)=mins∈[0,1][x−x(s)]2+[y−y(s)]2The normal distance reflects the minimal distance of each point from the approximate contour. Then, different from the definition of the calculation formula of distance in [23,27], a new weighted distance is defined as follows:(12)Dw(x,y)=−D(x,y)⋅exp−D(x,y)aba>0,b>0where a, b are two coefficients that control the descending velocity of the weighted distance. The function curve of the distance formula is shown in Fig. 4. It is noted that the inflection point of this function is (loga(b/a), −loga(b/a)exp(−1/a)).In order to enable the gradient of the distance map to point to the approximate contour, the distance function should be a decreasing function, i.e., the longer the distance of the point from the approximate contour, the lower the function value is. However, the weighted distance is a non-monotonic function of the normal distance as shown in Fig. 4. To guarantee the monotonic property of the function, the normal distance D(x,y) must satisfy the inequality:(13)D(x,y)≤logabaWe define Dmax as the maximum value of D(x,y), and assign the value of b to conform to the equation:(14)b=aDmaxaThus, Eq. (12) is changed to a decreasing function as follows:(15)Dw(x,y)=−D(x,y)⋅exp−D(x,y)aaDmaxaFrom Eqs. (11) and (15), we can obtain the new distance map, of which the gradients point to the approximate contour. Actually, we are more interested in the gradient of the distance map, for the gradient can be used to define a new GVF edge map. In general, the first order derivative of the distance function can greatly reflect the gradient of the distance map. Here, we get the first order derivative of the Eq. (15):(16)D′w(x,y)=D(x,y)aDmaxa−1⋅exp−D(x,y)aaDmaxaThe curves of the first order derivative with different a are shown in Fig. 5, and the value of Dmax is 100 here. We can note that all the curves start from the point (0,−1) and rise gradually till to the point (100, 0). The sign of the derivativeD′w(x,y)represents the direction of the gradient of the distance map. The negative sign reflects that the direction of the gradient points to the approximate contour. Besides, the absolute value ofD′w(x,y)indicates the magnitude of the gradient. With the increase of the normal distance, the magnitude of the gradient in the distance map decreases gradually. The effect of the coefficient a on the gradient of the distance map is shown in Fig. 5. When a is small, the magnitude of the gradient decrease rapidly, while when a is large, the magnitude of the gradient decrease slowly.An example is given to generate a new distance map in Fig. 6, and the value of a is 4 here. By using the GGVF snake model in step 1, an approximate contour is obtained as shown in Fig. 6(b). We use Eqs. (11) and (15) to generate a new distance map of the contour, and give 3D solid figure as well as 2D figure of the distance map in Fig. 6(c) and (d). The figures suggest that the weighted distances of the points near the contour are larger than those of the points far away from the contour. The red box of Fig. 6(d) is in any position of the distance map. It is noted that the gradients of the distance map are all in the desired directions that point to the approximate contour as shown in Fig. 6(e) and (f) shows the magnitude of the distance gradient. With the increase of the distances between the points and the contour, the magnitudes of the gradients in the new distance map decrease gradually.As mentioned in [26,27], a new directional edge map can be redefined by using the calculation of the scalar product of a 2D vector field and the filtered image gradient. Different from Eq. (8), the formula for calculating the new edge map fnew(x, y) is as follows:(17)fnew(x,y)=−h(x,y)2h(x,y)≥00h(x,y)<0where h(x, y)=∇(Gσ(x, y)×I(x, y))·n(x, y), and n(x, y) represents the 2D vector field. Typically, these vectors have unit magnitude and point out to the desired directions of the filtered image gradients near the real boundaries. The desired directions here are aligned perpendicular to the real boundaries and pointing outwards the boundaries (from dark to light). The scalar product gives high values for the filtered image gradients that have the desired directions and low values for the filtered image gradients that have different directions. Especially in the opposite direction, the value of the scalar product is 0. Thus, the 2D vector field helps to refine the original edge map by highlighting the desired edges and eliminating the unwanted edges. As a result, the influences of the spurious boundaries discussed above are greatly diminished.In this subsection, the gradient of the new distance map proposed in step 2 is used to define the vector field n(x, y). As shown in Fig. 7, the distance gradient (Fig. 7(d)) and the filtered image gradient (Fig. 7(e)) are all aligned perpendicular to the approximate contour of the live tumor, while they are varied in different directions. Obviously, if the gradients of the points outside the contour are changed in opposite directions, the newly generated vectors (Fig. 7(f)) are in the desired directions of the filtered image gradient (Fig. 7(e)) near the real boundaries. From Eq. (15), the weighted distances of the points on the contour are the highest value in the distance map, which may cause miscalculations of the distance gradients in these points. In general, the edges near the real boundaries need to be preserved. Therefore, the newly generated vectors of these points on the contour are assigned unit magnitude and have the same directionality of ∇ϕ proposed in [27]. The newly 2D vector field can be generated as follows:(18)n(x,y)=∇Dw(x,y),ifpoint(x,y)isinsidethecontour∇ϕ(x,y),ifpoint(x,y)isonthecontour−∇Dw(x,y),ifpoint(x,y)isoutsidethecontourThe 2D vectors in [26,27] have unit magnitudes and desired directions. Therefore, the attenuation of the unwanted edges is only relying on the directionalities of the vectors. The vector field proposed in this paper is ameliorated by concerning not only the directionalities of the vectors but also the magnitudes of the vectors. As is shown in Figs. 5 and 6(f), the magnitudes of the vectors decrease gradually with the increase of the distances from the contour. Because the approximate contour obtained in step 1 is close to the real boundaries of the target tumor, the new directional edge map can preserve the magnitudes of the desired edges near the boundaries and reduce the magnitudes of the unwanted edges far away from the boundaries. Depending on the coefficient a in Eq. (15), the decline range of the vector's magnitude at every point can be changed. The initial edge map of Fig. 7(a) is shown in Fig. 8(a), and the new directional edge map is shown in Fig. 8(b). The coefficient a in the figure is set to 2. It is intuitively clear that the unwanted edges are eliminated in the new directional edge map. As a result, the influences of the unwanted spurious boundaries are mitigated significantly.According to Eq. 9, a refined GGVF vector field is built by the diffusion of the gradient vectors of this directional edge map. The approximate contour is appointed as the initial contour because it is close to the real boundaries of the tumor. Then, the approximate contour is driven iteratively to the real boundaries until the GGVF snake converges. Because the initial contour is near the real boundaries, relapsing of the snake into local convergence is avoided. Therefore, the standard deviation σ in step 3 can be properly reduced to correct the contour and highlight the details of the target tumor. Finally, we obtain a new contour, which is more precise than the approximate contour obtained in step 1.In this step, the new contour obtained in step 5 is also used to redefine a new directional edge map and the standard deviation σ is adjusted to a small value to preserve the details of the target tumors. Thus, step 2–step 5 is repeated multiple times to get more precise contour near the real boundaries of the tumor. More commonly, the proposed multi-step directional GGVF snake model is stopped in step 5.In order to test the accuracy of our proposed algorithm in ultrasound image segmentation, we use area overlap measure (AOM) [33] to evaluate the agreement between the computerized segmentation and a referred segmentation:(19)AOM(S1,S2)=area{S1∩S2}area{S1∪S2}×100%where S1 and S2 denote the regions of the computerized segmentation and the referred segmentation, respectively. The computerized segmentation is obtained by using image segmentation algorithm, and the referred segmentation is obtained from manual segmentation. Two medical physicians skilled in HIFU ablation are invited to manually segment ultrasound images. In order to ensure the accuracy of the manual segmentation, each image are segmented twice by each physician in an independent way, i.e., at different times and without considering the first segmentation while segmenting the second one. These 4 manually delineated segmentations are all considered as our ground truth to compute AOM, since they are generally robust and reliable without gross error. Then the average AOM is used to evaluate the agreement between the computerized segmentation and the manual segmentation.

@&#CONCLUSIONS@&#
