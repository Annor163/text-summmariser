@&#MAIN-TITLE@&#
Multi-stage stochastic fluid models for congestion control

@&#HIGHLIGHTS@&#
We present multi-stage stochastic fluid models for congestion control.These models are driven by applications in telecommunications and manufacturing.We use elegant matrix-analytic methods and direct analysis methods.We derive efficient methodology for the transient and stationary analysis.

@&#KEYPHRASES@&#
Stochastic fluid model,Markov chain,Laplace–Stieltjes transform,Matrix-analytic methods,Congestion control,

@&#ABSTRACT@&#
We consider multi-stage stochastic fluid models (SFMs), driven by applications in telecommunications and manufacturing in which control of the behavior of the system during congestion may be required. In a two-stage SFM, the process starts from Stage 1 in level 0, and moves to Stage 2 when reaching thresholdb2from below. Stage 1 starts again when reaching thresholdb1<b2from above. While in a particular stage, the process evolves according to a traditional SFM with a unique set of phases, generator and fluid rates. We first consider a two-stage SFM with general, real fluid change rates. Next, we analyze a two-stage SFM with an upper boundaryB>b2. Finally, we discuss a generalization to multi-stage SFMs. We use matrix-analytic methods and derive efficient methodology for the analysis of this class of models.

@&#INTRODUCTION@&#
Consider an unbounded stochastic fluid model (SFM){(φ(t),X(t)),t⩾0}with phase variableφ(t)∈S={1,…,m}, level variableX(t)∈(-∞,+∞), generatorT=[Tij]i,j∈S, and real ratesci∈(-∞,+∞), for alli∈S, defined by the following set of conditions:•the phase process{φ(t),t⩾0}is an irreducible, continuous-time Markov chain (CTMC) with finite state spaceSand generator matrixTwhich records instantaneous transition ratesTij=dP(X(t)=j|X(0)=i)/dt|t=0between the phases,the levelX(t)at time t is changing at a constant rateci=dX(t)/dtwhenφ(t)=i, for somei∈S, see Fig. 1.The phase variable may be used to model the behaviour of the underlying environment in some system of interest, while the level variable may be used to model a continuous performance measure of the system. As a simple example, phase may record which switch is currently on in a telecommunications buffer, while level may be the amount of data currently in the buffer. Since the phase process modulates the behaviour of the level through the ratesci, we refer to the CTMC{φ(t),t⩾0}as the driving process. In particular, given the initial levelX(0)and the full history of the process{φ(t),t⩾0}, the evolution of the process{X(t),t⩾0}is then completely determined, since the only element of randomness is coming from the driving CTMC. For the results from the theory of the SFMs, the development of which was motivated by the applications in telecommunications, the reader is referred to Ahn and Ramaswami (2003, 2004, 2005), Asmussen (1995), Bean and O‘Reilly (2013), Bean, O‘Reilly, and Taylor (2005a, 2005b, 2008), da Silva Soares and Latouche (2002), O’Reilly and Palmowski (2013), Ramaswami (1997, 1999).Now, suppose that we want to model a situation in which a congested buffer may need to operate under a different regime, with lower input rates for example. In order to achieve this, we introduce thresholdsb1andb2for controlling congestion. Specifically, the process starts from level 0 in Stage 1 (original regime) and when it first hits thresholdb2>0from below, it moves to Stage 2 (a different regime). Following this, when it hits thresholdb1<b2from above, it moves to Stage 1 again. Of course, if the process is already in Stage 1, then no change of stage occurs upon hitting levelb1. Whenever in a particular stage, the process evolves according to the traditional SFM with a unique set of phases, generator and fluid rates. We refer to such model as a two-stage SFM and illustrate it in Fig. 2. This class of models for controlling congestion in telecommunications buffers, is motivated by and contains a model with two thresholds introduced by Malhotra, Mandjes, Scheinhardt and van den Berg in Malhotra, Mandjes, Scheinhardt, and van den Berg (2009).Formally, we define a two-stage stochastic fluid model (SFM), denoted by{(φ(t),X(t),Z(t)),t⩾0}, with phase variableφ(t), level variableX(t)⩾0, stage variableZ(t)∈{1,2}, and thresholdsb1,b2, with0<b1<b2<B, whereB<∞orB=∞, as follows.LetS(ℓ)={1,…,mℓ}be the set of phases,T(ℓ)be the generator matrix, andci(ℓ)for alli∈S(ℓ)be the rates corresponding to the (SFM of) Stageℓ, forℓ∈{1,2}. We say that Stageℓ, for anyℓ∈{1,2}, is (an SFM) driven by a CTMC with state spaceS(ℓ)and generatorT(ℓ).•We assumeφ(0)∈S(1),X(0)=0,Z(0)=1. That is, the process starts from level zero in Stage 1, driven by a CTMC with state spaceS(1)and generatorT(1).WhileZ(t)=1, the process is in Stage 1. In such case, wheneverφ(t)=iandX(t)>0, the rate of change of levelX(t)is given by a constantci(1), for alli∈S(1). Whenφ(t)=iandX(t)=0however, the rate of change of fluid ismax0,ci(1), since zero in the lower boundary in the buffer.Following this, as soon asX(t)=b2, the phase process moves to some phase inS(2)={1,…,m2}, according to the probability matrixP(b2). Also,Z(t)moves from 1 to 2, and we say that Stage 2 begins, driven by a CTMC with state spaceS(2)and generatorT(2).WhileZ(t)=2, the process is in Stage 2. In such case, wheneverφ(t)=i, the rate of change of levelX(t)is given by a constantci(2), for alli∈S(2).Following this, as soon asX(t)=b1, the phase process moves to some phase inS(1)according to the probability matrixP(b1). Also,Z(t)moves from 2 to 1, and Stage 1 begins again.In the case with a finite upper boundaryB<∞, we assume that whenφ(t)=i∈S(2)andX(t)=B, then the rate of change of fluid is given bymin0,ci(2). That is, when the bufferX(.)becomes full, it can only then start to decrease (whenci<0) or remain at the same level (whenci⩾0).We partitionP(b2)according toS1(1)×S1(2)∪S2(2)∪S0(2), andP(b1)according toS2(2)×S1(1)∪S2(1)∪S0(1), as(1)P(b2)=P11(b2)P12(b2)P10(b2),P(b1)=P21(b1)P22(b1)P20(b1).In this paper, we analyze the two-stage SFM with and without an upper boundary (B<∞andB=∞), respectively, and also consider a generalization to multi-stage SFMs.Compared to the earlier mentioned model of Malhotra, Mandjes, Scheinhardt and van den Berg in Malhotra et al. (2009), the two-stage SFM is more general and possesses the following set of useful properties.•We assume any real ratesci(ℓ),i∈S(ℓ), which allows to treat systems with general input rates.The change at the moment of the transition between the stages may involve not only the change in generatorT(ℓ), but also the change in the set of phasesS(ℓ), which may be useful for recording the changes in the underlying environment of a system of interest in a more practical manner.The change inci(ℓ)at the moment of the transition between the stages allows all possible types of changes of sign (from+or-to+,-and 0), which may be needed in a system with general input rates.We treat the model with an upper boundaryB<∞, which is a more realistic assumption for modeling real-life buffers.We consider a generalization to multi-stage SFMs, which allows to model multiple-threshold based regimes for modeling congestion.More importantly, apart from the above listed generalizations of the model itself, we make the following contribution in terms of the methodology provided. Specifically, we would like to note that the analysis in Malhotra et al. (2009) was based on solving appropriate balance equations using a spectral expansion, and as the authors emphasized there, was difficult.Here, we apply arguments within the theory of the matrix-analytic methods (MAMs) (Ramaswami, 1997, 1999), in particular the methods of direct analysis of SFMs developed in Bean et al. (2005b, 2009), which involve sample path decomposition and the use of the key fluid generatorQ(s)introduced in Bean et al. (2005b). The advantages of such methodology are that the expressions are in a matrix form that do not require the use of eigenvalues, and have useful probabilistic interpretation. This makes the analysis concise and leads to efficient numerical methods based on the existing powerful algorithms (Ahn & Ramaswami, 2005; Bean et al., 2005a, 2008; Bini, Iannazzo, Latouche, & Meini, 2006; Guo, Iannazzo, & Meini, 2007).Additionally, Malhotra et al. (2009) deals with the stationary analysis only. Here, we provide both time-dependent and stationary analysis of this more general model, and introduce ratesδ2→1,δ1→2andr2→1,r1→2as a measure of transient and stationary tendency of switching between the two stages, respectively.Some other related models include the multi-layer model of Bean, O’Reilly and Taylor in Bean and O‘Reilly (2008), and the model of da Silva Soares and Latouche in da Silva Soares and Latouche (2009). Unlike in the current model, both models assume that the process has unique parameters within each layer which is defined by an upper and lower threshold. The two models differ slightly from one another in their assumptions about the behaviour at the boundaries between the layers. The results in Bean and O‘Reilly (2008) focus on the Laplace–Stieltjes transforms (LSTs) of time-dependent measures, while da Silva Soares and Latouche (2009) provides stationary analysis. Some arguments used here are similar to those used in Bean and O‘Reilly (2008), da Silva Soares and Latouche (2009), as the methodology developed here uses building blocks from the theory of SFMs, which we detail in the following section.Congestion control, which the class of models introduced here addresses, is a classic problem with close relevance to telecommunications as well as manufacturing, with a range of methods studied (Baek, Lee, Lee, & Ahn, 2011; Bean & O‘Reilly, 2008; Buxey & Slack, 1973; da Silva Soares & Latouche, 2009; Horvth & Van Houdt, 2012; Malhotra et al., 2009; Mandjes, Mitra, & Scheinhardt, 2003; van Foreest, van Ommeren, Mandjes, & Scheinhardt, 2005; Van Houdt, 2012). Approaches for congestion control include the models studied within the Infinitesimal Perturbation Analysis literature (Cassandras, Sun, Panayiotou, & Wardi, 2003; Sun, Cassandras, Wardi, & Panayiotou, 2003; Xia & Cao, 2012), in which gradient estimators of measures of interest are derived in order to implement them for network control through the perturbation of parameters.An example of a direct application of the two-stage model defined above in manufacturing is discussed in our upcoming paper, where we present a case study on the wrapping section at a chocolate factory. In that real-life example, once the excess buffer collecting chocolates from the factory line reaches a certain upper threshold, the line is turned off and a new regime starts. Following this, once a lower threshold is reached, the line is turned back on and the original regime starts again. The lower threshold is chosen in order to avoid the need for too frequent turning off and on. This further motivates our choice of the upper thresholdsb2and lower thresholdb1, with necessarilyb1<b2, marking the start and the end of Stage 2 in the two-stage model, respectively.Remark 1As one alternative, one could assume the existence of the reflective states such that no change of stage occurs upon reaching thresholdb2from below if the level starts decreasing at that point. The analysis for such modified model, which is not of interest here, can be readily obtained by a slight modification of the results developed here.In this section we state the key results from the SFMs literature, which will be used in the analysis of the multi-stage SFMs in further sections. Consider the traditional SFM{(φ(t),X(t)),t⩾0}described in Section 1. We introduce the following partitioning of the setS. Define setsS1={i∈S:ci>0},S2={i∈S:ci<0},S0={i∈S:ci=0}. That is,S1,S2andS0are disjoint subsets ofScontaining phases with positive, negative and zero rates, respectively. Furthermore, we partition the generator according to the partitioningS=S1∪S2∪S0as(2)T=T11T12T10T21T22T20T01T02T00.Letθ(x)=inf{t>0:X(t)=x}be the first time the process reaches level x, andf(t)=∫0t|cφ(t)|dtbe the total amount of fluid that has flowed into or out of the bufferX(.)during the time interval(0,t].SupposeX(0)=0, and letω(y)=inf{t>0:f(t)=y}be the first time the total amount of fluid that has flowed into or out of the bufferX(.)reaches level y. Define matrixQ(s), introduced by Bean, O’Reilly and Taylor in Bean et al. (2005b), such that(3)Q(s)=Q11(s)Q12(s)Q21(s)Q22(s),withQ11(s)=C1-1(T11-sI+T10(sI-T00)-1T01),Q12(s)=C1-1(T12+T10(sI-T00)-1T02),Q21(s)=C2-1(T21+T20(sI-T00)-1T01),Q22(s)=C2-1T22-sI+T20(sI-T00)-1T02,whereC1=diag{ci}i∈S1andC2=diag{|ci|}i∈S2. Also, letC=C100C2.MatrixQ(s)is a key fluid generator of the SFMs (Bean et al., 2005b), with the physical interpretation such that, for alli,j∈S1∪S2,(4)[eQ(s)y]i,j=E(e-sω(y)I(φ(ω(y))=j)|φ(0)=i,X(0)=0)is the Laplace–Stieltjes transform (LST) of the time until the total amount of fluid that has flowed into or out of the bufferX(.)reaches y and does so in phase j, assuming start at level zero and phase i. Here,I(.)denotes an indicator function taking value 1 if the statement is true and 0 otherwise.Define matricesΨ(s)=[Ψ(s)ij]i∈S1,j∈S2,G(x)(s)=[G(x)(s)ij]i,j∈S1∪S2, andH(x)(s)=[H(x)(s)ij]i,j∈S1∪S2such that(5)Ψ(s)ij=E(e-sθ(0)I(φ(θ(0))=j)|φ(0)=i,X(0)=0),(6)G(x)(s)ij=E(e-sθ(0)I(φ(θ(0))=j)|φ(0)=i,X(0)=x),(7)H(x)(s)ij=E(e-sθ(x)I(φ(θ(x))=j)|φ(0)=i,X(0)=0).Also, defineΞ(s)=[Ξ(s)ij]i∈S2,j∈S1such thatΞ(s)ijis given by the right-hand side of (5), where we carefully note that the physical interpretations ofΨ(s)andΞ(s)are symmetrical (Bean et al., 2005b).We partitionG(x)(s)andH(x)(s)according toS1∪S2as(8)G(x)(s)=0G(x)(s)120G(x)(s)22,H(x)(s)=H(x)(s)110H(x)(s)210.Also, defineG(x,y)(s)=[G(x,y)(s)ij]i,j∈S1∪S2, andH(x,y)(s)=[H(x,y)(s)ij]i,j∈S1∪S2such that(9)G(x,y)(s)ij=E(e-sθ(0)I(θ(0)<θ(y),φ(θ(0))=j)|φ(0)=i,X(0)=x),(10)H(x,y)(s)ij=E(e-sθ(y)I(θ(y)<θ(0),φ(θ(y))=j)|φ(0)=i,X(0)=x),and partition(11)G(x,y)(s)=0G(x,y)(s)120G(x,y)(s)22,H(x,y)(s)=H(x,y)(s)110H(x,y)(s)210.By Bean et al. (2005b), matricesG(x)(s)andH(x)(s)are given by(12)G(x)(s)12=Ψ(s)G(x)(s)22,G(x)(s)22=e(Q22(s)+Q21(s)Ψ(s))x,(13)H(x)(s)21=Ξ(s)H(x)(s)11,H(x)(s)11=e(Q11(s)+Q12(s)Ξ(s))x,and each matrixΨ(s)andΞ(s), fors>0, is the minimum non-negative solution of an appropriate Riccati equation (Bean et al., 2005b), which can be solved by fast algorithms (Ahn & Ramaswami, 2003, 2004, 2005; Asmussen, 1995; Bean et al., 2005a, 2005b, 2008; Ramaswami, 1997, 1999).By Bean et al. (2009), fors≠0, and fors=0when the process is not null-recurrent, matricesG(x,y)(s)andH(x,y)(s)are given by(14)G(x,y)(s)H(x,y)(s)=G(x)(s)H(y-x)(s)IH(y)(s)G(y)(s)I-1.Denote the values ats=0for all the above LSTs by dropping(s), for exampleQ(0)=Q,Ψ(0)=Ψ,Ξ(0)=Ξetc.Further, for0<x<d, define matricesN1(d;x)andN2(d;x)such that(15)N1(d;x)N2(d;x)=IeKdΨeJdΞI-1×eKx00eJ(d-x)IΨΞI,withK=Q11+ΨQ21,J=Q22+ΞQ12. By Bean, O‘Reilly, and Sargison (2010); da Silva Soares (2005), the physical interpretation of matricesN1(d;x)andN2(d;x)is that they record•the mean number of visits to level x in some phase inS1∪S2, given start in level 0 in some phase inS1, andthe mean number of visits to level x in some phase inS1∪S2, given start in level d in some phase inS2,Also, forx>0, define matrixM1(x)by(16)M1(x)=eKxIΨ.By argument similar to Ramaswami (1999), with a slight modification to a model with all real rates,M1(x)records the mean number of visits to level x in some phase inS1∪S2, given start in level 0 in some phase inS1, before a visit to level 0.Now, consider the two-stage SFM{(φ(t),X(t),Z(t)),t⩾0}defined in Section 1. By inserting superscript(ℓ)in the above notations, introduce matricesC(ℓ),Q(ℓ),Ψ(ℓ)(s),Ξ(ℓ)(s),G(ℓ);(x)(s),H(ℓ);(x)(s),G(ℓ);(x,y)(s),H(ℓ);(x,y)(s), etc., defined in a manner analogous to above, and corresponding to an unbounded SFM driven by a continuous-time Markov Chain with state spaceS(ℓ)and generatorT(ℓ), forℓ∈{1,2}, respectively.In the analysis below, we use the above concepts as the building blocks and apply the methods of direct analysis of SFMs developed in Bean et al. (2005b, 2009).AssumeB=∞. In this section we derive the expressions for LSTs of several time-dependent measures of interest for the two-stage SFM{(φ(t),X(t),Z(t)),t⩾0}. Also, we introduce ratesδ2→1andδ1→2as a measure of transient tendency of the switching between the two stages.Letθ(x)=inf{t>0:X(t)=x}be the first time the process hits level x. Define matrixLb2b1(s)=[Lb2b1(s)ij]i∈S1(1),j∈S2(2)such that(17)Lb2b1(s)ij=E(e-sθ(b1)I(φ(θ(b1))=j)|φ(0)=i,X(0)=b2)is the LST of the time until first hitting levelb1from above and doing so in phasej∈S2(2), given start from levelb2in phasei∈S1(1)in Stage 1.Furthermore, we define matrixLb1b2(s)=[Lb1b2(s)ij]i∈S2(2),j∈S1(1)such that(18)Lb1b2(s)ij=E(e-sθ(b2)I(θ(b2)<θ(0),φ(θ(b2))=j)|φ(0)=i,X(0)=b1)is the LST of the time until first hitting levelb2from below and doing so in phasej∈S1(1), while avoiding level 0, given start from levelb1in phasei∈S2(2)in Stage 2.Also, define matrixL∼b1b2(s)=[L∼b1b2(s)ij]i∈S2(2),j∈S1(1)such that(19)L∼b1b2(s)ij=E(e-sθ(b2)I(φ(θ(b2))=j)|φ(0)=i,X(0)=b1)is the LST of the time until first hitting levelb2from below and doing so in phasej∈S1(1), given start from levelb1in phasei∈S2(2)in Stage 2, where a visit to level 0 is allowed.Theorem 1(20)Lb2b1(s)=P‾11(b2)(s)Ψ(2)(s)+P‾12(b2)(s)G22(2);(b2-b1)(s),(21)Lb1b2(s)=P‾22(b1)(s)H21(1);(b1,b2)(s)+P‾21(b1)(s)H11(1);(b1,b2)(s),(22)L∼b1b2(s)=Lb1b2(s)+P‾22(b1)(s)G22(1);(b1,b2)(s)+P‾21(b1)(s)G12(1);(b1,b2)(s)×I-P‾21(0)(s)G12(1);(0,b2)(s)-1H11(1);(0,b2)(s),with(23)P‾11(b2)(s)=P11(b2)+P10(b2)sI-T00(2)-1T01(2),(24)P‾12(b2)(s)=P12(b2)+P10(b2)sI-T00(2)-1T02(2),(25)P‾21(b1)(s)=P21(b1)+P20(b1)sI-T00(1)-1T01(1),(26)P‾22(b1)(s)=P22(b1)+P10(b1)sI-T00(1)-1T02(1),and(27)P‾21(0)(s)=I0sI-T22(1)T20(1)T02(1)T00(1)-1T21(1)T01(1).Consider expressions (23)–(27). Note that by arguments in Bean et al. (2009), matrixP‾11(b2)(s)records the LSTs of the time that the process starts from levelb2in some phase inS1(1),•and then moves to some phase inS1(2), ormoves to some phase inS0(2), spends some time at levelb2, and then moves to some phase inS1(2).Similar physical interpretations hold for the remaining matrices in (23)–(27).Now, consider paths contributing toLb2b1(s). The process hits levelb2from below in some phasei∈S1(1), and then one of the following alternatives occur. In the first alternative,•the process moves to some phase inS1(2); or moves to some phase in phase inS0(2), spends some time at levelb2, and then moves to some phase inS1(2). The corresponding LST of this occurring isP‾11(b2)(s).Next, starting from levelb2in some phase inS1(2), the process returns to levelb2in some phase inS2(2). The corresponding LST of this occurring isΨ(2)(s).Finally, starting from levelb2in some phase inS2(2), the process hits levelb1from above in some phase inS2(2). The corresponding LST of this occurring isG22(2);(b2-b1)(s).Therefore, the LST of the first alternative isP‾11(b2)(s)Ψ(2)(s)G22(2);(b2-b1)(s). In the second alternative,•the process moves to some phase inS2(2); or moves to some phase in phase inS0(2), spends some time at levelb2, and then moves to some phase inS2(2). The corresponding LST of this occurring isP‾12(b2)(s).Next, starting from levelb2in some phase inS2(2), the process hits levelb1from above in some phase inS2(2). The corresponding LST of this occurring isG22(2);(b2-b1)(s).Therefore, the LST of the second alternative isP‾12(b2)(s)G22(2);(b2-b1)(s). Hence, by adding the LSTs of the two alternatives (20), follows.Next, consider paths contributing toLb1b2(s). The process hits levelb1from above in some phasei∈S2(2), and then one of the following alternatives occur. In the first alternative,•the process moves to some phase inS2(1); or moves to some phase in phase inS0(1), spends some time at levelb2, and then moves to some phase inS2(1). The corresponding LST of this occurring isP‾22(b1)(s).Next, starting from levelb1in some phase inS2(1), the process hits levelb2from below in some phase inS1(1), while avoiding level 0. The corresponding LST of this occurring isH21(1);(b1,b2)(s).The LST of the first alternative occurring is thereforeP‾22(b1)(s)H21(1);(b1,b2)(s). Alternatively,•the process moves to some phase inS1(1); or moves to some phase in phase inS0(1), spends some time at levelb2, and then moves to some phase inS1(1). The corresponding LST of this occurring isP‾21(b1)(s).Next, starting from levelb1in some phase inS1(1), the process hits levelb2in some phase inS1(1), while avoiding level 0. The corresponding LST of this occurring isH11(1);(b1,b2)(s).The LST of the second alternative occurring is thereforeP‾21(b1)(s)H11(1);(b1,b2)(s). Hence, by adding the LSTs of the two alternatives (21), follows.Finally, consider paths contributing toL∼b1b2(s). These include paths contributing toLb1b2(s), which do not visit level 0. So consider the paths that do visit level 0. The process hits levelb1from above in some phasei∈S2(2), and then•hits level 0 while avoiding levelb2, and does so in some phase inS2(1). The LST of this occurring isP‾22(b1)(s)G22(1);(b1,b2)(s)+P‾21(b1)(s)G12(1);(b1,b2)(s).Next, starting from level 0 in some phase inS2(1), the process may leave level 0 (after possibly spending some time on it) and then return to level 0 while avoiding levelb2, and do so any number of times. The LST of this occurring isI-P‾21(0)(s)G12(1);(0,b2)(s)-1.Finally, starting from level 0 in some phase inS1(1), the process hits levelb2while avoiding level 0. The LST of this occurring isH11(1);(0,b2)(s). Hence, by multiplying the corresponding LSTs, and adding toLb1b2(s), expression (22) follows. □Next, we derive the expression for the LSTs of the duration of the busy period. Define matrixΨ(s)=[Ψ(s)ij]i∈S1(1),j∈S2(1), such that(28)Ψ(s)ij=E(e-sθ(0)I(φ(θ(0))=j)|φ(0)=i,X(0)=0)is the LST of time it take to first return to level 0 and do so in phase j, given start from level 0 in phase i.Theorem 2We have(29)Ψ(s)=G12(1);(0,b2)(s)+H11(1);(0,b2)(s)Lb2b1(s)I-Lb1b2(s)Lb2b1(s)-1×P‾22(b1)(s)G22(1);(b1,b2)(s)+P‾21(b1)(s)G12(1);(b1,b2)(s).Suppose the process starts from level 0 in some phase inS1(1)and then returns to level 0 in some phase inS2(1). This can occur in two alternative ways. The first alternative is that the process returns to level 0 while avoiding levelb2, and the LST of this occurring isG12(1);(0,b2)(s). The second alternative is that the process returns to level 0 after a visit to levelb2. For this to occur, the process must•hit levelb2from below in some phase inS1(1), while avoiding level 0. The LST of this occurring isH11(1);(0,b2)(s).Next, starting from some phase inS1(1), the process goes to Stage 2, which ends at the moment of first hitting levelb1from above in some phase inS2(2). The LST of this occurring isLb2b1(s).Further, starting from levelb1in some phase inS2(2), the process may go through Stage 1 while avoiding level 0, and then through Stage 2, and do so any number of times. The LST of this occurring is(I-Lb1b2(s)Lb2b1(s))-1.Finally, starting from levelb1in some phase inS2(2), the process must hit level 0 in some phase inS2(1)while avoiding levelb2. The LST of this occurring isP‾22(b1)(s)G22(1);(b1,b2)(s)+P‾21(b1)(s)G12(1);(b1,b2)(s).By taking the product of the corresponding LSTs and then adding the LST of the two alternatives, the result follows.□Now, since all matrices involved in the above expressions can be efficiently evaluated using methods discussed in Section 2, we can evaluate the corresponding mean times using(30)Eb2b1=-ddsLb2b1(s)|s=0,(31)Eb1b2=-ddsLb1b2(s)|s=0,(32)E∼b1b2=-ddsL∼b1b2(s)|s=0,(33)E=-ddsΨ(s)|s=0,as well as other moments, in a similar manner. Next, we can evaluate the transient tendency of the switching between the two stages using(34)δ2→1=11/|S1(1)|Eb2b11,(35)δ1→2=11/|S2(2)|E∼b1b21,withδ2→1andδ1→2interpreted as the transient rate of the switch from Stage 2 to 1 and from Stage 1 to 2, respectively, and where a higher rate means a faster switch to the other stage. Also, letβE=1E1, which we interpret as the mean cumulative measure of the busy period.We are also interested in a measure of the long-run tendency of the switching between the two stages. For this we require the analysis of the stationary behavior of the model, which we develop below.AssumeB=∞. In this section we derive expressions for measures that describe the long-run behaviour of the two-stage SFM{(φ(t),X(t),Z(t)),t⩾0}. Also, we introduce ratesr2→1andr1→2as a measure of stationary tendency of the switching between the two stages.Note that due to the dynamics of the process, we have a stationary probability mass corresponding to the times spent at the thresholds 0,b1andb2, respectively. Therefore, we introduce the following notation. Letp(0)=[p(0)i]i∈S(1)be the stationary probability mass vector corresponding to the boundary 0, partitioned according toS1(1)∪S2(1)∪S0(1)as(36)p(0)=0p(0)2p(0)0,p(b1)=[p(b1)i]i∈S(1)be the stationary probability mass vector corresponding to the boundaryb1, partitioned according toS1(1)∪S2(1)∪S0(1)as(37)p(b1)=00p(b1)0,andp(b2)=[p(b2)i]i∈S(2)be the stationary probability mass vector corresponding to the boundaryb2, partitioned according toS1(2)∪S2(2)∪S0(2)as(38)p(b2)=00p(b2)0.Furthermore, define the stationary density vectorsπ(1)(x)=[π(x)i]i∈S(1), forx∈(0,b1)∪(b1,b2), partitioned according toS1(1)∪S2(1)∪S0(1)as(39)π(1)(x)=π(1)(x)1π(1)(x)2π(1)(x)0,andπ(2)(x)=[π(x)i]i∈S(2), forx∈(b1,b2)∪(b2,∞), partitioned according toS1(2)∪S2(2)∪S0(2)as(40)π(2)(x)=π(2)(x)1π(2)(x)2π(2)(x)0.Also, forℓ∈{1,2},m∈{1,2}, define(41)π(ℓ)(x+)m=limy→x+π(ℓ)(y)m,(42)π(ℓ)(x-)m=limy→x-π(ℓ)(y)m,and note that these are not equivalent, due to the dynamics of the process at the thresholds.Denote the values ats=0for all the LSTs by dropping(s), for exampleLb1b2(0)=Lb1b2,P‾(b1)(0)=P‾(b1)etc.Theorem 3Letv=[vi]i∈S(2)be the stationary distribution vector of the CTMC driving Stage 2. The stationary distribution of the two-stage SFM exists when the driftμ(2)=∑i∈S(2)vici(2), corresponding to the SFM in Stage 2, is strictly negative. For0<x<b1,(43)π(1)(x)1π(1)(x)2=p(0)2p(0)0T21(1)T01(1)N1(1)(b1;x)(C(1))-1+π(1)b1-2C2(1)N2(1)(b1;x)(C(1))-1,forb1<x<b2,(44)π(1)(x)1π(1)(x)2=π(1)b1+1C1(1)N1(1)(b2-b1;x-b1)(C(1))-1and(45)π(2)(x)1π(2)(x)2=π(2)b2-2C2(2)N2(2)(b2-b1;x-b1)(C(2))-1,forx>b2,(46)π(2)(x)1π(2)(x)2=π(2)b2+1C1(2)M1(2)(x-b2)(C(2))-1,and forℓ∈{1,2},0<x<b1,b1<x<b2andx>b2,(47)π(ℓ)(x)0=π(ℓ)(x)1π(ℓ)(x)2T10(ℓ)T20(ℓ)-T00(ℓ)-1.As in da Silva Soares and Latouche in da Silva Soares and Latouche (2009), Theorem 4.2, we condition on the most recent visit to threshold 0,b1orb2. Of course, the two-stage SFM is essentially different from the model studied in da Silva Soares and Latouche (2009), and so different dynamics apply here.The stability conditionμ(2)<0is the stability condition of the SFM corresponding to Stage 2. Stage 1 is bounded by layer[0,b2], and so the stability of the process depends on the stability of Stage 2 only.To determine the expression forπ(1)(x)1π(1)(x)2,0<x<b1,j∈S(1), note that the vectorπ(1)(x)1π(1)(x)2C(1)records the long-run mean number of visits to level x in some phase inS1(1)∪S2(1), and that the visits to x in phasej∈S1(1)∪S2(1)might have occurred in two alternative ways.•The process was at level 0 (the corresponding probability mass vector isp(0)2p(0)0),then moved to a phase inS1(1)(the corresponding transition rate matrix isT21(1)T01(1)),and then, starting from level 0 in some phase inS1(1), the process visited level x in phase j, while avoiding levels 0 andb1(the corresponding matrix of the mean number of visits under a taboo of a visit to levels 0 andb1isN1(1)(b1;x)).Alternatively,•The process was at levelb1in some phase inS2(1)(the corresponding vector of the mean number of visits isπ(1)b1-2C2(1)),and then, starting from levelb1in some phase inS2(1), the process visited level x in phase j, while avoiding levels 0 andb1(the corresponding matrix of the mean number of visits under a taboo of a visits to levels 0 andb1isN2(1)(b1;x)).By taking the products and then adding the vectors corresponding to the two alternatives, we have(48)π(1)(x)1π(1)(x)2C(1)=p(0)2p(0)0T21(1)T01(1)N1(1)(b1;x)+π(1)b1-2C2(1)N2(1)(b1;x),and so (43) follows.To determine the expression forπ(1)(x)1π(1)(x)2,b1<x<b2, note thatπ(1)(x)1π(1)(x)2C(1)records the long-run mean number of visits to level x in some phase inS1(1)∪S2(1), and that the visits to x in phasej∈S1(1)∪S2(1)might have occurred in the following way.•The process was at levelb1in some phase inS1(1)(the corresponding vector of the mean number of visits isπ(1)b1+1C1(1)),and then, starting from levelb1in some phase inS1(1), the process visited level x in phase j, while avoiding levelsb1andb2(the corresponding matrix of the mean number of visits under a taboo of a visits to levelsb1andb2isN1(1)(b2-b1;x-b1)).Therefore,(49)π(1)(x)1π(1)(x)2C(1)=π(1)b1+1C1(1)N1(1)(b2-b1;x-b1),and so (44) follows.Expressions (45), (46) follow by a similar argument. Finally, to deriveπ(ℓ)(x)0,ℓ∈{1,2},0<x<b1,b1<x<b2andx>b2, note that in order for the process to be at level x in some phase inS0(ℓ),ℓ∈{1,2}, the process must•hit level x in some phase inS1(ℓ)∪S2(ℓ)(the stationary density vector of this occurring isπ(ℓ)(x)1π(ℓ)(x)2),then transition to some phase inS0(ℓ)(the corresponding transition rate matrix isT10(ℓ)T20(ℓ)),and then spend some time in the setS0(ℓ)(the corresponding probability matrix is-T00(ℓ)-1).The product of the above gives (47). □Vectorsπ(2)b2-2,π(2)b2+1,π(1)b1+1andπ(1)b1-2are the solution of the following set of equations:(50)π(2)b2-2=p(b2)0T02(2)+π(2)b2+1C1(2)Ψ(2)+π(1)b1+1C1(1)H11(1);(0,b2-b1)P12(b2)C2(2)-1,(51)π(2)(b2+)1=p(b2)0T01(2)+π(1)b1+1C1(1)H11(1);(0,b2-b1)P11(b2)+π(2)b2-2C2(2)H21(2);(b2-b1,b2-b1)C1(2)-1,(52)π(1)b1+1=p(b1)0T01(1)+p(0)0T01(1)H11(1);(b1,b1)+π(1)b1-2C2(1)H21(1);(b1,b1)+π(2)b2-2C2(2)G22(2);(b2-b1,b2-b1)P21(b1)C1(1)-1(53)π(1)(b1-)2=p(b1)0T02(1)+π(2)b2-2C2(2)G22(2);(b2-b1,b2-b1)P22(b1)+π(1)b1+1C1(1)G12(1);(0,b2-b1)(C2(1))-1.As in the proof of Theorem 3, we condition on the last visit to threshold 0,b1orb2. Here, we need to be careful due to the changing behaviour at the thresholds.We present the derivation ofπ(2)b2-2, the remaining expressions are obtained in an analogous manner. We note thatπ(2)b2-2C2(2)records the long-run mean number of visits to levelb2in some phase inS2(2), and that the visits tob2in phasej∈S2(2)might have occurred in one of the following ways.•The process was at levelb2in some phase inS0(2)(the corresponding probability mass vector isp(b2)0),and then moved to phase j (the corresponding transition rate matrix isT02(2)).Alternatively,•the process was at levelb2in some phase inS1(2)(the corresponding vector of the mean number of visits isπ(2)b2+1C(2)),and then, starting from levelb2in some phase inS1(2), the process returned to levelb2in phase j (the corresponding probability matrix isΨ(2)).Alternatively,•the process was at levelb1in some phase inS1(1)(the corresponding vector of the mean number of visits isπ(1)b1+1C(1)),and then, starting from levelb1in some phase inS1(1), the process hit levelb2and moved to phase j (the corresponding probability matrix isH11(1);(0,b2-b1)P12(b2)).By taking the products and adding the LSTs of the three alternatives, we have(54)π(2)b2-2C2(2)=p(b2)0T02(2)+π(2)(b2+)1C(2)Ψ(2)+π(1)b1+1C1(1)H11(1);(0,b2-b1)P12(b2),and so (50) follows.□So we can see now that there is a need to derive the results for the probability mass vectors observed at the thresholds 0,b1andb2, since all other stationary vectors can be expressed in terms of them. This is established below.Lemma 1Consider a discrete-time Markov chain observed at the moments the two-stage SFM hits threshold 0 from above in some phase inS2(1)(during Stage 1),b1from above in some phase inS2(2)(at the end of Stage 2), orb2from below in some phase inS1(1)(at the end of Stage 1), respectively.Partition the state space accordingly asS2(1)∪S2(2)∪S1(1), and similarly, the stationary distribution vector asξ=ξ(0)ξ(b1)ξ(b2).Then, the one-step transition probability matrixAof this chain, partitioned in an analogous manner, is given by(55)A=A000A0b2Ab100Ab1b20Ab2b10,where(56)A00=P‾21(0)G12(1);(0,b2),(57)A0b2=P‾21(0)H11(1);(0,b2),(58)Ab2b1=Lb2b1,(59)Ab1b2=Lb1b2,(60)Ab10=P‾22(b1)G22(1);(b1,b2)+P‾21(b1)G12(1);(b1,b2).First, the zero block matrices inAfollow since the corresponding types of transitions cannot be observed. For example, assuming hitting level 0 from above in some phase inS2(1), the next visit to a threshold can be observed when•hitting level 0 from above in some phase inS2(1), orhitting levelb2from below in some phase inS1(1),Next, (58)–(59) follow by the definitions ofLb2b1andLb1b2.Now, considerA00. The process hits level 0 from above in some phase inS2(1), and then•moves to some phase inS1(1); or moves to some phase inS0(1), spends some time at level 0, and then moves to some phase inS1(1). The corresponding LST of this occurring isP‾21(0).Next, starting from level 0 in some phase inS1(1), the process hits level 0 from above in some phase inS2(2), while avoiding levelb2. The corresponding LST of this occurring isG12(1);(0,b2).The product of the two LSTs gives (56).Further, considerA0b2. The process hits level 0 from above in some phase inS2(1), and then•moves to some phase inS1(1); or moves to some phase inS0(1), spends some time at level 0, and then moves to some phase inS1(1). The corresponding LST of this occurring isP‾21(0).Next, starting from level 0 in some phase inS1(1), the process hits levelb2from below in some phase inS1(1), while avoiding level 0. The corresponding LST of this occurring isH11(1);(0,b2).The product of the two LSTs gives (57).Finally, considerAb10. The process hits levelb1from above in some phase inS2(2), and then one of the following alternatives occur.•The process moves to some phase inS2(1); or moves to some phase inS0(1), spends some time at level 0, and then moves to some phase inS2(1). Next, starting from levelb1in some phase inS2(1), the process hits level 0 from above in some phase inS2(1), while avoiding levelb1. The corresponding LST of this occurring isP‾22(b1)G22(1);(b1,b2).Alternatively, the process moves to some phase inS1(1); or moves to some phase inS0(1), spends some time at level 0, and then moves to some phase inS1(1). Next, starting from levelb1in some phase inS1(1), the process hits level 0 from above in some phase inS2(1), while avoiding levelb1. The corresponding LST of this occurring isP‾21(b1)G12(1);(b1,b2).The sum of the two LSTs gives (60). □We have(61)p(0)2p(0)0=αξ(0)0-T22(1)T20(1)T02(1)T00(1)-1,(62)p(b2)0=αξ(b2)P10(b2)-T00(2)-1,(63)p(b1)0=αξ(b1)P20(b1)-T00(1)-1.whereαis a normalizing constant such that, withb0=0,(64)∫x=0b2π(1)(x)dx1+∫x=b1∞π(2)(x)dx1+∑i=02p(bi)1=1.Expressions (61)–(63) follow by noting that the probability mass vector at the threshold 0,b2orb1, respectively, is proportional to the product of•the stationary probability mass vector of hitting that threshold, andthe probability mass of staying at the threshold for some time.Eq. (64) follows since the total probability mass must equal to 1.□In practice, in order the evaluate the stationary results, apply the following steps.1.Evaluateξusing Lemma 1 and the results of Section 3.Evaluatep(bi)/α,i=0,1,2, using (61)–(63) in Theorem 5.Evaluateπ(2)b2-2/α,π(2)b2+1/α,π(1)b1+1/αandπ(1)b1-2/αby solving the set of equations in Theorem 4 (write them in a matrix formxD=dfirst).Substitute these results in the expressions of Theorem 3, divided byα.Evaluateαusing (64) and techniques in Bean et al. (2010); da Silva Soares (2005).Also, for convenience, please refer to the codes available in Bean et al. (2010) – some of them can be used here.Now, using the above results, we can evaluatep(1)andp(2), defined by(65)p(1)=∫x=0b2π(1)(x)dx1+p(0)1+p(b1)1,(66)p(2)=∫x=b1∞π(2)(x)dx1+p(b2)1,and interpreted as the long-run proportion of time spent in Stage 1 and Stage 2, respectively.Further, the long-run tendency of the switching between the two stages can be assessed using(67)r2→1=π(1)b2-11π(1)b2-1Eb2b11,(68)r1→2=π(1)b1+21π(1)b1+2E∼b1b21,where(69)π(1)b2-1=π(1)b1+1C1(1)H11(1);(0,b2-b1)C1(1)-1,(70)π(1)b1+2=π(2)b2-2C2(2)G22(2);(b2-b1,b2-b1)C2(2)-1,and withr2→1andr1→2interpreted as the long-run rate of the switch from Stage 2 to 1 and from Stage 1 to 2, respectively, where a higher rate means a faster switch to the other stage.Consider the following modification of the two-stage model of the previous sections. Suppose that the bufferX(.)has an upper boundaryB<∞, so that whenφ(t)=i∈S(2)andX(t)=B, then the rate of change of fluid is=min0,ci(2). That is, we assume that the bufferX(.)is finite, and so when full, it can only decrease or stay at the same level. This is an important consideration, since real-life buffers have limited capacity. The analysis of the model follows along the lines of the arguments of the previous sections, with some appropriate changes.For example, whenever the argument relies on the process starting from levelb2in some phase inS1(2)and returning to levelb2in some phase inS2(2), we can no longer useΨ(2)(s).So, define matrixΨb2(s)=[Ψb2(s)ij]i∈S1(2),j∈S2(2)such that the entry(71)Ψb2(s)ij=E(e-sθ(b2)I(φ(θ(b2))=j)|φ(0)=i,X(0)=b2)is the LST of the time that the process starts from levelb2in phase i and first returns to levelb2in phase j.For similar reasons, define matrixG22b2;b1(s)=[Gb2;b1(s)ij]i,j∈S2(2)such that(72)G22b2;b1(s)ij=E(e-sθ(b1)I(φ(θ(b1))=j)|φ(0)=i,X(0)=b2)is the LST of the time that the process starts from levelb2in phase i and first hits levelb1in phase j.Then, by standard theory for the bounded SFMs in Bean et al. (2009), with a slight modification due to a different behaviour at the boundary in the model considered here, the following result holds.Lemma 2We haveΨb2(s)=G12(2);(0,B-b2)(s)+H11(2);(0,B-b2)(s)P‾12(B)(s)×I-H21(2);(B-b2,B-b2)(s)P‾12(B)(s)-1G22(2):(B-b2,B-b2)(s),(73)G22b2;b1(s)=G22(2);(b2-b1,B-b1)(s)+H21(2);(b2-b1,B-b1)(s)P‾12(B)(s)×I-H21(2);(B-b1,B-b1)(s)P‾12(B)(s)-1G22(2):(B-b1,B-b1)(s),where(74)P‾12(B)(s)=I0T11(2)T10(2)T01(2)T00(2)-sI-1T12(2)T02(2).Consequently, the results can now be modified accordingly. We state them here without the proof, as this follows by arguments analogous to the previous sections.Theorem 6We have(75)Lb2b1(s)=P‾11(b2)(s)Ψb2(s)+P‾12(b2)(s)G22b2;b1(s).The remaining results inTheorems 1–2hold without changes.Forx>b2,(76)π(2)(x)1π(2)(x)2=π(2)b2+1C1(2)N1(2)(B-b2;x-b2)(C(2))-1,+p(B)1p(B)0T12(2)T02(2)×N2(2)(B-b2;x-b2)(C(2))-1,whereN1(2)(B-b2;x-b2)andN2(2)(B-b2;x-b2)obey the definition in(15).Further,(77)π(2)b2-2=p(b2)0T02(2)+π(2)(b2+)1C1(2)G12(2);(0,B-b2)+π(1)b1+1C1(1)H11(1);(0,b2-b1)P12(b2)+π(2)(B-)2C2(2)G22(2);(B-b2,B-b2)C2(2)-1,where(78)π(2)(B-)2=p(B)1p(B)0T12(2)T02(2).The remaining results inTheorems 3,4hold without changes.Consider a discrete-time Markov chain observed at the moments the two-stage SFM hits threshold 0 from above in some phase inS2(1)(during Stage 1),b1from above in some phase inS2(2)(at the end of Stage 2),b2from below in some phase inS1(1)(at the end of Stage 1), or B from below in some phase inS1(2)(during Stage 2), respectively.Partition the state space accordingly asS2(1)∪S2(2)∪S1(1)∪S1(2), and similarly, the stationary distribution vector asξ=ξ(0)ξ(b1)ξ(b2)ξ(B).Then, the one-step transition probability matrixAof this chain, partitioned in an analogous manner, is given by(79)A=A000A0b20Ab100Ab1b200Ab2b10Ab2B0ABb10ABB,where(80)Ab2b1=P‾22(b2)G22(2);(b2-b1,B-b1)+P‾21(b2)G12(2);(b2-b1,B-b1),(81)Ab2B=P‾22(b2)H21(2);(b2-b1,B-b1)+P‾21(b2)H11(2);(b2-b1,B-b1),(82)ABb1=P‾22(B)G22(2);(B-b1,B-b1),(83)ABB=P‾22(B)H21(2);(B-b1,B-b1),and the results(56), (57) and (59), (60)hold without changes.We have(84)p(B)1p(B)0=αξ(B)0-T11(2)T10(2)T01(2)T00(2)-1.The remaining results inTheorem 5hold without changes, andαis a normalizing constant such that, withb0=0,b3=B,(85)∫x=0b2π(1)(x)dx1+∫x=b1Bπ(2)(x)dx1+∑i=03p(bi)1=1.In this section we show the potential of the analysis using, for convenience of illustration, a simple numerical example of a two-stage model. AssumeB=∞,S(1)={1,2,3,4}withc1=1,c2=1.1,c3=-1.5,c4=0, andS2={5,6,7,8},c5=1,c6=-1,c7=-1.5,c8=0, withT(1)=-62312-63111-42112-4,T(2)=-31111-31111-31111-3andP(b2)=10000.80.10.10,P(b1)=000.60.50010.First, we are interested in the overall effect of changing the upper thresholdb2on the values of the performance measures of the process. Assumeb1=0.1and study the time-dependent and stationary measures as a function ofb2, forb2∈(b1,20]. Using the theory developed for the two-stage SFM in Sections 3,2,3,4, we construct the plots of these measures in Figs. 3–6.Next, we consider the case with the fixed valueb2=1, and with the remaining parameters as above. Using the results of Section 3, we computeδ1→2=0.0901,δ2→1=0.2639,E=1.40981.4525andEb2b1=1.53972.41.42612.2133,E∼b1b2=5.13815.92725.17355.9681,Eb1b2=0.05680.06480.02340.0266.Also, using the results of Section 4, we computep(1)=0.9595,p(2)=0.0405,r1→2=0.0901andr2→1=0.2641.The drift corresponding to Stage 1 SFM has valueμ1=-0.2333, while the drift corresponding to Stage 2 SFM has valueμ2=-0.3750. That is, both SFMs have a drift down, but the drift down while in Stage 2 is stronger. We observe that asb2increases, the values inEinitially decrease. The physical interpretation of this may be that whenb2is very closeb1, the process is spending more time ‘bouncing’ around the thresholds than whenb2is sufficiently large for the drift down to start playing role. For the values of upper threshold roughlyb2>4, we observe thatp(1)≈1. This means that the process spend almost all of its time in Stage 1 (and so the values inEare approximately that of a standard SFM with no upper boundary, driven by Stage 1 only). The r andδrates (which differ marginally in this particular example), reveal that forb2⩾2, the process takes a very long time to move from Stage 1 to Stage 2, and so for practical reasons, the values of interest for the choice ofb2could be restricted to the rangeb2<2. We note the minimum value of[E]13is reached whenb2=0.5800, while the minimum value of[E]23is reached whenb2=0.5200, so perhaps the value ofb2close to these may be a preferred option for the system considered here.We consider the following generalization of the two-stage SFMs to multi-stage SFMs. Define an n-stage SFM, denoted by{(φ(t),X(t),Z(t)),t⩾0}, with phase variableφ(t), level variableX(t)⩾0, stage variableZ(t)∈{1,…,n},n⩾2, and thresholds0<u2<⋯<un,un+1=∞,0<d2<⋯<dn<∞,dk<uk<dk+1fork=2,…,n, as follows.•We assumeφ(0)∈S(1)={1,…,m1},X(0)=0,Z(0)=1. That is, the process starts from level zero in Stage 1, driven by a CTMC with state spaceS(1)and generatorT(1).WhileZ(t)=1, the process is in Stage 1. In such case, wheneverφ(t)=iandX(t)>0, the rate of change of levelX(t)is given by a constantci(1), for alli∈S(1). Whenφ(t)=iandX(t)=0however, the rate of change of fluid ismax0,ci(1), since zero in the lower boundary in the buffer.Following this, as soon asX(t)=u2, the phase process moves to some phase inS(2)={1,…,m2}, according to the probability matrixP(u2). Also,Z(t)moves from 1 to 2, and we say that Stage 2 begins, driven by a CTMC with state spaceS(2)and generatorT(2).WhileZ(t)=k,k⩾2, the process is in Stage k which is driven by a CTMC with state spaceS(k)and generatorT(k). In such case, wheneverφ(t)=iandZ(t)=k, the rate of change of fluid is given by a constantci(k), for alli∈S(k).Whenever the process is in Stagek,k⩾2, and hits leveluk+1from below, Stage k moves to Stage(k+1)according to the probability matrixP(uk+1). When it hits leveldkfrom above however, Stage k moves to Stage(k-1)according to the probability matrixP(dk).That is, upon hitting levelukfrom below the process moves to Stage k, and then it remains in Stage k as long as the level is within the interval(dk,uk+1). Whenever the process in Stage k hits leveldkfrom above, it moves to Stage(k-1), and when it hits leveluk+1from below, it moves to Stage(k+1). We illustrate this in Fig. 7.Note that changing the above assumptiondk<uktodk=ukfor all k results in the familiar multi-layer model introduced by Bean, O’Reilly and Taylor in Bean and O‘Reilly (2008), where the time-dependent measures were derived. Another model, the stationary analysis of which was presented by da Silva Soares and Latouche in da Silva Soares and Latouche (2009), could be seen as the variant of the model in Bean and O‘Reilly (2008), but without matricesP(dk),P(uk), and with different dynamics at the thresholds.The assumptiondk≠ukis important, as in practice different congestion control levels may be desired at the start and at the end of the congestion period, respectively, see (Malhotra et al., 2009) as an example. Here, we have assumeddk<uk, as it is natural for the end-of-congestion threshold to be lower than the other.Below, we provide the building blocks of the methodology for the analysis of the multi-stage SFMs defined above.For the purpose of the analysis of the n-stage SFMs, it convenient to introduce the following notation. Let matrixL(s)be made of block matricesLukuℓ(s),Lukdℓ(s),Ldkuℓ(s), andLdkdℓ(s)defined as follows. We label the block rows and block columns inL(s)byd2,u2,…,dn,un, so that block entry[L(s)]ukdℓ=L(s)ukdℓ, where, fork=2,…,(n-1),(86)Lukuk+1(s)=P‾22(uk)(s)H21(k);(uk-dk,uk+1-dk)(s)+P‾21(uk)(s)H11(k);(uk-dk,uk+1-dk)(s),(87)Lukdk(s)=P‾22(uk)(s)G22(k);(uk-dk,uk+1-dk)(s)+P‾21(uk)(s)G12(k);(uk-dk,uk+1-dk)(s),fork=2,…,n, withd1=0,(88)Ldkuk(s)=P‾22(dk)(s)H21(k-1);(dk-dk-1,uk-dk-1)(s)+P‾21(dk)(s)H11(k-1);(dk-dk-1,uk-dk-1)(s),(89)Ldkdk-1(s)=P‾22(dk)(s)G22(k-1);(dk-dk-1,uk-dk-1)(s)+P‾21(dk)(s)G12(k-1);(dk-dk-1,uk-dk-1)(s),and(90)Lundn(s)=P‾22(un)(s)G22(n);(un-dn)(s)+P‾21(un)(s)G12(n);(un-dn)(s),with the remaining block matrices set to0matrix of appropriate size, respectively.Theorem 9We have(91)Ψ(s)=G12(1);(0,u2)(s)+H11(1);(0,u2)(s)[(I-L(s))-1]u2d2×P‾22(d2)(s)G22(1);(d2,u2)(s)+P‾21(d2)(s)G12(1);(d2,u2)(s),where[(I-L(s))-1]u2d2denotes the block matrix inu2block row andd2block column in(I-L(s))-1.First note that•Lukuk+1(s)records the LSTs of the time that the process starts from levelukin some phase inS1(k-1)and hits leveluk+1in some phase inS1(k)before hitting leveldk,Lukdk(s)records the LSTs of the time that the process starts from levelukin some phase inS1(k-1)and hits leveldkin some phase inS2(k)before hitting leveluk+1,Ldkuk(s)records the LSTs of the time that the process starts from leveldkin some phase inS2(k)and hits levelukin some phase inS1(k-1)before hitting leveldk-1,Ldkdk-1(s)records the LSTs of the time that the process starts from leveldkin some phase inS2(k)and hits leveldk-1in some phase inS2(k-1)before hitting leveluk,and therefore[(I-L(s))-1]u2d2=∑m=0∞[(L(s))m]u2d2records the LSTs of the time that the process starts from levelu2in some phase inS1(1), makes some number of transitions between the various stages, and ends in leveld2in some phase inS2(2).Consequently, the result follows by decomposition of the sample path argument as outlined below. The process starts from level 0 in some phase inS1(1)and then it may hit level 0 in some phase inS2(1), while avoiding levelu2. The corresponding LST isG12(1);(0,u2)(s).Alternatively,•The process starts from level 0 in some phase inS1(1)and then hits levelu2in some phase inS1(1), while avoiding level 0. The corresponding LST isH11(1);(0,u2)(s).Next, starting from levelu2in some phase inS1(1), the process spends some time in Stages 2 or higher, and ends in leveld2in some phase inS2(2). The corresponding LST is[(I-L(s))-1]u2d2.Finally, starting from leveld2in some phase in inS2(2), the process moves to Stage 1 and then hits level 0 in some phase inS2(1), while avoiding levelu2. The corresponding LST isP‾22(d2)(s)G22(1);(d2,u2)(s)+P‾21(d2)(s)G12(1);(d2,u2)(s).□In order to derive the stationary results, it is convenient to establish the expressions for the stationary probability mass observed the thresholds0,d2,u2,…,dn,unfirst. This is achieved with the following result.Theorem 10Consider a discrete-time Markov chain observed at the moments the n-stage SFM hits thresholddkfrom above in some phase inS(k),k=1,…,n, withd1=0, or thresholdukfrom below in some phase inS(k-1),k=2…,n.Partition the state space according to the thresholds0,d2,u2,…,dn,unasS2(1)∪S2(2)∪S1(1)…∪S2(n)∪S1(n-1), and similarly, the stationary distribution vector asξ=ξ(0)ξ(d2)ξ(u2)…ξ(dn)ξ(un). Then, the one-step transition probability matrixAof this chain, partitioned in an analogous manner, has block matrices given by(92)A00=P‾21(0)G12(1);(0,u2),(93)A0u2=P‾21(0)H11(1);(0,u2),(94)Ad20=P‾22(d2)G22(1);(d2,u2)+P‾21(d2)G12(1);(d2,u2),and the remaining block matricesAab,a,b=d2,u2,…,dn,un, given by(95)Aab=[L(0)]ab.Furthermore,(96)p(0)2p(0)0=αξ(0)0-T22(1)T20(1)T02(1)T00(1)-1,(97)p(uk)0=αξ(uk)P10(uk)(-T00(k))-1,(98)p(dk)0=αξ(dk)P20(dk)(-T00(k-1))-1,fork=2,…,n, whereαis a normalizing constant such that, withun+1=∞,(99)∑k=1n∫x=dkuk+1π(k)(x)dx1+∑k=1np(dk)1+∑k=2np(uk)1=1.The result follows by argument analogous to Lemma 1, Theorem 5 and the physical interpretation of matrixL(s)established in Theorem 9.□The remaining stationary analysis follows in a manner analogous to Section 4. That is, all stationary distribution mass or density vectors can be expressed in terms of vectorξ. Also, the results for an n-stage SFM with an upper boundaryB<∞can be derived by an appropriate modification of the above results, in a manner analogous to Section 5.

@&#CONCLUSIONS@&#
