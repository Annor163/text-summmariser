@&#MAIN-TITLE@&#
A computerized framework for monitoring four-dimensional dose distributions during stereotactic body radiation therapy using a portal dose image-based 2D/3D registration approach

@&#HIGHLIGHTS@&#
We have investigated a framework for monitoring 4D dose distributions.A portal dose image-based 2D/3D registration has been proposed.Dose errors can be calculated to ensure the quality of the radiation therapy.

@&#KEYPHRASES@&#
Stereotactic body radiation therapy,Four-dimensional dose distribution,2D/3D registration,Optimization,

@&#ABSTRACT@&#
A computerized framework for monitoring four-dimensional (4D) dose distributions during stereotactic body radiation therapy based on a portal dose image (PDI)-based 2D/3D registration approach has been proposed in this study. Using the PDI-based registration approach, simulated 4D “treatment” CT images were derived from the deformation of 3D planning CT images so that a 2D planning PDI could be similar to a 2D dynamic clinical PDI at a breathing phase. The planning PDI was calculated by applying a dose calculation algorithm (a pencil beam convolution algorithm) to the geometry of the planning CT image and a virtual water equivalent phantom. The dynamic clinical PDIs were estimated from electronic portal imaging device (EPID) dynamic images including breathing phase data obtained during a treatment. The parameters of the affine transformation matrix were optimized based on an objective function and a gamma pass rate using a Levenberg–Marquardt (LM) algorithm. The proposed framework was applied to the EPID dynamic images of ten lung cancer patients, which included 183 frames (mean: 18.3 per patient). The 4D dose distributions during the treatment time were successfully obtained by applying the dose calculation algorithm to the simulated 4D “treatment” CT images. The mean±standard deviation (SD) of the percentage errors between the prescribed dose and the estimated dose at an isocenter for all cases was 3.25±4.43%. The maximum error for the ten cases was 14.67% (prescribed dose: 1.50Gy, estimated dose: 1.72Gy), and the minimum error was 0.00%. The proposed framework could be feasible for monitoring the 4D dose distribution and dose errors within a patient's body during treatment.

@&#INTRODUCTION@&#
The aim of radiation therapy is to reduce the dose as low as possible to surrounding normal tissues, while concentrating the dose administered to target tumors. High-precision radiation therapies, such as stereotactic body radiation therapy (SBRT), have been employed to achieve this purpose. SBRT has several unique features, such as the delivery of large doses for small irradiation fields within several fractions (e.g. 48Gy/4fractions), and the use of seven to eight beam directions, including coplanar and non-coplanar beam arrangements for localized small tumors in the lung or liver [1]. It has been reported that the treatment outcome of radiation therapy has been similar to or better than that of surgery, depending on type of tumor, stage and location [2–4].In SBRT, it is substantially necessary to ensure whether the high dose beam is correctly delivered with respect to geometrical and dosimetrical targeting according to the treatment plan. Regarding the geometrical targeting, if tumor location errors, such as patient setup errors, physiological motion, variations of tumors or organs occur at the treatment time, the location errors could result in increased normal tissue complication and decreased tumor control [5,6]. Therefore, in SBRT, electronic portal imaging device (EPID) dynamic images are acquired to verify the tumor location within the irradiation field during the treatment dose delivery. However, as for dosimetric targeting, it has not been verified whether the planned dose distribution has been accurately administered to the target during the treatment dose delivery. Therefore, it is essential to monitor four-dimensional (4D) dose distributions for the target and its surrounding normal tissues in the patients’ bodies during the treatment time in order to guarantee the quality of the radiation therapy.A number of methods for estimating the dose distributions in patient bodies or phantoms during the treatment time have been developed [7–11]. The purpose of these methods was to estimate the 3D dose distributions in patient bodies or phantoms to verify the intensity-modulated radiation therapy (IMRT) plans. Several studies on 4D dose distributions obtained using four-dimensional computed tomography (4D-CT), which were affected by respiratory motion, have been reported [12–15]. A common approach of these studies was to apply dose calculation algorithms to breathing phase 4D-CT image sets, which were acquired under the free-breathing condition. These studies were based on the assumption that the breathing phase during the treatment time is very similar to that during 4D-CT scanning.Gendrin developed a system of monitoring tumor motion by a real-time 2D/3D registration during radiotherapy [16]. The system can monitor three-dimensional tumor movements by registering 3D planning CT images to portal images, which were acquired during the treatment time [16]. In this study, we have proposed a computerized framework for monitoring 4D dose distributions during the SBRT using a portal dose image (PDI)-based 2D/3D registration approach.Fig. 1shows a conceptual diagram for monitoring 4D dose distributions during the treatment time. Fig. 2shows a processing pipeline for monitoring 4D dose distributions using the PDI-based 2D/3D registration approach during the treatment delivery. The proposed framework mainly consists of the following four steps. First, a 2D dynamic clinical PDI was derived from the EPID dynamic image based on the deconvolution and convolution of lateral scatter kernels, and a pixel-to-dose conversion function. Second, a 2D planning PDI was obtained by calculating the total energy released per unit mass (TERMA) and applying a dose calculation algorithm for the 3D planning CT image. Third, simulated 4D “treatment” CT images were estimated by deforming 3D planning CT images by using affine transformation matrices so that a 2D planning PDI could be similar to a 2D dynamic clinical PDI at a certain time. The gamma pass rate was used as a similarity index. The parameters of the affine transformation matrices were optimized based on an objective function and a gamma pass rate by a Levenberg–Marquardt (LM) algorithm. Finally, 4D dose distributions during the treatment time were calculated by applying a dose calculation algorithm, i.e., a pencil beam convolution (PBC) algorithm, to simulated 4D “treatment” CT images.This study was performed under a protocol approved by the institutional review board of our hospital. Ten patients with lung cancer, who were treated with SBRT from 2004 to 2005, were selected for this study. The patients (six males and four females) had a median age of 75 years (range, 51–84 years). Table 1shows the characteristics of the ten cases evaluated in this study. All patients received a dose of 48Gy, prescribed at the isocenter in four fractions, with accelerating voltages of 6MV on linear accelerators (Clinac 21EX; Varian Medical Systems Inc., Palo Alto, USA). These patients were scanned by using a 4-slice CT scanner (Mx 8000; Philips, Amsterdam, The Netherlands) with 16-bit gray levels, a matrix size of 512×512pixels, and a slice thickness of 2.0mm. The treatment planning was performed by experienced radiation oncologists on a commercially available radiotherapy treatment planning system (Eclipse version 6.5; Varian Medical System Inc., Palo Alto, USA). The dynamic portal images were acquired on an EPID (Portal Vision aS-500; Varian Medical System Inc., Palo Alto, USA) using 6MV X-rays with an X-ray converter of amorphous silicon, a phosphor of terbium-activated gadolinium oxysulfide (Gd2O2S:Tb), a detection region of 400×300mm2, a matrix size of 512×384pixels, 16-bit gray levels, and a frame rate of 0.5 frames per second during SBRT. The average and total numbers of frames for the ten cases were 18.3 and 183, respectively. Our proposed framework was implemented in C, and performed by a general purpose personal computer, which was equipped with a 3.30GHz central processing unit (CPU) (Intel® Core™ i7-3960X CPU) and 32.0 gigabyte (GB) memory.The dynamic clinical PDI was derived from an EPID dynamic image by applying the deconvolution and convolution of lateral scatter kernels, and a pixel-to-dose conversion function [17]. Fig. 3shows a conceptual diagram for obtaining a dynamic clinical PDI. Algorithm 1 shows an algorithm for the production of the dynamic clinical PDI.Algorithm 1An algorithm for the production of the dynamic clinical PDI.1.INPUTiE: EPID dynamic image;2.kE: LSK in the EPID;3.kw: LSK of the water equivalent phantom;4.COMMENTSpE: incident primary X-ray signal to the EPID;5.pw: incident primary X-ray dose to the water equivalent phantom;6.iw: X-ray dose in the water equivalent phantom;7.(Capital symbols indicate spatial frequency domains.)8.IE←Fourier transform (iE), KE←Fourier transform (kE);9.//Calculation of the incident primary X-ray signal10.PE←IEKE;11.pE←Inverse Fourier transform (PE);12.//Conversion of the X-ray signal into the X-ray dose13.pw←Pixel-to-dose conversion function (pE);14.Pw←Fourier transform (pw), Kw← Fourier transform (kw);15.//Calculation of the dynamic clinical PDI16.Iw←Pw·Kw;17.iw←Inverse Fourier transform (Iw);18.Ic←iw;19.OUTPUTIc: dynamic clinical PDI;The lateral scatter kernel (LSK) was considered to be a function, which describes laterally scattered X-rays. In this study, the LSKs of EPID and the water equivalent phantom were calculated by a Monte Carlo simulation [18]. The number of histories was 108, which was used for estimation of the both LSKs in the Monte Carlo simulation. The uncertainty of the Monte Carlo simulation was less than 0.5%. In order to estimate the incident primary X-ray signal distributions to the EPID, the EPID dynamic images were deconvolved using the LSK of the EPID.The incident primary X-ray signal to the EPID was converted into the incident primary X-ray dose to the water equivalent phantom using a pixel-to-dose conversion function.The pixel-to-dose conversion function was estimated by using the EPID based on Chen's method [17]. The pixel-to-dose conversion function was experimentally measured using the EPID [18]. Errors of EPID dynamic image pixel value and absorbed dose in this measurement were ±0.02% and ±0.09%, respectively. Finally, dynamic clinical PDIs were calculated by convolution of the incident primary X-ray dose to the water equivalent phantom with the LSK of the water equivalent phantom.The 2D planning PDI was estimated by calculating the TERMA and applying a dose calculation algorithm in a world coordinate system including a linear accelerator, the 3D planning CT image, and a virtual water phantom. Fig. 4shows an illustration of a geometry used for the production of the planning PDI from the planning CT images. The source-to-axis distance (SAD) and source-to-image receptor distance (SID) were 100cm and 140cm, respectively. The geometric setting was the same as that of the EPID mounted on the linear accelerator. The isocenter in the planning CT image was placed at an SAD of 100cm. The isocenter coordinate was obtained from a digital imaging and communications in medicine (DICOM) file for radiation therapy, i.e., DICOM-RT. A divergent primary beam with a number of rays produced from the X-ray focal spot of the linear accelerator was virtually delivered to the planning CT image. The X-ray focal spot was estimated based on an actual focal spot size of 1.53mm [19,20] and a primary collimator angle of 13.9°.Algorithm 2 shows an algorithm for the production of the planning PDI. The dose distribution was calculated in the planning CT image and the virtual water phantom by using the PBC algorithm [26–28]. The PBC algorithm is expressed by:Algorithm 2An algorithm for the production of the planning PDI.1.INPUTIp: planning CT image, K: dose deposition kernel,2.res: resolution of planning CT image;3.COMMENTSIp′: isotropic planning CT image, r: position vector,4.vwp: virtual waterphantom, voi: VOI,5.ρre: relative electron density to water,6.ri: ith sampling position vector, dr: sampling interval on a ray,7.T: TERMA, r0: the initial position vector of the X-ray source,8.ψ: X-ray energy fluence (MeVm−2), E: X-ray energy (MeV),9.μw: linear attenuation coefficient of water (m−1),10.(μ/ρ)w: mass attenuation coefficient of water (m2kg−1);11.INITIALIZATIONvwp←0;12.//Isotropic Planning CT image by cubic interpolation[21]13.FOR ALL r DO14.Ip′(r)←Cubic interpolation (Ip(r), res);15.//Deamination of VOI[22]16.voi(r)←Cropping VOI (Ip′(r),vwp(r));17.//Conversion of the CT value into the electron density[23]18.IFvoi(r)≠ 0 THEN19.ρre(r)←CT to ED conversion(Ip′(r),vwp(r));20.//Calculation of WEPL[24,25]21.W(r)←∑i=0S−1ρre(ri)⋅dr;22.T(r)←r0r2∫ψ(E,r0)exp(−μw(E)⋅W(r−r0))⋅μρw(E,r)dE;23.//Calculation of dose distribution24.D(r)←T(r)⋅K(r);25.//Extraction of 2D dose distribution in detector plane26.IF r∈detector plane THEN27.Φ(r)←D(r);28.END IF29.END IF30.END FOR31.OUTPUTΦ: planning PDI;(1)D(r)=∭T(r')⋅K(r−r')dr'=T(r)*K(r),where D is the absorbed dose (Gy), r is the 3D position vector, T is the TERMA and K is the dose deposition kernel (DDK). The DDK is a 3D spatial distribution of the energy deposited by electrons and positrons, which describes the energy spread from the site of a primary photon interaction [27]. A DDK modeled by Ahnesjö [27] was used in this study, and it is defined by:(2)K(l,θ)=Aθe−aθl+Bθe−bθll2,where Aθ, aθ, Bθ, and bθare the parameters of the scattering angle θ, and l is the distance between the interaction site and the dose deposition site. The first term in the numerator of Eq. (2) mainly describes the energy deposited as a primary dose, and the second term mainly describes the energy deposited as a scattered dose. A 2D dose distribution on the detector plane in the virtual water phantom was estimated as a planning PDI. The detector plane was set at the same position as the EPID on a central beam axis (z-axis).Fig. 5shows a processing pipeline for estimating the simulated 4D “treatment” CT images based on a PDI-based 2D/3D registration. The simulated 4D “treatment” CT image was estimated by deforming the 3D planning CT image with an affine transformation matrix, which is described in Appendix A.Algorithm 3 shows an overall algorithm for the estimation of the simulated 4D “treatment” CT images by using a PDI-based 2D/3D registration between a 2D portal dynamic image and 3D planning CT image.Algorithm 3An overall algorithm for the estimation of the simulated 4D “treatment” CT images by using a PDI-based 2D/3D registration between a 2D portal dynamic image and 3D planning CT image.1.INPUTIp, Ic, K, res;2.COMMENTS s=[θx, θy, θz, τx, τy, τz, μx, μy, μz]T: transformation parameter set,3.sopt: optimal transformation parameter set,4.TM: affine transformation matrix, It: deformed planning CT image,5.gp: gamma pass rate (3mm/3%),6.In: simulated “treatment” CT image in nth frame,7.N: max. no. of frames;8.WHILEn≤NDO9.INITIALIZATIONs←[0,0,0,0,0,0,1,1,1]T10.//Deformation of the planning CT image11.TM(s)←Affine matrix conversion (s);12.It(s)←TM(s)⋅Ip;13.//Production of planning PDI14.Φ(s)←Planning PDI (It(s), K, res);15.//Gamma pass rate as a criteria16.gp←Gamma evaluation (Φ(s), Ic);17.IFgp>98.0 THEN18.sopt←s;19.ELSE THEN20.sopt←Optimization of a parameter set of an affine transformation matrix using an LM algorithm (s, Φ(s), Ic, gp);//Algorithm 421.END IF22.In←It(sopt);23.END WHILE24.OUTPUTI={I1,I2,…IN}: simulated 4D “treatment” CT image;A gamma pass rate (3mm/3%) between the planning PDI and the dynamic clinical PDI was calculated as a criterion for estimating the “treatment” CT image. The gamma evaluation is an analytical method, which can evaluate the agreement between two dose distributions based on the distance between compared points and the dose difference [29,30]. Fig. 6shows a schematic representation of the theoretical concept of the gamma evaluation method. The gamma value is defined by:(3)γ(rc)=min{Γ(rr,rc)}∀{rr},where(4)Γ(rr,rc)=r2(rr,rc)ΔdM2+δ2(rr,rc)ΔDM2,rris the reference point, rcis the compared point, r(rr, rc) is the distance between the reference and the compared point, δ(rr, rc) is the difference between the dose on the rrand rc, ΔdMis the distance criterion and ΔDMis the dose difference criterion. The agreement and disagreement criteria become:(5)γ(rc)≤1,agreement,andγ(rc)>1,disagreement.The gamma pass rate is defined by the following equation:(6)Gamma pass rate(%)=No. of agreement pointsNo. of all points⋅100.If the pass rate exceeded 98.0%, the deformed planning CT image and planning PDI were regarded as the “treatment” CT image and “treatment” PDI, respectively. Otherwise, a transformation parameter set was optimized by using the Levenberg–Marquardt (LM) algorithm [31,32], whose details are explained Appendix B. It should be noted that each parameter range was limited to avoid the use of unlikely large parameters, which may be calculated using the LM algorithm. Table 2shows the ranges for the rotation, translation and scaling parameters in the affine transformation. If any of the parameters exceeded its range, the upper or lower limit value was used as the parameter. This procedure was applied to all frames of the EPID dynamic images to estimate the simulated 4D “treatment” CT image.Fig. 7shows an illustration of an estimation of the 4D dose distributions. The 4D dose distributions during the treatment delivery were calculated by applying the PBC algorithm to the simulated 4D “treatment” CT images.The gamma evaluation mentioned above was used to evaluate the proposed framework with respect to the dose distribution similarity between the “treatment” PDI derived from simulated 4D “treatment” CT image and the dynamic clinical PDI derived from the EPID dynamic image. Gamma images, whose pixel value was a γ value, were calculated to visually verify the dose distribution similarity.In addition, a percentage error between a prescribed dose and an estimated dose at an isocenter was also calculated to evaluate of the proposed framework. The percentage dose error was defined by the following equation:(7)Dose error(%)=|estimated dose−prescribed dose|prescribed dose⋅100.

@&#CONCLUSIONS@&#
