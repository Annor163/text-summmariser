@&#MAIN-TITLE@&#
A statistical atlas based approach to automated subject-specific FE modeling

@&#HIGHLIGHTS@&#
A statistical atlas is constructed to account for shape variations.Shape correspondence is obtained through the eigenspace search.Subject-specific FE mesh is obtained from the deformed mesh of the mean shape.The method is automated and is applicable to shapes with large variations.

@&#KEYPHRASES@&#
Free-form deformation,Morphing,Statistical shape modeling,Finite element modeling,

@&#ABSTRACT@&#
Subject-specific modeling is increasingly important in biomechanics simulation. However, how to automatically create high-quality finite element (FE) mesh and how to automatically impose boundary condition are challenging.This paper presents a statistical atlas based approach for automatic meshing of subject-specific shapes. In our approach, shape variations among a shape population are explicitly modeled and the correspondence between a given subject-specific shape and the statistical atlas is sought within the “legal” shape variations. This approach involves three parts: (1) constructing a statistical atlas from a shape population, including the statistical shape model and the FE model of the mean shape; (2) establishing the correspondence between a given subject shape and the atlas; and (3) deforming the atlas to the subject shape based on the shape correspondence. Numerical results on 2D hands, 3D femur bones and 3D aorta demonstrate the effectiveness of the proposed approach.

@&#INTRODUCTION@&#
Biomechanical simulation often involves finite element (FE) modeling of subject-specific anatomic structures. However, the task of creating FE meshes such as hex mesh for each subject usually requires manual intervention and can be tedious and time consuming. Such lack of automation in FE modeling and its lengthy laborious process pose substantial challenges for applications where FE modeling and analysis need to be done in a short period of time, for example, in clinical setting such as providing surgical guidance during surgery. The ability to automate FE modeling of subject-specific shapes would lead to a population of subject-specific models with applications in surgical planning and implant design. The goal of this paper is to present an approach that can automatically build subject-specific FE models from a given subject-specific shape.In the literature, a common approach to efficient shape modeling or FE modeling of subject-specific shapes is through template-based deformation. For example, morphing template meshes to subject-specific shapes has been explored in  [1–3]. A mesh morphing approach to conduct statistical models of femurs was studied in  [4]. However, it has not been used to generate subject-specific FE models. Recently, an atlas based geometry pipeline for constructing three-dimensional cubic Hermite finite element meshes from tomographic patient image data and deforming the atlas to a second patient has been studied in  [5].The above approaches usually contain two steps: (1) registration of the subject shape  [1–4] or image  [5] to the template; (2) FE mesh morphing of the template to the subject with the correspondence obtained in the registration. However, these approaches are unaware of the specificity of the subject shapes and usually need to involve a large number of registration parameters and manual specification of a large number of landmarks to ensure proper correspondence between a given shape and the template shape. For example, in the free-form deformation, as pointed out by  [3], the resolution of the deformation should be approximately the size of the smallest anatomical structures to be registered, so it requires a large number of degrees of freedom (thousands) for the accurate registration of fine structures. This makes the problem complex, inefficient and more importantly, not robust. When a subject shape deviates significantly from the template shape, a simple deformation based approach, without manual specification of correspondence between the template shape and the given shape, would fail to generate proper correspondence between the two shapes. Therefore, the FE mesh and boundary conditions cannot be properly transferred from the template shape to the given shape.For a certain class of shapes, the shape variations follow some particular patterns, and the deformations within the class are constrained by a limited number of degrees of freedom. Thus, for the FE mesh construction of a specific class of subject shapes, we first learn a prior knowledge of the population through statistical shape modeling  [6] and build a linear space of shapes. Then, instead of applying a “free style deformation” in the registration, the mean shape of the population is deformed in the “shape space” to match the subject-specific shape. In this way the deformation could be parameterized by just a few number of variables and becomes simple and robust. The generic FE mesh is built upon the mean shape of the population.Fig. 1gives an overview of our approach: the input is the subject specific shape, the output is the FE mesh of the subject shape. This mesh construction process is based on the statistical atlas and contains two steps: (1) boundary correspondence identification through shape instantiation and projection; (2) FE mesh morphing by the boundary correspondence.The statistical atlas contains two parts: the statistical shape model which determines a linear shape space and the FE mesh of the mean shape. The statistical shape model is learned from a population of shapes by principal component analysis, and includes the mean shapeS̄of the population and the eigen-modes{Ψi}that capture the variations of the population. Originated at the mean shape, the eigen-modes together span a linear space of the shapes and any instance in that space can be instantiated by:S˜=S̄+∑iwiΨi,where{wi}are the shape parameters.In the step of correspondence identification, the mean shape is deformed to the subject shape along a path in the shape space by optimizing the shape parameters{wi}and is then projected onto the subject shape to establish the boundary correspondence between the mean shape and the subject shape.Based on the obtained boundary correspondence, the FE mesh of the mean shape is then morphed to the subject shape through free-form deformation.The contribution of this paper is a new approach that can automatically, efficiently and robustly produce high quality FE meshes for a given subject-specific shape. To examine the quality of the proposed approach, we use three measures: the distance between the instantiated shape and the given shape, the correlation coefficient of normal vectors between the mean shape and the given shape, and the mesh quality. Numerical examples on 2D hands, 3D femur bones and 3D aorta demonstrate that the proposed approach outperforms the simple deformation based approach.The remainder of this paper is organized as follows. Section  2 introduces the construction of statistical atlas, Sections  3 and 4 cover the two steps of the proposed approach, Section  5 introduces the three measures for our approach. Numerical results are presented in Section  6. This paper is concluded in Section  7.The statistical atlas is constructed to incorporate the prior knowledge of a specific class of shapes and provide a generic FE mesh for mesh morphing. The prior knowledge are learned by the statistical shape modeling of a population of training shapes. The generic FE mesh is constructed on the population mean whose overall distance to other instances in the population is minimized.In this section we briefly introduce the process of statistical atlas construction. A set of training shapes are registered together in a non-rigid fashion through free-form deformation. In order to ensure good correspondence across the shape population, landmarks are specified. A mean shape model and shape variations across a population of shapes are then obtained through generalized Procrustes alignment (GPA)  [7] and principal component analysis of the shape population. The mean shape is then discretized into FE meshes (triangular or hexagonal).In the following subsections we will use the 40 hand shapes in  [6] as examples to demonstrate our method.Given the training set ofnsnumber of shapesS={S1,S2,…,Sns}, in order to correctly calculate the population mean and model the shape variations, correspondences between these shapes must be built. Based on such correspondences, we sample the same number of points on each shape and conduct the statistical shape modeling.In our work, we use the free-form deformation (FFD) method to establish the correspondences between the training shapes, which had been successfully applied in the shape registrations by  [8–10].Among thensnumber of training shapes, one shape is chosen as the template shape, note it asS1. It is deformed to the other shapesSk,k=2,…,nsin the training set respectively and is then projected onto them to build the correspondences.The deformation of a shapeS⊂Rdin theddimensional Euclidean spaced=2,3is done by the deformation of its underlying domainΩ⊂Rd, here we use the B-spline FFD:(1)f(u)=∑i∈IPiBi(u),u∈[0,1]d,{Pi:i∈I}is the set of control points,{Bi:i∈I}is the set of B-bases,uis the parameter value.As shown by Fig. 2, in this paper, the shapes are represented by discrete points:Sk={v1(k),v2(k),…,vNk(k)},k=1,…,ns. The registration of the template shapeS1to a target shape (note it asS2for simplicity) is done by minimizing:(2)min{Pi}Edeviation+αEsmooth+βElandmarks.The first term in (2)Edeviation=∑j=1N1‖f(vj(1))−vj(2,c)‖2,is the sum of square of deviations between the deformed templatef(S1)and the targetS2,fis the deformation field as defined in (1), andvj(2,c)is the closest point ofvj(1)inS2.The second term in (2)Esmooth=∫Ω‖(∑i=1d∂∂xi)2f‖2dx,is the smoothing term and penalizes large deformations. The smoothing coefficientαin (2) is chosen to be large at the initial deformation steps and reduced gradually.To guide the deformation, we manually assign a set of landmarks to each shape with presumed correspondences. The third term in (2)Elandmarks=∑i=1l‖f(v̄i(1))−v̄i(2)‖2,captures the mismatch error of the landmarks.{(v̄1(1),v̄1(2)),…,(v̄l(1),v̄l(2))}are the pair of landmarks onS1andS2. The landmark weightβin (2) is decided so thatαEdeviationandβElandmarksare in the same order of magnitude.Formula (2) is a formulation that has been widely used in the pairwise shape registrations  [9–14,8,15], to minimize it we adopt the typical iterative algorithm  [9,8,12] in non-rigid shape registration.After we have found the desired deformationf, we project the deformed templatef(S1)onto the targetS2along the vertex normal and establish a point-wise correspondence betweenS1andS2. The normal on the vertex is calculated by averaging the normals of its surrounding elements (line segments in 2D and triangle facets in 3D).Once we have established the point-wise correspondences between the train shapes and the template, we re-sample each shape with the correspondences and obtainSc={S1c,S2c,…,Snsc}.The shapes inScare represented by the same number of points that are in correspondences, on which we conduct the generalized Procrustes analysis  [7] and obtain the mean shapeS̄and the set of aligned shapesSa={S1a,S2a,…,Snsa}that had been projected to the tangent space  [6] of the mean shape, whereS̄={p¯1,…,p¯N},Ska={p1(k),…,pN(k)},k=1,…,ns,Nis the number of sample points, and(3)S̄=1ns∑k=1nsSka.Fig. 3shows the results of the generalized Procrustes analysis of 40 hand shapes.In the generalized Procrustes analysis, we have aligned all the training shapes to the mean shape and projected them into the tangent space of the mean shape, by doing these we obtain a linear space of shapes. Here, we vectorize each shape by rearranging the coordinates and have:S̄=[x¯1,1,…,x¯1,d,x¯2,1,…,x¯N,d]T, andSka=[x1,1(k),…,x1,d(k),x2,1(k),…,xN,d(k)]T,k=1,…,ns.We can view those vectorized shapesS1g,S2g,…,Snsgas points in theN×ddimensional space, and center them with respect to the mean shape, by that we obtain the shape variation matrixΦ={Φ1,Φ2,…,Φns}, whereΦk=Ska−S̄,k=1,…,ns. The variations{Φk}together span a linear shape spaceΘcentered atS̄.By calculating the eigen-valuesλ1,λ2,…,λns−1and the corresponding eigen-modesΨ1,Ψ2,…,Ψns−1of the covariance matrixΣ=1ns−1ΨΨT, we obtain a set of orthonormal basesΨk,k=1,…,ns−1forΘ, these bases are the principal directions that maximize the shape variations, andλk,k=1,…,ns−1are the variances in these directions ordered from large to small.Usually a good statistical shape model should have the first several eigen-values to capture a majority of the population variations and in this case the shape variations can be efficiently modeled by the first several eigen-modes. We call the space spanned by the set of eigen-modesΨk,k=1,…,m,m<ns−1the eigen-spaceΘof the statistical shape model, which is a subspace of the whole shape spaceΘ. We can instantiate new shape instances inΘby:(4)S˜=S̄+∑k=1mwkΨk.Usually, we choosemby letting∑i=1mλi/∑insλi≥p, wherepis the percentage of variances we want the firstmeigen-modes to capture. For the 40 hands we choosep=98.5%, which corresponds to the first 11 eigen-modes.In Fig. 4we show the first three eigen-modes of the hand shapes obtained by the principal component analysis.In Fig. 5we show the cumulative shape variances. In which the first 8 modes have captured 98.14% of the shape variances and the first 11 modes have captured 99.01% of the shape variances.After the statistical shape modeling, we obtain the mean shapeS̄of the training populations, on which we create a generic FE mesh. This generic FE mesh will be used as a template to create subject-specific FE meshes.Fig. 6shows the quadrilateral mesh of the mean shape of the 40 hands in Section  2.3, the color shows the value of Jacobians, which are all positive.By the statistical shape modeling, we obtain the mean shapeS̄and the eigen-modesΨ1,Ψ2,…,Ψns−1of the training populations. The eigen-modes capture the shape variations and together span a linear shape space. By choosing the firstmeigen-modes corresponding to the major shape variations as described in 2.3, we obtain the eigen-spaceΘ, and an instance in it can be instantiated byS˜=S̄+∑k=1mwkΨk, wherew=[w1,w2,…,wm]Tare the shape parameters.Given a new shapeSˆ, we search in the eigen-space to find the optimal shape parameterswthat best synthesize it and obtain the optimal shape instanceS˜inΘforSˆ. Then we projectS˜ontoSˆalong the normal so to obtain the finally synthesized shapeS˜P, from which the point-wise correspondences between the given shape and the atlas can be established.During the eigen-space search, the instantiated shapeS˜is in the reference frame ofΘ, whileSˆlocates in the image frame or physical frame, depends on how it was obtained, and we note the transformation from the reference frame to the physical frame astR,T,swith parametersR,T,s, whereRis the rotation,Tis the translation andsis the scaling. For a pointp,tR,T,s(p)=sRp+T. In our later expression, we usetR,T,s∘Sto denote the transformation of a shape undertR,T,spoint-wisely.Similar with the free-form deformation, we search for the optimal shape parameters and transformation by minimizing the distances between the new shapeSˆand the instantiated shapeS˜follows by a regularization term. We have the total energy function:(5)minR,T,s,wE=Ed+γEr,whereEdis the distance term andEris the regularization term just asEsmoothin the free-form deformation, and large regularization coefficientγwill give strong penalizations to large shape parameterswwhen compared with the square roots of the eigen-valuesσk=λk,k=1,…,m. We have(6)Ed=‖Sˆc−tR,T,s∘(S̄+Ψw)‖2,captures the discrepancies between given shapeSˆand the shape instanceS˜=S̄+Ψw, whereΨ=[Ψ1,Ψ2,…,Ψm], andSˆcis the re-sampling ofSˆbased on the correspondence. We have(7)Er=wTΛ−1w,as the regularization term, whereΛ=diag(σ12,…,σm2)is the diagonal matrix of the eigen-values.Similar to the non-rigid registration algorithm in  [8,9,12], we choose large initial regularization coefficientγand reduce it gradually. So at the beginning, more global transformations are recovered byR,T,sand asγis reduced, major shape variations are recovered by the parameters corresponding to larger eigen-values, and asγ​keeps reducing, local fine shape variations are recovered as the parameters corresponding to smaller eigen-values being effective in (5).The shape instantiation is done through an iterative process as shown in Fig. 7, in which the correspondence and the parametersw,R,T,sare optimized iteratively.Starting from the mean shapeS̄, we build the correspondence betweenS̄and the given shapeSˆby searching the closest point. Based on the correspondence, we re-sampleSˆand obtainSˆc, with which we search for the optimal shape parameterswand transformationR,T,sby minimize (5). After that we instantiate a shape instance byS˜=S̄+Ψwand transform it to the frame ofSˆbytR,T,s∘S˜. Then we update the correspondence with the newly instantiated shape and iterate until convergence.With known correspondence and the re-sampled pointsSˆc, formula (5) is minimized through iteratively optimizing the shape parameterswand the transformationR,T,sby applying the Protocol 1 (Matching model points to target points) of the active shape algorithm in  [16], which was originally used for image segmentation in  [16,17]. The only difference is the way we update the shape parametersw. Due to the regularization term added, by letting∂E∂w=0, we have(8)w=(I+γs2Λ−1)−1ΨT(tR,T,s−1∘Sˆc−S¯),wheretR,T,s−1is the inverse transformation oftR,T,s, I is them×midentity matrix. Whenγ=0, we havew=ΨT(tR,T,s−1∘Sˆc−S̄)as in  [16].The below Algorithm gives a detailed description of our approach:The inputs for Algorithm 1 are the mean shapeS̄, the eigen-modesΨand the given shapeSˆfor synthesis; the output is the finally synthesized shapeS˜P. With the initialization, we start from the mean shape and deform it to the given shape through successive shape instantiations.In the outer loop, under the current regularization coefficientγ, we found the optimal correspondence, shape parameterswand transformationsR,T,sfor the given shapeSˆwhich respect to (5). Then we reduce the regularization coefficientγ, and use the current parameters as the initial input and optimize. If the correspondence does not change any more, we exit the outer loop otherwise we go toγn.In the inner loop, we find the optimal parameters for the currentγby iteratively optimizing the correspondence and the parametersw,R,T,s. The convergence criteria for the inner loop is that the change of the shape parameters should be smaller thanε=10−6.Once the correspondence is not changing, we projecttR,T,s∘S˜ontoSˆalong the normal and obtain the optimal shape synthesisS˜PforSˆ, by which we obtain the one-to-one correspondences between the mean shapeS̄and the given shapeSˆas a by-product.In Section  3 we have shown how to automatically register the subject shapeSˆto the mean shapeS̄by the shape instantiation and projection. As a by-product, we obtain the transformationtR,T,sfrom the reference frame to the frame ofSˆ, by its inversetR,T,s−1we transform the subject shapeSˆto the reference frame where the mean shape locates. Then with the explicit correspondences between the boundaries ofSˆandS̄, we obtain a smooth deformation field that morphs the mesh ofS̄toSˆby(9)min{Pi}∑j=1N‖f(p¯j)−pˆj‖2+αEsmooth,wherefis the B-spline field defined in (1),Pi,i∈Iare its control points.p¯j,j∈1,…,Nis the point on the mean shapeS̄, andpˆjis its corresponding point onSˆobtained by the shape instantiation and projection. The smoothing termEsmoothis the same as in Section  2.1 andαis the smoothing coefficient. Here since we know the right correspondences, a smallαis enough. e.g., in the pairwise registration by FFD of the 2D hand, we begin withα=30,000, hereα=50would be enough.With the obtained deformation fieldf, we morph the FE mesh ofS̄toSˆ.In Fig. 8we show the correspondence obtained by the method of Section  3 and the resulting FE mesh from mesh morphing with the correspondence. The Jacobians in Fig. 8(b) are all positive which means the mesh is valid.

@&#CONCLUSIONS@&#
