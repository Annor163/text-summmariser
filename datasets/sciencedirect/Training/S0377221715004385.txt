@&#MAIN-TITLE@&#
Risk aversion in multistage stochastic programming: A modeling and algorithmic perspective

@&#HIGHLIGHTS@&#
We discuss alternatives to incorporate risk into a multistage stochastic program.We propose a new definition of (time)-consistency.We illustrate the pitfalls of some measures of risk used in practice.We study a new class of multi-period risk measures.We apply the proposed multi-period risk measure to a pension fund problem.

@&#KEYPHRASES@&#
Stochastic programming,Risk aversion,Multistage,Consistency,Pension funds,

@&#ABSTRACT@&#
We discuss the incorporation of risk measures into multistage stochastic programs. While much attention has been recently devoted in the literature to this type of model, it appears that there is no consensus on the best way to accomplish that goal. In this paper, we discuss pros and cons of some of the existing approaches. A key notion that must be considered in the analysis is that of consistency, which roughly speaking means that decisions made today should agree with the planning made yesterday for the scenario that actually occurred. Several definitions of consistency have been proposed in the literature, with various levels of rigor; we provide our own definition and give conditions for a multi-period risk measure to be consistent. A popular way to ensure consistency is to nest the one-step risk measures calculated in each stage, but such an approach has drawbacks from the algorithmic viewpoint. We discuss a class of risk measures—which we call expected conditional risk measures—that address those shortcomings. We illustrate the ideas set forth in the paper with numerical results for a pension fund problem in which a company acts as the sponsor of the fund and the participants’ plan is defined-benefit.

@&#INTRODUCTION@&#
The evolution and widespread use of stochastic programming is closely related to the increasing computing power made available since the foundation of the field. The important class of two-stage stochastic programs found immediate use in applications since its general framework of first- and second-stage decisions is suitable for a number of real-world problems, see for instance Wallace and Ziemba (2005). Later, the attention turned to multistage stochastic programs (MSSPs), which are a natural extension of two-stage models. In those problems the sequence of events starts with a decision, followed by a realization of a random vector, and then a decision is made knowing the outcome of the random vector, a new realization occurs, and so on. Randomness is often described by a continuous stochastic process or by a discrete process with a very high number of possible outcomes. A common approach is to build a scenario tree, which is a discrete representation that in some sense is close to the original process according to some distance. The generation of scenario trees has received a great deal of attention in the literature: see, for instance, Pflug (2001), Høyland and Wallace (2001), Dupačová, Gröwe-Kuska, and Römisch (2003), Heitsch and Römisch (2009), Pflug and Pichler (2011), Pflug and Pichler (2012), Mehrotra and Papp (2013). Scenario trees are crucial for numerical solution of the problem, as algorithms used in practice to solve the problem are typically rooted in some decomposition principles such as the Nested Decomposition (Donohue & Birge, 2006) or the Stochastic Dual Dynamic Programming scheme (Pereira & Pinto, 1991). MSSPs have been used in a number of areas, including finance, revenue management, energy planning, and natural resources management, among others.The classical formulation of stochastic programs (in two or more stages) optimizes the expected value of an objective function that depends on the decision variables as well as on the random variables that represent the uncertainty in the problem. Such a formulation assumes that the decision maker is risk-neutral, i.e., he or she will not mind large losses in some scenarios as long as those are offset by large gains in other scenarios. While such an approach is useful in a number of applications, it does not reflect the situation where the decision is very concerned about large losses—in other words, such a decision maker is risk-averse. It is natural then to consider risk-averse formulation of stochastic programs.In the case of two-stage models, the structure of a first-stage deterministic cost plus a random recourse cost in the second stage makes the extension to the risk-averse case immediate from a modeling perspective, in the sense that the natural choice is to replace the expectation of the second stage cost with some other risk measure; see, for instance, Schultz and Tiedemann (2006), Fábián (2008), Shapiro, Dentcheva, and Ruszczyński (2009) and Miller and Ruszczyński (2011). The difficulty associated with the risk-averse model depends on the choice of the risk measure. Ahmed (2006) shows that if the risk measure is the variance, then the resulting problem is NP-hard. Furthermore, monotonicity in the second stage would be lost, and the cost units of first and second stage would be different unless the standard deviation was used, but the problem would likely become intractable in this case. Rockafellar and Uryasev (2000) show that if the Conditional Value-at-Risk is chosen, the sampled version of the continuous problem can be approximated by a linear programming problem. Noyan (2012) proposes two decomposition algorithms to efficiently solve a disaster management problem with the Conditional Value-at-Risk as the risk measure.For multistage stochastic programming the picture is quite different and several questions arise. When sequential decision is involved, there is no natural or obvious way of measuring risk. Should risk be measured at every stage separately? Should it be applied to the several scenario paths in the tree? Or should risk be measured in a nested way, in the spirit of dynamic programming? What if only the risk at the end of the time horizon is relevant and we do not want to measure risk at the other stages? The difficulty in extending risk measures to the multistage setting has been discussed in several papers and it can be argued that the differences among the approaches are far more significant than the two-stage case.A number of recent papers have considered the importance of measuring risk in MSSPs (see, for instance, Collado, Papp, & Ruszczyński, 2012; Eichhorn & Römisch, 2005; Guigues & Sagastizábal, 2013; Kozmík & Morton, 2015; Pagnoncelli & Piazza, 2012; Pflug & Römisch, 2007; Pflug & Pichler, 2014b; Philpott & de Matos, 2012; Philpott, de Matos, & Finardi, 2013; Shapiro, 2012a; Shapiro, Tekaya, Soares, & da Costa, 2013). Several of these papers focus on how to adapt existing algorithms from the risk-neutral case to the risk-averse case, often with the Conditional Value-at-Risk as the risk measure. One of the goals of our paper is to address some of the popular ways to measure risk and discuss their advantages and drawbacks. In addition, we revisit and extend a class of multi-period risk measures proposed by Pflug and Ruszczyński (2005) (see also Pflug, 2006 for a more extensive discussion), which we call expected conditional risk measures (ECRMs), and discuss how the resulting problem can be efficiently solved. ECRMs combine two attractive features: on the one hand, ECRMs can be represented in a nested form, a feature that is desirable and the focus of much of the recent literature, as we shall see later; on the other hand, we show that when ECRMs are applied with the Conditional Value-at-Risk (CVaR) as the underlying risk measure, the resulting MSSP can be represented by a simpler risk-neutral MSSP with additional variables, much in the spirit of the polyhedral risk measures introduced by Eichhorn and Römisch (2005).As it has been observed in the literature, one very important issue that arises when modeling risk-averse MSSPs is that of time consistency. Time consistency in MSSPs has been highlighted by several authors in recent years as a desirable property a problem should have. Informally, time consistency means that if you solve an MSSP today and find solutions for each node of a tree, you should find the same solutions if you re-solve the problem tomorrow given what was observed and decided today. The definitions in the literature differ mainly by their focus: the works of Ruszczyński (2010) and Kovacevic and Pflug (2014) deal with sequences of random variables, while Detlefsen and Scandolo (2005), Cheridito, Delbaen, and Kupper (2006), and Bion-Nadal (2008), define time consistency for continuous-time dynamic models. The definitions in Shapiro (2009), Carpentier, Chancelier, Cohen, De Lara, and Girardeau (2012), Rudloff, Street, and Valladão (2014) and De Lara and Leclère (2014) are centered on optimization and on the stability of decision variables at every stage. Xin, Goldberg, and Shapiro (2013) propose definitions of time-consistency of policies in the context of distributionally robust MSSPs, whereas Pflug and Pichler (2014a) propose a related notion of time-consistent decisions. We propose a new definition of consistency, closer to the optimization-oriented papers. Our definition is suitable for MSSPs that can be represented via scenario trees. Using a simple three-stage inventory problem we show that several natural ways of measuring risk lead to inconsistent formulations, according to our definition. We also show the class of ECRMs we study in this paper is time-consistent.We illustrate the applicability of ECRMs by using it in a pension fund problem proposed by Haneveld, Streutker, and Van Der Vlerk (2010). This numerical example illustrates two important aspects of ECRMs: first, the simplicity of implementation when the CVaR is used as an ingredient for the ECRM—indeed, we use standard software for risk-neutral multistage programs available in the literature to solve the corresponding risk-averse problem. The second important aspect is the flexibility allowed by the model to represent the change in the degree of risk aversion over time; for example, the decision maker may be more risk-averse about the earlier stages and less risk-averse about the stages farther in the future. We also use the numerical example to propose a (to the best of our knowledge) novel way to compare optimal solutions of MSSPs. The majority of applications only analyzes the first-stage solution since in most cases a rolling-horizon procedure will be implemented in practice and the solutions of other stages will not be implemented. We show in our pension fund example that the solutions of subsequent stages carry important information concerning the quality and robustness of the first-stage solution. By using first- and second-order dominance we show that despite having an attractive first-stage allocation, some solutions exhibit a poor behavior in subsequent stages, such as having a very high probability of needing extra money injection in the fund.The rest of the paper is organized as follows. Section 2 defines our notion of consistency. In Section 3 we present an inventory problem that illustrates our notion of consistency and discuss several modeling paradigms for risk-averse MSSPs. We prove some results that characterize consistency according to our definition in Section 4. In Section 5 we introduce the notion of ECRMs and study in detail their properties, including consistency and the equivalent risk-neutral formulation of the case with CVaR. The pension fund example that illustrates our approach is presented in Section 6, while Section 7 presents some concluding remarks.We start by defining precisely the notation and the class of problems we want to study. Consider a probability space(Ω,F,P),and letF1⊂F2⊂…FTbe sub sigma-algebras ofFsuch that eachFtcorresponds to the information available up to (and including) stage t, withF1={∅,Ω}andFT=F. LetZtdenote a space ofFt-measurable functions from Ω toR,and letZ:=Z1×⋯×ZT. We define a multi-period risk functionFas a mapping fromZtoR. For example, we may have, forZ∈Z,(2.1)F(Z)=F1(Z1)+⋯+FT(ZT),where eachFtis a one-period risk function, i.e., a mapping fromZttoR. Note that some assumptions may be required for the existence of the mappingF. For example, consider the additive case (2.1) with eachFibeing the expectation operator; then, each expectation must exist and be finite, which can be ensured for example when Ω is finite. Throughout this paper we assume thatFis well-defined and finite.Consider now the spaceDTof distributions of T-dimensional random vectors inZ. That is, each elementG∈DT—which is a mapping fromBTto [0, 1], whereBTis the Borel sigma-algebra inRT—can be written as the distribution function GZof someZ=(Z1,…,ZT)∈Z,defined asGZ(BT):=P(Z∈BT).Note that Z is not uniquely defined, i.e., we may haveG=GZ=GYfor two different random vectors Z and Y. For the purpose of the developments in this paper, we shall restrict ourselves to multi-period risk functionsFthat are law-invariant, in the sense that if Z and Y are elements ofZsuch that Z and Y have the same distribution (i.e.,GZ(BT)=GY(BT)for allBT∈BT), thenF(Z)=F(Y). In that case, given a multi-period risk functionFwe can associateFwith a unique mappingF˜:DT↦Rsuch thatF˜(GZ):=F(Z).Following this line of reasoning, we can define the notion of a conditional risk function corresponding to a multi-period risk functionFas follows. GivenZ∈Zand(z1,…,zt)∈Rt,letGZ|Z1=z1,…,Zt=ztdenote the conditional distribution of Z givenZ1=z1,…,Zt=zt,which lies inDT. We then define the conditional risk functionFof Z givenZ1,…,Zt(written asFZ1,…,Zt(Z)) as a mapping fromZtoZtsuch that on the event{ω:Z1(ω)=z1,…,Zt(ω)=zt}we have(2.2)FZ1,…,Zt(Z)(ω):=F˜(GZ|Z1=z1,…,Zt=zt).Note thatFZ1,…,Zt(Z)is an element ofZt.Remark 1It is useful to compare the above notion of a conditional risk function with that of a conditional risk mapping defined in Ruszczyński and Shapiro (2006). In that paper, the authors define a conditional risk mapping as a mapping between two linear spaces (for example, fromZttoZt−1) that satisfies some axioms of convexity, monotonicity and translation invariance. Our notion is different in that it presupposes the existence of a multi-period risk functionFon the entire product spaceZ,and then the conditional risk functions are defined in terms of conditional distributions. Although our notion is in a sense less general than that of Ruszczyński and Shapiro (2006) (as it requires the risk functions to be law-invariant), we believe it is convenient from a practical viewpoint. A risk-averse decision maker might want to simply replace the single external expected value in MSSP by another risk measure, without having to define the appropriate conditional risk mappings in each stage as in Ruszczyński and Shapiro (2006). Note, however, that we can create conditional risk mappings from a special class of the conditional risk functions defined in (2.2) using an additive risk functionF,as discussed in Proposition 2.1 below. Below and henceforth, the notation a[t] indicates the collectiona1,…,at.LetFbe a multi-period risk function (as defined earlier) such that(2.3)F(Z1,…,ZT)=F0(Z1+⋯+ZT),for some one-period risk functionF0:ZT↦R. GivenZt∈Zt,consider the conditional risk functionFZ[t]constructed fromFas in (2.2) and define, accordingly,F0Z[t](soF0Z[t]is a mapping fromZTtoZt). Suppose that the one-period risk functionF0satisfies the following properties:(i)Convexity: If α ∈ [0, 1] andY,W∈ZT,thenF0(αW+(1−α)Y)≤αF0(W)+(1−α)F0(Y).Monotonicity: IfW,Y∈ZTare such that W ≥ Y w.p.1, thenF0(W)≥F0(Y).Translation invariance: IfW∈ZTand c is a constant, thenF0(W+c)=F0(W)+c.Then,F0Z[t]satisfies the conditions to be a conditional risk mapping as defined inRuszczyński and Shapiro (2006).The proof follows directly from the fact that, for each realizationZ1=z1,…,Zt=zt(writtenZ[t]=z[t]for short), the conditional risk functionF0Z[t]defined fromFZ[t]in (2.2) corresponds toF0applied to some element ofZT(namely, the random variable whose distribution isG(·|Z[t]=z[t])), so properties (A1) and (A2) in Ruszczyński and Shapiro (2006) follow immediately from (i) and (ii). Property (A3) in Ruszczyński and Shapiro (2006) follows from (iii) and the observation that on the event{Z[t]=z[t]}the random variable Ztis a constant.□In the course of our discussion we will often refer to one-period conditional risk measures; those should be understood as theF0Z[t]in Proposition 2.1. Note that several one-period risk measures can be expressed as functions of expectations; this is the case, for example, of CVaR and mean semi-deviations, among others. In such cases, the conditional risk functionFZ[t]corresponds to replacing the expectations with conditional expectationsE[·|Z[t]]. More generally, one can apply a similar procedure to the dual representation of a coherent risk measure to obtain its conditional version, as done in Pflug and Pichler (2014a).Remark 2It is important to note that the notion of law invariance defined above is different from that in Shapiro (2012b). In that paper, a risk function of the form (2.3) is called law invariant ifF0(Z1+⋯+ZT)=F0(W1+⋯+WT)wheneverZ1+⋯+ZTis equal in distribution toW1+⋯+WT. Our notion, in contrast, requires that the values of the risk functions be equal whenever the joint distribution ofZ1,…,ZTis the same as the joint distribution ofW1,…,WT. In other words, our requirement for law invariance is weaker in the sense that we only require the risk function values to be the same when the whole processes are equivalent. This is an important distinction, since in our view the decision maker may assign different risks to the total costZ1+⋯+ZTdepending on how that cost was achieved—for example, a portfolio manager may consider a portfolio with many ups-and-downs a lot riskier than one with constant returns, even if the final wealths are equal in distribution. Fig. 1illustrates the issue. An examination of the two trees shows that the distribution of total costs (i.e., second plus third period) is the same for both trees. However, the tree on the left-side of the figure has more variability in period 2 than the one on the right side, which may be important for the decision maker. Under the notion of law invariance in Shapiro (2012b), the two trees will be assigned the same risk, whereas our definition allows for different values.With the above notation at hand, we formulate the class of problems we are interested in studying.(P)minx1,…,xTF(f1(x1,ξ1),…,fT(xT,ξT))s.t.xt∈Xt(x[t−1],ξ[t]),t=1,…,T.In the above model,xt∈Rntdenotes the decision made in stage t; ξtis an mt-dimensional random vector representing the uncertainty observed in stage t, i.e., ξtis anFt-measurable mapping from Ω toRmt; ftis a function fromRnt×Rmtthat corresponds to the cost of decision xtgiven the observed uncertainty ξt(ω) in that stage;Xt(x[t−1],ξ[t])denotes the feasibility set in stage t, which may depend on previous decisions as well as on the observed uncertainty. We writeF(f1(x1,ξ1),…,fT(xT,ξT))as a short forF(Z1,…,ZT),withZt∈Ztdefined as Zt(ω) ≔ ft(xt, ξt(ω)). It is clear from the above definition that any feasible solutionx:=[x1,…,xT]to (P) is such that each xtis actually a function ofξ2,…,ξt,though we make that dependence explicit only when necessary to avoid cluttering the notation.We propose now our notion of consistency, which is inspired by the different definitions available in the literature. Consider the problem of solving (P) at a given stage t, when all the information from previous stages (given byx^[t−1]andξ^[t]) is known. That is, we have the following optimization problem to solve:(Pt)minxt,…,xTFξ^[t](f1(x1,ξ1),…,fT(xT,ξT))s.t.xτ∈Xτ(x^[t−1],xt,…,xτ−1,ξ^[t],ξt+1,…,ξτ),τ=t,…,T.In the above, the notationFξ^[t]indicates a conditional risk function as defined earlier, i.e., the multi-period risk functionFin (P) applied to the random vectorf1(x1,ξ1),…,fT(xT,ξT),conditional on a given realizationξ^1,…,ξ^t(and implicitly onx^[t−1]). Note that under such conditions,f1(x^1,ξ^1),…,ft−1(x^t−1,ξ^t−1)are constants, and so isξ^t.Let[x¯τt,x^[t−1],ξ^[t]:τ=t,…,T]denote an optimal solution of (Pt). We include t,x^[t−1]andξ^[t]as superscripts to emphasize that such a solution is calculated at time t, given the previous stages decisionsx^1,…,x^t−1and conditional on a given realizationξ^1,…,ξ^t. Moreover, as mentioned earlier, eachx¯τt,x^[t−1],ξ^[t],τ=t,…,T,is a function ofξt+1,…,ξτ.Definition 2.2We say that the inherited optimality property (henceforth called IOP) holds for an instance11An instance is an specification of functions ft(xt, ξt), the feasible setsXtas well as the distribution of random vector(ξ1,…,ξT).of problem (P) if, given any time period t such that 1 < t ≤ T and any realizationξ^1,…,ξ^t,there exists an optimal solution x* of (P) such that the solution “inherited” from x* atξ^2,…,ξ^t(denoted as[xτ*(ξ^2,…,ξ^t,·):τ=t,…,T],where “( · )” indicates this is a function ofξt+1,…,ξτ) coincides with an optimal solution of (Pt) for those t,ξ^,andx^:=x*.It is important to observe in the above definition that, in general, problem (Pt) may have many optimal solutions of the form[x¯τt,x^[t−1],ξ^[t](·):τ=t,…,T]. Likewise, problem (P) may have multiple optimal solutions as well. When solving problem (Pt) one might hit upon an optimal solution which is different from the one inherited from period 1. The IOP only requires that one of the optimal solutions of (Pt) coincide with some inherited solution from period 1. Of course, when (P) and (Pt) have unique optimal solutions, then the optimal solution of (Pt) must be the solution “inherited” from the optimal solution in period 1.We are now in a position to define consistency:Definition 2.3We say that the multi-period risk measureFis consistent for problems of the form (P) if the IOP holds for any particular instance of that problem.Note that, by definition, our notion of consistency is independent of any particular instance of the problem; for example, when working with scenario trees, a multi-period risk measureFis consistent no matter which tree we use to represent the input process. We believe consistency is a desired property a risk-averse multistage stochastic program should possess. It can be understood as some sort of stability property: the decision you make today should agree with some optimal plan made yesterday given what was observed today. While a somewhat natural property, consistency does not hold automatically. In the next section we present an example of a simple problem that illustrates several different modeling frameworks for multistage risk-averse stochastic programming and discuss their advantages and disadvantages, including lack of consistency.In this section we present a small inventory problem that illustrates our notion of consistency. To keep the calculations simple, the problem has only three stages. We write the formulations and calculations explicitly to illustrate the characteristics of the resulting models, a feature that in our view helps to illustrate the consequences of choosing among the various ways of measuring risk.We consider two different ways of incorporating risk into the problem, and for those examples we will use the Conditional Value-at-Risk (CVaR) as our risk measure. The choice is justified by the extensive use of this risk measure in a vast array of applications, as well as by its desired properties. A risk measure is said to be coherent according to Artzner, Delbaen, Eber, and Heath (1999) if it satisfies the following properties (below,Wis a linear space of random variables):Translation invariance: Ifa∈RandW∈W,thenρ(W+a)=a+ρ(W).Positive homogeneity: If c > 0 eZ∈Wthenρ(cW)=cρ(W).Monotonicity: IfW1,W2∈Wand W1 ≤ W2, then ρ(W1) ≤ ρ(W2).Convexity: IfW1,W2∈Wand λ ∈ (0, 1), thenρ(λW1+(1−λ)W2)≤λρ(W1)+(1−λ)ρ(W2).It can be shown that the CVaR is a coherent risk measure Pflug (2000).A key result in Rockafellar and Uryasev (2002) is the proof that CVaR can be expressed as the optimal value of the following optimization problem:(3.1)CVaRα[X]=minη∈R{η+11−αE[(X−η)+]},where(a)+:=max(a,0). It is easy to see from representation (3.1) that CVaR is law-invariant. and that the conditional version of CVaR (as in the context of Proposition 2.1) is obtained by conditioning the expectation in (3.1).Consider a decision maker trying to sell a certain product. Each unit produced has a cost c, and there are two opportunities to sell the product, at timet=2and timet=3,at prices s2 and s3 respectively, with s3 > s2. The demand D2 at time 2 is revealed after the decision x1 of how many products should be manufactured is made, whereas the demand D3 at time 3 is revealed after the decision x2 of how many products to sell at price s2 is made. The decision of how many products to sell at the end of the horizon at price s3—when all the uncertainty has been realized—is denoted by x3. Unsold products at the end of the horizon have no value.Let us write a minimization problem, so costs are positive and gains are negative. In that case, the total cost iscx1−s2x2−s3x3. A perhaps intuitive way to formulate the problem with risk-aversion is to measure the risk of the total cost as a single quantity, i.e., to takeF(Z1,…,ZT)=ρ(Z1+⋯+ZT),where ρ is a one-period law-invariant risk function. Clearly, this implies thatFis a law-invariant multi-period risk function. Suppose also that ρ satisfies the translation-invariance property (iii) of Proposition 2.1. In this particular example we haveF(f1(x1,ξ1),f2(x2,ξ2),f3(x3,ξ3))=F(cx1,−s2x2,−s3x3)=ρ(cx1−s2x2−s3x3).For an arbitrary one-period risk function ρ satisfying the above conditions the problem can be formulated as follows:(3.2)mincx1+ρ(−s2x2−s3x3)s.t.x2≤min{D2,x1}x3≤min{D3,x1−x2}x1,x2,x3≥0,where x2 is a function of D2 and x3 is a function of D2 and D3. Note that the term cx1 moves out of the risk measure due to the translation-invariance property, since in this case cx1 is not random. Suppose now that we use the risk measureρ=CVaRα. Using the optimization formulation (3.1) for CVaR, we can write problem (3.2) in the following equivalent form:(3.3)mincx1+η+11−αE[(−s2x2(D2)−s3x3(D2,D3)−η)+]s.t.x2(D2)≤min{D2,x1}x3(D2,D3)≤min{D3|D2,x1−x2(D2)}η∈R.In the above formulation, we abuse the notation by writing D3|D2 to indicate a collection of random variables indexed by the values taken by D2, such that the random variable indexed byD2=d2is defined onΩd2:=Ω∩{ω∈Ω:D2(ω)=d2},and is given by the restriction of D3 toΩd2. It is clear that when D2 and D3 have finite support the above problem can be written as a linear program. Note also that the auxiliary variable η is not a function of D2 or D3.Suppose that demand is distributed as in Fig. 2, with equal probabilities on each branch. The purchase price isc=2,and the sale prices ares2=3in the second stage ands3=10in the third stage.The case ofαclose to 1. Let us first takeα=1−ϵfor some arbitrarily smallϵ. Such a choice corresponds to using the one-period worst-case risk measure given byρ(X)=esssup(X). By solving problem (3.3) we obtain the following optimal policy:(3.4)x^1=11,x^2(5)=5;x^2(10)=10,x^3(5,3)=3;x^3(5,7)=3;x^3(10,1)=1;x^3(10,12)=1.Now suppose we advance one period and consider the subproblem consisting of the left-hand side of the tree in Fig. 2, that is, demand att=2isD^2=5and we want to solve the problem at this node. Sincex^1=11,our decisions are what to do at times 2 and 3 with the 11 units we have at hand. To test whether the IOP holds or not, let us solve problem (Pt) fort=2. In line with the notation of problem (Pt), the variables in that problem can be identified asxt2,x^1,D^2,t=2,3. Since we are considering the realizationD^2=5,we shall writext2,5for short. The problem can then be written as(3.5)min−s2x22,5+η2,5+11−αE[(−s3x32,5(D3)−η2,5)+|D2=5]s.t.x22,5≤min{5,x^1}x32,5(D3)≤min{D3|(D2=5),x^1−x22,5}x22,5,x32,5≥0.η2,5∈R.Note the presence of the auxiliary variable η2, 5 that is introduced to model the conditional risk measureCVaRα(·|D2=5). By solving this problem we obtain(3.6)x¯22,5=5,x¯2,5(3)=3;x¯2,5(7)=3,with optimal value−45. We see that this solution actually coincides with the solution obtained earlier calculated atD^2=5,i.e.,x¯22,5=x^2(5)=5,x¯32,5(3)=x^3(5,3)=3,andx¯32,5(7)=x^3(5,7)=3. It is easy to see that the same phenomenon occurs whenD^2=10.To finish the test for the IOP, we need to solve problem (Pt) fort=3. Since the third-stage variable x3 is essentially the minimum between the observed demand in that stage and the slack between the purchased amount x1 and the amount x2 sold in the second stage, it is easy to verify that there exists some optimal solutionxˇof (3.3)—in this case,xˇ=x^except thatxˇ3(5,7)=6—such that the solution inherited fromxˇis optimal for (Pt). Thus, the IOP holds for this problem instance when the risk measure used isF(Z1,…,ZT)=esssup(Z1+⋯+ZT).It is worthwhile observing that the solution(3.7)x˜1=11,x˜2(5)=4;x˜2(10)=10,x˜3(5,3)=3;x˜3(5,7)=3;x˜3(10,1)=1;x˜3(10,12)=1is also an optimal solution of (3.3) that coincides withx^in period 1, but the solution of problem (3.5) obtained by fixingx22,5=x˜2(5)=4,x32,5(3)=x˜3(5,3)=3,andx32,5(7)=x˜3(5,7)=3yields an objective value equal to−42. Thus, the solution “inherited” from thisx˜is not optimal for the subproblem. The goal of this remark is to emphasize that the proposed notion of consistency requires only that some inherited solution be optimal for the subproblem, we do not require that all inherited solutions be optimal—it is tempting to call the latter property “strong consistency” but, as the above example demonstrates, such a property is unlikely to hold in practice and it would be difficult to verify it unless the optimal solutions are unique, in which case it would be the same as consistency.The case of intermediateα. Suppose we take againF(cx1,−s2x2,−s3x3)=CVaRα(cx1−s2x2−s3x3),but withα=0.3. By solving problem (3.3) we obtain the following optimal policy:(3.8)x^1=12,x^2(5)=5;x^2(10)=5,x^3(5,3)=3;x^3(5,7)=7;x^3(10,1)=1;x^3(10,12)=7.An analysis of the reduced costs shows that such this optimal solution is unique. Now, the solution of the subproblem (3.5) yieldsx¯22,5=5,x¯2,5(3)=3;x¯2,5(7)=7,so we see that this solution actually coincides with the solutionx^in (3.8) calculated atD^2=5. However, the solution of the subproblem analogous to (3.5) forD^2=10yieldsx¯22,10=10,x¯2,10(1)=1;x¯2,10(12)=2,with an optimal value of−42.85,which is better than the solution inherited fromx^,that is,x^2(10)=5,x^3(10,1)=1,x^3(10,12)=7,which yields an objective value equal to−42.14. Thus, we see that the risk measureF(Z1,…,ZT)=CVaR0.3(Z1+⋯+ZT)is inconsistent for the problem.Remark. As discussed in Carpentier et al. (2012), it is possible that by enlarging the state space consistency may be recovered. However, the resulting dynamic programming equations would be intractable since one might end up with an infinite dimensional problem. Since we have algorithmic concerns, our definition of consistency does not allow for infinite dimensional state spaces.As another example, suppose we measure risk in each stage separately, i.e., we use the risk measureF(Z1,…,ZT)=Z1+ρ2(Z2)+⋯+ρT(ZT)where each ρtis a one-period risk measure applied to period t. In this particular example we haveF(cx1,−s2x2,−s3x3)=cx1+ρ2(−s2x2)+ρ3(−s3x3). In particular, suppose that we use the risk measuresρ2=ρ3=CVaRαforα=1−ϵwith arbitrarily smallϵ,which as seen before is the same as usingρ2=ρ3=esssup. Then, we obtain the problem(3.9)mincx1+η2+11−αE[(−s2x2(D2)−η2)+]+η3+11−αE[(−s3x3(D2,D3)−η3)+]s.t.thesameconstraintsasproblem(3.2),which yields the following optimal policy:(3.10)x^1=6,x^2(5)=5;x^2(10)=5,x^3(5,3)=1;x^3(5,7)=1;x^3(10,1)=1;x^3(10,12)=1.Note that the subproblem consisting of the left-hand side of the tree in Fig. 2 coincides with (3.5), except thatx^1=6. By solving this problem we obtain(3.11)x¯22,5=3,x¯2,5(3)=3;x¯2,5(7)=3.The optimal value of the subproblem is−39. However, the solution inherited fromx^,which isx^2(5)=5,x^3(5,3)=1,andx^3(5,7)=1yields an objective value equal to−25. Thus, the solution “inherited” from solving the problem at time 1 is not optimal for the subproblem. Moreover, by conducting a sensitivity analysis for problem (3.9) it can be verified that any optimal solution of the problem att=1must havex^1=6andx^2(5)=5,which leads to an inherited sub-optimal solution for the subproblem. We conclude that the risk measureF(Z1,…,ZT)=Z1+ρ2(Z2)+⋯+ρT(ZT)withT=3is inconsistent for this problem.The situations shown by the above examples illustrate well the concepts of consistency. In the first example withα=1−ϵ,the optimal policy (3.4) protects against the worst-case path. When we move to the subproblem, the same principle applies. Whenα=0.3the decision is not guided by the worst case criterion anymore, and we showed that inconsistency occurs. In the second example, the optimal policy (3.10) is protecting against the worst-case outcome in each stage—i.e.,D2=5,D3=1,which leads tox^1=6—but it is clear such a scenario cannot happen since those two realizations are not in the same path of the tree in Fig. 2. That is, no optimal solution generated by the original problem will be optimal for the subproblem. These simple examples show that a risk measure for multistage stochastic programs that measures risk either based on complete paths of the scenario tree or separately per stage is inconsistent in general. So if consistency is a desired property, then such risk measures should be avoided.We close this section by noting that the analysis of some of the above examples whereCVaRα=esssupcould have been made much shorter since in reality there is no need to solve linear programs to find the best solutions. Nevertheless, we chose to present the material as done above for two reasons: first, to illustrate how consistency can be checked in a more systematic way for a general problem (in fact, even the same problem but for a smaller α, as done for the caseα=0.3); and second, to illustrate the role of the auxiliary variables ηt. The latter is particular important because Shapiro (2009) justifies inconsistency of stage-wise risk formulations such as (3.9) based on the fact that the auxiliary variables ηtcan be viewed as stage-1 variables as they are not functions of ξt. While that statement is certainly true for the problem att=1,we believe it does not quite explain the issues of inconsistency since in reality these variables are not “inherited” by the subproblems. For example, we cannot fix the values of the auxiliary variable η2 when solving the subproblem at timet=2,otherwise the subproblem would not calculate the CVaR correctly. Indeed, we can see that in the subproblem formulation (3.5) it is essential to define a new variable η2, 5 to model the conditional risk measureρ(·|D2=5),but even then inconsistency is observed. That is, inconsistency is a characteristic of the risk measure itself, and not of one of its particular representations.We consider now nested risk measures of the form(4.1)F(Z1,…,ZT)=ρ2∘⋯∘ρT(Z1+⋯+ZT),where each ρtis a one-period conditional risk measure, defined in terms of a realizationξ^2,…,ξ^t−1. Such nested risk measures have been object of extensive study, see for instance Shapiro (2009), Ruszczyński (2010), Philpott and de Matos (2012) and Philpott et al. (2013). Nested risk measures are somewhat equated with their respective definitions of consistency. We show next that nested risk measures satisfy our notion of consistency.Theorem 4.1Consider the risk measureFgiven byF(Z1,…,ZT)=ρ2∘ρ3ξ[2]∘⋯∘ρTξ[T−1](Z1+⋯+ZT),where the notation indicates that eachρtξ[t−1]is a one-period conditional risk measure, defined in terms of the historyξ2,…,ξt−1. Suppose also that eachρtξ[t−1]is translation-invariant and monotone, i.e.,(i)ρtξ[t−1](Z+X)=Z+ρtξ[t−1](X)whenever Z is measurable with respect to the sigma-algebra generated byξ1,…,ξt−1;ρtξ[t−1](X)≤ρtξ[t−1](Y)whenever X ≤ Y w.p.1.Then,Fis consistent for problem (P).Observe initially that, given x, each term ft(xt, ξt) is constant given the historyξ1,…,ξt,so it “moves out” of the argument of the conditional risk measureρt+1ξ[t]due to the translation-invariant property. It follows that(4.2)minx:xt∈Xt(x[t−1],ξ[t])ρ2∘⋯∘ρTξ[T−1](f1(x1,ξ1)+⋯+fT(xT,ξT))(4.3)=minx1∈X1minx2∈X2(x1,ξ[2])…minxT∈XT(x[T−1],ξ[T])f1(x1,ξ1)+ρ2(f2(x2,ξ2)+ρ3ξ[2](f3(x3,ξ3)+ρ4ξ[3](⋯+ρTξ[T−1](fT(xT,ξT)))…))=minx1∈X1{f1(x1,ξ1)+ρ2(minx2∈X2(x1,ξ[2]){f2(x2,ξ2)+ρ3ξ[2](minx3∈X3(x[2],ξ[3]){f3(x3,ξ3)+⋯+ρTξ[T−1](minxT∈XT(x[T−1],ξ[T])fT(xT,ξT))…})},where we have assumed that all minimization problems in the above expressions are feasible and have finite value (the latter follows, for example, if each ftis continuous in the first argument and the feasibility set for xtis compact). Note that the second equality in the above development (i.e., the interchange betweenρtξ[t−1]and min) follows from the assumed monotonicity of eachρtξ[t−1]. Thus, we see that solving the original problem (P) is equivalent to solving (4.3).Let t be an arbitrary time period such that 1 < t ≤ T. Note that we can rewrite (4.3) as(4.4)minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=1,…,t−1{f1(x1,ξ1)+ρ2(f2(x2,ξ2)+ρ3ξ[2](f3(x3,ξ3)+ρ4ξ[3](⋯ft−1(xt−1,ξt−1)+ρtξ[t−1](minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,T{ft(xt,ξt)+ρt+1ξ[t](…fT−1(xT−1,ξT−1)+ρTξ[T−1](fT(xT,ξT))…)}…))}Letx^:=[x^τ:τ=1,…,T]be an optimal solution of problem (4.4) (and hence of (4.2)). Note that, by construction, the solution inherited fromx^is an optimal solution of the inner minimization problem in (4.4).We now show that the solution inherited fromx^is optimal for the subproblem (Pt). SinceFis assumed to be a nested risk measure, we have thatFξ[t](Z1,…,ZT)=ρt+1ξ[t]∘ρt+2ξ[t],ξt+1⋯∘ρTξ[t],ξt+1,…,ξT−1(Z1+⋯+ZT)=Z1+⋯+Zt+ρt+1ξ[t](Zt+1+ρt+2ξ[t],ξt+1(…ZT−1+ρTξ[t],ξt+1,…,ξT−1(ZT)))so problem (Pt) becomes(4.5)minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,TFξ[t](f1(x1,ξ1),…,fT(xT,ξT))=f1(x1,ξ1)+⋯+ft−1(xt−1,ξt−1)+minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,T{ft(xt,ξt)+ρt+1ξ[t](…fT−1(xT−1,ξT−1)+ρTξ[T−1](fT(xT,ξT))…)}.It becomes clear that the inner minimization problem in (4.4) coincides with the minimization problem in (4.5). It follows that the solution inherited fromx^is optimal for the subproblem (Pt), so the inherited optimality property holds. The above argument is valid regardless of the problem instance, so we conclude thatFis consistent.□It is worthwhile noticing that problem (4.3) essentially corresponds to a Bellman formulation of the original problem, which allows for the use of recursive algorithms commonly used in dynamic programming. Thus, we see that nested risk measures are consistent and naturally lead to Bellman formulations. Of course, many authors have discussed the equivalence between consistency and recursive formulations; the value of Theorem 4.1 lies in showing that our proposed notion of consistency—which, as mentioned before, attempts to formalize some of the notions found in the literature—is also implied by the Bellman formulation of nested risk measures.A particular case of interest is the risk neutral measureF(Z1,…,ZT)=E[Z1+⋯+ZT]. By the well-known “tower property”, we have thatE=E∘Eξ[2]∘⋯∘Eξ[T−1],whereEξ[t](written this way to agree with our notation) is the conditional expectationE[·|ξ[t]]. Another case of interest is the worst-case risk measureF(Z1,…,ZT)=esssup(Z1+⋯+ZT). Since we can also write that risk measure in similar composite form, we see that Theorem 4.1 provides a general framework that includes the first example of Section 3. The conclusion of the corollary below is immediate from Theorem 4.1.Corollary 4.2The risk neutral measureF(Z1,…,ZT)=E[Z1+⋯+ZT]and the worst-case risk measureF(Z1,…,ZT)=esssup(Z1+⋯+ZT)are consistent for problems of the form (P).It is worthwhile mentioning here that Shapiro (2012b) shows that the only consistent law invariant risk measures are the ones in Corollary (4.2). While such a result is interesting in its own, we believe it may lead one to think that it is dangerous to use other consistent risk measures as they are not law invariant. It should be stressed however that this limitation is a direct consequence of the notion of law invariance used in Shapiro (2012b), which is somewhat strict as discussed in Remark 2 earlier in this paper. Once that notion is relaxed (as in our definition), nested risk measures of the form (4.1) become law invariant as well, provided each ρiis law invariant.Consider now the class of multi-period risk measuresFdefined as follows:(5.1)F(Z1,…,ZT)=Z1+ρ2(Z2)+Eξ[2][ρ3ξ[2](Z3)]+Eξ[3][ρ4ξ[3](Z4)]+⋯+Eξ[T−1][ρTξ[T−1](ZT)],where the subscript inEindicates that the expectation is with respect to the corresponding variables. We shall call multi-period risk measures defined this way expected conditional risk measures (ECRMs). This class of risk measures includes the mCVaR risk measure that was introduced in Pflug and Ruszczyński (2005), which is defined as (5.1) for the case whereρt=CVaRαt. Pflug (2006) provides a more extensive study of mCVaR and proves some fundamental properties of that risk measure. We show now that anyFdefined as in (5.1) is consistent, provided that eachρtξ[t−1]satisfies some basic properties that automatically hold, for example, for coherent risk measures.Theorem 5.1Consider the expected conditional risk measureFgiven by(5.1), where eachρtξ[t−1]is a translation-invariant and monotone conditional risk measure, in the sense of conditions (i) and (ii) spelled out inTheorem 4.1. Suppose also that the random vectors ξt have finite support. Then,Fis consistent for problem(P).Observe initially that, using the “tower property” of expectations, we can rewriteFas(5.2)F(Z1,…,ZT)=Z1+ρ2(Z2)+Eξ2[ρ3ξ[2](Z3)+Eξ3ξ[2][ρ4ξ[3](Z4)+⋯+EξT−1ξ[T−2][ρTξ[T−1](ZT)]…]].By the translation-invariant property of eachρtξ[t−1],we can re-write the above equation as(5.3)F(Z1,…,ZT)=Z1+ρ2(Z2+Eξ2∘ρ3ξ[2](Z3+Eξ3ξ[2]∘ρ4ξ[3](Z4+⋯+EξT−1ξ[T−2]∘ρTξ[T−1](ZT)…))).To simplify the notation, define nowρ˜tξ[t−2]:=Eξt−1ξ[t−2]∘ρtξ[t−1].Then, we can write (5.3) as(5.4)F(Z1,…,ZT)=Z1+ρ2(Z2+ρ˜3ξ[1](Z3+ρ˜4ξ[2](Z4+⋯+ρ˜Tξ[T−2](ZT)…))).Note that, despite the apparent nested form of (5.4), the resulting formulation does not fit the framework of Theorem 4.1 sinceρ˜tξ[t−2]is measurable with respect to the σ-algebra generated byξ[t−2]instead of that generated byξ[t−1]—so we cannot write, for example,ρ˜tξ[t−2](Zt−1+Zt)=Zt−1+ρ˜tξ[t−2](Zt). Nevertheless, as shown below we can follow similar steps as those in the proof of Theorem 4.1.To proceed, let t be an arbitrary time period such that 1 < t ≤ T. Then, by using (5.4), together with the monotonicity and translation-invariant properties ofρ˜tξ[t−2]—which follow from the fact that bothEandρtξ[t−1]have such properties—we have that(5.5)minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=1,…,TF(f1(x1,ξ1)+⋯+fT(xT,ξT))(5.6)=minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=1,…,t−1{f1(x1,ξ1)+ρ2(f2(x2,ξ2)+ρ˜3ξ[1](f3(x3,ξ3)+ρ˜4ξ[2](…ft−1(xt−1,ξt−1)+ρ˜tξ[t−2](minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,T{ft(xt,ξt)+ρ˜t+1ξ[t−1](…fT−1(xT−1,ξT−1)+ρ˜Tξ[T−2](fT(xT,ξT))…)}…))}Letx^:=[x^τ:τ=1,…,T]be an optimal solution of problem (5.6) (and hence of (5.5)). Note that, by construction, the solution inherited fromx^is an optimal solution of the inner minimization problem in (5.6).We now show that the solution inherited fromx^is optimal for the subproblem (Pt). Note that when information up to time t is available we have thatEξt∘ρt+1ξ[t]=ρt+1ξ[t]. It follows thatFξ[t](Z1,…,ZT)=Z1+⋯+Zt+ρt+1ξ[t](Zt+1+ρ˜t+2ξ[t](Zt+2+⋯+ρ˜Tξ[T−2](ZT)…))so problem (Pt) becomes(5.7)minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,TFξ[t](f1(x1,ξ1),…,fT(xT,ξT))=f1(x1,ξ1)+⋯+ft−1(xt−1,ξt−1)+minx:xτ∈Xτ(x[τ−1],ξ[τ]),τ=t,…,T{ft(xt,ξt)+ρt+1ξ[t](ft+1(xt+1,ξt+1)+ρ˜t+2ξ[t](…fT−1(xT−1,ξT−1)+ρ˜Tξ[T−2](fT(xT,ξT))…))}.It is important to observe that, unlike the case of the proof of Theorem 4.1, the inner minimization problem in (5.6)does not coincide with the minimization problem in (5.7), since the former optimizes the conditional risk measureρ˜t+1ξ[t−1]=Eξtξ[t−1]∘ρt+1ξ[t]whereas the latter optimizes the conditional risk measureρt+1ξ[t](the remaining terms are identical). We will show, however, that the solution inherited fromx^is an optimal solution of the minimization problem in (5.7). Indeed, suppose that this is not the case, i.e., there exists an optimal solutionx˜:=[x˜τ:τ=t,…,T]of the minimization problem in (5.7) (givenx^τ,τ=1,…,t−1) such thatx˜is strictly better thanx^for some realizationξ^[t]of ξ[t], i.e.(5.8)ft(x˜t,ξ^t)+ρt+1ξ^[t](ft+1(x˜t+1,ξt+1)+ρ˜t+2ξ^[t](⋯+ρ˜Tξ^[t],ξt+1,…,ξT−2(fT(x˜T,ξT))…))<ft(x^t,ξ^t)+ρt+1ξ^[t](ft+1(x^t+1,ξt+1)+ρ˜t+2ξ^[t](⋯+ρ˜Tξ^[t],ξt+1,…,ξT−2(fT(x^T,ξT))…)).For any other realization of ξ[t], of course, the above inequality holds with ≤ in place of <, sincex˜is optimal. By computing the conditional expectationEξtξ^[t−1]on both sides of the inequality we obtain(5.9)Eξtξ^[t−1][ft(x˜t,ξt)]+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x˜t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x˜T,ξT))…))<Eξtξ^[t−1][ft(x^t,ξt)]+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x^t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x^T,ξT))…)).In the above inequality, the assumption of finite support of each ξtwas essential—this is what allows us to write the strict inequality in (5.9) as a consequence of the strict inequality in (5.8).On the other hand, sincex^is optimal for the inner minimization problem in (5.6), it follows that for any realizationξ^[t]of ξ[t] we haveft(x^t,ξ^t)+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x^t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x^T,ξT))…))≤ft(x˜t,ξ^t)+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x˜t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x˜T,ξT))…))and hence(5.10)Eξtξ^[t−1][ft(x^t,ξt)]+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x^t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x^T,ξT))…))≤Eξtξ^[t−1][ft(x˜t,ξt)]+Eξtξ^[t−1]∘ρt+1ξ^[t−1],ξt(ft+1(x˜t+1,ξt+1)+ρ˜t+2ξ^[t−1],ξt(⋯+ρ˜Tξ^[t−1],ξt,…,ξT−2(fT(x˜T,ξT))…)).By putting together inequalities (5.9) and (5.10), we see that we reach a contradiction. It follows that the solution inherited fromx^is optimal for the subproblem (Pt), so the inherited optimality property holds. The above argument is valid regardless of the problem instance, so we conclude thatFis consistent.□As mentioned above, a particular case of ECRMs defined in (5.1) is to useρt=CVaRαt. We shall denote the resulting ECRM byE-CVaR. To the best of our knowledge, this measure was introduced in Pflug and Ruszczyński (2005) in a pension fund problem with incoming cash flows. Pflug (2006) refers to this measure as the multi-period average value-at-risk.Theorem 5.1 shows the consistency ofE-CVaR. As we are assuming that consistency is a desirable property in applications, Theorem 5.1 establishes theE-CVaRas a valid alternative to the nested risk measure defined in (4.1). In fact theE-CVaRhas additional properties that makes it an appealing alternative to measure risk in multistage settings. As we show below, any risk-averse MSSP defined withE-CVaRcan be written as a risk-neutral model for a modified problem that has some additional variables. Thus, moderately sized problems can be efficiently solved to optimality by using commercial solvers.For large scale problems, existing algorithms can be readily adapted to solve theE-CVaRcase. For example the popular SDDP algorithm, developed by Pereira and Pinto (1991), can in principle be applied directly. The only changes would be the addition of some variables and a redefinition of the vectors and matrices of the problem. This is not true for the nested CVaR formulation: in Philpott and de Matos (2012) the authors show that the Bellman equations for the nested case in time t contain the recursive function at timet+1in the constraints, which in general is not given in explicit form. Approximation by cutting planes can be performed, but the procedure to compute the upper bound of the optimal value needs significant changes; see Philpott and de Matos (2012), Kozmík and Morton (2015) and Philpott et al. (2013).We will now show the explicit Bellman equations for theE-CVaRcase. From equation (5.2) in Theorem 5.1, we can write an optimization formulation for theE-CVaRas follows:minx1,…,xTf1(x1,ξ1)+CVaRα2(f2(x2,ξ2))+Eξ2[CVaRα3ξ[2](f3(x3,ξ3))+Eξ3[CVaRα4ξ[3](f4(x4,ξ4))+…+EξT−1[CVaRαTξ[T−1](fT(xT,ξT))|ξ[T−2]]…|ξ[2]]],s.t.xt∈Xt(x[t−1],ξ[t]),t=1,…,T.Using the CVaR representation described in Rockafellar and Uryasev (2000) we haveminx1,…,xTf1(x1,ξ1)+minη2η2+11−α2Eξ2[(f2(x2,ξ2)−η2)+]+Eξ2[minη3η3+11−α3Eξ3[(f3(x3,ξ3)−η3)+|ξ[2]]+Eξ3[minη4η4+11−α4Eξ4[(f4(x4,ξ4)−η4)+|ξ[3]]+⋯+EξT−1[minηTηT+11−αTEξT[(fT(xT,ξT)−ηT)+|ξ[T−1]]…|ξ[2]]],s.t.xt∈Xt(x[t−1],ξ[t]),t=1,…,T.Note that the auxiliary variables {ηt} are such thatηt+1is a function ofξ1,…,ξt,i.e.,ηt+1is a “t-stage variable” just as xtis. By interchanging the minimum and the expected value and merging the minimum on xtwith the minimum inηt+1we can write Bellman equations fort=1,…,T−1in the following way:(5.11)Qt(xt−1,ξ[t],ηt)=minηt+1,xt11−αt(ft(xt,ξt)−ηt)++ηt+1+Eξt+1[Qt+1(xt,ξt+1,ηt+1)|ξ[t]].For the last period we have(5.12)QT(xT−1,ξT,ηT)=minxT11−αT(fT(xT,ξT)−ηT)+.The piecewise linear function in (5.11) can be linearized by the addition of a positive variable utsuch and two constraints for eacht=2,…,T:(5.13)ut≥0,ut≥ft(xt,ξt)−ηt.We see then that theE-CVaRformulation corresponds to a risk-neutral problem that modifies the original problem by adding two new variables in stagest=2,…,T(utand ηt), and two additional constraints (5.13) as well. As mentioned before, this brings significant computational advantages, as standard algorithms for risk-neutral problems can be used in this setting.We illustrate the application of theE-CVaRto a pension fund problem described in Haneveld et al. (2010). The problem is a defined benefit model in which a large Dutch company owns the fund and acts as its sponsor. The company has to maintain the ratio between assets and liabilities—the funding ratio—above some pre-specified threshold at every time period. To achieve this goal there are three sources of income: the returns from its asset portfolio, regular contributions made by fund participants and remedial contributions performed by the company, which are essentially money injections intended to keep the fund solvent. It is worthwhile mentioning that Kilianova and Pflug (2009) also study a risk-averse multistage pension fund problem under theE-CVaRrisk measure; the fundamental differences between our problem and theirs are that (i) the problem in Kilianova and Pflug (2009) is modeled from the viewpoint of the pension fund participant, whereas ours is from the perspective of the fund manager, and (ii) the resulting optimization problem is solved as a large linear program in Kilianova and Pflug (2009); in contrast, we use this example to demonstrate the usefulness of writing the equivalent risk-neutral formulation discussed in Section 5.2, and in fact we solve the problem using standard software that implements decomposition algorithms for expectation-based MSSPs.The fund has three decisions to make in every stage t: the allocation strategy of its assets among the available classes i, denoted by Xi, t, the value of the contribution rate ctof the participants of the fund and the remedial contribution Zt. Randomness is present through the returns of the assets rit, the total wages of active participants Wt, the benefit payments Ptto the participants and the liabilities Lt. In words, the constraints for every scenario are•The total value of the assets at time t is equal to the yield of the investments at time t, plus the participants’ payments and the remedial contribution minus the payments due to retirement and others.The value of each asset i at timet+1is the value of asset i in period t times the interests minus transaction costs due to buying and selling.All assets should be allocated.The funding ratio has to be greater or equal than a fixed threshold at every time period.The model defines lower and upper bounds on assets classes and on the contribution rate ct. Non-negativity of all variables completes the constraints. In the original paper the authors do not include any risk measure in the objective function: the objective is to minimize the expected value of the sum, for all stages, of remedial contributions and contribution rates for the participants. A full description of the model can be found in Haneveld et al. (2010).We implemented the experiment using the program SLP-IOR (Kall & Mayer, 1996). The software has an interface in which one can enter a risk-neutral multistage stochastic program per stage, specifying the decision variables and the matrices as well as the scenario tree structure. A few specialized decomposition algorithms for MSSPs are implemented in SLP-IOR. Since Bellman equations for theE-CVaRcan be written using the expected value, as shown in (5.11) and (5.12), we represented theE-CVaRas a risk neutral problem with extra variables ηtfor the CVaR and utto linearize the max function. We see here the advantage of being able to write the problem as a risk-neutral one, a feature that is not present in other multi-period risk-averse formulations.Using data generated according to the distributions described on page 57 of Haneveld et al. (2010), we consider a four stage problem whose scenario tree has 10 bifurcations per node, for a total of 1000 scenarios. There are four types of assets, from riskier (with higher returns) to safer (lower returns): stocks, real state, bonds and cash. We can control risk at the second, third and fourth stages by using parameters α2, α3 and α4. For example, the choice (0, 0, 0) corresponds to the risk-neutral case, whereas (.95, 0, 0) represents the situation where the decision maker is very risk-averse regarding the outcome of stage 2 but it is risk-neutral regarding stages 3 and 4. First-stage solutions are shown in Table 1.Several comments are in order. First we observe that the remedial contribution was not necessary in the first stage for any of the six risk profiles considered. The risk neutral solution (fifth row) has a contribution rate of only 13 percent, while in all of the other cases the contribution is at its maximum of 21 percent. In the first row we have the most conservative solution: only 30 percent of the initial wealth is invested in stocks, as opposed to an average 48 percent among rows 2–5. In addition, more than 50 percent of the initial wealth is invested in bonds.Those numbers support the fact that the choice (.95, 0, 0) strongly protects the first-stage solution against volatility. The (.95, .95, .95) configuration should also offer a similar protection, but it is equally concerned with second and third stages and, as a consequence, the percentage invested in stocks and real estate is much higher than in the (.95, 0, 0) case. Nevertheless, among the middle four rows, this it is the one with smallest percentage of investment in stocks plus real estate. The last row is an intermediate case: the amount invested in risky assets is halfway between rows 1 and 2–5.The vast majority of authors that report multistage experiments only show the results of the first stage. We believe there are two valid reasons for that: first, the solution for stages other than the first will probably not be implemented since the realization of the uncertainties will be different, with probability one, from any realization that is represented in the scenario tree. Second, many practical applications (energy, finance among others) use a rolling horizon procedure, that is, after implementing the first-stage solution and observing the realization of the uncertainties, the problem is re-solved and the new first-stage solution obtained is implemented, and so forth.Despite the fact that we agree with both arguments presented, we believe that showing the solutions of the further stages increases the understanding of the problem. In fact, it helps the decision maker to understand the consequences of the first-stage solution that will be implemented. For example, a look at Table 1 would suggest that the risk neutral solution dominates all other solutions: it requires no contribution from the fund sponsor and has the smallest contribution rate of all solutions! We will use first and second order stochastic dominance (see, e.g., Müller and Stoyan, 2002 for definitions) to infer about the quality of second- and third-stage solutions.Figs. 3 and 4show parts of the second and third stage solutions that will allow to us to understand the implications of adopting one of the first-stage solutions displayed in Table 1. In each figure we plot four empirical cumulative distributions functions constructed based on the solutions of second (Fig. 3) and third (Fig. 4) stages, for each realization in the tree: investment in risky assets (top left, assets and real estate), safer assets (top right, bonds and cash), the remedial contribution and the contribution rate.The first observation is that, for the remedial contribution, the solution (0, 0, 0) first-order stochastically dominates all other solutions, both in the second and third stages. That is a clearly undesirable property for a solution: it means that for every value x the probability of having losses greater than or equal to x will be larger for the risk neutral solution. Furthermore, we can see in Fig. 3 that the probability of not having to include a remedial contribution in the second stage is around .6, while for the other solutions it is around .7 and .8. For the third stage we can see in Fig. 4 that the probability is around .5 while for the other solutions it is between .6 and .7.With the contribution rate the situation is the opposite: the risk neutral solution is stochastically dominated in first order by all the other solutions in the second stage, and it is dominated in first order by all but the (.95, 0, 0) in the third stage. In the third stage for example almost 90 percent of the scenarios result in the fund taking no contribution at all from the participants. While this may seem desirable, we know from the remedial contribution graphs that the fund will probably have to inject a significant amount of money in order to satisfy the funding ratio constraints.Let us take a closer look at other solutions. The extreme risk-averse solution, (.95, .95, .95) is much better than the risk-neutral solution in terms of remedial contribution in both stages. Moreover, it dominates (0, .95, 0) in the first order and (.95, 0, 0) in the second order. That is not surprising: the solution (.95, .95, .95) is equally risk-averse in all stages, while (0, .95, 0) and (.95, 0, 0) in some sense protect the decision maker with more weight in early stages. With respect to the contribution rate, we see that (0, .95, 0) dominates in first order all the other solutions in the second stage and three other solutions in the third stage. The decision maker that implements this solution can expect lower remedial contributions but contribution rates close to the upper bound limit of .21.The (.5, .5, .5) is an interesting case of a compromise solution. The decision maker is risk-averse in every stage, but the α value is halfway between risk neutrality and extreme risk aversion. In both stages the curves for remedial contribution and contribution rate lie roughly in the middle of all other curves, indicating that very large remedial contribution and very small contribution rates are unlikely.Now we focus our attention on the second- and third-stage decisions with respect to investment in risky assets (stocks and real estate) and safer instruments (bonds and cash). In Figs. 3 and 4 we observe that the risk neutral solution will probably invest heavy on risky assets and much less on safer instruments. Given the results obtained for the remedial contribution such findings are not surprising: the risk neutral decision maker will try to meet his obligations by betting on the possible high returns of stock and real estate. A similar analysis can be performed for the solution (0, 0, .95). In fact for risky assets this solution stochastically dominates in second order all the other solutions in the second stage, while the risk neutral dominates all but (0, 0, .95) and (.95, 0, 0). We can see from Figs. 3 and 4 that the other solutions follow a more conservative pattern, with significantly smaller probabilities of investment in risky assets. For example the probability of investing less than 1.0 × 104 in risky assets is on average 45 percent for the more risk-averse solutions while it is only 10 percent for the risk-neutral solution.For bonds and cash, the risk-neutral solution is stochastically dominated in second order by all the other solutions in both second and third stages (Fig. 4). Thus, the results inform the decision maker that by implementing the risk neutral solution in the first stage he should be prepared in the subsequent stages to face the more volatile stock and real estate markets. For investments in bonds and cash, the solution (.95, .95, .95) stochastically dominates in second order all the other solutions in the third stage. Similar to what was observed for the remedial contribution and the contribution rate, the (.5, .5, .5) case is between all curves, especially in the third stage, indicating a compromise between the investment on risky and safer assets.

@&#CONCLUSIONS@&#
The incorporation of measures of risk into multistage stochastic programs has received great attention recently in the literature, as there is a clear need to model a decision maker’s risk attitude in that context. There is however no consensus on how to do that; in fact, in our conversations with other researchers we have heard a variety of opinions. Our goal in this paper is three-fold: first, we wanted to illustrate by means of a simple example the pitfalls of certain types of multi-period risk measures used in practice. We study such drawbacks under the framework of a formal notion of consistency which we define in terms of an optimization problem. Providing such a formal optimization-oriented definition of consistency is our second goal in this paper. The third goal is to propose a class of multi-period risk measures, which we call expected conditional risk measures (ECRMs), which extend the multi-period CVaR risk measure originally proposed by Pflug and Ruszczyński (2005). As we discuss in the paper, ECRMs have some attractive properties both from a modeling perspective as well as from an algorithmic standpoint. The modeling advantages include the fact that ECRMs give a more intuitive meaning to the decision maker about what is being measured, which in particular allows him the flexibility of choosing different risk levels in different stages. In the particular case of ECRMs with CVaR—which we denote byE-CVaRin line with our more general definition—we have seen that the resulting model can be written as a risk-neutral problem with extra variables, thus allowing for the use of the various methods developed for multistage risk-neutral problems such as Nested Decomposition (Donohue & Birge, 2006) or the SDDP algorithm of Pereira and Pinto (1991). We believe that these features make ECRMs an attractive choice, as it overcomes some issues that arise with other alternatives proposed in the literature such as the nested CVaR. Our study of the pension fund example demonstrates the applicability of ECRMs.