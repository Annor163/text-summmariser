@&#MAIN-TITLE@&#
Joint parameter and state estimation of the hemodynamic model by iterative extended Kalman smoother

@&#HIGHLIGHTS@&#
In a former paper which is accepted in this journal (which is under revision) we implemented several filtering methods for hemodynamic state estimation. There we showed in detail that the hemodynamic model is weakly non-linear. Based on that finding we extended our researched by implementing a successful joint hemodynamic state and parameter estimation method. We also implemented the algorithm to a real fMRI data set.We emphasized the following point in the literature. It is alleged that extended Kalman filter is unrobust and poor in performance. We carefully examined this allegation under various state/measurement noise conditions. This allegation is not true for the widely used hemodynamic model in a wide range of process and measurement noise conditions. Furthermore, several times particle filters are alleged to outperform Extended Kalman Filters. The alleged EKF is shown to be better in state estimation. We examined carefully and showed the contrary is true.By smoother we improved the estimation even more. The alleged unrobust filter is shown even to accurately perform joint parameter and state estimation. The parameter estimation scheme is achieved by adding artificial dynamics to the parameters. In that perspective, parameters are augmented to the state vector.The iterative scheme is applied for the joint parameter and state estimation. In the standard implementation of smoother there is no iteration. We compared iterative performance and noted substantial improvement in performance.Iterative extended Kalman smoother (IEKS) is compared with the most successful algorithm in the fMRI model inversion literature. IEKS was 2.3 times faster and (though not big difference) always better in state and parameter estimates. The comparison is made under a wide range of process/measurement noise conditions.

@&#KEYPHRASES@&#
Hemodynamic model,Extented Kalman filter/smoother,Cubature Kalman filter/smoother,

@&#ABSTRACT@&#
The joint estimation of the parameters and the states of the hemodynamic model from the blood oxygen level dependent (BOLD) signal is a challenging problem. In the functional magnetic resonance imaging (fMRI) literature, quite interestingly, many proposed algorithms work only as a filtering method. This makes the estimation of hidden states and parameters less reliable compared with the algorithms that use smoothing. In standard implementations, smoothing is performed only once. However, joint state and parameter estimation can be improved substantially by iterating smoothing schemes such as the extended Kalman smoother (IEKS). In the fMRI literature, extended Kalman filtering is thought to be less accurate than standard particle filtering (PF). We compared EKF with PF and observed that the contrary is true. We improved the EKF performance by adding smoother. By iterative scheme joint hemodynamic and parameter estimation is improved substantially. We compared IEKS performance with the square-root cubature Kalman smoother (SCKS) algorithm. We show that its accuracy for the state and the parameter estimation is better and much faster than iterative SCKS. SCKS was found to be a better estimator than the dynamic expectation maximization (DEM), EKF, local linearization filter (LLF) and PF methods. We show in this paper that IEKS is a better estimator than iterative SCKS under different process and measurement noise conditions. As a result, IEKS seems to be the best method we evaluated in all aspects.

@&#INTRODUCTION@&#
In estimation theory, there are two main categories for the state estimation. These are the filtering and smoothing. In the filtering of the state estimate, the observation sequence y1, y2, ⋯, ykor y1:kis used to find the statistical information about the states x1, x2, ⋯, xk. We are interested to finding the conditional probability density function (pdf) p(xk|y1:k) for the filtering. Since by the new observation yk+1 we can find the conditional pdf p(xk+1|y1:k+1), filtering is also known as online estimation, whereas, in the smoothing approach, all the observation sequence including the future data (y1:N, N>k) are used to find p(xk|y1:N) [1]. Since for every time step we need the complete observation sequence, this kind of processing is also known as offline estimation. The use of future data contains information about the past data and, as a result, improves the state and parameter estimates of the system. The choice of the state estimation technique also has an important effect on the parameter estimation. Having a more accurate state estimation algorithm also improves the parameter estimation of the system. In the fMRI model inversion literature, most of the state estimation techniques work only in the filtering sense. However, in most hemodynamic data analysis cases, the computation is not performed in real time. By using smoothing techniques, the estimation of both the state and the parameters of the hemodynamic systems is improved. Trade-off is that incorporating smoothing into existing algorithms leads to an increased computation time.In this paper, we worked on the joint parameter and state estimation of the hemodynamic nonlinear dynamic system representation. The blood oxygen level dependent (BOLD) signal is a measure for the localized hemodynamic response, which is observed after neuronal activation [2]. This response is a nonlinear function of the blood flow and the blood oxygen content [3]. Hemodynamic response typically lasts for several seconds to respond and decay [4]. This response changes from subject to subject, even in different times during the day and different regions of the brain [4,5]. The general shape of the response is a typically skewed bell-shaped function and is commonly represented as a mixture of gamma functions [6]. Alternatively, the total system representing the hemodynamic response can be modeled by nonlinear differential equations [7–9].We estimate the parameters and the states by using the BOLD signal and the functional representation of the system. In this paper, we use the following functional model:(1)xk+1=f(θ,xk)+wk(2)yk=h(θ,xk)+vkHere, f and h are nonlinear functions of the state xk, where k is the time index. The state in our case is a vectorxk∈ℝ4, because there are four hemodynamic state variables. The observed BOLD signal at time k is denoted byyk∈ℝ, because the BOLD signal is one dimensional. The state transition noisewkis Gaussian withN(0,Qk), and the observation noisevkis Gaussian withN(0,Rk). The set of parameters of the model is denoted by θ. Given N observations y1, y2, ⋯, yNor y1:N, our aim is to find the parameter set θ and the states x1, x2, ⋯, xNor x1:N.In the fMRI model inversion literature, Riera et al. [10] used a kind of extended Kalman filter where the discretization was not based on the Euler-Maruyama method. They used the method proposed by Jimenez et al. [11]. Hu et al., on the other hand, used the unscented Kalman filter (UKF) [12] in their work for the estimation of the hemodynamic model states and parameters [13]. Riera et al. and Hu et al. used these techniques in a forward pass manner without smoothing. The early attempts in the fMRI model inversion literature disregarded the state noise. For example, in [7] Friston et al. models the input and the output relation via Volterra kernels. Later, Friston used a Bayesian estimation technique [14] to find the posterior of the parameters again under zero state noise assumption. Later, Friston et al. suggested advanced techniques based on variational filtering in which he also included the nonzero state noises in the model [15–17]. Variational filtering techniques assume factorization of the parameters and states. Dynamic expectation maximization (DEM) is the most popular of them. As Havlicek et al. pointed out, DEM also works in the forward pass manner [3]. Johnston et al. [2] used particle filters, without using any smoothing. However, Murray and Storkey [18] used particle smoothers. Most recently, Havlicek et al. [3] used the square-root cubature Kalman smoother (SCKS) and obtained quite a remarkable success compared with DEM under certain noise conditions. Most of the signal analysis techniques in the fMRI literature can be regarded as a kind of deterministic model inversion technique. Finally, there is a class of variational filtering schemes known as generalized filtering that operate in generalized coordinates of motion [17]. Crucially, from our perspective, these effectively perform online smoothing. This is because the filter estimates not just the current state but high order derivatives that are based on (local) past and future states. In other words, generalized filtering can be regarded as a local Bayesian smoother. Generalized filtering is, however, a recent addition to the portfolio of Bayesian deconvolution schemes and will not be considered further in this paper.In this paper, the iterative extended Kalman smoother (IEKS) method is used as a model inversion technique and it is shown that the parameter and the state estimation performances are improved compared with the standard extended Kalman type algorithms, which are used in the literature. Quite interestingly, EKF in the hemodynamic literature is used only in the forward pass without smoothing [2,10]. Furthermore, Johnston et al. [2] concluded that EKF is not robust and poor in performance compared with the particle filters and LLF filters. The assertion that EKF is poorer in performance was repeated in the fMRI literature in several landmark papers without examining specifically for the hemodynamic modeling case [3,16]. In this paper, we showed that the contrary is true. We followed a similar approach with Havlicek et al.'s method and showed that IEKS is a powerful alternative of former model inversion algorithms. We compared IEKS with EKS and EKF and noticed the remarkable state estimation performance under different process/measurement noise conditions. We compared IEKS with SCKS for joint state and parameter estimation performance. In all conditions, IEKS is shown to be robust and more accurate than iterative SCKS. Also, IEKS was more than twofold faster than iterative SCKS.The paper is organized as follows: in Section 2, we give the details of the algorithms used. The steps of EKF, EKS and IEKS are detailed, including the joint parameter and the state estimation parts.Hemodynamic model system identification is presented in Section 3; we work on the details of the fMRI hemodynamic model state space formulation. We first represent the system in the deterministic nonlinear dynamical differential equations form. We use the Euler-Maruyama method with time step Δt=0.1 to discretize the system. We assume that there is an associating measurement for every one second. We perturb the system with process and measurement noises. We work on different process and measurement noise conditions, including [16,3].In the Results and Discussion section, we first compare the hemodynamic state estimation performance of EKF with the standard particle filters (PF). Johnston et al. [2] asserted that PF outperforms EKF and LLF filters. In this paper, we reexamined this assertion and concluded that the most basic usage of particle filters do not outperform other filtering techniques. We checked the state estimation performance of PF with EKF under a variety of process and measurement noise conditions. Subsequently, we checked the numerical improvement in state estimation, achieved by applying smoother to the EKF state estimation for a wide range of noise conditions. Subsequently, for the joint parameter and state estimation, we checked the performance comparison of EKS and IEKS. We conclude that IEKS substantially improves the estimation performance. Subsequently, for the joint parameter and state estimation, we give the simulation results of the algorithms IEKS and iterative SCKS for five different scenarios. SCKS was tested in the former hemodynamic model inversion work for low process noise conditions [3]. We test IEKS and SCKS for more challenging process and measurement noise levels. The performance improvement of EKS over SCKS for all process and measurement noise conditions is shown in terms of the state and parameter accuracy. The bias improvement for the parameters for IEKS is stressed compared with iterative SCKS. In Section 5, we apply IEKS method to a real data set. We discuss further aspects of the method in detail.The main findings and contributions for the hemodynamic model inversion for PF, EKF, EKS and IEKS are as follows:--The assertion made in the literature that PF outperforms Gaussian approximated model inversion methods seems not valid for the hemodynamic model tested for a wide range of process/measurement noise conditions.The notion that EKF is not an efficient model inversion scheme can be refuted. It appears to operate well for various levels of measurement noise and different processes.EKF's hemodynamic state estimation performance is even better than standard particle filters under a wide range of process and measurement noise conditions.EKS is robust and improves EKF especially in the higher hemoydnamic process/measurement noise conditions.IEKS substantially improves hemodynamic state estimation performance by utilizing the EKS algorithm iteratively.IEKS has better hemodynamic state estimation accuracy compared with iterative SCKS for different process and measurement noise conditions.IEKS has better parameter estimation accuracy compared with iterative SCKS for different hemodynamic model process and measurement noise conditions. The bias of the parameters is lower.IEKS is more than twice faster than iterative SCKS for the joint hemodynamic model inversion.In the former evaluation of SCKS and DEM [3], SCKS is concluded to be the best method for model inversion in the fMRI literature. In this paper, it is concluded that IEKS seems to be the best method to be used for the joint parameter and state estimation of the hemodynamic dynamical system. This also stresses how important smoothing is in the hemodynamic model inversion algorithms.In this section, the details of the EKF, EKS and IEKS algorithm is given. For the SCKS implementation, the reader is referred to [3]. The extended Kalman filter/smoother and cubature Kalman filter/smoother algorithms can be classified under the deterministic inference algorithms. They approximate the filtered state estimate p(xk|y1:k) and the smoothed state estimate p(xk|y1:N) by Gaussian probability density functions (pdf). Since the pdfs are Gaussian, both of the algorithms iteratively update the mean and covariance of the state estimates.For the EKF algorithm, the system is linearized in the estimated state values. After the linearization step, the standard Kalman filter algorithm is applied, which is known to operate optimally in linear systems [19]. So the extended Kalman filter is a kind of deterministic approximation technique. It has the further assumption that the filtered and the predicted states can be approximated by Gaussian densities:(3)p(xk|y1:k)=N(xˆk|k,Pk|k)(4)p(xk+1|y1:k)=N(xˆk+1|k,Pk+1|k)Here,xˆk|kandxˆk+1|kare the filtered and the predicted mean values of the densities, whereas Pk|kand Pk+1|kare the filtered and the predicted covariances of the states.Subsequently, the EKF algorithm recursively updates these statistics as follows:Prediction update:(5)xˆk|k−1=f(xˆk−1|k−1)(6)Pk|k−1=F(xˆk−1|k−1)Pk−1|k−1F(xˆk−1|k−1)T+Qk−1Hence, the state updatexˆk|k−1is done by propagating the estimatexˆk−1|k−1through the nonlinear state equation. In order to calculate the predicted covariance Pk|k−1, the state equation is linearized. The Jacobian matrix of f at the state value x is denoted by F with the component values evaluated as:(7)Fij(x)=∂f(xi)∂xjThis concludes the prediction step. The next step is the measurement update. The first step is to calculate the so-called innovationvk.Measurement update:If there is a measurement at time k, then the updates are:(8)vk=yk−h(xˆk|k−1)(9)Sk=H(xˆk|k−1)Pk|k−1H(xˆk|k−1)T+Rk(10)Kk=Pk|k−1H(xˆk|k−1)TSk−1(11)xˆk|k=xˆk|k−1+Kkvk(12)Pk|k=Pk|k−1−KkSkKkTIf there is no measurement available at time k,(13)xˆk|k=xˆk|k−1(14)Pk|k=Pk|k−1In order to calculate the Kalman gain, Kk, the measurement function h is linearized similar to the prediction step. The Jacobian matrix of h at the state value x is denoted by H with the component values evaluated as:(15)Hij(x)=∂h(xi)∂xjBy using the EKF algorithm, the state xkis predicted from the observed sequence y1:k. From the future data, once we have them, a more accurate state estimation can be accomplished. This is achieved through the EKS algorithm [1]. The EKS algorithm is also easy to implement. The recursion is done by going backward in time. The recursion step begins from k=N−1.First, the state is predicted as:(16)xˆk+1|k=f(xˆk|k)and the covariance is predicted by the formula(17)Pk+1|k=F(xˆk|k)Pk|kF(xˆk|k)T+QkThe Kalman gain Kkfor the smoother is:(18)Kk=Pk|kF(xˆk|k)TPk+1|k−1Smoother estimates for the state meanxˆk|Nand state covariance Pk|Nare found by using the Kalman gain Kkand the filter estimates of the state meanxˆk|kand the state covariance Pk|k:(19)xˆk|N=xˆk|k+Kk(xˆk+1|N−xˆk+1|k)(20)Pk|N=Pk|k+Kk(Pk+1|N−Pk+1|k)KkTEKF and EKS can also be used to estimate the parameters of the system. It is possible to augment the parameters to the state variables. In this description, the parameters are treated as time-varying variables with small noise perturbations as in [3]. So the parameter updates become:(21)θk+1,1=θk,1+wk,1(22)θk+1,2=θk,2+wk,2(23)⋯(24)θk+1,p=θk,p+wk,pwhere θk,istands for the i-th parameter at time k, i=1, 2, ⋯, p. The new state xa,kbecomes an extended version of the original state xk.(25)xa,k=xkθk,1θk,2⋮θk,pFor SCKS, Havlicek et al. used the similar technique for parameter estimation [3]. Since we augmented the parameters to the state, EKS also estimates for the parameters besides the states. At the end of the EKS algorithm, we obtain an estimate of the parameter set θ. Using the estimates of the parameters θ as the new initial estimate for the parameters, we iterate the EKS algorithm until convergence similar to [3].In this section, we first review the deterministic hemodynamic model. Following Friston, we then make a nonlinear transformation to guarantee positive values for the hemodynamic variables [16]. We then perturb the system with white noise to obtain the stochastic representation of the hemodynamic model. As a final step, we discretize the system by using the Euler-Maruyama method to obtain the discrete time nonlinear state space model. We also specify the parameter values and the noise statistics of the hemodynamic model.The hemodynamic model consists of four dimensional state transition equations and one dimensional measurement equation. The hemodynamic model represents the relationship between the neuronal activity u and the metabolic demands [18]. After the neuronal activity, an increase in the vasodilatory signal h1 is observed. In proportion to the increase in the vasodilatory signal h1, an increase in the blood flow h2 is observed. Subsequently, a change in the blood volume h3 and the deoxyhemoglobin content h4 is observed [16]. These quantitative facts are expressed in the following nonlinear dynamic differential equations:(26)h˙1(t)=ϵu(t)−κh1(t)−χ(h2(t)−1)(27)h˙2(t)=h1(t)(28)h˙3(t)=τ(h2(t)−F(h3(t)))(29)h˙4(t)=τh2(t)E(h2(t)))−F(h3(t))h4(t)h3(t)where(30)F(h3(t))=h3(t)1/α(31)E(h2(t))=1φ(1−(1−φ)1/h2(t))Here, the parameter φ is denoted as the resting oxygen extraction fraction, and the parameter α is called Grubb's exponent. The parameter τ is called the transit time. The parameter κ is a measure for the decay of the vasodilatory signal h1. The parameter χ is the rate constant for the feedback of the blood flow h2. Finally, the parameter ϵ represents the neuronal efficacy factor.The measurement equation is given by(32)y(t)=V0k1(1−h4(t))+k21−h4(t)h3(t)+k3(1−h3(t))Here the parameter V0 is called the resting blood volume fraction, and k1, k2 and k3 are called the intravascular coefficient, the concentration coefficient and the extravascular coefficient, respectively. The measurement equation relates the observed BOLD signal in terms of the blood volume h3 and the deoxyhemoglobin content h4. For the derivation and justification of this equation, the reader is referred to [20,9,21].For arriving at the final discrete time nonlinear state space model, we first utilize the technique of variable transformation proposed by Friston [22]. Subsequently, we perturb the model by white noises. Afterward, we employ the Euler method to derive the discrete time nonlinear state space representation. In order to guarantee positive values for the hemodynamic states, we make the transformation x1(t)=h1(t) and xi(t)=log(hi(t)) for i=2, 3, 4 [16,3], and we add the white noises. As a result, we work on the following transformed system of equations for the states:(33)x1˙(t)=ϵu(t)−κx1(t)−χ(ex2(t)−1)+β1(t)(34)x2˙(t)=x1(t)ex2(t)+β2(t)(35)x3˙(t)=τ(ex2(t)−F(ex3(t)))ex4(t)+β3(t)(36)x4˙(t)=τ(ex2(t)E(ex2(t)))−F(ex3(t))(ex4(t)/ex3(t)))ex4(t)+β4(t)By utilizing Euler discretization for the first derivative, we obtain the following representation of the stochastic nonlinear system for hemodynamic modeling of fMRI signals:(37)x1(t+Δt)≈x1(t)+Δt(ϵu(t)−κx1(t)−χ(ex2(t)−1))+Δtβ1(t)(38)x2(t+Δt)≈x2(t)+Δtx1(t)ex2(t)+Δtβ2(t)(39)x3(t+Δt)≈x3(t)+Δtτ(ex2(t)−F(ex3(t)))ex4(t)+Δtβ3(t)(40)x4(t+Δt)≈x4(t)+Δtτ(ex2(t)E(ex2(t))−F(ex3(t))(ex4(t)/ex3(t)))ex4(t)+Δtβ4(t)For the discrete time instants t=tk≜kΔt, k=1, 2, …, putting xk+1=x(tk+Δt), xk=x(tk), uk=u(tk), yk=y(tk), andwk=Δtβ(tk),11Here, the scaling factorΔton the noise standard deviation comes from the discretization of the stochastic integral ∫dβt.we arrive at the discrete time state space representation of the form:(41)xk+1=f(θ,xk)+wk(42)yk=h(θ,xk)+vkwhere the state transition function f(θ, xk) and the observation function h(θ, xk) are(43)f(θ,xk)=xk,1+Δt(ϵuk−κxk,1−χ(exk,2−1))xk,2+Δtxk,1exk,2xk,3+Δtτ(exk,2−F(exk,3))exk,4xk,4+Δtτ(exk,2E(exk,2)−F(exk,3)(exk,4/exk,3))exk,4and(44)h(θ,xk)=V0k1(1−exk,4)+k21−exk,4exk,3+k3(1−exk,3)respectively. In the equation above, xk,ifor i=1, 2, 3, 4 denote the components of the state vector xk.In the simulations, we took the parameter values of the hemodynamic model and the BOLD signal as shown in Tables 1 and 2as in [16]. The input is taken as in [3] as Gaussian bumps with different amplitudes centered in the time points (10, 15, 39, 48). The length of the input signal is 64s. Δt is taken as 0.1s as in [2]. The sampling interval for the measurement is taken as 1s.The noise statistics can be found in Table 3. For the measurement noisevk, we first used the numerical value e−6 as the standard deviationσv. Note that this corresponds to a noise variance ofσv2=e−12, and it is an equivalent choice to the noise characteristics given in the histogram plots in [2,10]. We included four more scenarios to test the robustness and accuracy of the EKS and SCKS methods under different process and measurement noise conditions as can be seen from Table 3. For the parameter estimation, we estimated the same parameters κ, τ, χ as in [3]. As indicated by [3], Grubb's exponent α and the resting oxygen extraction fraction φ were also fixed in the work of [10]. The reason for focusing on the three parameters above is that there is conditional dependency among the parameters of the hemodynamic model. This means that the parameters considered above can account for normal variations in the hemodynamic response function. In effect, this corresponds to fixing Grubb's exponent and oxygen extraction fraction to their physiologically expected values [23,3]. Furthermore, we also assumed that the neuronal efficiency ϵ is known and taken as 0.5. In the Monte Carlo analysis, we disturbed the initial estimation of the parameters κ, τ, χ by the varianceN(0,1/12)as done in [3].Based on the above problem formulation, in the next section, we perform a detailed comparison of PF, EKS, IEKS, and iterative SCKS under five different simulation scenarios.

@&#CONCLUSIONS@&#
