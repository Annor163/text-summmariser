@&#MAIN-TITLE@&#
Stabilizing 3D in vivo intravital microscopy images with an iteratively refined soft-tissue model for immunology experiments

@&#HIGHLIGHTS@&#
Software for stabilizing in vivo two-photon microscopy images with tissue movements.Pixel weighted registration algorithm that explicitly treats inter and intrastack motion errors.A nonlinear soft-tissue deformation alignment correction called the poor man׳s diffeomorphic map.A method for detecting and removing multiple exposure errors caused by undersampling.A globally stabilization method using a constrained optimization method.

@&#KEYPHRASES@&#
Bioimaging,Biomedical image stabilization,Image registration,Soft-tissue deformations,In vivo two photon microscopy,Lymphocyte tracking,

@&#ABSTRACT@&#
We describe a set of new algorithms and a software tool, StabiTissue, for stabilizing in vivo intravital microscopy images that suffer from soft-tissue background movement. Because these images lack predetermined anchors and are dominated by noise, we use a pixel weighted image alignment together with a correction for nonlinear tissue deformations. We call this correction a poor man׳s diffeomorphic map since it ascertains the nonlinear regions of the image without resorting to a full integral equation method. To determine the quality of the image stabilization, we developed an ensemble sampling method that quantifies the coincidence between image pairs from randomly distributed image regions. We obtain global stabilization alignment through an iterative constrained simulated annealing optimization procedure. To show the accuracy of our algorithm with existing software, we measured the misalignment error rate in datasets taken from two different organs and compared the results to a similar and popular open-source solution. Present open-source stabilization software tools perform poorly because they do not treat the specific needs of the IV-2pM datasets with soft-tissue deformation, speckle noise, full 5D inter- and intra-stack motion error correction, and undefined anchors. In contrast, the results of our tests demonstrate that our method is more immune to noise and provides better performance for datasets’ possessing nonlinear tissue deformations. As a practical application of our software, we show how our stabilization improves cell tracking, where the presence of background movement would degrade track information. We also provide a qualitative comparison of our software with other open-source libraries/applications. Our software is freely available at the open source repository http://sourceforge.net/projects/stabitissue/.

@&#INTRODUCTION@&#
In vivo intravital imaging microscopy (IVM) is used to extract quantitative cell information, such as location, motility, adhesion and interactions [46], that best resemble the actual cellular behavior within an organ [43]. Volume data in intravital two photon microscopy (2pM) imaging is acquired from planar images (i.e., z-stacks) obtained by successively changing thez-focal length, and subsequently repeating the volume acquisition over time. Thus, a five-dimensional image is represented asI(x,y,z,c,t), with a set of z-stacked 2D(x,y,z)images, a set of color channel(c), and time(t). The acquisition of deeper volumes and higher resolution is limited by the finite acquisition time of the microscope. This time to obtain an image for an image stack volume directly impacts the time-resolution associated with capturing cell behavior in the live tissue.Image acquisition times depend upon the laser microscopy and fluorescent marker parameters in a complex way. Nonetheless, typical acquisition times(Δts)are approximately 3s/slice and, therefore, 30s or more for a practical tissue volume (for 10 image slices or more). As an example, the image acquisition time needed to resolve lymphocytes motility in typical immunology experiments is limited by the average lymphocyte speed of10–25μm/min[39]. Thus, if the volume acquisition is 30s(Δts=3s/slice×10slices), the lymphocytes travel approximately their diameter between volume acquisitions. During this time to acquire an image volume, background tissue movements could corrupt image quality, thereby compromising quantitative measurement required to answer biological questions. Background motion can also accentuate errors due to undersampling, introducing multiple exposure artifacts.These fundamental technical problems of IVM technology limit both the possible spatio-temporal resolution as well as the ability to attain deeper tissue volumes. Thus, practitioners invest considerable efforts in specialized microscope staging to reduce tissue motion in the live animal under study. Even with experimental precautions, the background motion of organs during image acquisition cannot be entirely eliminated. These movements cause relative displacements between successive image stacks over time, degrading the final quality of the dataset. To remove these displacements, image stacks are aligned, or registered.Alignment in this context means that for a particular image Italong the timeline, we determine the relative displacement vectorΔuwith its predecessor,It−1, such that the overlap between the images is maximal. This procedure is repeated for all image pairs, using the vectors to translate images so as to obtain maximum pixel coincidence. We refer to this process of aligning all image stacks relative to one another as stabilization. Moreover, fluorescent two-photon microscopy is not only three-dimensional but also multi-channel. Different wavelengths correspond to different reporter proteins, and hence can distinguish biologic cells and tissue of interest. In channels that tag specific cells, all other biologic tissue is transparent. Thus, once the alignment from this color channel is obtained, the results are applied to the other color channels.Most registration/stabilization algorithms were designed to align images or image sequences using well-defined anatomic landmarks. Such algorithms employ scale invariant feature vectors (e.g. SIFT (scale invariant feature transform[37]) or other similar techniques, that allow a comparison of key points between successive images. In the case of IV-2pM, predefined anchor structures are often not available. Instead, the only landmarks may be blood vessels or other soft vessels that are neither fixed, nor maintain their shape over time. Also, IV-2pM datasets are dominated by speckle noise, rendering them poor candidates for feature-based registration methods. As a result, the specialized registration algorithm must use these approximate anchors to infer the best alignment solution for this particular application.ImageJ [51] and the parallel development branch, Fiji [50], are popular general purpose (open-source) tools for microscopy analysis, which have active third party software contributions through plugin support. In both platforms, plugins are available for performing image registration and stabilization. Nonetheless, the specific needs of the IV-2pM datasets with soft-tissue deformation, speckle noise, full 5D inter- and intra-stack motion error correction, and undefined anchors, are not well treated in these more general purpose plugins. To this end, we developed a set of specialized algorithms for stabilizing IV-2pM datasets that we have packaged into a software tool, called StabiTissue, that is freely available at http://sourceforge.net/projects/stabitissue/.Fig. 1shows a top-level workflow of the principle steps StabiTissue for stabilizing IV-2PM image datasets. In the next section, we provide a brief background of previous work and the problem context. In the Methods section, we describe the technical details of the algorithms employed by our software: (1) a pixel weighted registration algorithm that explicitly treats inter- and intra-stack motion errors, (2) a nonlinear soft-tissue deformation alignment correction process, we call the poor man׳s diffeomorphic map, (3) a method for detecting and removing multiple exposure errors caused by undersampling, and (4) a global stabilization method that selects the optimal internal parameters of our method using a constrained optimization method based upon simulated annealing.Intravital imaging has become a mainstream technology in the biological sciences that is used in various ways to study the spatial location, motility, adhesion and interaction of cells within their natural environment, or ecological niche. While in widespread use, advances are continually pushing the envelope of time/spatial performance and even more are promised on the horizon. Developments in dynamic intravital multiphoton microscopy have been described in recent reviews [41,46], while high resolution intravital microscopy techniques are treated in [3]. A discussion of intravital imaging used in dynamic biological systems can be found in [28].The field of Immunology has particularly benefited from IVM [4], where many processes of the adaptive immune system have been revealed, despite still being poorly understood due to the complex interplay between different lymphocyte types and other cells of the immune system. IVM has been made possible with the discovery and implementation of multiphoton microscopy, first described by [25]. Early work applying IVM to immunology can be found in [26,20]. The development of two-photon microscopy (2pM) facilitated the ability to probe live tissue at greater depths, representing a considerable improvement over traditional confocal microscopy. Because two-photon excitation use lower-energy photons (i.e., employing the concept of two-photon absorption that subsequently results in the spontaneous emission of a photon of higher energy at the fluorescent wavelength), 2pM produces lower backscatter and also lower photobleaching damage to tissue. Since the probability that a two-photon absorption events occurs is exceedingly small, the photon density must be high. Such high densities can be achieved with short-pulse (femtosecond) and high powered lasers, sufficient photon–photon interactions can take place.Practical issues involved in using IVM in conjunction with two-photon microscopy (2pM) for immunological research is described in [44], while a review of immunoimaging techniques is described by [59]. From many different studies using IV-2pM, lymphocyte function in the adaptive immune system is being elucidated. With respect to the location and motility: B cell migration has been extensively studied in germinal centers to understand details of the maturation process, possibly involving a recycling process in two spatially distinct regions, the dark and light zones: [13,61,24,2,6,63,7]. More complex motility of leukocytes has been studied using 2pM IVM in a beating heart [34].We have recently used IV-2pM to study lymphocytes interactions in the presence of malaria [16]. In other work, we used IVM to reveal the complex behavior of regulatory T cells (Tregs) and dendritic cell (DC)/lymphocyte contacts in the uterus and placenta [65,66] in order to uncover the role of Tregs in pregnancy. Lymphocyte cell-cell contact interactions have been studied with IV-2pM to understand the basic process of lymphocyte activation, through the so-called immunological synapse [17]. A recent review has discussed the techniques for visualization of cell–cell contact at the fetal–maternal interface, [43,42].IV-2pM has also made its way into clinical uses. Deep intravital tissue imaging for clinical research using IV-2pM is discussed in [63,64]. IVM is also being used for revealing new insights into metastasis of tumors [5], who suggest that intravital real-time microscopic imaging of living organs, such as through endomicroscopy and surgical imaging shall be important in the future. The IV-2pM methods are also used in neuroscience applications [55], where stringent resolutions are required [54].A technical problem that affects the quality of IV-2pM images is the background tissue movement associated with the living animal and the natural peristaltic movement of the organ under study. Several researchers have described specialized experimental stands whose objective is to reduce the source of movement. [32] showed that by measuring the respiration with a piezoelectric device, the background respiration induced motion could be subtracted out from the final image acquisition. Others have developed special staging structures for studying abdominal cavities [10] and lungs [36], where background movements are particularly pronounced. Physical movement compensation methods, such as suctioning stabilization are described by [62]. Adaptive movement compensation [31] and motion correction [11,12], which feedback systems have been described to improve resolution of cellular level dynamics in the presence of large background tissue movement. Recently, a fully integrated open source hardware/software co-design solution using bead tracking with feedback compensation has been developed [50,45,21].Despite these experimental methods to reduce movement, image sequences can benefit from post-processing image alignment. As described previously, image registration is the process of finding the mapping between one image and another, whether it is a linear displacement or involving some nonlinear warping, by using common features as landmarks. Such features could be elementary geometric entities in the image (e.g., edges, contours, or lines) that constitute distinguishing control points (e.g., as in the SIFT method, or scale invariant feature transform[37]) for performing similarity comparisons between two images. The spatial mapping between the set of images can be either linear (e.g., translational or purely rotational) or nonlinear that take into account local diffeomorphic mappings between points, as for example in the elastix software library [30].The choice of the basic image registration technique is driven by the problem to be solved and there is no universal technique that can work in all cases. For example, the choice of features and matching will depend upon whether there are rigid or known landmarks and features, or the extent of alignment; i.e., if it consists of a set of images or is pairwise. Reviews of image registration can be found in [67,49]. Complete treatment of image registration, and other computer vision topics, are covered in the recent book by Szeliski [57] and another by Modersitzki [40]. We used a form of the Fourier based algorithms for registration [53,47,15], together with a pixel weighting [57] method.As can be seen in these references, the field of image registration is mature particularly for images where landmark features are well defined and features are easily determined. In such cases, many sophisticated algorithms have been developed, especially for medical applications, to handle challenging situations, such as obtaining globally consistent alignment, different exposure levels, to remove object movement, and to determine a nonlinear (diffeomorphic) warping between images. When no such landmarks are available, however, as in the case of IV-2pM, effective algorithms are still in their infancy. Our software fills this gap and provides a solution for the specific problems faced by full 5D IV-2pM motion errors.

@&#CONCLUSIONS@&#
Ideally, a stabilization algorithm registers each frame of an image sequence using well-defined anatomic landmarks, which remain constant over the entire image set. Many examples exist among other biomedical imaging (e.g., CT and MRI) where image registration of anatomical structures (e.g., cranial images, thorax) is guided by well defined landmarks. In general, however, IV-2pM datasets lack such predefined anchor structures. Instead, a potential landmark may be a blood vessel, or other soft vessel, which is neither fixed, nor maintains an exact shape over time. Therefore, the registration algorithm must handle this type of anchor that only approximates an ideal fixed shape over the entire image sequence. Moreover, IV-2pM images are dominated by speckle noise, rendering them poor candidates for feature-based registration methods, such as SIFT (scale invariant feature transform[37]), that tend to work well in situations with rigid objects and sharp edges. Here we described a set of algorithms and a software to treat each of the problems described above, foremost a pixel weighting alignment method that corrects for nonlinear deformations.Throughout this paper, we described several advantages of our algorithm and showed these ideas with real datasets. First, our method stabilizes the full 3D stack, aligning images within and across stacks; other software solutions we tested stabilize only across the same slice plane. Next, we correct our linear stabilization algorithm against nonlinear deformations that could bias the results by subtracting their contributions from the alignment weights. The final solution still remains a linear translation, only it is not biased by the nonlinear distortions. To determine the nonlinear background deformations in each image slice along time, we use a data-driven iterative procedure. We also described a global optimization procedure that constrains the displacements of images in a time averaged manner. Finally, since our algorithm is not based upon keypoint features, it is more immune to noise.As with any method, there are disadvantages that limit the performance of our algorithms. With respect to the pixel weighted alignment algorithm, despite the nonlinear corrections, it is still a linear transformation. Moreover, there is a complex relationship between the pixel threshold and the number and size of contours. Selecting the proper pixel and contour size thresholds that will yield acceptable stabilization results is still an art. Because these internal free parameters are central to the method, these limitations are difficult to remediate without resorting to trial and error or a computationally demanding optimization procedure.With respect to the nonlinear soft tissue movements, the intention of our PDMD algorithm was to remove unwanted bias from the pixel weights originating from regions undergoing nonlinear deformations, while retaining a linear stabilization. The reason we maintained the linear stabilization is to correct cell tracking trajectories from tissue movement with respect to the global coordinate system. While the PDMD correction does improve the stabilization, it does not explicitly address the nonlinear deformations. A future direction for this work shall investigate the diffeomorphic mappings between image of the 3D stacks and subsequently the appropriate affine transforms that can flatten the deformed regions.Finally, our implementation as a stand-alone application provides an easy to use interface for the specific problem of stabilization. Nonetheless, it is not a general purpose image analysis tool. For this reason, our algorithm could be more widely accepted if it were incorporated as a plugin into a popular general purpose microscopy analysis systems, such as ImageJ, Fiji or Omero. Another future direction for this work is to implement our algorithms within one of these more widely accepted platforms.None declared.Supplementary data associated with this paper can be found in the online version at doi:10.1016/j.compbiomed.2015.07.001.Video 1Video demonstration of the StabiTissue application. The StabiTissue program is a multiplatform application that was developed in Python using the Qt framework. The following tasks are shown in the video: importing data, partial data selection, selecting a slice along the timeline, stabilization of a dataset, parameter tuning, and visualization of the stabilization along the Z-axis.Video 2Stabilization of intravital placenta data. The video sequence shows a set of sequential intravital images of the placenta obtained using a microscopy system consisting of the following: a stereoscope Zeiss Lumar Stereo (Zeiss, Inc., Chester, VA, USA) with an Apo Lumar S1.29 FWD 47-mm objective, a Chameleon Ti:Sapphire laser (Coherent, Inc., Santa Clara, CA, USA) used in conjunction with four photomultiplier tubes (PMT) for separate monitoring of the color channels, and a water immersion objective (Olympus Inc., Center Valley, PA, USA). Images were acquired with a tissue volume having a 50μ depth, divided into 4.0μ z-steps (60 cycles, 3 channels). Further details of the experimental procedures and animal preparation for in vivo imaging microscopy can be found in [?,?,?,?,?]. The first part of the video shows the original data stabilized and unstabilized, while the second part of the video shows the same data ”cropped” to the maximum viewable area over all time points time. The last part of the video shows a screenshot of StabiTissue stabilization results along the Z-axis for all time cycles.Video 3Stabilization of intravital data from the uterus. Sequential intravital images of the uterus obtained using a microscopy system consisting of the following: a stereoscope Zeiss Lumar Stereo (Zeiss, Inc., Chester, VA, USA) with an Apo Lumar S1.29 FWD 47-mm objective, a Chameleon Ti:Sapphire laser (Coherent, Inc., Santa Clara, CA, USA) used in conjunction with four photomultiplier tubes (PMT) for separate monitoring of the color channels, and a water immersion objective (Olympus Inc., Center Valley, PA, USA). Images were acquired with a tissue volume having a 50μ depth, divided into 4.0μ z-steps (60 cycles, 3 channels). Further details of the experimental procedures and animal preparation for in vivo imaging microscopy can be found in [?,?,?,?,?]. The first part of the video shows the original data stabilized and unstabilized, while the second part of the video shows the same data “cropped” to the maximum viewable area over all time points time. The last part of the video shows a screenshot of StabiTissue stabilization results along the Z-axis for all time cycles.