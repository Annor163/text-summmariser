@&#MAIN-TITLE@&#
Appearance normalization of histology slides

@&#HIGHLIGHTS@&#
A method for normalizing the appearance of histology slides is given.The method uses prior information to stabilize stain direction estimation.The effectiveness of the method over those not using prior information is shown.The method is shown to be effective in normalizing the appearance of faded slides.Normalization is shown to improve the performance of statistical classification.

@&#KEYPHRASES@&#
Appearance normalization,Histology,

@&#ABSTRACT@&#
This paper presents a method for automatic color and intensity normalization of digitized histology slides stained with two different agents. In comparison to previous approaches, prior information on the stain vectors is used in the plane estimation process, resulting in improved stability of the estimates. Due to the prevalence of hematoxylin and eosin staining for histology slides, the proposed method has significant practical utility. In particular, it can be used as a first step to standardize appearance across slides and is effective at countering effects due to differing stain amounts and protocols and counteracting slide fading. The approach is validated against non-prior plane-fitting using synthetic experiments and 13 real datasets. Results of application of the method to adjustment of faded slides are given, and the effectiveness of the method in aiding statistical classification is shown.

@&#INTRODUCTION@&#
Stains are often used to highlight distinct structures in microscopy slides of tissue samples. Frequently two stains, such as eosin and hematoxylin, are applied for purposes such as discriminating cell nuclei and cytoplasm. Standardized staining protocols help to reduce variations in staining results; however, various factors can affect stain color and intensity in practice. For example, stains can fade over time, stain colors may differ slightly, or different imaging equipment may be used.Standard stains absorb light. The concentrations of the various stains on a sample will determine its appearance when illuminated under a microscope, with higher concentrations appearing darker. The amount of light absorbed by a stain is wavelength dependent, and each stain can be characterized by its absorption coefficients. These coefficients form a vector (the stain vector) of dimension equal to the number of wavelengths in the imaging sensor (three for a standard RGB camera). Given the stain vectors, an image can be decomposed into components of each individual stain via color deconvolution [13]. These components can be adjusted and recomposed into an image which appears to have different amounts of each stain than before. This paper proposes a method for automatic stain vector estimation and slide appearance normalization (both color and intensity). This can improve quality both for viewing the slides as well as quantitative analysis of the slides.Previous approaches to extract stain vectors include manual region of interest definition, methods relying on non-negative matrix factorizations [11], and working in the optical density domain, including plane fitting [3] and learning per-image vectors from manually segmented regions [5].Stain vector estimation is not the only approach used for normalization of histology slides. Reinhard et al. [12] transform images into the lab color space and normalize the mean and standard deviation of each channel of an image to a target image. Magee et al. [5] propose an extension to this method which first segments the pixels into multiple classes based on color and then normalizes each class separately. This method uses a prior obtained by computing the mean of each pixel class over a set of manually segmented images. Another common approach is equalization of color histograms. Kothari et al. [1] use a modification of this approach which normalizes using rank functions of unique colors rather than all colors present in an image.Methods which do not use prior information often have trouble dealing with images which do not fit the assumptions made by their models. Histogram-based methods assume that two images are similar in the amount of stain present. Stain vector estimation via plane-fitting becomes unstable in the cases where the number of pixels with each stain is highly unbalanced. The method of [5] which does include prior information on stain vectors requires per-image manual segmentations of each stain.This paper addresses these issues by introducing prior information to the plane-fitting algorithm of [3]. This is an extension of the work by [8] with additional applications and validation. Novel contributions include: (1) a rigorous theory for the color model used, (2) the introduction of prior information for the stain vector taking into account varying amounts of stain (such as that encountered in the case of sparsely distributed nuclei on large amounts of stained background tissue), (3) an alternating optimization method and its connection to a sub-problem from trust region optimization, (4) a novel twist on Otsu thresholding [10] which also includes prior information, and (5) quantitative validation on synthetic and real datasets.The rest of this paper is organized as follows: Section 2 gives background information on the stain vector model used, Section 3 describes the basic plane optimization problem, Section 4 adds prior information to this optimization, Section 5 describes the prior-based clustering method, Section 6 describes the digital restaining procedure, Section 7 gives results from a variety of experiments, Section 8 describes several applications of this method, and Section 9 gives conclusions and discussion.According to the Beer–Lambert law, the transmission of light through a material can be modeled as(1)I=I0e−αcxwhere I0 is the intensity of the incident light, I is the intensity of the light after passing through the medium, α is the absorption coefficient, c the concentration of the absorbing substance, and x the distance traveled through the medium. The optical density (OD) or absorbance is(2)OD=αcx=−logII0We assume that α and x are constant for a specimen and a given stain, but that a stain's concentration c may change both locally and between slides. For a multispectral image, such as an RGB image captured with three wavelengths, Eq. (1) becomes vector-valued(3)I=I0⊙e−αcxresulting in an OD vector(4)OD=−log(IøI0)=αcxHere, the absorption coefficients αiare color dependent, and ⊙ and ø represent element-wise vector multiplication and division. Note that dark intensities will correspond to large optical density values and bright image parts where no absorption occurred will have small values. Each stain has a characteristic vectorαof absorption coefficients. Given a traced distance x the optical densityODis linearly related to the absorption coefficient, with a proportionality constant given by the stain concentration, i.e.,OD=αxc. Applying the vector-valued Beer–Lambert law to the case of a two-stain color image, such as one stained by eosin and hematoxylin, yields(5)I=I0⊙e−(α1c1x1+α2c2x2)where subscripts denote values for the two distinct stains. The optical density can be computed as(6)−log(IøI0)=α1c1x1+α2c2x2This shows that, for a given illuminationI0, the obtainable intensity vectorsIlie in the plane spanned by the absorption coefficients, or stain vectors,αi. Since ci≥0, xi≥0, and theαiare linearly independent, any color which can be represented by the imaging model must lie in the convex cone(7)C={x|x=q1α1+q2α2,q1,q2≥0}If all possible optical density vectors are normalized, all points must lie inside(8)CN=x˜|x˜=x∥x∥,x∈C∘whereC∘denotesC\0. Geometrically,CN=S2∩C, the intersection ofCand the three-dimensional unit sphere, which is the sector of a great circle.In the previous section, we described a method for transforming an RGB image into optical density space. As shown in Fig. 1, when an image stained with two stains is transformed into OD space, the image colors lie in the convex cone defined by the two stain vectors. The following sections develop a method for estimating both this plane and the associated stain vectors.By definition, the convex cone spanned by the stain vectors is a subset of a planePpassing through the origin(9)P={x:nTx=0}wherenis the plane's unit normal. The signed distance of any point to the plane can be computed asd(x,P)=nTxThe plane which minimizes the sum of squared distances to all given optical density vectors is given by minimizing(10)E(n)=∑i(nTxi)2=nT∑ixixiTn=nTSns.t.∥n∥=1Since S is positive semi-definite,nis the eigenvector of the smallest eigenvalue of S. This unconstrained optimization was proposed in [3].The results of this estimation are only reliable when a sufficient amount of both stains is present in the sample. When this assumption does not hold, additional constraints are needed. Adding prior information helps to ensure the estimator performs well. While introducing prior information gives up the convenience of a closed-form solution, it has clear benefits for increasing the stability of the plane estimation (see Section 7). We use an EM-style alternating optimization approach with efficient solutions for both stages.To introduce prior information, we penalize the deviation from a given reference plane (npTx=0) through a reference normalnp. The energy to be minimized now becomes(11)E(n)=12σ2∑i=1nd2(xi,P)+12σ02∥n−np∥2s.t.∥n∥=1where σ is the standard deviation for the measured points (assumed to be independent) and σ0 is the standard deviation of the prior (assumed to be Gaussian).Eq. (11) shows how, as n→∞, the effect of the prior shrinks. The distribution of points will only be approximately planar when there are a large number of measurements for both stains. This distribution cannot be guaranteed, especially if working with smaller sub-regions of a stained slide which may contain low amounts of nuclei and high amounts of stained background. In this case, without the stabilizing effect of the prior information, the plane that is fit will be heavily biased toward the cluster with a large number of points and will be a poor fit to the actual stains present. This problem can be overcome by weighting the data points assigned to a stain vector.Assuming the partitioning of these data points into two clusters (one for each stain) is known, the minimization energy (up to constants) is given by(12)E(n)=∑j=12∑i∈Pjnjd2(xi,P)2σ2+α2σ02∥n−np∥2wjwhere thewiare the weights, Pithe partitions, and nithe number of points in each partition. The partitioning method used is described in Section 5.The weights are chosen based on several conditions. The weights must take into account whether there are a sufficient number of data points in each cluster, and should simplify back to Eq. (11) if the clusters are of equal size. The following conditions are placed upon the weights for these properties to hold:αw1+αw2=1(firstlimitcondition)w1n2+w2n2=n(secondlimitcondition)γn1=w1(firstclustersizecondition)γn2=w2(secondclustersizecondition)The first two conditions ensure that Eq. (12) simplifies back to Eq. (11) for equal size clusters, and the second two set the weights inversely proportional to the cluster sizes. These conditions are fulfilled for α=1/2,w1=2n2/n, andw2=2n1/n. This allows clusters to contribute equally even when the cluster sizes are uneven, while simplifying back to the original equation when they are equal, as desired. Substituting these values into Eq. (12), rearranging, and rescaling by 2σ2n/(4cn1n2), the energy to be minimized becomesE(n)=nT12n1∑i=1n1xixiT+12n2∑i=1n2xixiTn+n4n1n2σ2σ02∥n−np∥2which is of the general formEp(n)=nTSn+1σ2∥n−np∥2,s.t.∥n∥=1a weighted covariance matrix and cluster-dependent weighting of the prior term, and assumes at least one point per cluster. Additional conditions for the weights could be used to remove this condition if desired. This optimization problem is closely related to finding a minimum over a boundary in trust-region optimization [9] and can be solved as such. The overall solution alternates between solving this optimization problem and reclustering the data points until convergence.The plane-fitting algorithm described in Section 4 requires a clustering method to partition the set of data points into two classes. k-means[4] is one of the most popular clustering methods. Standard k-means clustering minimizes(13)S=argmin{Sk}∑k∑i∈Sk∥xi−μi∥2over all possible cluster sets Sk. For the case when only two classes are sought, k-means simplifies toE=∑i∈S1∥xi−μ1∥2+∑i∈S2∥xi−μ2∥2whereμk=(∑i∈Sk∥xi−μk∥2)/|Sk|are the cluster centers. Prior information can be added to this two-class case to obtainE=∑i∈S1∥xi−μ1∥2+1σ12∥μ1−μ¯1∥2+∑i∈S2∥xi−μ2∥2+1σ22∥μ2−μ¯2∥2whereσ=σkμ/σkis a user-defined constant andμ¯1andμ¯2are priors for the cluster centers.In the standard k-means algorithm, elements are assigned to a current estimate of the cluster centers. From this new partitioning, new cluster centers are calculated as the means of the current clusters, and this process is iterated until convergence. This optimization is non-convex, and so is not guaranteed to reach a global minimum. When seeking two cluster centers for one-dimensional features, however, k-means simplifies to Otsu thresholding. Otsu thresholding [10] computes the globally optimal separation between two classes by searching the feature histogram for the threshold which minimizes the intra-class variance.A one-dimensional feature suitable for clustering the points in the plane-fitting algorithm is angle in the fitting plane with respect to a reference direction; in this case, the midpoint of the projections of the stain vector priors. Prior stain vector information is used to prevent mis-clustering when the number of data points for one stain direction clearly dominates the other. The actual stain vectors are extreme directions specifying the boundaries of the optical density cone. These directions of pure color are not the norm, as most colors are a mixed combination of these two extremes. For this reason, the stain vectors themselves are not chosen as the priors for clustering. Instead, priors are chosen to be slightly inward from the cone boundaries. Given two stain vectors s1 and s2, the priors are chosen as the angles with respect to the reference direction of the projectionsΠ{qi}=qi−qiTnnonto the current estimate of the fitting plane, where q1=(1−α)s1+αs2 and q2=αs1+(1−α)s2, α∈[0, 0.5) are directions moved slightly inward from the cone boundary. Including this prior information, the minimization problem becomes(14)E(I≤Iθ,μ1,μ2)=1σ12∑i∈j:Ij≤Iθ(Ii−μ1)2+1σ22∑i∈j:Ij>Iθ(Ii−μ2)2+1(σ2μ)2(μ2−μ¯2)2+1(σ1μ)2(μ1−μ¯1)2which is computed for all thresholds Iθ. For a given partitioning, the optimal values for μ1 and μ2 are(15)μi=σi2σi2+(σiμ)2niμ¯i+(σiμ)2niσi1+(σiμ)2niI¯iwhere nirepresents the numbers of points in a cluster andI¯ithe mean angles in the cluster. Note that μ1 and μ2 are not simply the foreground and background means, but a weighted average of the means and priors. Algorithm 1 gives an overview of the plane fitting algorithm with prior.Algorithm 1Algorithmic description of the optimal plane-fit algorithm.Once an image's stain vectors have been computed, it can be restained to better match a target image. As stated in Section 2, the relationship between an image's optical densityOD, its stain vectorsαi, and the amounts of each stain qiis given by the equationOD=αq=α1q1+α2q2Once theαihave been estimated, the concentration of each stain present in each pixel can be solved for. The stain concentrations are given by(16)qi=αi−1ODIn order to restain the image to a different color space, these concentrations must be rescaled to match a desired distribution. This is done by adjusting the concentrations so that their median mqmatches a desired medianmqˆ:qˆ=(mqˆ/mq)q. Given these adjusted saturations and a set of desired stain vectorsαˆ, the restained image is given by(17)Iˆ=e−(α1ˆq1ˆ+α2ˆq2ˆ)In practice, pixels with nearly no stain are thresholded out for stability reasons.

@&#CONCLUSIONS@&#
This paper presented a method to automatically adjust the appearance of stained histology slides. It described a novel way of adding prior information for the stain vectors and how to deal with unequal stain distribution through a clustering process which is a novel adaptation of Otsu thresholding to include prior information. The underlying optimization problem is related to trust-region optimization, and is therefore well studied and easy to solve. Experiments on real and synthetic data show the superior performance of the method developed compared with methods which use no prior information. Results of applying the method to slides which have faded over time show a potentially powerful application of this method. Normalization of histology slides is shown to improve performance of statistical classification of those slides.