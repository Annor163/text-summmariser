@&#MAIN-TITLE@&#
TRUS image segmentation with non-parametric kernel density estimation shape prior

@&#HIGHLIGHTS@&#
An explicit prostate segmentation model utilizing non-parametric shape prior is proposed.The method can model the shape that is not statistically significant in the shape space.The method can escape from local minima by using a fairly large detection range during freely deforming.Compared with recently proposed sparse shape composition method, training data set with a large number of instances is not necessary.The intrinsic properties of TRUS images are integrated into the model.

@&#KEYPHRASES@&#
Transrectal ultrasound image segmentation,Kernel density estimation,Shape prior,Mean shift,Gabor filter,

@&#ABSTRACT@&#
Due to noises, speckles, etc., automatic prostate segmentation is rather challenging, and using only low-level information such as intensity gradient is insufficient and unable to tackle the problem. In this paper, we propose an automatic prostate segmentation method combining intrinsic properties of TRUS images with the high-level shape prior information. First, intrinsic properties of TRUS images, such as the intensity transition near the prostate boundary as well as the speckle induced texture features obtained by Gabor filter banks, are integrated to deform the model to the target contour. These properties make our method insensitive to high gradient regions introduced by noises and speckles. Then, the preliminary segmentation is fine-tuned by the non-parametric shape prior, which is optimally distilled by non-parametric kernel density estimation as it can approximate arbitrary distributions. The refinement is along the direction of mean shift vector, and considerably strengthens the robustness of the method. The performance of our method is validated by experimental results. Compared with the state of the art, the accuracy and robustness of the method is quite promising, and the mean absolute distance is only 1.21±0.85mm.

@&#INTRODUCTION@&#
Prostate cancer is one of the major public health problems, and it is the second leading cause of cancer death among men, only surpassed by lung cancer [1]. Due to real-time realization, low cost and simplicity, transrectal ultrasound (TRUS) is frequently used in prostate therapy, and many modern prostate related clinical applications rely on accurate segmentation of the prostate. For example, prostate volume can be determined from prostate segmentation [2]. Brachytherapy requires segmentation of the prostate boundary from TRUS images pre-operatively to generate the treatment plan [3]. Since 3D TRUS probe is not commonly available in diagnostic centers, the 2D TRUS slice is still helpful especially for biopsy needle placement, whose accuracy can be further improved by fusion of pre-acquired magnetic resonance (MR) slice and 2D TRUS slice containing shape information obtained by segmentation [4].Since manual segmentation is difficult, time consuming and prone to variability, many automatic methods have been proposed, nevertheless, they are considerably challenged by low signal-to-noise ratio (SNR), low intensity contrast, speckles, shadow artifact and heterogeneous intensity distribution inside the prostate, etc. Consequently, high-level knowledge about the prostate is exploited to disambiguate the low-level intensity information and improve the segmentation performance. One kind of the knowledge gaining extensive research is the shape prior of the prostate [5–10]. However, most of the methods are based on the assumption that the training shapes form a Gaussian distribution, while non-Gaussian shape prior used in several medical image segmentation tasks demonstrates superior results [11,12].On the other hand, many studies have been carried out to embed the shape prior into both the explicit active contour model (ACM) [13] and the implicit level sets models [14], using non-Gaussian shape prior [11,15–25]. However, very few of them are specially designed for ultrasound images, and the prostate segmentation procedure cannot favor from the advantages of these methods for the following reasons. First, except the semi-automatic methods requiring user-interaction to initialize the models, most of the methods use some simple shapes, such as the mean shape of the training set, as the initial models. However, the quality of TRUS images is largely corrupted by speckles and the SNR of the images is rather low, which lead to many local minima of the target energy function, and in turn make the precise segmentation of prostates rely on the closeness of initial model and the target contour. Care therefore should be taken to the initialization, and only using some simple shapes as the initial models is insufficient. Second, some other region based segmentation methods following the pioneer work of Chan and Vese [26] claim that the initialization step is not required or the models are not sensitive to the initial contours. However, these region competition methods only use the region properties designed for nature images, no matter the properties are obtained from the training data set [19,25] or not [11,24]. These properties, such as the mean and variance of the pixel intensity values in each region, are not suitably qualified for TRUS images, since TRUS images have their own characteristics. First, homogeneity in both prostate and non-prostate tissues makes the mean values of intensity less discriminative. Second, tremendous speckle noises always lead to a large variance of intensity in both regions. Third, heterogeneous intensity distribution occurs both inside and outside the prostate making the region competition procedure even more difficult to achieve a desired result. An example of these difficulties is shown in Fig. 1.To address the aforementioned problems, in this paper, we propose a novel segmentation framework based on non-parametric kernel density estimation shape prior, which can be incorporated with several intrinsic properties of TRUS images to make our algorithm more suitable for TRUS image segmentation. The method uses explicit segmentation model based on landmark points, instead of implicit level sets model, to reduce the computing complexity. Besides, unlike the methods based on Bayesian inference framework, in which the shape prior constraint is employed as an additional energy term, the proposed model is allowed to deform without shape constraint. After that, a kernel density estimation based procedure using mean shift vector [27], which always climbs towards the direction of maximum increase in the density, is utilized to drive the deformed model to the shape with higher kernel density. This procedure eventually puts the non-parametric shape constraint on the model.The proposed segmentation framework based on the non-parametric shape prior has the following advantages:-The method can model the shape that is not statistically significant in the shape space. During model evolution, mean shift is employed to drive the model to the one satisfying the least shape requirement, say, the predefined minimum kernel density of the shape. However, the shape prior used in many other Bayesian framework based methods (e.g. [11,17]) is inclined to the most possible one. Besides, an additional weight parameter is required to balance the shape prior energy and the image energy, which should be tuned with care.The method can escape from local minima by using a fairly large detection range during freely deforming. Therefore, a universal initial model is sufficient, and no user-interaction is required. Experimental results in Section 4 and Fig. 7demonstrate a superior result of our segmentation framework to the traditional active shape model (ASM) [28] as well as level sets with non-parametric shape prior [11], which is a combination of [7,26] and kernel density estimation.Compared with recently proposed sparse shape composition [12] method, training data set with a large number of instances is not necessary. Sparse shape composition is based on an over complete shape dictionary requiring numerous shapes pre-acquired to train, however, obtaining the shapes manually is a time-consuming and tedious work. Moreover, even if a large number of training shapes are available, the ℓ1-norm constrained minimization problem is quite time-consuming.Since there is no requirement of modeling topological changes in TRUS image segmentation, compared with implicit level sets models, explicit model based on landmark points is still competitive when it comes to computing complexity.Only using a well-designed shape prior as well as low-level image gradient information is insufficient, since the intrinsic difficulties of TRUS images and most of the methods designed for natural images are not suitable. Consequently, several useful techniques based on the intrinsic properties of TRUS images are combined with the proposed shape prior. First, image gradient magnitude is replaced by the intensity transition along the normal of the model as one part of the image energy driving the model to the target contour. Second, speckle induced texture features are extracted by Gabor filter banks [29] acting as another image energy term. Both of these two energy terms are insensitive to noises and speckles. Third, anisotropic diffusion scale-space [30] is utilized to relieve the computing complexity, enlarge detection range and suppress noises and speckles as well as preserve edges.The rest of this paper is organized as follows. We first introduce the proposed non-parametric shape prior in detail in Section 2. Then in Section 3, we detail the two forces driving the model to the target contour, and then summarize the entire framework of our method. In Section 4, the performance of the proposed method is verified by many experiments. Finally, concluding remarks are drawn in Section 5.In this section, we introduce the non-parametric statistical shape model based on the explicit segmentation model. The model is represented by a column vector shown in lowercase bold letter, with coordinates of landmark points as its elements.To build the model, training shapes are delineated by the expert, with three main landmark points having fixed indexes selected from the top, left bottom and right bottom of the contour (Fig. 2(a)). Then, the rest of the landmark points are generated by sampling along the contour (Fig. 2(b)). With this scheme, the landmark points having the same index in different shapes are treated as corresponding to each other. These shapes therefore can be aligned with each other directly.During segmentation, with a model y after suggested movement without shape constraint (discussed in Section 3), shape prior constraint is introduced by the following steps. Firstly, we align it to the mean shapea¯of the aligned training set{ai}i=1,2,…,k, where k is the number of training shapes, we get y′. The shape alignment can be implemented using the least square method proposed in [28], with respect to scaling, translation and rotation.Then the probability density of the model can be non-parametrically estimated using the kernel estimator K as(1)Pr(y′)=1k∑i=1kK(y′−ai),wherey′,ai∈ℝ2nand n is the number of landmark points. If we choose our kernel estimator function, K, to be a Normal function N(0, Σ), where Σ represents the kernel function bandwidth, then the density can be estimated as(2)Pr(y′)=1k∑i=1k1(2π)n|Σ|12e−(1/2)(y′−ai)TΣ−1(y′−ai).In practical terms, when n is large, Σ will be ill conditioned or even singular. Principle component analysis (PCA) can be performed on the matrix a=(a1a2⋯ak)Tto reduce the dimension of the model. With P=(p1p2⋯pd) the matrix of the first d(d<2n) eigenvectors of a, the mean-adjusted and transformed data of a is(3)a′=PT(aT−a¯).Then y′ is transformed to the same space to get(4)y′′=PT(y′−a¯).With the linear dependence of each dimension eliminated, Eq. (2) is reduced to(5)Pr(y′)=Pr(y′′)=1k∑i=1k∏j=1d12πσj2e−(1/2)((yj′′−aij′)2/σj2),where σj(corresponding to the first d eigenvalues of Σ) is the bandwidth of dimension j. The shapey′′is treated as a point in the d-dimensional space and all the places have probability density greater than t span the space of acceptable shape, where t is the global threshold defined as(6)t=αmini1k−1∑j≠iK(ai′−aj′)(α<1).Note that t is based on the minimum kernel density of one shape in the training set with respect to the others, which means that a shape can still be treated as acceptable if there are similar shapes in the training set, even though these shapes are not statistically significant.IfPr(y′′)<t, more efforts should be done to find an acceptable shape. The acceptable shape should be as close toy′′as possible, and also has kernel density Pr>t. Mean shift [27] is a kernel density estimation based procedure and can be utilized here to drivey′′in the d-dimensional space until a desired probability density is achieved. As presented in [27], the mean shift vector mh,G(x) follows(7)mh,G(x)=12h2c∇ˆfh,K(x)fˆh,G(x),where c is a constant, fh,K(x) and fh,G(x) are the density estimator using kernel K and G with bandwidth h, separately. Moreover, the profile of G is the negative derivation of the profile of K. From (7), we can see that the mean shift vector always climbs towards the direction of maximum increase in the density. We utilize this property of mean shift to find the acceptable shape. The sequence used to find the acceptable shape is donated by{yj′′}j=1,2,…, where(8)yj+1′′=yj′′+β∑i=1nyj′′K(yj′′−ai′)∑i=1nK(yj′′−ai′)−yj′′,y1′′=y′′and β(β<1) is a step parameter to slow down the speed of convergence and make sure the acceptable shape achieved is near the boundary of acceptable space. For eachyj′′, the density is calculated with (5), and the procedure stops when criterionPr(yj′′)>tholds.Then the acceptable shape s′ can be obtained by transformingyj′′back to the original space(9)s′=Pyj′′+a¯,wherePr(yj′′)>tandPr(yj−1′′)<t. In the previous procedure, in order to evaluate the density of shape, we have aligned the input shape y with the mean shapea¯, now, we can align s′ with y to restore scale, position and orientation information of the model. We get s as the final model under shape prior constraint.These non-parametric shape prior constraint steps are summarized in Step (II) of Algorithm 1.In this section, we introduce the two forces driving the model to the target contour as well as a summary of the entire segmentation framework in anisotropic diffusion scale-space.Gabor filters [29] are utilized here to extract speckle induced texture features acting as one part of the forces driving the model. Gabor filters can be treated as orientation and scale tunable edge or line detectors, and can extract localized information in the frequency domain with different values of rotation and scaling parameters. The function of the two-dimensional Gabor filter is(10)G(x,y)=exp−x′2+γ2y′22σ2expi2πx′λ+ψ,wherex′=xcosθ+ysinθ,y′=−xsinθ+ycosθ,λ refers to the wavelength of the sinusoidal factor, θ represents the orientation of a Gabor function, ψ is the phase offset, σ measures the standard deviation of the Gaussian envelope and γ is the spatial aspect ratio. An example of Gabor filter is shown in Fig. 3.We adopt Fλ,θto stand for the convolution of Gabor filter Gθ,λwith the TRUS image. Then the feature vector of a landmark pointvin the i-th image of the training set can be represented by(11)ti(v)=(Fi,λ1,θ1(v),…,Fi,λ1,θn(v),Fi,λ2,θ1(v),…,Fi,λ2,θn(v),…,Fi,λm,θn(v))T,where m and n is the total number of frequency and rotation parameters, respectively. The mean value ofti(v)along all the training images is(12)t¯(v)=1k∑i=1kti(v),where k is the number of the training images. The texture information is used as one part of the forces to drive the suggested movement.Since the TRUS images suffer a lot from noises and speckles, which lead to many high intensity gradient regions, the gradient based segmentation methods [13,28,31] are not appropriate for searching for the target contour. However, the intensity value near the prostate boundary has the property of dark-to-light transition from inside to outside. This priori knowledge is pretty useful to eliminate some regions not belong to the prostate contour with high gradient magnitude. In order to utilize this property, we extend the normal vector profile (NVP) [10] here. For a directed vectorf→through landmark pointvon the model, directing from inside of the model to outside and perpendicular to the model contour, the intensity of the points on it can be presented as L=(I(l1), …, I(ln), I(ln+1), …, I(l2n+1))T, where ln+1 is the pointvon the model. The contrast c at lkwith respect to the model is calculated as(13)c(lk)=1jpkT·L,where pkis defined as(14)pk=(0,…,0︸k−1−j,−1,…,−1︸j,0,1,…,1︸j,0,…,0︸2n+1−k−j)T.The number of points used near and far from the model center is the same, say, j. This scheme used to obtain the contrast c for the points along the normal of the model is illustrated in Fig. 4.The texture features defined in (12) combined with the contrast information guides the suggested movement of the model. A landmark pointvon the contour moves alongf→and tries to find the position ldsatisfying(15)ld=argminli(∥t(li)−t¯(v)∥−γc(li)),where ldis the point suggested to move to, t(li) is the texture features of liand γ weights the contrast information.The proposed prostate segmentation method is based on an anisotropic diffusion multi-scale framework [30] and sub-sampling, which can enlarge the detection range of our suggested movement step and relieve the computing complexity. In addition, compared with Gaussian scale-space, anisotropic diffusion can suppress speckles and noises, at the same time, preserve significant edges.For each TRUS image, we first initialize our model with the predefined universal shape (the scaled mean shape of the training set in our implementation) in the coarsest scale. Then, we tentatively deform the model using the directed contrast and texture information based on (15), after that, the non-parametric shape prior is employed to find a model with acceptable shape and also similar to the deformed one. This procedure is done until convergence and then repeated in a finer scale. The result in the finest scale is treated as the final segmentation. The entire segmentation framework is listed in Algorithm 1 as a summary.Algorithm 1TRUS Image Segmentation(I)Initialize the model with the predefined universal initial shape.Do the following steps until convergence(a)Tentatively deform the model based on (15).Use the proposed non-parametric shape prior to refine the model:(i)Align the deformed model to the mean shapea¯.Transform the aligned model to the linear subspace based on (4).Use (8) iteratively to get the acceptable shape.Transform the model back to original space based on (9).Align the model back to the original coordinate system.If we are not processing the TRUS image in the finest scale, then convert to a finer scale, and go to Step (II), else, stop and output the model as the final segmentation result.All the ultrasound images used in the experiments were obtained from a Philips HDI 5000 sonographic imaging system with the same setting, and different images correspond to different patients. The spatial resolution of each image was 576×768 pixels, and the pixel size of the image was 0.138mm×0.138mm. In our experiments, totally 132 TRUS images were segmented by one expert. These images are randomly divided into 2 groups, 47 images in one group for training, while the rest 85 images for validating the algorithm. We repeated the randomly dividing procedure 5 times and each division was trained and validated individually.In the experiments, four anisotropic diffusion scales were employed, and the detection range of suggested movement step based on (15) was 8 pixels in the coarsest scale. Since the image resolution in the coarsest scale is only 72×96 pixels, this detection range is fairly large and can help the model escape from local minima. Different values of the detection range were tested, and we observed better performance with the growing of the range until some unstable segmentations occurred with the range larger than 9. The parameter α controlling the least acceptable shape in (6) was set to 0.2, which is not critical and similar results observed in the range (0.1–0.4). The parameter β=0.2 was the step width parameter in (8), and similar results observed in the range (0.1–0.5). The weight parameter γ in (15) was 4.5.In order to evaluate the efficiency and robustness of our algorithm, distance and area criteria were used by comparing the automatic segmentation result with the segmentation delineated by the expert. For distance-based metric, the mean absolute distance (MAD) error [5] was utilized. For area-based metric, the coverage (Cov) [32] was used, which is defined by the ratio of the surface of intersection area to the union area of manually segmented one SMand automatically segmented one SA:(16)Cov=|SM∩SA||SM∪SA|.Our method was implemented in Matlab, except the anisotropic diffusion step in C++, and was evaluated on a laptop with Intel 2.4GHz processor. The mean processing time during our experiments of the entire technique is about 19s. We are hoping to reduce the time by optimizing the code and implementing it fully in C++ in the future.To demonstrate the performance of the proposed non-parametric shape prior constraint algorithm, we first applied the method to the synthetic data in two-dimensional, which were generated by perturbing the sinusoid in the interval [0, π]. The symbol ‘+’ in Fig. 5indicates the training shapes, which do not form a Gaussian distribution. The pentagram is the mean value of all the training shapes (corresponding to the mean shapea¯) and the elliptic region corresponds to space of acceptable shape using PCA based ASM. The symbol ‘*’ represents example input model. In Fig. 5, two example models are in the space generated by PCA (left top and right bottom ones), however, they are driven to the places with higher kernel density (models with better shapes), indicated by the symbol ‘⊗’. Unlike these two examples, the third example model (left bottom one) is not in the space generated by PCA, and its final shape given by the non-parametric shape prior is still not in the elliptic region, since a different distribution is modeled by the proposed method. However, intuitively, the result given by our method is acceptable.From this experiment, we can see that the proposed shape prior will not force the model to the one with the most possible shape; instead, the refined model with better shape is on the border of the shape space, which is close to the input model and has an acceptable kernel density.To give a more intuitive sense of how the noise shape is refined by the proposed shape prior, another experiment using a real synthetic shape is shown in Fig. 6. With an input contour in the left, which can hardly be identified as a prostate, the proposed shape prior drives the contour towards the one with higher kernel density, and finally produces a shape of prostate.Several comparison experiments were done to the real TRUS images. In total, six methods were evaluated. Besides our method, the rest five comparison methods are based on the state-of-the-art algorithms with different shape prior constraints and driving forces (or target energy functions). Table 1gives a summary of these methods. A universal initial model was employed in all these methods, and most of the parameters used in the experiments were the same with the ones suggested in the original contributions, if any. Besides, the driving force model proposed in Section 3 used in different methods shared the same parameter setting. Some example comparison results can be accessed from Fig. 7, in which the names of different methods are consistent with those in Table 1, and the initial model used for all the methods are shown in column 1. Some more example results to indicate the robustness of our algorithm are shown in Fig. 8, compared with the ‘golden truth’ given by the expert.We take two methods using the same shape prior, Zhang [12] (column 2 of Fig. 7) and Comparison #2 (column 6 of Fig. 7), as the first group of comparison to show the effectiveness of the proposed driving force model. The ACM [13] used in Zhang [12] was implemented by Dynamic Programming [33] with the same detection range (8 pixel in the coarsest scale) as our method. Because of numerous speckles and noises in TRUS images, the contour of prostate is not quite identifiable in terms of image gradient magnitude. Consequently, The ACM was easily trapped by local minima when the initial model was far from the target contour, and then leaded to failure segmentation. However, better segmentation results were obtained by the method Comparison #2 based on the proposed driving force model, which utilizes the intrinsic properties of TRUS images and is insensitive to noises and speckles.The second group of experiments aims at evaluating the region based implicit level sets segmentation methods, Tsai [7] (column 3 of Fig. 7) and Rousson [11] (column 4 of Fig. 7), based on Chan–Vese [26] energy function. Because of the intrinsic difficulties of TRUS image segmentation illustrated previously in Fig. 1, the prostate tissue is not separable using the mean intensity value of each region. Thus region based methods also failed to segment the prostate, no matter using the PCA based shape prior or the non-parametric shape prior. Both of these two methods converged to the place, inside which were the bright pixels, including the brighter part out of prostate contour. While the darker pixels outside the model were mostly introduced by the shadow artifact.To evaluate the favorableness of the proposed non-parametric shape prior, the methods in the third group, say, our method (column 7 of Fig. 7), Comparison #1 (column 5 of Fig. 7) and Comparison #2 (column 6 of Fig. 7), all used the same driving force model. The only difference between them was the shape prior constraint. We can see that our method converged to the target contour and demonstrated superior results, while the rest two methods both faced some segmentation failures. The significant performance improvement compared with PCA based shape prior is due to the superior property of the proposed shape prior to approximate arbitrary distributions. On the other, the performance of sparse shape composition [12] was limited by the number of training samples. In sparse representation, the representation dictionary should be over complete, which means that the number of training shapes should be much larger than the number of landmark points used in each model. However, only limited numbers of TRUS images were acquired in our experiments, and the requirement of a large number of manually delineated TRUS images may be difficult to fulfill. Besides, due to the tremendous dimension of vectorization version of implicit functions (e.g. signed distance function) of level sets method, the sparse shape composition method is prevented from extending to implicit segmentation models.Quantitative evaluation of the proposed segmentation method was done on the 5 random divisions, with the results shown in Table 2. Since the ACM and Chan–Vese energy functions are not appropriate for the TRUS images, Zhang [12], Tsai [7] and Rousson [11] are not included in the table. We can see from Table 2 that our method is quite inspiring, for the mean MAD error of 5 random divisions is only 1.21±0.85mm and Cov reaches 88.65±7.16%. In addition, the performance of our algorithm is considerably increased by 20.39% and 54.51% with the methods Comparison #2 and #1 in terms of MAD, which is consistent with the examples shown in Fig. 7. Both of the comparison methods are not as stable as the proposed method with a large detection range (8 pixels in the coarsest scale) and some unstable segmentation results are observed, which lead to the higher standard deviations of the criteria.

@&#CONCLUSIONS@&#
In this paper, we have proposed a segmentation model utilizing non-parametric kernel density estimation based shape prior and the intrinsic properties of TRUS images to segment prostate. First, the property of dark-to-light transition of intensity near the prostate contour is modeled by the contrast along the normal of the model, making the method insensitive to noises and speckles. Then, the speckle induced texture features are integrated into the method using Gabor filter banks, which provide useful information for segmentation. Finally, the preliminary segmentation result obtained is refined by the proposed non-parametric kernel density estimation method, which can approximate arbitrary distributions and can model prostate shape prior more accurately. The performance of the algorithm is shown by many experimental results. For example, the shape of prostate segmented by our algorithm is very close to the one delineated manually by expert; the mean absolute difference is only 1.21±0.85mm. All the results imply that the algorithm is quite promising.