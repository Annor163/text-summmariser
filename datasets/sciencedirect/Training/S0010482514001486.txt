@&#MAIN-TITLE@&#
New method for geometric calibration and distortion correction of conventional C-arm

@&#HIGHLIGHTS@&#
A new method is proposed to calibrate and correct the image for conventional C-arm.C-arm is calibrated with non-linear model before image distortion correction.An automatic method for marker extraction in C-arm image and matching is realized.The new method can simplify the installment of the calibration phantom onto C-arm.Increasing polynomial order will increase both the precision and time-consumption.

@&#KEYPHRASES@&#
X-ray fluoroscopy,C-arm machine,Distortion correction,Geometric calibration,Two-stage calibration,

@&#ABSTRACT@&#
Image distortion correction and geometric calibration are critical operations for using C-arm DSA (Digital Subtraction Angiography) images to digitally navigate vascular interventional surgery. In traditional ways, C-arm images are corrected with global or local correction methods where a supposed virtual ideal image is needed, and then the corrected images are utilized to calibrate the C-arm with a pin-hole model. In this paper, we propose a new method to calibrate the C-arm with a nonlinear model and to improve navigation performance. We first calibrate the C-arm with a nonlinear model and then the distortion correction is accomplished without virtual ideal image. In this paper, the nonlinear model of C-arm imaging system is addressed at first, and then the C-arm is calibrated with a two-stage method. In the first stage, the C-arm is calibrated with the markers in image center by RAC (radial alignment constraint) method, and in the second stage the calibration parameters are optimized with Levenberg-Marquadt algorithm by minimizing the sum of the square of difference between all markers׳ real distorted positions and their theoretical distorted positions in the phantom image. Based on the calibration result, the image distortion can be corrected. To verify our method, experiments were conducted with a conventional DSA C-arm machine in hospital. The errors in distortion correction and 3D (three-dimensional) reconstruction were quantitatively compared with the global polynomial correction method and visual model method, and the results showed that the proposed method had better performance in distortion correction and 3D reconstruction.

@&#INTRODUCTION@&#
C-arm X-ray machine is widely used for its flexible mobility and perspectives ability to acquire real-time medical X-ray images of the physiological tissue of patient. In C-arm X-ray image based medical robotic system, the C-arm should be calibrated to get 3D information from 2D images [1]. However, images captured by conventional C-arm have inherent geometric distortion [2], mainly including pincushion distortion, sigmoidal distortion and local distortions [3–5]. These distortions should be corrected for accurate navigation.Traditionally, the distortion correction is conducted at first. Then the corrected images are used to calibrate the C-arm with the pinhole model [6]. There are two main types of conventional correction methods: local method [5,7] and global method [8–10]. Soimu et al. [11], designed a method by combining both global and local methods. Yan et al. [2] proposed a method based on moving least squares and polynomial fitting. They also came up with a hybrid method integrating the moving least-squares method and multilevel B-spline approximation approach [12]. For these traditional correction methods, both the distorted and the undistorted image positions of calibration phantom markers are needed. The distorted positions can be extracted from the real images, while their undistorted positions must be acquired by special ways. Most researchers [5,13–15] assumed that the phantom plane was parallel to the imaging plane of C-arm input screen and that distortions at the central region of the C-arm image were very small. The ideal positions of markers were deduced from the markers׳ positions in the central image region. As the image plane of input screen is virtual and invisible, it is hard to guarantee that the plane of phantom is parallel to it. In [22] we compared the installation of phantom between with and without a bubble level. The result showed that directly installing the phantom resulted in larger distortion correction error than installing under help with a bubble level. But the installment of phantom with a bubble level help was complex and took longer time than directly installment. Furthermore, sigmoidal distortion is particularly bigger in the center region of the image than the border area [16]. Gronenschild pointed out that computation of the ideal image from central markers in the distorted image is unreliable [5].Previous studies focused on distortion correction and the distortion correction errors were analyzed generally. Since pin-hole model is linear model, few discussed about the 3D reconstruction or localization error with C-arm. But in fact, the actual imaging procedure of C-arm is nonlinear. This should be considered to improve the localization accuracy with C-arm.In our previous study [17] a visual model (VM) based method was proposed to solve geometric calibration and image distortion correction, in which the C-arm was regarded as a nonlinear CCD(Charge Coupled Device ) camera. In that work, we calibrated the C-arm with two steps. In the first step we just considered the radial distortion and calibrated the C-arm with Tsai׳s RAC method. In the next step, we took into account of the decentering distortion and thin prism distortion, and optimized the calibration using the result in the first step as initial value. After calibration, the C-arm image distortion can be corrected with the calibrated image center and distortion parameters. It worked but the result was not ideal, because the sigmoidal distortion of C-arm is different from the decentering distortion and thin prism distortion of a CCD camera lens.In this paper, we improve the VM method by introducing a revised nonlinear projection model of C-arm. With the improved method, the distortion error is decreased and the localization accuracy is improved. We firstly introduce the nonlinear model based geometric calibration of C-arm and image geometric distortion correction, then compare it with traditional global polynomial (GP) method and VM method in aspect of distortion error and distance reconstruction error. The results show that the proposed method has a better performance than GP and VM. The proposed method is a vital basis of the IGS (Image Guidance System) of RVIR (Remote Vascular Intervention Robot) [18] which has been validated by animal clinic experiment [19].The proposed method differs from previous techniques in three aspects: First, C-arm is calibrated before image distortion correction, which is reversed to the traditional ways, therefore their applied mechanisms are also different. Second, we do not need to suppose the phantom to be parallel to the image plane of the C-arm and to compute the virtual ideal image using positions of phantom markers in central image, which is necessary in traditional studies but whose accuracies are controversial. Third, C-arm calibration is not based on pinhole model but a revised nonlinear model. With this method, we can install the calibration phantom directly and quickly, without need of a bubble level׳s help.In a C-arm imaging system, the X-ray beams transmitted by X-ray tube penetrate through an object, e.g. patient body, project onto the input screen of X-ray detector to form an X-ray image, as shown in Fig. 1. The projection model of an ideal C-arm is pinhole model [6]. If we usex˜to denote the homogeneous coordinate ofx, then a 3D pointP˜=[X,Y,Z,1]Tand its ideal image projection pointp˜=[u,v,1]Thas the following relation:(1)sp˜=MP˜where s is a scalar factor andMis the 3 × 4 projection matrix.However, the real C-arm imaging system exists geometrical distortions, including pincushion, sigmoidal and local distortions. Among them, the local distortion is irregular for different C-arm input screen [13], but it is rather smaller compared with the other two distortions. Therefore it is often neglected [14]. Letpdbe the actual projection position of pointP.pddepends on C-arm distortion and can be described as(2)pd=p+δ,δ=δp+δswhere δ is the total geometrical distortion, including pincushion distortion δpand sigmoidal distortion δs.Pincushion distortion is caused by the curved surface of input screen, which is similar to a CCD camera lens. Previous studies [2,7,13] implied that pincushion distortion could be modeled as that of a CCD. Weng et al.׳s [20] pincushion distortion model is chosen in our technique and can be expressed by the following form:(3){δpx=xu(k1r2+k3r4+k5r6+…)δpy=yu(k2r2+k4r4+k6r6+…),r=xu2+yu2where(xu,yu)is the undistorted position and k1,k2,k3,…are the coefficients of pincushion distortion.We used the first item in each of the above equations to model the pincushion distortion of C-arm. Therefore, k1 and k2 represent the coefficients of pincushion distortion of C-arm.Sigmoidal distortion is introduced by the electron optics between the input and the output phosphor of the input screen and the interaction with external earth׳s magnetic field or other stray magnetic fields around the input screen. It changes considerably in pattern and magnitude when the C-arm position changes.Since for sigmoidal distortion the tangential displacement is different along the radial displacement, we reckon that sigmoidal distortion includes rotation and displacement effect. Therefore we model the sigmoidal distortion by the following function:(4){δsx=(xucosθ−yusinθ)(1+t/r)−xuδsy=(xusinθ+yucosθ)(1+t/r)−yu,r=xu2+yu2where θ and t are the magnitudes of rotational and translational effects respectively (see Figs. 2 and 3).Rotational and translational effects of sigmoidal distortion vary from one position to another. The earth׳s magnetic field is unstable because of different locations and time, meanwhile, the internal electronic beam of C-arm could not be acquired accurately. Therefore, it is difficult to find the accurate relationship between distortion parameters and their positions. In order to minimize the localized effect, we utilized the following n-order polynomial to calculate k1, k2, θ and t separately.(5)ϑ=∑p=0n∑q=0n−papqxupyuqwhere n is polynomial degree, and apqis the polynomial coefficient, and ϑ represents k1, k2, θ and t.C-arm calibration can be performed based on its nonlinear distortion model. The nonlinear optimization is a common solution to this issue. However, the initial parameters have a great influence on the accuracy and optimization speed. Therefore, a good estimation of the initial parameters of the C-arm is important. In the central region of C-arm image, sigmoidal distortion is much smaller than pincushion distortion. Since Tsai׳s Radial Alignment Constraints (RAC) [21] is a good camera calibration method for those versatile cameras which just considers the radial(pincushion) distortion only, it could be utilized to estimate the initial parameters of C-arm. With above consideration, we conducted the C-arm calibration as following steps:At first, a phantom with many markers is used to get the calibration image. The markers are extracted from the phantom image, their coordinates in image and 3D space are worked out and matched. The marker detection and matching algorithm will be described in Section 3.Secondly, the C-arm is calibrated by RAC method with markers in the central image region. In our case, the markers lying within the quarter radius of the image are considered to be central markers. The initial imaging parameters of the C-arm are acquired except the sigmoidal distortion parameters.Thirdly, C-arm parameters (including sigmoidal distortions parameters) are optimized with the markers in the whole image. The optimization object is to minimize the distances between the real markers’ image positions and their theoretical distortion positions:(6)min∑i=1n[(xdi−xdi′)2+(ydi−ydi′)2]where(xd,yd)is the actual distorted coordinate,(xd′,yd′)is the calculated distorted position and the subscript i denotes the ith marker. n is the total marker number in the whole image. The optimization is conducted with Levenberg–Marquardt algorithm. The initial parameters for sigmoidal distortion are 0, and other initial parameters are computed in the second step.C-arm calibration builds the relationship between the images and their coordinates in the world reference frame and determines the distortion parameters. To calibrate the C-arm, markers should be used whose coordinates in world reference frame and in image are known or can be worked out, whose coordinate sequence should also be correspondent. For these purposes, a double-layered aluminium calibration phantom is designed.In our method, a double-layered aluminium calibration phantom is utilized, as shown in Fig. 4. It consists of one mount base, and two removable parallel thin plate. In the lower layer arrays of ϕ 1 holes are spaced with same center interval (2cm), except three holes A, B and C whose diameters are ϕ 2, as shown in Fig. 4(c). These three holes are used to build a coordinate system for later automatic matching between marker׳s world coordinates and their images coordinates. In the upper layer there are just nine ϕ 1 holes which are vertically corresponding to nine holes on the lower layer, as shown in Fig. 4(c). These holes work as markers and their centers work as marker points. Fig. 5(a) shows one X-ray image of the phantom.The reasons that we designed the calibration phantom this way are as following: At first, since non-coplanar phantom could result in better calibration result in RAC calibration, double-layer design is utilized which could provide spatial phantom. Secondly, the markers should be quantitatively enough to get precise calibration, while also should be easily detected and distinguished in the X-ray images of the phantom, therefore many markers are distributed in the lower plate while only nine markers in the upper layer plate. Thirdly, the phantom is made of aluminium because the material is low cost and light.From Fig. 5(a), it can be seen that there are large numbers of markers in the phantom image. Since the phantom should be removed after calibration, and the FOV (field of view) of C-arm varies with doctor׳s adjustment, the markers that enter into the FOV vary in every calibration procedure. Therefore an automatic method should be developed to extract the marker images and match them with their coordinates in the world frame.To automatically extract the markers in X-ray image, the mathematical morphology method is utilized. At first, the phantom X-ray image is filtered with a Wiener filter. Then open operation of mathematical morphology is utilized to acquire the image background. The open operation of mathematical morphology is defined asf○s=(f⊖s)⊕s, where f is the filtered image and s is 3 × 3 structuring element, ⊕ is gray-scale dilation and ⊖ is gray-scale erosion. Thirdly, we subtract the filtered image by the background image to extract the markers׳ image. At last the markers are segmented using threshold technique and their sub-pixel image coordinates are calculated with centroid computation. Here the centroid of the marker is regarded as the image of the center of hole-marker since the cylindrical hole is very small. Fig. 5(b) shows the extracted marker image.In Fig. 5(b), the points a, b and c are the projections of three large holes A, B and C in Fig. 4(b). These three points can be quickly detected from the extracted marker images since they covered the most pixels than other points. These three points can also be easily distinguished because a is nearest to the image center while b is farthest to the image center. There are eight rectangles in Fig. 5(b) and two dots are enclosed within every rectangle. For every these two dots, the dot closer to the image center belongs to the upper layer, while the other one is in the lower layer. This can be inferred from Fig. 5(c), since the upper layer is nearer to the X-ray detector than lower layer, the correspondent markers in the upper layer will be nearer to the image center.For automatic matching, we utilize the three large markers A, B and C in the lower layer of the phantom to build local physical frame on the calibration phantom, and accordingly their image points a, b and c are utilized to build affine coordinates frame in the distorted X-ray image. Since the lower layer of the phantom and the image are both planar, there is homography between them. The homography can be computed by four markers A, B, C and M (M is shown in Fig. 4(c)) and their correspondent image points.Actually the homography is very close to affine translation because the lower layer is nearly parallel to the virtual image plane of X-ray detector, and their distance is far smaller than SID (Source–Intensifier–Distance). Therefore we modify the marker׳s image coordinates to recover the ideal affine translation. Based on their sub-pixel positions, they are rounded to the nearest integer to get their affine coordinates in the above-mentioned affine coordinate frame. For affine transformation, the simple ratio is invariant. From the markers ideal image affine coordinate and equivalent center-to-center space, we can calculate the markers’ space coordinates in the local physical frame, which is shown in Fig. 6.After C-arm calibration, the distortion parameters are acquired. Then the image geometrical distortion can be corrected.Geometric distortion correction of C-arm images can be divided into two steps: spatial transformation and gray-level interpolation. Spatial transformation is the process of finding the position mappings between distorted and corrected (undistorted or ideal) pixels. After calibration, the image center(u0,v0), projection matrix and distortion parameters of C-arm are acquired. The spatial transformation between the ideal pixelp=[u,v]Tand the distorted pixelpd=[ud,vd]Tcan be determined by the following equation:(7){ud=((u−u0)dx+δx)/dx+u0vd=((v−v0)dy+δy)/dy+v0where dxand dyare the physical size of C-arm image pixel along u and v direction respectively,(δx,δy)are the distortions along image axes direction and can be calculated with Eqs. (3)–(5).Then we rectified the distorted image by using back projection algorithm and bilinear interpolation. The projection matrix and distortion parameters vary when the orientation and SID (Source Intensifier Distance) of the C-arm changes. Therefore, these parameters are specific for a particular orientation of C-arm. Fig. 7shows the distorted image and corrected image of a ruler.

@&#CONCLUSIONS@&#
