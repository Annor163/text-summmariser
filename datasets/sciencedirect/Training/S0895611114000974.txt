@&#MAIN-TITLE@&#
Distortion correction and calibration of intra-operative spine X-ray images using a constrained DLT algorithm

@&#HIGHLIGHTS@&#
Automatic method for distortion correction and calibration of intraoperative spine X-ray images.Constrained version of the well-known Direct Linear Transform (DLT) algorithm, reducing its degrees of freedom from 11 to 3.Experimental evaluation to ensure that the method is fast and more accurate than other existing methods.The low segmentation error level also ensures accurate calibration of the c-arm.

@&#KEYPHRASES@&#
Calibration,X-ray,Intra-operative imaging,Direct Linear Transform,

@&#ABSTRACT@&#
This work presents an automatic method for distortion correction and calibration of intra-operative spine X-ray images, a fundamental step for the use of this modality in computer and robotic assisted surgeries. Our method is based on a prototype calibration drum, attached to the c-arm intensifier during the intervention. The projections of its embedded fiducial beads onto the X-ray images are segmented by the proposed method, which uses its calculated centroids to undo the distortion and, afterwards, calibrate the c-arm. For the latter purpose, we propose the use of a constrained version of the well known Direct Linear Transform (DLT) algorithm, reducing its degrees of freedom from 11 to 3. Experimental evaluation of our method is included in this work, showing that it is fast and more accurate than other existing methods. The low segmentation error level also ensures accurate calibration of the c-arm, with an expected error of 4% in the computation of its focal distance.Most modern hospitals have intra-operative fluoroscopic devices – known as ‘c-arms’ – which makes X-ray imaging a natural choice for the implementation of computer and robotic assisted surgeries. These procedures require registration of the pre and intra operative images, which requires an accurate knowledge of the X-ray image formation process’ parameters. This makes c-arm's calibration and distortion correction necessary requisites for which reliable solutions must be developed.It is well accepted that c-arms can be modelled as pinhole cameras, borrowing terms from computer vision [1]. Calibration of this type of cameras consists in the estimation of its intrinsic (i.e. invariant to the c-arm's location) and extrinsic (i.e. variable with the c-arm's location) parameters. Intrinsic parameters are, mainly, the pixel's dimensions and the focal point location, whereas extrinsic parameters correspond to the c-arm's location with respect to a given frame of reference. Unfortunately, most c-arm's do not provide any of these: they normally lack from encoders to measure their angulation (extrinsic parameters) nor provide information about pixel size or focal point. To make matters worse, c-arm's intensifiers are affected by distortion, which is dependent on the curvature of its phosphorous panel and its surrounding electromagnetic field, influenced in turn by nearby metallic objects and the device's orientation [2]. This problem has been solved on more modern c-arms replacing image intensifiers by flat panel detectors with negligible distortion [3]. However, this technology is quite recent and the majority of hospital do not have access to it yet.Most c-arm calibration and distortion correction systems require use of a special device, known as ‘drums’, ‘cages’ or ‘rings’, which are attached to the intensifier before or during the intervention. Calibration drums normally consist of parallel plastic plates with embedded metallic fiducials, which are projected onto the X-ray images and segmented by specialised image processing algorithms. Their detected locations are then used to correct the effects of distortion and estimate the c-arm's parameters. According to Zheng and Zhang, algorithms for these problems can be divided in two groups: off-line and on-line methods. Off-line approaches acquire a set of images with the attached calibration drum before intervention on some predefined positions. Calculation of intrinsic parameters and distortion corrections are performed for each position and saved. Then, the calibration device is removed and operation begins. Off-line approaches are simpler to implement, as no objects are present on the images used for calibration and, therefore, fiducial segmentation is greatly simplified. Their main drawback is that results are only valid for a reduced set of positions, and no others can be used during intervention. On the other hand, on-line approaches perform calibrations for each acquired X-ray image and, therefore, never remove the calibration drum during surgery. On-line approaches are inherently more reliable (they provide results adjusted to each image) and cope better with additional factors that may vary the intrinsic parameters, such as the c-arm's mechanical flexion produced by the intensifier's weight which may displace the focal point between consecutive X-rays [9]. The choice between off-line and on-line approaches also affects the calibration drum's design: off-line methods can use drums with denser fiducial grids, which produce more precise results (but only for a reduced set of positions), whereas on-line methods must use sparser grids, otherwise X-ray images would suffer from excessive occlusion. As we consider that limiting the calibration to a small set of positions is too restrictive, we opted for the flexibility of an on-line approach. This, however, has the trade-off of increased complexity of implementation, which we considered an acceptable price to pay to obtain higher precision and increased safety for the patient and clinical staff.Multiple on-line calibration algorithms have been proposed in the recent years, such as the ones proposed by Foley et al. [4], Tate et al. [5], Livyatan et al. [6], Merloz et al. [7], Sadowsky [8] and Zheng and Zhang [9]. These studies have proposed multiple calibration drum designs, sometimes arranging the fiducial objects on a symmetrical arrangement [4,7,8]. This approach, although valid, has an inconvenience: it impedes detection of image reflection. If the uncalibrated image is reflected – for any reason – an algorithm based on a symmetrical pattern would not detect it, giving a wrongly oriented image as result. In surgery, ensuring correct orientation of images is of critical importance, as a reflected image could lead surgeons to operate on the wrong side of the patient with terrible consequences. Therefore, asymmetrical designs of calibration drums are preferred, an approach followed by Tate et al. [5], Livyatan et al. [6] and Zheng and Zhang [9]. One of the most known on-line algorithms was published by Livyatan et al. in 2002, who proposed a method which performed distortion correction first followed by estimation of the c-arm parameters [6]. The authors used the FluoroTrax calibration drum – previously used by Tate et al. [5] – consisting of two parallel plates with embedded fiducial beads arranged on an asymmetrical pattern. The beads’ projections were segmented from the X-ray using standard image processing techniques and, then, the drum's centre and rotation were calculated and used to generate a ground-truth pattern of the proximal plate fiducials, which differed from the segmented ones due to distortion. The subtraction between both patterns generated a vector field, used to warp the X-ray image and correct the distortion effects [10]. Finally, the corrected beads’ locations were used as input for a calibration algorithm which estimated the c-arm's intrisic and extrinsic parameters [11,12].A different approach was presented by Zheng and Zhang in 2009, who also used a 2-plate drum, but with a less dense bead pattern [9]. After segmentation of the fiducials – using a more sophisticated template matching algorithm – their method performed the correction and calibration steps in the opposite order: it first calibrated the c-arm using information taken from the central portion of the image and then generated a vector field used to undistort the X-ray. Zheng and Zhang used the Direct Linear Transform (DLT) algorithm for the c-arm calibration step, which is well known and widely used by computer vision researchers [1].Currently, image-guided spinal surgery applications struggle to obtain sub-millimetre precision, which is a clinically relevant goal. Required error levels for the safe prevention of nerve damage and bone fracture fall well below the sub-millimetrical level in many spinal sections, particularly in some vertabrae of the thoracic and cervical levels [13]. Attainment of this goal requires high levels of precision in all elements comprising the surgical application's chain. Calibration and registration are critical parts of it, as errors introduced in these fundamental processes will be propagated into the following stages in which correction becomes increasingly difficult. In addition, surgical application are expected to be fast enough to produce results in a few seconds, otherwise their use in the operating room becomes impractical. To attain these goals, we propose a new calibration method which combines the strengths of previously published methods, aiming to produce an algorithm which is simultaneously fast and accurate.As we have said, we present a new method for the problem of distortion correction and calibration. In the following subsections we describe our approach.We built a custom calibration drum – shown in Figs. 1 and 2– based on the design proposed by Zheng and Zhang [9], which has two parallel plastic plates with embedded fiducial beads of two different diameters, arranged on a not too dense pattern. The proximal plate has beads of 3mm arranged on a cartesian grid with a separation of 20mm, which are projected on each acquired X-ray image. In the latter, the small beads will not appear arranged exactly as in the cartesian grid, due to the distortion effects. However, as the grid's shape is known in advance, its undistorted positions can be inferred and used to warp the image undoing the effects of distortion. In addition to the small beads, the calibration drum has an asymmetrical pattern of seven 5mm beads, three of them placed on the proximal plate D1, D2 and D3) and four on the distal plate (D4, D5, D6 and D7) on the coordinates given in Table 1. The large beads’ configuration was chosen to ensure that no symmetries were present in both axes, permitting the unambiguous determination of the drum's pose undoing the effects of displacements, rotations and reflections. In addition, it was intentionally placed close to the image intensifier's centre, as this area of the images is less affected by distortion and, therefore, permits a more accurate determination of the drum's pose.A specialised image processing algorithm, described in Fig. 3, is executed to segment the projected beads on each acquired X-ray image. This algorithm first searches for the large beads by applying a median filter to the image and subtracting the result to the original one. This gives a difference image which has pixel values close to zero everywhere except on the beads’ locations, which have large negative values. The difference image is binarised using a threshold and a connected component analysis is performed to identify all objects in it. This binary image contains both beads and other spurious objects, so a morphological opening followed by three additional filtering operations are performed to discard objects which are too small, too large or not round enough to be considered beads. This gives as a binary image as result which only contains the large beads. Finally, each bead centroid is calculated with sub-pixel accuracy using the following formulae(1)xP=∑x∈ΩxF(x)∑x∈ΩF(x)(2)F(x)=I(x)−TifI(x)≤T0ifI(x)>TIn Eq. (1) Ω is a small neighbourhood around the detected bead,I(x)is the original image's value for pixel x andTis the Otsu's threshold calculated in the Ω neighbourhood of the original image [14].In the morphological operations, roundness R is defined as R=Π(r)/p, where p is the perimeter of the segmented figure, r is the radius of a disc with area equal to the one enclosed by segmented figure and Π(r) is the perimeter of a disc of radius r. Values of R are defined from 0 to 1, with 1 corresponding to a perfect circle.In all experiments described in this document, segmentation of the large beads was performed using a median filter with radius of 9pix and a threshold of the subtracted image equal to −10. Morphological operations were performed using a circular kernel with a radius of 4pix. Minimum and maximum areas were defined between 90 and 200pix, whereas the minimum roundness threshold was set at 0.95. Segmentation of the small beads was performed using the same pipeline with a different set of parameters: the median filter radius of 6pix and the subtracted image's threshold of −10. Morphological filtering was carried out using a kernel with a radius of 4pix and admitted areas where defined between 30 and 70pix. Roundness cutoff value was kept at 0.95. All these values were chosen emprirically. In addition, a 4th order polynomial interpolation was appended to locate the small beads missing due to occlusions.The seven large beads are identified using a set of geometrical rules similar to the ones proposed by Zheng and Zhang, determining which belong to the distal plate and which to the proximal one [9]. These are listed in Table 2.As the distance between the proximal plate and the c-arm's intensifier is negligible in comparison with the focal distance, we can assume that the proximal plate's beads are directly overlayed on the image and, thus, no perspective effects are present. In fact, the separation between beads and the image intensifier is 5mm and c-arms’ focal distances are, normally, around 1000mm. Assuming this, we can describe the transform to the proximal plate's beads from their projections as an affine transform composed of a scaling followed by a rotation and then an offsetting. Mathematically, this can be expressed as follows(3)cφ−sφsφcφ100−1︸RotationΔx00Δy︸ScalingxPiyPi+xD0yD0︸Offset=xDiyDiIn Eq. (3) terms Δxand Δyare the c-arm's detector pixel sizes in mm. Terms cφ and sφ are the cosine and sine of angle φ, which measures the relative rotation between the calibration drum and the image intensifier. TermsxD0andyD0are the coordinates – in mm – of the image corner with respect to the drum's (D) coordinate system. The subscript P denotes the X-ray image's coordinate system. Multiplication of the matrices of Eq. (3) followed by a rearrangement of its terms, leaving Δx, Δy, φ,xD0andyD0as variables leads to the following linear system(4)xPi00yPi100xPi−yPi001ΔxcφΔxsφΔycφΔysφxD0yD0=xDiyDiStacking the equation system above for the three proximal beads yields the following system of 6 variables and 6 equations, which can be solved using any suitable algorithm.(5)xP100yP1100xP1−yP1001xP200yP2100xP2−yP2001xP300yP3100xP3−yP3001ΔxcϕΔxsϕΔycϕΔysϕxD0yD0=3010−1030−30−10The solution of Eq. (5) is used to generate the distortion-free pattern of the small beads, which is subtracted from the segmented beads locations generating a vector field. The latter is used in conjunction with a thin-plate spline interpolation algorithm to warp the image undoing the effects of distortion [15], as shown in Fig. 4.The vector field is also used to update the large beads’ centroids, aiming to improve the following calibration calculations. For the latter, we adhere to the convention that c-arms can be modelled as linear projective cameras [1]. These are fully described by a projection matrix P of the form(6)P=KRI|−CIn Eq. (6) matrix K represents the intrinsic parameters whereas the extrinsic parameters are described by matrix R and point C. Following the convention of this thesis, extrinsic parameters correspond to the relative displacement and rotation between the calibration drum and the image plane or, in other words, between the coordinate systems D and P.Matrix K, containing the c-arm's intrinsic parameters, has the following form(7)K=−f/Δx0xPC0−f/ΔyyPC001Parameters f/Δxand f/Δyare the focal distances measured in pixels with f being the focal distance in mm whereas Δxand Δyare the already calculated pixel sizes. ParametersxPCandyPCare the coordinates, in pixels, of the principal point, that is, the intersection of the normal ray that goes from the imaging plane to the focal point. It has been assumed that skewing is null (i.e. pixels are rectangular and K's top element of its second column is zero). As pixel sizes are fixed, this model for K has only 3 degrees of freedom, which correspond toxPC,yPCand f.As said previously, matrix R represents the rotation between the drum and the c-arm's intensifier, which correspond to the already calculated φ angle. Assuming that no rotation around x and y are present, R can be expressed as followsR=cφ−sφ0sφcφ00011000−1000−1=cφsφ0sφ−cφ000−1Point C corresponds to the focal point position with respect to the drum's (D) frame of reference. As the drum and the intensifier – and thus the image plane – form a rigid body, it is sufficient to know the principal point and focal distance to obtain C, using the solution of Eq. 5.(8)C1=cφsφ0xD0sφ−cφ0yD000−100001︸TPDΔxxPCΔyyPCf1Please note that the 4-by-4 right-side matrix of Eq. 8 corresponds to transformTPD, which takes points from the image's frame to the drum's coordinates. This transform will be used again in Section 4.4.To estimate P we used a customised version of the widely used DLT algorithm, which obtains the optimal projection matrix between a set of points and their corresponding projections [1]. However, the standard DLT algorithm has 11 degrees of freedom, so its use is not appropriate for the model described by Eqs. (6)–(8), which has only 3. Therefore, a constrained version of the DLT algorithm was used, which iteratively minimises the distance between the segmented points and the projected ones using an estimation of matrix P parametrised byxPC,yPCand f.(9)P˙=argmin(xPC,yPC,f)∑i=17|xPi−P(xPC,yPC,f)xDi|2Still, the standard algebraic DLT is used to obtain the starting values ofxPC,yPCand f before minimisation of Equation 9. Resolution of the latter completes the calibration step.

@&#INTRODUCTION@&#


@&#CONCLUSIONS@&#
