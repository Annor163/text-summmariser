@&#MAIN-TITLE@&#
Hybrid approaches for multiple-species stochastic reaction–diffusion models

@&#HIGHLIGHTS@&#
A novel hybrid stochastic/deterministic reaction–diffusion simulation method is given.Can massively speed up stochastic simulations while preserving stochastic effects.Can handle multiple reacting species.Can handle moving boundaries.

@&#KEYPHRASES@&#
Reaction–diffusion system,Stochastic model,Hybrid model,Fisher–Kolmogorov equation,Lotka–Volterra equation,

@&#ABSTRACT@&#
Reaction–diffusion models are used to describe systems in fields as diverse as physics, chemistry, ecology and biology. The fundamental quantities in such models are individual entities such as atoms and molecules, bacteria, cells or animals, which move and/or react in a stochastic manner. If the number of entities is large, accounting for each individual is inefficient, and often partial differential equation (PDE) models are used in which the stochastic behaviour of individuals is replaced by a description of the averaged, or mean behaviour of the system. In some situations the number of individuals is large in certain regions and small in others. In such cases, a stochastic model may be inefficient in one region, and a PDE model inaccurate in another. To overcome this problem, we develop a scheme which couples a stochastic reaction–diffusion system in one part of the domain with its mean field analogue, i.e. a discretised PDE model, in the other part of the domain. The interface in between the two domains occupies exactly one lattice site and is chosen such that the mean field description is still accurate there. In this way errors due to the flux between the domains are small. Our scheme can account for multiple dynamic interfaces separating multiple stochastic and deterministic domains, and the coupling between the domains conserves the total number of particles. The method preserves stochastic features such as extinction not observable in the mean field description, and is significantly faster to simulate on a computer than the pure stochastic model.

@&#INTRODUCTION@&#
Random effects due to finite numbers of components are ubiquitous in reaction–diffusion systems. Within this context, much research has been done, for instance, on the robustness and response to noise in gene regulatory networks. The study of such systems, as well as other examples such as chemical pattern-forming reaction–diffusion systems, has also revealed that an accurate description of their dynamics may require inclusion of the effects of spatially-inhomogeneous distributions of molecules. The usual framework to analyse such situations is that of stochastic reaction–diffusion models.A popular approach for studying stochastic reaction–diffusion models involves decomposing the domain occupied by the system into small compartments or voxels, and counting the number of molecules of each species in each voxel [33,3]. Chemical reactions between species are treated locally (i.e. within each voxel), their rates being determined by the local abundance of each constituent species. Molecular transport between compartments is usually modelled by simple diffusion.This compartmental approach poses a problem: numerical (Monte Carlo) techniques such as the Gillespie stochastic simulation algorithm (SSA) [18,19] or the τ-leap method [20,8] are inefficient since they scale poorly with the number of reaction channels, which is proportional to the number of compartments.In order to overcome issues regarding the efficiency of direct simulation methods, several strategies have been proposed. For example, the Next Reaction Method (NRM) proposed by Gibson and Bruck [17] is an exact method in the same sense as the SSA, i.e. the sample paths generated are exact realisations of the solution of the corresponding Master Equation. However, unlike the SSA, the computing time grows logarithmically with the number of reaction channels. This is accomplished by (i) recycling the random numbers generated in previous time steps, so at each time step only one new random number must be generated, and (ii) organising the reaction channels in a queue (more specifically, a tree) with events ordered in ascending order of waiting time. In this way, it is possible to determine which channel will fire next, and when it will fire, by looking at the root of the tree. The Next Sub-Volume Method (NSVM) is a modification of the NRM which accounts for reaction–diffusion systems [10]. It deals with the stiffness problem arising from the fact that the transition rates associated with diffusion are proportional toh−2, where h is the compartment length.An alternative set of methods are hybrid methods. Often a stochastic description is only needed in a certain region of the domain. Elsewhere the number of components is sufficiently large for a mean-field description to be reasonable. A paradigmatic example of this situation is front propagation in reaction–diffusion systems [4,6,5]. In systems such as the stochastic Fisher–Kolmogorov model, the number of particles ahead of the front is small and, therefore, fluctuations need to be taken into account. By contrast, behind the front, the number of particles fluctuates about the carrying capacity of the model. In these conditions, simulating the system using the compartmental approach and a direct (Gillespie) simulation method is inefficient and it is natural to propose a hybrid approach where the region behind the front is modelled as a Fisher–Kolmogorov PDE, the region ahead of the front is treated as a stochastic process, and appropriate matching conditions are applied in the intermediate region.This idea, and variations thereupon, have been implemented for several different methods and several systems. Its first incarnations consisted of hybrid models for pure diffusion [12,14,15]. In [15] uni-molecular chemical reactions such as chemoabsorption are also considered. In all these methods the boundary or overlapping region between the two regimes is considered fixed.A further step forward towards algorithms that can cope with more complex situations has recently been proposed by Hellander et al. [21]. Based on previous work on a method to simulate stochastic reaction–diffusion systems on unstructured domains [11], they have proposed a method where, at each voxel, the different species are divided into two classes, namely, mesoscopic (i.e. well-mixed within the voxel and with dynamics determined by the corresponding Master Equation) and microscopic. Concerning the latter, they are assumed to be subject to off-lattice reaction–diffusion dynamics, modelled in terms of the Green's function method for the corresponding Smoluchowski equation proposed by Van Zon and ten Wolde [37,36]. The coupling between mesoscopic and microscopic degrees of freedom within each voxel is accomplished via a splitting scheme. Similar hybrid algorithms are discussed in [1,2,27,28,13,30,31,23,38].Moro [5] proposed a similar method for simulating stochastic reaction–diffusion systems with propagating fronts in which a macroscopic PDE is coupled with a mesoscopic Master Equation. The two descriptions hold in different sub-domains and are coupled across a moving boundary, using a method which balances the fluxes between the sub-domains on average only.The hybrid algorithm presented in this paper also couples a mesoscopic description of a stochastic reaction–diffusion system, modelled by an on-lattice, reaction–diffusion Master Equation (RDME), with a reaction–diffusion system, which is obtained from the mean field equations associated with the stochastic model. We remark that whilst our mean-field reaction–diffusion system converges to a reaction–diffusion PDE in the continuum limit, the RDME does not converge to the associated off-lattice (Doi or Schmolokowski) reaction–diffusion models [24,22] in spatial dimensions larger than 2. In light of this, our method should be viewed as the hybridisation of the RDME with its associated on-lattice, mean-field reaction–diffusion limit.Our method extends the work of [5] to systems without propagating fronts. Furthermore, the interface condition used here preserves the total amount of particles at all times in every single simulation. The interface is also chosen such that the mean field description is still valid at the interface region, and each interface is only one compartment in size. In this way, errors in the flux between the two domains are negligible. We allow multiple interfaces so the stochastic and deterministic regions need not be connected, and interfaces may be dynamic in space and time. For multi-species models, different species may exist in different stochastic and deterministic sub-domains. We test our algorithm on two classical systems, the Fisher–Kolmogorov equation and a spatial Lotka–Volterra system. The former serves as the simplest example of a system with a propagating front, and in our hybrid model a single interface separates the stochastic region at the wave front from the deterministic region behind the wave front. The spatially resolved Lotka–Volterra system serves as a test case for a multi-species reaction–diffusion system, where the hybrid model can, in general, have multiple species-specific interfaces.The paper is organised as follows: In Section 2 we introduce notations and conventions for stochastic and deterministic reaction–diffusion systems. The methodology for a generic hybrid model with an arbitrary number of species is presented in Section 3 and our algorithm is applied to the Fisher–Kolmogorov equation in Section 4. Finally, the spatially resolved Lotka–Volterra model is investigated in Section 5.We consider a system ofsmaxspecies defined on a regular lattice. Each species comprises individuals that can migrate to neighbouring lattice sites, or react locally with entities of the same or other species. For simplicity, we describe the system in one spatial dimension, where the lattice index isk=1,…,kmax, but the generalisation to higher dimensions is straightforward. We letNs(k,t),s=1,…,smaxdenote the number of individuals of species s in box k at time t, and let h denote the lattice constant, so thatL=hkmaxis the domain size. IfNs(k,t)is Markovian, then the time evolution ofNs(k,t)is governed by a master equation of the form(1)dP(N,t)dt=∑N˜(TN|N˜P(N˜,t)−TN˜|NP(N,t)).Here, N denotes a generic state specified by the number of individualsNs(k,t)of all species s in any compartment k, and likewiseN˜, so the sum is understood to be over all states defined byN˜. The probability that the system is in state N at time t is denotedP(N,t)and the transition rate for a change from state N to stateN˜isTN˜|N. In what follows, we suppress the time dependence ofNs(k,t)whenever it is clear thatNs(k)depends on the current time t. We will consider two types of transition ratesTN˜|N, one describing a random walk and the second local reactions:(2)TNs(k)−1,Ns(l)+1|Ns(k),Ns(l)=Dsh2Ns(k),l=k±1TN1(k)+ρ1,r,…,Nsmax(k)+ρsmax,r|N1(k),…,Nsmax(k)=Rr(N1(k),…,Nsmax(k)).In (2),k=2,…,kmax−1, whereas the specification of the transition rates in the boundary boxesk=1,kmaxdepends on the boundary conditions. Furthermore,r=1,…,Mdenotes the index of a particular reaction, andρs,rspecifies how reaction r changes the number of individuals of species s. Thus, a step in the random walk changes the spatial distribution of a particular species, whereas reactions act locally in a particular box k.We define shift operators(3)Ek,s±f(Ns(k),…):=f(Ns(k)±1,…),where the dots indicate that the function can depend onNs′(k′)fors′≠s,k′≠k, but operatorEk,s±affects onlyNs(k). Substituting (2) in (1), we can write the master equation as(4)dPdt=∑i,j=i±1(Ei,s+Ej,s−−1)TNs(i)−1,Ns(j)+1|Ns(i),Ns(j)P+∑i,r(∏sEi,s−ρs,r−1)TN1(i)+ρ1,r,…,Nsmax(i)+ρsmax,r|N1(i),…,Nsmax(i)P.The mean quantitiesNs(k)‾=∑Ns(k)Ns(k)P(N)evolve in time according(5)dNs(k)‾dt=∑i,j∈i±1Ns(k)(Ei,s+Ej,s−−1)TNs(i)−1,Ns(j)+1|Ns(i),Ns(j)P+∑i,rNs(k)(∏sEi,s−ρs,r−1)TN1(i)+ρ1,r,…,Nsmax(i)+ρsmax,r|N1(i),…,Nsmax(i)P=Dsh2(Ns(k+1)‾+Ns(k−1)‾−2Ns(k)‾)+∑rρs,rRr(N1(k),…,Nsmax(k))‾,k=2,…,kmax−1.The equations fork=1,kmaxdepend on the boundary conditions. If the reaction terms are non-linear, then these equations are not closed but depend on higher moments ofNs(k). However, if the number of particles of each species is large,Ns(k)∝Ω, whereΩ≫1, we can perform a system size expansion in inverse powers of Ω [35]. The leading order term in the expansion closes the time evolution equations for the means so that(6)dNs(k)‾dt=Dsh2(Ns(k+1)‾+Ns(k−1)‾−2Ns(k)‾)+Rs˜(N1(k)‾,…,Nsmax(k)‾),k=2,…,kmax−1.By expanding∑rρs,rRr(N1(k),…,Nsmax(k))‾to lowest order in1Ω, we obtain the total reaction rateRs˜for species s. In the limith→0we can obtain from (6) continuum reaction–diffusion equations for the particle densitiesns(x,t):(7)∂ns(x,t)∂t=Ds∇2ns(x,t)+rs(n1,…,nsmax).In (7) we have abused notation, identifiedns(x,t)≡ns(k,t)=Ns(k,t)‾hforkh−h2<x≤kh+h2, and introduced a local reaction termrs, which is obtained fromRs˜by(8)Rs˜(N1(k)‾,…,Nsmax(k)‾)=hrs(N1‾(k)h,…,Nsmax‾(k)h).Note that in higher spatial dimensions (d≥2), the h in the denominator needs to be replaced by1hd. Furthermore, we note that to solve (7) numerically, we must discretise the PDE, potentially with a different discretisation than that used for the stochastic compartment model. This might be desirable as for a PDE, typically we want the lattice to be as small as computationally reasonable to avoid discretisation errors; by contrast for the stochastic model we must be careful when simulating non-linear reactions if the lattice becomes similar in size to the reaction radii. Hence, if we do not alter the compartmental model, we cannot decrease the compartment size arbitrarily, see also the discussion in [24]. For the remainder of this paper we use the mean field equation (6), and do not consider the continuum limit (7) any further. We emphasise whether a variable is part of the deterministic or stochastic regime by using capital lettersNkfor stochastic variables, and lower case lettersnkfor deterministic variables, so (6) is rewritten in terms of thenkas(9)dns(k)‾dt=Dsh2(ns(k+1)‾+ns(k−1)‾−2ns(k)‾)+rs(n1(k)‾,…,nsmax(k)‾),k=2,…,kmax−1.We solve the stochastic model using the Gillespie algorithm [18,19], exploiting the fact that the time to the next event is distributed exponentially. Hence, ifakdenotes one of the non-zero transition rates of the model, andr1is a random number uniformly distributed in[0,1], then(10)τ=−1∑kaklog⁡(r1)gives the time to the next event. Furthermore, ifr2is a second, independent random number uniformly distributed in[0,1], we can calculate which event l happens by imposing the condition(11)∑k=1l−1ak∑kak<r2<∑k=1lak∑kak.The advantage of using the Gillespie algorithm is that it simulates exactly the defined Markov process. The hybrid methods discussed in this paper do not depend on the details of how the stochastic process is simulated, and faster algorithms such as the τ leaping algorithm [20,8] can also be used. Since these algorithms are not exact, in this paper we prefer to keep the stochastic simulation as detailed and accurate as possible and use the original Gillespie algorithm, and improve computational performance by switching to a mean field description when appropriate.Our algorithm involves decomposing the spatial domain into two regions for each species. In one region the species of interest is modelled in a stochastic way; in the other the mean-field limit is used. In regions where one species is modelled stochastically and the other deterministically, all interaction terms involving the two species are modelled stochastically. The interface condition describes how the two domains are coupled together, and how the interface moves. The following steps are performed by the hybrid model repeatedly:Hybrid algorithm1.Generate time to next stochastic event via equation (10)Simulate which stochastic event happens via condition (11)Iterate finite difference scheme to new time via equation (9)Calculate interface conditionReturn to Step 1 until specified end timeFor notational simplicity, in the main part of this section, we focus on a one-species system with a single interface. We explain in Appendix A how this algorithm can be modified to account for multiple species and multiple dynamic interfaces.Let[0,L]be our modelling domain, discretised as before intokmaxcompartments of size h such thatk=1,…,kI−1is the mean field domain,k=kI+1,…,kmaxis the stochastic domain, andk=kIlabels the interface compartment. We use equation (9) to solve for the variablesns(1),…,ns(kI−1)in the deterministic regime, whereas the evolution of the stochastic variablesNs(kI+1),…,Ns(kmax)is determined by simulations of the master equation (1) with transition rates (2). The equations used to determine the variables atkIwill be discussed below.We now explain how the stochastic and deterministic regimes are coupled at the interface. We identify at all times(12)ns(kI)=Ns(kI)h,to emphasise that the interface compartment will exhibit both deterministic and stochastic behaviour. Three processes contribute to changes in particle numbers in compartmentkI: fluxes into and from compartment(kI−1), which is part of the mean field domain, fluxes into and from compartment(kI+1), which is part of the stochastic domain, and local reactions (see Fig. 1). Hence, we model the flux between compartmentskIand(kI−1)deterministically, and the flux between compartmentskIand(kI+1)in a stochastic manner. If τ denotes the current Gillespie time step, we calculate(13)ns(kI,t+τ)=ns(kI,t)+τDsh2(ns(kI,t)−ns(kI−1,t)).The flux between boxeskIand(kI+1)is accounted for by the transition rates(14)TNs(kI)−1,Ns(kI+1)+1|N(kI),N(kI+1)=Dh2Ns(kI),TNs(kI)+1,Ns(kI+1)−1|Ns(kI),Ns(kI+1)=Dh2Ns(kI+1).We also have(15)TNs(kI)±1,Ns(kI−1)∓1|Ns(kI),Ns(kI−1)=0,as the corresponding flux is already accounted for by equation (13). Finally, we specify the local reactions in a stochastic way via transition rates(16)TN1(kI)+ρ1,r,…,Nsmax(kI)+ρsmax,r|N1(kI),…,Nsmax(kI)=Rr(N1(kI),…,Nsmax(kI)).In Appendix A.3 we discuss an alternative formulation for which local reactions are calculated in the mean field framework.We remark that due to the interfacial coupling, the mean field solution acquires some stochasticity. Indeed, formally, (13) appears to correspond to a Neumann-like boundary condition at the interface. However, sincens(kI)is subject to both stochastic reactions and a stochastic flux into the stochastic domain, the interface condition appears as a stochastic source for the mean field model at the interface.The mean behaviour of the full hybrid model is obtained by solving the mean field equations in the whole domain. By construction, these are obtained from the mean of the stochastic model. We now have to convince ourselves that the mean behaviour at the interface gives the mean field limit of the full stochastic model. Note that (13) appears to diverge in the limith→0. This is because the deterministic contribution due to diffusion includes only the flux between the interface and the deterministic domain. To obtain the full discrete Laplacian, we must add the mean flux to the right-hand side. This is easily obtained if we calculate the mean field limit associated with the transition rates (14), givingDsh2(ns(kI+1,t)−ns(kI,t)), and this contribution is simply added to (13).Conventionally, the state of the stochastic model is defined by the numbers of individualsNs(k)in each compartment k, and these are non-negative integers, whereas the densitiesns(k)are real-valued. At the interface the flux into and from the mean field domain is given by equation (13) which altersns(kI), and thusNs(kI), by a real-valued number. However, local reactions, as well as the flux into and from the stochastic domain, are described by transition rates (14) and (16), which effect integer changes inNs(kI). Consequently, it is not a priori clear whether the stochastic components of the reactions and fluxes at the interface are well defined. First, we note that, by definition, the interface is such that the particle number there is sufficiently large,Ns(kI)≫1, so that the mean field description is accurate, and hence agrees closely with the corresponding stochastic model (which has integer-valued particle numbers). Adding a real part between zero and one to a large integer number will not significantly alter the transition rates, so the stochastic model with real-valuedNs(kI)will agree closely with both the stochastic model with integer-valuedNs(kI)and the mean field model. Formally, the state space of the stochastic model at the interface is thus still in one-to-one correspondence with the integers, which are shifted by the fractional part ofNs(k). Hence, the stochastic part of the hybrid model is well-defined. There is still a numerical mismatch between the results obtained from a Gillespie algorithm with fractional or with integer-valued numbers, but as long asNs(kI)≫1, we found this mismatch to be negligible.The condition used to locate the interface is not dictated by a rigorous mathematical requirement: it represents a compromise between performance and accuracy. We view the mean field equations as an approximation to the stochastic model that neglects fluctuations. Hence, the larger the mean field domain, the fewer stochastic fluctuations are taken into account. However, we then typically increase the performance of the simulation.We determine whether a compartment belongs to the stochastic or mean field domain by comparing the number of particles in that compartment with a threshold number,Θs, such that ifNs(k)<Θs, then box k is part of the stochastic domain, and otherwise part of the mean field domain.11If this condition splits the whole modelling domain such that the stochastic domain consists of multiple, disconnected components we either need to introduce multiple interfaces, see Appendix A.4, or connect the disconnected components.This is justified since fluctuations typically scale with the square root of the number of particles in a box,Ns(k). As the number of individuals may change in time, the position of the interface may also evolve in space and time.We also implement a minimum domain size condition as a simple check that no connected component of the mean field domain is allowed to become too small. Imagine, for instance, that the mean field domain is enclosed by two disconnected components of the stochastic domain. If the mean field domain comprises only a few compartments in the discretisation, it might be computationally more efficient to remove the mean field domain and absorb it into the stochastic domain, as then we do not have to calculate the interface condition. In the simulations performed in this paper a minimum domain size of 5 compartments for the mean field model was used. In higher dimensions, we anticipate that a cube with a length of 5 compartments would work well. We stress, however, that the choice of threshold conditions is model specific, and hence the minimal domain size requirement should be chosen on a case-by-case basis.After the position of the interface is updated, we must check that all particle numbers in the stochastic domain are integer values, paying particular attention to compartments that were previously part of the mean field domain. By mass conservation, this will result in a renormalisation of the density functions in the mean field domain: this procedure is discussed in Section 3.3.The following steps are used to adjust the position of the interface:1.Calculate threshold condition to locate interfaceCalculate minimum domain size conditionRenormalise particles and densitiesWhen the interface moves such that a compartment previously treated deterministically and, hence, described by real-valued densitiesns(k), enters the stochastic domain, we need to ensure that the number of particles becomes integer-valued. By mass conservation, we cannot simply remove the fractional part ofNs(k)=hns(k): instead we rescale the densities outside the stochastic domain.Let us focus on a single box k (and assume that the single interface has moved by only one compartment, so thatNs(k)is now non-integer-valued but part of the stochastic domain). We interpret the fractional part(17)ps=Ns(k)mod(1),as the probability that an additional particle is in this box. We draw a uniform random numberr∈[0,1]. Ifr<psthen we place the particle in box k; otherwise it is placed in the deterministic domain. To preserve particle numbers, we renormalise the density function in the deterministic regime and resetNs(k)so that ifr<psthen(18)Ns(k)→Ns(k)+(1−ps),ns(l)→(1−(1−ps)∑m=1k−1ns(m)h)ns(l),l=1,…,k−1,and otherwise(19)Ns(k)→Ns(k)−ps,ns(l)→(1+ps∑m=1k−1ns(m)h)ns(l),l=1,…,k−1.A similar rescaling procedure was used in [15], where a reaction–diffusion PDE was coupled with a Brownian dynamics model. There, it was found that particles crossing the interface twice can cause increased variance. Our algorithm does not lead to an observable increase in variance as, by construction, the interface is chosen so that the mean field and interface domain always contain a large number of particles.In this section, we apply our algorithm to the Fisher–Kolmogorov equation,(20)∂n∂t=D∂2n∂x2+λn(1−nΩ)Here, D is the diffusion coefficient, λ is the growth rate and Ω is the carrying capacity.A stochastic, lattice-based version of equation (20) was studied in [4,6] and is defined by a master equation with the transition rates(21)TN(k)−1,N(k±1)+1|N(k),N(k±1)=Dh2N(k),TN(k)+1|N(k)=λN(k),TN(k)−1|N(k)=λΩhN(k)(N(k)−1),k=1,…,kmax,with Dirichlet boundary conditionsN1=Ω,Nkmax=0. The evolution of the meansN(k)‾is given by(22)∂N(k)‾∂t=Dh2(N(k+1)‾−2N(k)‾+N(k−1)‾)+λN(k)(1−N(k)Ωh)‾.Definingn(x,t)=N(k,t)‾h, withx=hk, the mean field equation for n reduces to (20) ifΩ≫1, as the van Kampen approximation at leading order implies the moment reductionN(k,t)2‾≈N(k,t)‾2.We will now use the hybrid algorithm to simulate travelling wave solutions as we vary several model parameters. As noted in [4,6] for the stochastic Fisher–Kolmogorov equation with the conventions used in the present paper and in [5,7,9] for alternative formulations, stochastic effects can produce wave speedscstochwhich deviate from the deterministic Fisher–Kolmogorov equation (20),cPDE=2Dλ. The three other parameters control the various limits:Θ→∞yields the stochastic model from the hybrid model,Ω→∞yields the mean field model from the stochastic model, andh→0yields the PDE from the mean field model. We will study the effect of variation in these three parameters on travelling wave speeds in the next subsection.We now study travelling wave solutions, fixingD=1,λ=1. We ensure that in all simulations the travelling wave is sufficiently far from the boundaries, so that effects associated with the finite domain size are negligible. As initial conditions we approximate the travelling wave solution of the PDE (20), so that we can focus on wave propagation, rather than wave formation.Fig. 2compares travelling wave solutions generated from the stochastic model, the hybrid model (withΘ=25) and the PDE. In each plot we present a single realisation and the mean of 256 realisations of the stochastic (Fig. 2(a), (c), (e)) and hybrid models (Fig. 2(b), (d), (f)) together with the numerical solution of the corresponding PDE. We fixD=λ=1,kmax=20,h=1, and allow to vary Ω. We note that the travelling wave speeds for the stochastic and hybrid models are slower than those of the PDE, and the speed increases with Ω. Furthermore, the relative noise, i.e. the fluctuation of a single stochastic or hybrid realisation about the mean, decreases as Ω increases. Finally, the wave front of the PDE appears to be steeper compared to the wave front of the mean of 256 realisations both in the stochastic and hybrid models compared to the PDE, and the steepness increases with Ω. This is explained as the different realisations of the stochastic model can have different speeds, hence the average broadens the wave front.We now compare the stochastic to the hybrid model. ForΩ=10, soΩ<Θ, neither single realisations nor the mean of the stochastic model (Fig. 2(a)) differ significantly from the hybrid model (Fig. 2(b)), as the threshold of the hybrid model is considerably larger than the carrying capacity, so almost certainly the entire domain of the hybrid model will be stochastic. WhenΩ=25, soΩ=Θ, the stochastic model (Fig. 2(c)) and the hybrid model (Fig. 2(d)) differ significantly away from the wave front. The stochastic model is much noisier, but the noise in the hybrid model is non-zero as noise from the stochastic domain can diffuse into the mean field domain, raising the particle number above the threshold value. Note that fluctuations can also reach beyond the threshold in the hybrid model due to the minimum domain size requirement for the deterministic domain. WhenΩ=50, soΩ>Θ, the noise away from the wave front associated with the stochastic model (Fig. 2(e)) is absent in the hybrid model (Fig. 2(f)). Nevertheless, the wave fronts of the means appear similar. Hence, for the parameter values used, the hybrid model represents a good approximation to the stochastic model, producing travelling waves with the same speed. If the carrying capacity is larger than the threshold Θ then fluctuations around the carrying capacity behind the front are suppressed, without affecting the wave speed.Fig. 3shows the dependence of the wave speed on the lattice constant. We compare the stochastic model against the mean field model, i.e. the finite difference discretisation of the PDE with the same lattice constant, and the hybrid model. Densities are fixed by adjustingΩ=80⁎h. Likewise,Θ=16⁎h, but we also compare to the hybrid model with a fixed thresholdΘ=10. The wave speed c is calculated by observing that the change of the total number of particles in time, averaged over all simulations,Ntot‾=∑k=1kmaxN(k)‾, should be proportional to c. We approximate the wave speed by comparingNtotafter fixed time intervalsΔt=5, obtainingNtot(t+Δt)−Ntot(t)=ΔtΩhc. The finite difference model converges, as expected, toc=2ash→0, even though every finite lattice spacing will still result in some visible dispersion after a long time. The stochastic model has a significantly lower wave speed and the wave speed of the hybrid model, withΘ=10, converges to that for the stochastic model. However, ifΘ=16h, then the hybrid model does not appear to converge to the stochastic model.Fig. 4(a) shows how the wave speed varies with the carrying capacity Ω for the stochastic and hybrid models. Here,h=D=λ=1in all cases. The wave speeds for the stochastic model are identical to those obtained in [4], and for large Ω they approach the wave speed of the mean field theory as expected by general theory [26,35], this value is slightly abovec=2because h is finite. WhenΘ=100, the wave speeds for the hybrid and stochastic models are indistinguishable. We remark that a naive expectation that the hybrid model should be intermediate between the PDE and the stochastic model does not imply that the wave speed of the hybrid model should be intermediate between their wave speeds. However, a correct expectation is that as Θ increases, the agreement between the hybrid and stochastic models, including their wave speeds, increases. Fig. 4(b) shows this clearly. Here, we have fixedΩ=100and varied Θ. The wave speed monotonically approaches that of the stochastic model (not shown, but it is formally obtained asΘ→∞), and forΘ≃25the wave speed of the hybrid model is almost identical to that of the stochastic model. Due to the observation in those numerical simulations that the wave speed seems to plateau for high and low values of Θ, we have fitted the functionc=a1+a2Erf(a3⁎Log(Θ)+a4)to the values obtained from the simulations, and obtained a very good fit for the valuesa1=1.5,a2=0.13,a3=1.4,a4=−3.0.We now investigate a predator–prey system with predator M and prey N. In the stochastic model, each species can jump to neighbouring lattice sites, the prey reproduce at rate a, predators die at rate c and consume prey and reproduce at rate b. The transition rates are given by(23)TN(k)−1,N(k±1)+1|N(k),N(k±1)=DNh2N(k),TM(k)−1,M(k±1)+1|M(k),M(k±1)=DMh2M(k),TN(k)+1|N(k)=aN(k),TN(k)−1,M(k)+1|N(k),M(k)=bN(k)M(k),TM(k)−1|M(k)=cM(k).For simplicity, we choose the interaction reaction such that each time a prey is eaten by a predator, a single new predator is born. The mean field and continuum limit corresponds to the classical spatial Lotka–Volterra equations:(24)∂n∂t=DN∂2n∂x2+an−bnm,∂m∂t=DM∂2m∂x2+bnm−cm.Here,n=n(x,t)andm=m(x,t)are prey and predator densities related toN(k)andM(k)respectively in the same way as before.As before, we use a finite difference approximation to solve equation (24), discretising in space using the same lattice as for the stochastic model. For the time integration we use the Runge–Kutta method. All plots are normalised so that the number of predators or prey in a box is shown, rather than the corresponding density.There are now four subdomains to consider, depending on whether each of the predator and prey evolve deterministically or stochastically. For notational simplicity we identifyN(k)=hn(k)andM(k)=hm(k)where appropriate. We will now explain explicitly which transition rates define the stochastic model, and which PDEs correspond to the mean field model solved in the respective subdomain. The interfaces between the subdomains are as given in Section 3.1.1.Deterministic predator and deterministic preyIn this region, we solve Equations (24), and set the transition rates (23) equal to zero, so no stochastic reactions occur.Deterministic predator and stochastic preyThe deterministic equation are:(25)∂n∂t=0,∂m∂t=DM∂2m∂x2−cm,and the transition rates are the following(26)TN(k)−1,N(k±1)+1|N(k),N(k±1)=DNh2N(k),TM(k)−1,M(k±1)+1|M(k),M(k±1)=0,TN(k)+1|N(k)=aN(k),TN(k)−1,M(k)+1|N(k),M(k)=bN(k)M(k),TM(k)−1|M(k)=0.Stochastic predator and deterministic preyDeterministic part equations are described below,(27)∂n∂t=DN∂2n∂x2+an,∂m∂t=0,and the transition rates are the following(28)TN(k)−1,N(k±1)+1|N(k),N(k±1)=0,TM(k)−1,M(k±1)+1|M(k),M(k±1)=DMh2M(k),TN(k)+1|N(k)=0,TN(k)−1,M(k)+1|N(k),M(k)=bN(k)M(k),TM(k)−1|M(k)=cM(k).Stochastic predator and stochastic preyHere both species are fully stochastic and we use transition rates (23). We consider two scenarios appearing in the spatial Lotka–Volterra system, and compare the hybrid model to the stochastic and deterministic models. Both scenarios correspond to solutions of the PDE which oscillate in space and time, but in one case the oscillations bring the total number of prey so close to zero that extinction is possible in the stochastic model.The domain of lengthL=20is divided intokmax=101boxes, soh=0.2. Initially it contains a spatially homogeneous distribution of prey and predators so thatN(k,t=0)=50,M(k,t=0)=5. The model parameters are fixed so thatDN=DM=1,a=2,b=0.1,c=3. With Neumann boundary conditions, equations (24) remain spatially homogeneous at all times, and both populations oscillate in time. Typical results are presented in Fig. 5, and show that the peak in prey numbers is followed by a peak in the number of predators. For this choice of parameter values the minimum number of individuals of either species is always sufficiently large that extinction in the stochastic, spatial model is almost impossible. Corresponding results for the stochastic and hybrid models for two choices of the threshold values (Θ=10andΘ=25) are shown in Fig. 6. The column on the left shows the spatial profile of the number of predators and prey in a given box at timet=2.5, both for a single realisation and the mean of 256 different realisations. Comparing either predator and prey numbers, we note that the means for the stochastic and hybrid models appear similar for both values of Θ (see Fig. 6(a), (c), (e)), and are fairly homogeneous, whereas single realisations of either model differ markedly. As expected, the profile of predator and prey numbers in the stochastic model is noisy throughout the domain, whereas noise is suppressed in the hybrid model when the population numbers exceed the threshold. We observe the predator numbers in Fig. 6(c) are above the threshold and hence smoothly distributed in space, but they are not homogeneous, in contrast to the profile of the mean.The column to the right in Fig. 6 shows the time evolution of the spatial mean of the number of prey,〈N〉k=1kmax∑k=1kmaxN(k). We note that the means for the stochastic model (Fig. 6(b)) and the hybrid model are similar for either threshold (Figs. 6(d), (f)). In all cases, we observe oscillatory behaviour around30=cb, the steady state of the corresponding PDE Eq. (24), with a decreasing amplitude. This contrasts with the dynamics of the PDE (see Fig. 5) where the amplitude of oscillations was constant in time. This is because stochastic fluctuations may cause oscillations to fall out of synchrony and hence oscillations average out. Hence, the damping effect is stronger when plotting the mean of all realisations, rather than a single realisation, where the amplitude can fluctuate in time. However, this also implies that the PDE is not a good approximation to the mean over different realisations. We finally remark that while the plots of the spatial mean number of predators look different for the stochastic and hybrid models with the two thresholds, this is not significant as different realisations of the same model (not shown here) also look different. To properly compare the stochastic and hybrid models, we need quantitative measures (Table 1). We calculate the spatial and temporal average of the mean number of prey across 256 different realisations,(29)〈N〉‾k,t=1256kmaxtmax∑r=1256∑k=1kmax∫0tmaxNr(k,t)dt,over the simulation time oftmax=50, and likewise the average of the mean number of predators. In this way we obtain a single number with large statistical significance, which is easier to compare as at individual time points, the oscillations in different realisations can be out of synchrony. We observe good agreement between the models. The values reported in Table 1 are in good agreement with the steady state values of the corresponding ODE model, but slightly different, as the temporal oscillations are not necessarily symmetric with respect to the steady state value. We then measure the standard deviation of the spatio-temporal averages, which is〈N〉k,t2‾−〈N〉‾k,t2for prey numbers, and likewise for predator numbers. Here, we note that the stochastic model is in close agreement with the hybrid model withΘ=25; this agreement is less striking whenΘ=10. We conclude that the hybrid model can reproduce stochastic measures of the stochastic model, such as the standard deviation, and the agreement is better for larger values of the threshold Θ.We now choose a spatially homogeneous population of prey,N(k,t=0)=50,k=1,…,kmax, a number of predators present only on the left side of the domain,M(k)=100,(k=1,…,9),M(10)=98,M(11)=50,M(12)=2, andM(k)=0,(k=13,…101), Neumann boundary conditions and parametersDN=DM=1,a=1,b=0.1,c=2,L=20,kmax=101. This scenario is a typical example of invasion of a predator into a population of prey, leading to spatial and temporal fluctuations even in the purely deterministic model (Fig. 7).Fig. 7 shows how the number of predators and prey at the two boundaries (x=0,x=20) vary in time for the mean field model. We note that during the first few oscillations both predator and prey populations are close to zero. In the corresponding stochastic model, the population can only be integer-valued, so a value below 1 in the deterministic model indicates that extinction of the population is likely. At later times, we observe regular oscillations with minima significantly above 0, and conclude that if extinction were to occur in the stochastic model, it would most likely happen at early times. Fig. 8confirms these expectations. Fig. 8(a) shows that, for the stochastic model, the spatial average of the number of predators (or prey) may exhibit oscillations similar to those of the deterministic model. However, extinction of either population can also occur. Fig. 8(c) shows that if the prey die out first, then, necessarily, the predators will also die out. On the other hand, if the predators die out first, then prey numbers will blow up (see Fig. 8(e)). Figs. 8(b), (d), (f) confirm that the hybrid model can reproduce each of these three qualitatively different scenarios. Since statistics for the mean and standard deviation are not meaningful if the prey population blows up, we compare the frequency of extinction events in the stochastic and hybrid models.The results presented in Table 2suggest that the hybrid model with a threshold ofΘ=10or larger has a similar probability of extinction as the stochastic model. We conclude that in this case the hybrid model provides a good approximation to the stochastic model. We finally investigate the performance gain obtained by using the hybrid model.Table 3compares the computational time needed to perform 256 simulations of the stochastic and hybrid models proceeding until extinction or timet=100in all cases. The simulations were performed on a Xeon-2680 16-core server with 2.7 GHz and 128 GB RAM. Simulations of the stochastic model were stopped once predator extinction occurred, as in that case the population of prey necessarily blows up. Hence, the advantage in performance of the hybrid model is even larger than the numbers indicate.

@&#CONCLUSIONS@&#
In this paper we have presented a hybrid algorithm which couples a stochastic reaction–diffusion system on a lattice to its associated mean field limit, which can be seen as the finite-difference discretisation of a reaction–diffusion PDE. Our algorithm preserves mass at the interface between the stochastic and deterministic domains, and these domains need neither to be static nor connected. Furthermore, for multi-species systems, the corresponding stochastic and deterministic domains may differ for individual species. We also introduced a normalisation procedure to ensure that the stochastic domain contains only integer numbers of particles when the mean field equations are evolved or the interface is moved. With the example of the spatial Lotka–Volterra system, this paper provides a detailed study of a multi-species hybrid system that can accommodate multiple moving interfaces. We found that our hybrid algorithm can produce stochastic effects that are not present in the corresponding mean field model with the same frequency as the stochastic model, while the time taken to perform hybrid simulations is much shorter than that for fully stochastic simulations.At present, we solve the deterministic equations on the same grid as the stochastic model. For computational reasons, one might consider other numerical schemes to solve the mean field equations [11,25]. This could be particularly important for simulating systems in higher spatial dimensions and geometries with curved boundaries because, in such cases, finite difference discretisations might not be sufficiently accurate. Another modification to determine the position of our algorithm could be to refine the condition used at the interface. For the models studied in this paper, we found that counting the number of particles in a box provides a good threshold condition for when to use the stochastic, and when to use the mean field, model. This is justified as typically stochastic fluctuations scale with the square root of the number of particles. However, for some systems one might need to choose the domains directly according to the size of the fluctuations.Finally, it would be interesting to test our algorithm on reaction–diffusion systems involving larger numbers of individuals, such as models of cancer growth [16,34], angiogenesis [32] or cell polarity [29]. Such considerations are beyond the scope of this paper and are therefore postponed for future research.